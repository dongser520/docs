---
navbar: true
sidebar: auto
title: 企业网站后台内容管理
---

## 一、企业网站后台内容管理（网站的新闻、产品、内容等等信息）表 news
### 1、表设计
企业网站后台内容管理（网站的新闻、产品、内容等等信息）表 news 字段设计（更多字段根据业务需求来扩展）
> 表名：news
> | 字段名                 |  数据类型   | 描述                              |   空     |         默认值                       | <p style="width:100px;">字段含义 </p>     |
> | :---:                 | :---:       | :---:                            | :---:    |         :---:                           |        :---:                           |
> | <b>id </b>            | <span>int(20) </span>     | <span style="font-size:12px">主键、自增长、UNSIGNED无符号 </span>      |   否      |         <span style="font-size:12px">无  </span>                             |                                        |
> | <b>category_id </b>      | int(20) |                                  |    否    |          0        |   外键，关联哪个分类，属于哪个分类下面的信息内容            |
> | <b>name </b>     | varchar(100) |                                  |    否    |                        |   内容标题、新闻标题、产品名称等            |
> | <b>enname </b>     | varchar(255) |                                  |    是    |                        |   标题、名称等英文            |
> | <b>status </b>     | int(1) |                                  |    是    |         1   |   内容显示状态 0不显示 1显示 等等状态          |
> | <b>order </b>     | int(11) |                       |    是    |       50                 |   文章、内容排序，默认50            |
> | <b>description </b>     | varchar(255) |                       |    是    |                        |   内容摘要，同时也是百度等搜索引擎抓取的描述信息            |
> | <b>keywords </b>     | varchar(255) |                       |    是    |                        |   百度等搜素引擎的关键字            |
> | <b>maincontent </b>     | text |                       |    是    |      |   主体内容（可为空，比如当对产品描述时候仅仅说一下产品名称内容不想填）            |
> | <b>attachment </b>     | varchar(255) |                 |    是    |      |   内容附件，比如：封面图、文件等等，或者指明文章出自哪个网址链接，一般是网址            |
> | <b>lookcount </b>     | int(11) |                       |    是    |       0                 |   文章、内容点击量，默认0            |
> | <b>manager_id </b>      | int(20) |            |    否    |     0             |   哪个发布的内容，一般关联管理员表，外键            |
> | <b> timestamp </b>    | datetime  |            |    否    |        	CURRENT_TIMESTAMP               |   时间戳(可用于统计内容发布数量等)   |
> | ...    |   |                                   |        |        	               |   |
> | <b> create_time </b>  | datetime  |                                   |    否    |        CURRENT_TIMESTAMP	               |   数据创建时间                         |
> | <b> update_time </b>  | datetime  |                                   |    否    |        CURRENT_TIMESTAMP	               |   数据更新时间                         |
> 
> 额外说明：`mysql每行最大只能存65535个字节。假设是utf-8编码，每个字符占3个字节。varchar存储最大字符数为(65535-2-1)/3=21844字符长度`

### 2、创建迁移文件、执行迁移命令创建数据表 news
> 在数据库创建数据表的方式很多，在上面定义了表字段之后，可以使用`phpmyAdmin`、`数据库插件执行sql语句创建`等等方式，但是建议大家通过：创建迁移文件、执行迁移命令创建数据表。
>> 涉及的知识点：
>> 1. 章节2：egg.js基础-五、<a href="/secondless/w-c/Egg.js.html#五、eggjs项目中sequelize模型创建mysql数据库" target="_blank">eggjs项目中sequelize模型创建mysql数据库</a>
>>
>> 创建迁移文件 命令：
>> ```js
>> npx sequelize migration:generate --name=init-news
>> ```
>> 创建迁移文件：
>> ```js
>> 'use strict';
>> 
>> /** @type {import('sequelize-cli').Migration} */
>> module.exports = {
>>   async up(queryInterface, Sequelize) {
>>     const { INTEGER, STRING, DATE, ENUM, TEXT, BIGINT } = Sequelize;
>>     // 创建表 --- 类似我们sql语句定义表结构
>>     await queryInterface.createTable('news', {
>>       id: {
>>         type: INTEGER(20).UNSIGNED,
>>         primaryKey: true,
>>         autoIncrement: true,
>>         comment: '内容主键id'
>>       },
>>       category_id: {
>>         type: INTEGER(20).UNSIGNED,
>>         allowNull: false,
>>         defaultValue: 0,
>>         comment: '分类id',
>>         references: { //关联关系
>>           model: 'category', //关联的表
>>           key: 'id' //关联表的主键
>>         },
>>         onDelete: 'cascade', //删除时操作
>>         onUpdate: 'restrict', // 更新时操作
>>       },
>>       name: {
>>         type: STRING(100),
>>         allowNull: false,
>>         defaultValue: '',
>>         comment: '内容标题、新闻标题、产品名称等'
>>       },
>>       enname: {
>>         type: STRING,
>>         allowNull: true,
>>         defaultValue: '',
>>         comment: '标题、名称等英文'
>>       },
>>       status: {
>>         type: INTEGER(1),
>>         allowNull: false,
>>         defaultValue: 1,
>>         comment: '内容显示状态 0不显示 1显示 等等状态'
>>       },
>>       order: {
>>         type: INTEGER,//不限定长度.默认int(11)
>>         allowNull: true,
>>         defaultValue: 50,
>>         comment: '文章、内容排序，默认50'
>>       },
>>       description: {
>>         type: STRING,//不限定长度.默认varchar(255)
>>         allowNull: true,
>>         defaultValue: '',
>>         comment: '内容摘要'
>>       },
>>       keywords: {
>>        type: STRING,//不限定长度.默认varchar(255)
>>         allowNull: true,
>>         defaultValue: '',
>>         comment: '关键字'
>>       },
>>       maincontent: {
>>         type: TEXT,
>>         allowNull: true,
>>         defaultValue: '',
>>         comment: '主体内容（可为空，比如当对产品描述时候仅仅说一下产品名称内容不想填）'
>>       },
>>       attachment: {
>>         type: STRING,//不限定长度.默认varchar(255)
>>         allowNull: true,
>>         defaultValue: '',
>>         comment: '内容附件，比如：封面图、文件等等，或者指明文章出自哪个网址链接，一般是网址'
>>       },
>>       lookcount: {
>>         type: INTEGER,
>>         allowNull: true,
>>         defaultValue: 0,
>>         comment: '文章、内容点击量，默认0'
>>       },
>>       manager_id: {
>>         type: INTEGER(20).UNSIGNED,
>>         allowNull: false,
>>         defaultValue: 0,
>>         comment: '哪个发布的内容，一般关联管理员表，外键',
>>         references: { //关联关系
>>           model: 'manager', //关联的表
>>           key: 'id' //关联表的主键
>>         },
>>         onDelete: 'cascade', //删除时操作
>>         onUpdate: 'restrict', // 更新时操作
>>       },
>>       timestamp : {
>>         type: DATE, 
>>         allowNull: false, 
>>         defaultValue:Sequelize.fn('NOW'),
>>         comment: '时间戳(可用于统计内容发布数量等)',
>>       },
>>       create_time: { type: DATE, allowNull: false, defaultValue: Sequelize.fn('NOW') },
>>       update_time: { type: DATE, allowNull: false, defaultValue: Sequelize.fn('NOW') }
>>     });
>>   },
>> 
>>   async down(queryInterface, Sequelize) {
>>     await queryInterface.dropTable('news')
>>   }
>> };
>> 
>> ```
>> 执行迁移文件命令生成数据库表：
>> ```js
>> // 升级数据库-创建数据表
>> npx sequelize db:migrate
>> // 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更
>> npx sequelize db:migrate:undo
>> // 可以通过 `db:migrate:undo:all` 回退到初始状态
>> npx sequelize db:migrate:undo:all
>> ```
### 3、创建 news表 的模型
> 模型文件主要是用于处理数据库表的增删改查等操作 `app/model/news.js`
```js
'use strict';

module.exports = app => {
    const { INTEGER, STRING, DATE, ENUM, TEXT, BIGINT } = app.Sequelize;

    const News = app.model.define('news', {

        id: {
            type: INTEGER(20).UNSIGNED,
            primaryKey: true,
            autoIncrement: true,
            comment: '内容主键id'
        },
        category_id: {
            type: INTEGER(20).UNSIGNED,
            allowNull: false,
            defaultValue: 0,
            comment: '分类id',
            references: { //关联关系
                model: 'category', //关联的表
                key: 'id' //关联表的主键
            },
            onDelete: 'cascade', //删除时操作
            onUpdate: 'restrict', // 更新时操作
        },
        name: {
            type: STRING(100),
            allowNull: false,
            defaultValue: '',
            comment: '内容标题、新闻标题、产品名称等'
        },
        enname: {
            type: STRING,
            allowNull: true,
            defaultValue: '',
            comment: '标题、名称等英文'
        },
        status: {
            type: INTEGER(1),
            allowNull: false,
            defaultValue: 1,
            comment: '内容显示状态 0不显示 1显示 等等状态'
        },
        order: {
            type: INTEGER,//不限定长度.默认int(11)
            allowNull: true,
            defaultValue: 50,
            comment: '文章、内容排序，默认50'
        },
        description: {
            type: STRING,//不限定长度.默认varchar(255)
            allowNull: true,
            defaultValue: '',
            comment: '内容摘要'
        },
        keywords: {
            type: STRING,//不限定长度.默认varchar(255)
            allowNull: true,
            defaultValue: '',
            comment: '关键字'
        },
        maincontent: {
            type: TEXT,
            allowNull: true,
            defaultValue: '',
            comment: '主体内容（可为空，比如当对产品描述时候仅仅说一下产品名称内容不想填）'
        },
        attachment: {
            type: STRING,//不限定长度.默认varchar(255)
            allowNull: true,
            defaultValue: '',
            comment: '内容附件，比如：封面图、文件等等，或者指明文章出自哪个网址链接，一般是网址'
        },
        lookcount: {
            type: INTEGER,
            allowNull: true,
            defaultValue: 0,
            comment: '文章、内容点击量，默认0'
        },
        manager_id: {
            type: INTEGER(20).UNSIGNED,
            allowNull: false,
            defaultValue: 0,
            comment: '哪个发布的内容，一般关联管理员表，外键',
            references: { //关联关系
                model: 'manager', //关联的表
                key: 'id' //关联表的主键
            },
            onDelete: 'cascade', //删除时操作
            onUpdate: 'restrict', // 更新时操作
        },
        timestamp : {
            type: DATE, 
            allowNull: false, 
            defaultValue:app.Sequelize.fn('NOW'),
            get(){
              let data = this.getDataValue('timestamp') ;
              /*
              //如果想转换成年月日时分秒，可以使用moment.js库等其他时间库
              //我们这里带领大家回忆一下js基础，就手动拼接一下
              let year = data.getFullYear();
              let month = ("0" + (data.getMonth() + 1)).slice(-2);
              let day = ("0" + data.getDate()).slice(-2);
              let hours = ("0" + data.getHours()).slice(-2);
              let minutes = ("0" + data.getMinutes()).slice(-2);
              let seconds = ("0" + data.getSeconds()).slice(-2);
              return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
              */
              //如果想转成时间戳
              return (new Date(data)).getTime();
            }
        },
        // sex: { type: ENUM, values: ['男','女','保密'], allowNull: true, defaultValue: '保密', comment: '留言用户性别'},
        create_time: {
            type: DATE,
            allowNull: false,
            defaultValue: app.Sequelize.fn('NOW'),
            get() {
                return app.formatTime(this.getDataValue('create_time'));
            }
        },
        update_time: { type: DATE, allowNull: false, defaultValue: app.Sequelize.fn('NOW') }
    });

    // 模型关联关系
    News.associate = function (models) {
        // 关联分类 反向一对多(一个分类可以有多个新闻内容，分类对于新闻内容是一对多的关系，反过来新闻内容属于分类belongsTo，就是反向一对多)
        News.belongsTo(app.model.Category);
        // 关联管理员 反向一对多(一个管理员可以发布很多新闻，管理员对于新闻内容就是一对多的关系，反过来新闻内容属于管理员belongsTo，就是反向一对多)
        News.belongsTo(app.model.Manager);
    }

    return News;
}
```

### 4、完成基本的新闻内容列表展示、及创建发布新闻内容界面
> 控制器 `app/controller/admin/news.js`
```js
'use strict';

const Controller = require('egg').Controller;

class NewsController extends Controller {

    //内容列表界面
    async index() {
        const { ctx, app } = this;
        //分页：可以提炼成一个公共方法page(模型名称，where条件，其他参数options)
        let data = await ctx.page('News',{},{
            // 关联查询
            include:[
                {
                    model:app.model.Category,// 需要查询的模型
                    attributes:['id','name','enname'],// 查询的字段 
                },
                {
                    model:app.model.Manager,// 需要查询的模型
                    attributes:['id','username','avatar'],// 查询的字段 
                },
            ],
        });
        data = JSON.parse(JSON.stringify(data));
        // console.log(data);return;
        //渲染公共模版
        await ctx.renderTemplate({
            title: '信息内容列表',//现在网页title,面包屑导航title,页面标题
            data,
            tempType: 'table', //模板类型：table表格模板 ，form表单模板
            table: {
                //表格上方按钮,没有不要填buttons
                buttons: [
                    {
                        url: '/admin/news/create',//新增路径
                        desc: '发布内容',//新增 //按钮名称
                        // icon: 'fa fa-plus fa-lg',//按钮图标
                    }
                ],
                //表头
                columns: [
                    {
                        title: '标题/名称',
                        key: 'name',
                        class: 'text-left',//可选
                    },
                    {
                        title: '所属栏目',
                        // key: 'category_id',
                        class: 'text-center',//可选
                        render(item) {
                            return `
                               <span>${item.category.name}</span>
                            `;
                        }
                    },
                    {
                        title: '浏览量',
                        key: 'lookcount',
                        class: 'text-center',//可选
                    },
                    {
                        title: '哪个管理员发布的',
                        // key: 'username',
                        render(item) {
                            return `
            <h2 class="table-avatar">
              <a href="#" class="avatar avatar-sm mr-2">
                  <img
                      class="avatar-img rounded-circle"
                      src="${item.manager.avatar}"
                      alt="User Image"></a>
                  <a href="#"> ${item.manager.username}
                  <span>管理员id:${item.manager.id}</span></a>
            </h2>
           `;
                        },
                    },
                    
                    {
                        title: '创建时间',
                        key: 'create_time',
                        width: 200,//可选
                        class: 'text-center',//可选
                    },
                    {
                        title: '操作',
                        class: 'text-right',//可选
                        action: {
                            //修改
                            edit: function (id) {
                                return `/admin/news/edit/${id}`;
                            },
                            //删除
                            delete: function (id) {
                                return `/admin/news/delete/${id}`;
                            }
                        }
                    },
                ],
            },
        });
    }

    //新增内容界面
    async create() {
        const { ctx, app } = this;

        // 渲染模版前先拿到所有分类
        let data = await ctx.service.category.dropdown_Categorylist();
        console.log(data);
        data.shift();//删除自定义的第一项
        console.log(data);
        //渲染公共模版
        await ctx.renderTemplate({
            title: '发布内容',//现在网页title,面包屑导航title,页面标题
            tempType: 'form', //模板类型：table表格模板 ，form表单模板
            form: {
                //提交地址
                action: "/admin/news/save",
                //  字段
                fields: [
                    {
                        label: '请选择一个分类栏目发布',
                        type: 'dropdown', //下拉框
                        name: 'category_id',
                        default: JSON.stringify(data),
                        placeholder: '请选择',
                    },
                    {
                        label: '标题/名称',
                        type: 'text',
                        name: 'name',
                        placeholder: '请输入标题/名称',
                        // default:'默认值测试', //新增时候默认值，可选
                    },
                    {
                        label: '标题/名称英文',
                        type: 'text',
                        name: 'enname',
                        placeholder: '请输入标题/名称英文，选填',
                    },
                    {
                        label: '内容摘要',
                        type: 'text',
                        name: 'description',
                        placeholder: '请输入内容摘要,选填',
                    },
                    {
                        label: '关键字',
                        type: 'text',
                        name: 'keywords',
                        placeholder: '请输入关键字（逗号隔开）,选填',
                    },
                    {
                        label: '主体内容',
                        type: 'text',
                        name: 'maincontent',
                        placeholder: '请输入主体内容,选填',
                    },
                    {
                        label: '内容附件',
                        type: 'text',
                        name: 'attachment',
                        placeholder: '请输入附件如：封面图、文件、网址等,选填',
                    },
                    {
                        label: '点击量',
                        type: 'text',
                        name: 'lookcount',
                        default:0,
                        placeholder: '请输入点击量,选填，默认0',
                    },
                    {
                        label: '排序',
                        type: 'number',
                        name: 'order',
                        placeholder: '请输入排序（数字越小越排在前面）',
                        default:50,
                    },
                    {
                        label: '内容显示状态',
                        type: 'btncheck', //按钮组选择
                        name: 'status',
                        default: JSON.stringify([
                            { value: 1, name: '显示', checked: true },
                            { value: 0, name: '隐藏' },
                        ]),
                        placeholder: '内容显示状态 0不显示 1显示 等等状态',
                    },
                ],
            },
            //新增成功之后跳转到哪个页面
            successUrl: '/admin/news/index',
        });
    }

}

module.exports = NewsController;

```
> 路由 `app/router/admin/admin.js`
```js
//新闻内容列表页面
router.get('/admin/news/index', controller.admin.news.index);
//发布新闻内容界面
router.get('/admin/news/create', controller.admin.news.create);
```
> 表单模版微调 `app/view/admin/layout/_form.html`
```html
...
{# 如果是下拉框类型 #}
<div class="dropdown">
    <button type="button" class="btn dropdown-toggle dropdown-{{item.name}}" data-toggle="dropdown" id="dropdownData">
        {{item.placeholder  if item.placeholder  else '一级分类'}}
    </button>
...
```
> 分类控制器调整 `app/controller/admin/category.js`
```js
//修改分类界面
...
//  字段
fields: [
    {
        label: '放在哪个分类里面',
        type: 'dropdown', //下拉框
        name: 'pid',
        default: JSON.stringify(data),
        placeholder: '不调整（如需调整请选择）',//统一改成placeholder提示
        // id:id,//有id说明操作是修改不是新增
    },
...    
```