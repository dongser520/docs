---
navbar: true
sidebar: auto
title: 上传文件
---

> 前言 <br/>
> 1. 关于上传文件方式<br/>
> 官网提供： <a href="https://www.eggjs.org/zh-CN/basics/controller#%E8%8E%B7%E5%8F%96%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%96%87%E4%BB%B6" target="_blank">获取上传的文件</a>，提供了两种模式：<a href="https://www.eggjs.org/zh-CN/basics/controller#file-%E6%A8%A1%E5%BC%8F" target="_blank">File 模式</a> 和 <a href="https://www.eggjs.org/zh-CN/basics/controller#file-%E6%A8%A1%E5%BC%8F" target="_blank">Stream 流模式</a><br/><br/>
> 2. 上传文件之后，文件存储方式<br/>
> 第一种存储方式： 存放在你自己的服务器上，和项目代码放在一起；<br/>
> 第二种存储方式： 通过第三方OSS云存储服务，例如：七牛云、阿里云、腾讯云等它们的云存储服务，存放在第三方服务器上；

## 一、Stream 流模式上传文件（单个文件），文件存储在你自己的服务器上
### 1、安装依赖包和插件
```js
npm i await-stream-ready stream-wormhole dayjs --save
// 安装了三个依赖或者插件
// await-stream-ready： 用于处理文件上传的流，当文件上传完毕后，会触发一个事件
// stream-wormhole： 用于处理文件上传的流，当文件上传完毕后，会触发一个事件
// dayjs： 用于处理时间插件
```
### 2、项目配置：`config/config.default.js`
```js
//配置上传文件相关
config.multipart = {
    fileSize:'50mb', //最大上传大小50MB
    mode:'stream', //上传文件模式，stream 流模式 file 模式
    fileExtensions:['.xls','.txt','.jpg','.JPG','.png','.PNG',
                    '.gif','.GIF','.jpeg','.JPEG'],//文件格式自定义
};
```

### 3、新建控制器 `app/controller/upload.js` 处理文件上传，前后端都可以用
```js
'use strict';

// 引入
const fs = require('fs');
const path = require('path');
//故名思意 异步二进制 写入流
const awaitWriteStream = require('await-stream-ready').write;
//管道读入一个虫洞
const sendToWormhole = require('stream-wormhole');
// 日期格式化
const dayjs = require('dayjs');

const Controller = require('egg').Controller;

class UploadController extends Controller {
 
    // 上传单个文件流模式到本地服务器
    async uploadStreamSingleToServer() {
        const fileDirname = 'uploads';
        // 单个文件，多个文件查看：https://www.eggjs.org/zh-CN/basics/controller#stream-%E6%A8%A1%E5%BC%8F
        const stream = await this.ctx.getFileStream(); //单个文件
        // 基础的目录：上传的文件存放的目录，如：'app/public/uploads'
        const uploadBasePath = 'app/public/' + fileDirname;
        // 生成唯一文件名：时间戳+随机数+文件后缀 [你也可以定义成其它的方式]
        const timestamp = Date.now(); //当前时间戳
        const random = Number.parseInt(Math.random() * 100000000); //随机数
        const extname = path.extname(stream.filename).toLocaleLowerCase(); //文件后缀
        const filename = `${timestamp}_${random}${extname}`;
        // 生成文件夹如：app/public/uploads后面的文件夹如：/2019/01/01，当然你可以自定义其他方式
        // const dirname = dayjs(Date.now()).format('YYYY/MM/DD');//使用我们上面安装的dayjs模块方法转换的日期格式
        const dirname = dayjs(Date.now()).format('YYYYMMDD');// /20190101
        //这个方法是判断这个文件夹是否存在，不存在则创建这个文件夹
        function mkdirsSync(dirname) {
            if(fs.existsSync(dirname)){
                return true
            } else {
                if(mkdirsSync(path.dirname(dirname))){
                    fs.mkdirSync(dirname)
                    return true
                }
            }
        }
        //调用方法生成完整文件路径
        mkdirsSync(path.join(uploadBasePath,dirname));
        // 生成写入路径: 完整文件路径 + 文件名
        const target = path.join(uploadBasePath,dirname,filename);
        // 写入流
        const writeStream = fs.createWriteStream(target);
        // 尝试写入文件数据流
        try {
            // 异步把文件流写入
            await awaitWriteStream(stream.pipe(writeStream));
        } catch (error) {
            // 出现错误，关闭管道
            await sendToWormhole(stream);
            this.ctx.throw(500,error);
        }
        //写入成功后返回文件路径地址
        let url = path.join('/public/' + fileDirname,dirname,filename).replace(/\\|\//g,'/');
        this.ctx.apiSuccess({ url });

    }

}

module.exports = UploadController;

```
### 4、配置路由 `app/router.js`
```js
// 上传单个文件流模式到本地服务器
router.post('/uploadStreamSingleToServer', controller.upload.uploadStreamSingleToServer); 
```
### 5、如果不需要管理员登录就可以上传图片，配置中间件路由 `config/config.default.js`
```js
// 对中间件adminAuth进一步配置
  config.adminAuth = {
    ignore: [
      ...,
      "/uploadStreamSingleToServer", //忽略文件上传路由需要管理员登录
    ],
  };
```
### 6、postman测试上传文件
> 1. post请求，地址：`http://127.0.0.1:7001/uploadStreamSingleToServer` <br/>
> 2. Body发送数据：`form-data类型，Key值：files , Value:选择要上传的图片` <br/>
> 3. 返回结果示例：
> ```js
> {
>     "msg": "ok",
>     "data": {
>         "url": "/public/uploads/20240309/1709952961932_9076609.jpg"
>     }
> }
> ```

## 二、File 模式
> 将在后面的课程：视频点播项目中使用
