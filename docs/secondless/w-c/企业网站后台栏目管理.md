---
navbar: true
sidebar: auto
title: 企业网站后台栏目管理
---

## 一、企业网站后台栏目管理（网站导航栏，栏目分类）表 category 
### 1、网站栏目分析
```js
网站首页
关于我们
    公司介绍
        公司简介
        企业资质
        企业文化
        发展历程
    公司动态
    公司团建
    ...
产品中心
    产品分类
        产品分类1
            产品分类1-1
            产品分类1-2
        产品分类2
            产品分类2-1
            产品分类2-2
        产品分类3    
        ...
    上市产品
    研发产品
    ...
新闻中心
    公司新闻
    行业新闻
    ...
人才招聘
    招聘职位
    招聘要求
    ...     
联系我们
    联系方式
    在线留言
    ...
```
### 2、分析怎样的数据结构可以方便展示上面的数据？
> 上面的结构只是做了4层分类，如果业务需求更大，还需要继续进行分类。很显然，通过外键关联查询无法办到，这个时候我们需要对数据进行处理了。
```js
[
    {
      id:1,
      name:"关于我们",
      children:[
          {
            id:2,
            name:"公司介绍",
            children:[
                {
                    id:5,
                    name:"公司简介",
                    children:[]
                },
                {
                    id:6,
                    name:"企业资质",
                    children:[]
                },
                {
                    id:7,
                    name:"企业文化",
                    children:[]
                },
                {
                    id:8,
                    name:"发展历程",
                    children:[]
                },
            ]
          },
          {
            id:3,
            name:"公司动态",
            children:[]
          },
          {
            id:4,
            name:"公司团建",
            children:[]
          },
      ]
   },
   ...
   {
      id:40,
      name:"联系我们",
      children:[
        {
            id:41,
            name:"联系方式",
            children:[]
        },
        {
            id:42,
            name:"在线留言",
            children:[]
        }
      ]
   }
]

//那么这样的结果，可以通过什么数据处理呢？
[
   { id:1 , name:"关于我们" , pid:0 },
   { id:2 , name:"公司介绍" , pid:1 },
   { id:3 , name:"公司动态" , pid:1 },
   { id:4 , name:"公司团建" , pid:1 },
   { id:5 , name:"公司简介" , pid:2 },
   { id:6 , name:"企业资质" , pid:2 },
   { id:7 , name:"企业文化" , pid:2 },
   { id:8 , name:"发展历程" , pid:2 },
   ...
]

```
### 3、如何将以上结构转成树形结构来方便程序处理和展示？
### 入门级方法
```js
function transformToTree(data) {
  // 创建一个空对象用于存储键值对形式的节点映射
  const nodeMap = {};
  
  // 遍历原始数据，构建节点映射表并初始化节点的 children 属性
  data.forEach(item => {
    const node = { id: item.id, name: item.name, children: [] };
    nodeMap[item.id] = node;
    
    if (item.pid !== 0) {
      // 如果当前节点不是根节点，则将其添加到其父节点的 children 数组中
      if (nodeMap[item.pid]) {
        nodeMap[item.pid].children.push(node);
      }
    }
  });

  // 从映射表中提取所有 pid 为 0 的根节点
  return Object.values(nodeMap).filter(node => node.pid === 0);
}

// 使用给定的数据进行转换
const menuData = [
  { id:1 , name:"关于我们" , pid:0 },
  { id:2 , name:"公司介绍" , pid:1 },
  { id:3 , name:"公司动态" , pid:1 },
  { id:4 , name:"公司团建" , pid:1 },
  { id:5 , name:"公司简介" , pid:2 },
  { id:6 , name:"企业资质" , pid:2 },
  { id:7 , name:"企业文化" , pid:2 },
  { id:8 , name:"发展历程" , pid:2 },
];

const treeData = transformToTree(menuData);

console.log(treeData);
```     

### 树形结构方法演变
由于树形结构数据在很多场景会使用到，如：`网站导航栏`、`产品分类`、`权限选择`、`无限极评论及回复`等等常景都会用到，所以这里把整个方法的演变过程，单独给大家写了一下，感兴趣的同学可以查阅：<br/>
<a href="/secondless/w-c/树形结构方法演变" target="_blank" title="点击查看课程文档">树形结构方法演变</a>

### 演变最终方法：兼容性和扩展性更好的方法
```js
function transformToTree(data, rootPid = 0, level = 0, defaultName = "未命名") {
  const nodeMap = {};

  data.forEach(({ id, pid, enname, ...otherProps }) => {
    let name = enname || defaultName;
    const node = { id, name, pid, level, children: [], ...otherProps };
    nodeMap[id] = node;

    if (pid !== rootPid && nodeMap[pid]) {
      nodeMap[pid].children.push(node);
      node.level = nodeMap[pid].level + 1;
    } else if (pid === rootPid) {
      node.level = level;
    }
  });

  return Object.values(nodeMap).filter(node => node.pid === rootPid);
}

// 示例数据（这种数据更具代表性，也兼容我们上面的数据格式）
const menuData = [
  { id:1 , pid:0 },
  { id:2 , pid:1, enname:"about us" },
  { id:3 , pid:1 },
  { id:4 , pid:1 },
  { id:5 , pid:2 },
  { id:6 , pid:2 },
  { id:7 , pid:2 },
  { id:8 , pid:2 },
];

// 默认情况，rootPid 为 0，层级为 0，默认名称为 "未命名"
const treeData = transformToTree(menuData);

console.log(treeData);
```

### 测试方法
方法封装到 'app/extend/application.js' 扩展里面
```js
...
//5、将普通带有层级关系数组转成树形结构数组[基本结构须有id,pid字段]
transformToTree(data, rootPid = 0, level = 0, defaultName = "未命名") {
    const nodeMap = {};

    data.forEach(({ id, pid, enname, ...otherProps }) => {
        let name = enname || defaultName;
        const node = { id, name, pid, level, children: [], ...otherProps };
        nodeMap[id] = node;

        if (pid !== rootPid && nodeMap[pid]) {
            nodeMap[pid].children.push(node);
            node.level = nodeMap[pid].level + 1;
        } else if (pid === rootPid) {
            node.level = level;
        }
    });

    return Object.values(nodeMap).filter(node => node.pid === rootPid);
}    
```
`app/controller/admin/live.js` 写在index方法里面感受一下
```js
//创建直播功能中的直播间列表页面
async index() {
    ...
    //测试树形结构
    const menuData = [
        { id: 1, name: "关于我们", pid: 0 },
        { id: 2, name: "公司介绍", pid: 1 },
        { id: 3, name: "公司动态", pid: 1 },
        { id: 4, name: "公司团建", pid: 1 },
        { id: 5, name: "公司简介", pid: 2 },
        { id: 6, name: "企业资质", pid: 2 },
        { id: 7, name: "企业文化", pid: 2 },
        { id: 8, name: "发展历程", pid: 2 },
    ];
    // 默认情况，rootPid 为 0，层级为 0，默认名称为 "未命名"
    const treeData = app.transformToTree(menuData);

    console.log('测试树形结构', JSON.stringify(treeData));
}
```
结果可用 `在线json` 比对一下：<a href="https://www.bejson.com/" target="_blank">https://www.bejson.com/</a>

### 4、最终表设计
企业网站后台栏目管理（网站导航栏，栏目分类）表 category 字段设计（更多字段根据业务需求来扩展）
> 表名：category
> | 字段名                 |  数据类型   | 描述                              |   空     |         默认值                       | <p style="width:100px;">字段含义 </p>     |
> | :---:                 | :---:       | :---:                            | :---:    |         :---:                           |        :---:                           |
> | <b>id </b>            | <span>int(20) </span>     | <span style="font-size:12px">主键、自增长、UNSIGNED无符号 </span>      |   否      |         <span style="font-size:12px">无  </span>                             |                                        |
> | <b>pid </b>      | int(20) |                                  |    否    |      0                          |   上一级(父级)id            |
> | <b>name </b>     | varchar(100) |                                  |    否    |                        |   分类名称            |
> | <b>enname </b>     | varchar(100) |                                  |    是    |                        |   分类英文名称            |
> | <b>status </b>     | int(1) |                                  |    否    |         1   |   分类状态 0不可用 1可用 等等状态          |
> | <b> create_time </b>  | datetime  |                                   |    否    |        CURRENT_TIMESTAMP	               |   数据创建时间                         |
> | <b> update_time </b>  | datetime  |                                   |    否    |        CURRENT_TIMESTAMP	               |   数据更新时间                         |
> 
> 额外说明：`mysql每行最大只能存65535个字节。假设是utf-8编码，每个字符占3个字节。varchar存储最大字符数为(65535-2-1)/3=21844字符长度`

### 5、创建迁移文件、执行迁移命令创建数据表 category
> 在数据库创建数据表的方式很多，在上面定义了表字段之后，可以使用`phpmyAdmin`、`数据库插件执行sql语句创建`等等方式，但是建议大家通过：创建迁移文件、执行迁移命令创建数据表。
>> 涉及的知识点：
>> 1. 章节2：egg.js基础-五、<a href="/secondless/w-c/Egg.js.html#五、eggjs项目中sequelize模型创建mysql数据库" target="_blank">eggjs项目中sequelize模型创建mysql数据库</a>
>>
>> 创建迁移文件 命令：
>> ```js
>> npx sequelize migration:generate --name=init-category
>> ```
>> 创建迁移文件：
>> ```js
>> 'use strict';
>> 
>> /** @type {import('sequelize-cli').Migration} */
>> module.exports = {
>>   async up(queryInterface, Sequelize) {
>>     const { INTEGER, STRING, DATE, ENUM, TEXT, BIGINT } = Sequelize;
>>     // 创建表 --- 类似我们sql语句定义表结构
>>     await queryInterface.createTable('category', {
>>       id: {
>>         type: INTEGER(20).UNSIGNED,
>>         primaryKey: true,
>>         autoIncrement: true,
>>         comment: '分类主键id'
>>       },
>>       pid: {
>>         type: INTEGER(20).UNSIGNED,
>>         allowNull: false,
>>         defaultValue: 0,
>>         comment: '上一级(父级)id',
>>       },
>>       name: {
>>         type: STRING(100),
>>         allowNull: false,
>>         defaultValue: '',
>>         comment: '分类名称'
>>       },
>>       enname: {
>>         type: STRING(100),
>>         allowNull: true,
>>         defaultValue: '',
>>         comment: '分类英文名称'
>>       },
>>       status: {
>>         type: INTEGER(1),
>>         allowNull: false,
>>         defaultValue: 1,
>>         comment: '分类状态 0不可用 1可用 等等状态'
>>       },
>>       create_time: { type: DATE, allowNull: false, defaultValue: Sequelize.fn('NOW') },
>>       update_time: { type: DATE, allowNull: false, defaultValue: Sequelize.fn('NOW') }
>>     });
>>   },
>> 
>>   async down(queryInterface, Sequelize) {
>>     await queryInterface.dropTable('category')
>>   }
>> };
>> 
>> ```
>> 执行迁移文件命令生成数据库表：
>> ```js
>> // 升级数据库-创建数据表
>> npx sequelize db:migrate
>> // 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更
>> npx sequelize db:migrate:undo
>> // 可以通过 `db:migrate:undo:all` 回退到初始状态
>> npx sequelize db:migrate:undo:all
>> ```

### 6、创建直播功能中的直播间表 category 的模型
> 模型文件主要是用于处理数据库表的增删改查等操作 `app/model/category.js`
```js
'use strict';

module.exports = app => {
    const { INTEGER, STRING, DATE, ENUM, TEXT, BIGINT } = app.Sequelize;

    const Category = app.model.define('category', {
        id: {
            type: INTEGER(20).UNSIGNED,
            primaryKey: true,
            autoIncrement: true,
            comment: '分类主键id'
        },
        pid: {
            type: INTEGER(20).UNSIGNED,
            allowNull: false,
            defaultValue: 0,
            comment: '上一级(父级)id',
        },
        name: {
            type: STRING(100),
            allowNull: false,
            defaultValue: '',
            comment: '分类名称'
        },
        enname: {
            type: STRING(100),
            allowNull: true,
            defaultValue: '',
            comment: '分类英文名称'
        },
        status: {
            type: INTEGER(1),
            allowNull: false,
            defaultValue: 1,
            comment: '分类状态 0不可用 1可用 等等状态'
        },
        // sex: { type: ENUM, values: ['男','女','保密'], allowNull: true, defaultValue: '保密', comment: '留言用户性别'},
        create_time: {
            type: DATE,
            allowNull: false,
            defaultValue: app.Sequelize.fn('NOW'),
            get() {
                return app.formatTime(this.getDataValue('create_time'));
            }
        },
        update_time: { type: DATE, allowNull: false, defaultValue: app.Sequelize.fn('NOW') }
    });


    return Category;
}
```

### 7、创建表 category 的控制器、完成后台分类列表功能
> 创建控制器 `app/controller/admin/category.js` 完成功能
```js
'use strict';

const Controller = require('egg').Controller;

class CategoryController extends Controller {
    //创建分类表表单
    async create() {
        const { ctx } = this;
        //渲染公共模版
        await ctx.renderTemplate({
            title: '创建分类表表单',//现在网页title,面包屑导航title,页面标题
            tempType: 'form', //模板类型：table表格模板 ，form表单模板
            form: {
                //提交地址
                action: "/admin/category/save",
                //  字段
                fields: [
                    {
                        label: '上一级(父级)id',
                        type: 'number',
                        name: 'pid',
                        default: '0',
                        placeholder: '上一级(父级)id',
                    },
                    {
                        label: '分类名称',
                        type: 'text',
                        name: 'name',
                        placeholder: '请输入分类名称',
                        // default:'默认值测试', //新增时候默认值，可选
                    },
                    {
                        label: '分类英文名称',
                        type: 'text',
                        name: 'enname',
                        placeholder: '请输入分类英文名称',
                    },
                    {
                        label: '分类状态',
                        type: 'number',
                        name: 'status',
                        default: '1',
                        placeholder: '分类状态 0不可用 1可用 等等状态',
                    }
                ],
            },
            //新增成功之后跳转到哪个页面
            successUrl: '/admin/category/index',
        });
    }

    //创建分类表表单提交数据
    async save() {
        //一般处理流程
        //1.参数验证
        this.ctx.validate({
            name: {
                type: 'string',  //参数类型
                required: true, //是否必须
                // defValue: '', 
                desc: '分类名称' //字段含义
            },
            enname: {
                type: 'string',
                required: false,
                defValue: '', 
                desc: '礼物图标'
            },
            status: {
                type: 'int',
                required: true,
                defValue: 1,
                desc: '分类状态 0不可用 1可用 等等状态'
            },
            pid: {
                type: 'int',
                required: true,
                defValue: 0,
                desc: '上一级(父级)id'
            }
        });
        //先判断一下直播功能中的礼物账号是否存在，不存在在写入数据库
        //2.写入数据库
        //3.成功之后给页面反馈
        let { name, enname, status, pid} = this.ctx.request.body;
        if (await this.app.model.Category.findOne({ where: { name } })) {
            return this.ctx.apiFail('分类名称已存在');
        }
        //否则不存在则写入数据库
        const res = await this.app.model.Category.create({
            name,
            enname,
            status,
            pid
        });
        this.ctx.apiSuccess('创建分类成功');
    }

    //创建分类列表页面
    async index() {
        const { ctx, app } = this;
        //分页：可以提炼成一个公共方法page(模型名称，where条件，其他参数options)
        let data = await ctx.page('Category');
        //渲染公共模版
        await ctx.renderTemplate({
            title: '分类列表',//现在网页title,面包屑导航title,页面标题
            data,
            tempType: 'table', //模板类型：table表格模板 ，form表单模板
            table: {
                //表格上方按钮,没有不要填buttons
                buttons: [
                    {
                        url: '/admin/category/create',//新增路径
                        desc: '新增分类',//新增 //按钮名称
                        // icon: 'fa fa-plus fa-lg',//按钮图标
                    }
                ],
                //表头
                columns: [
                    {
                        title: '分类名称',
                        key: 'name',
                        class: 'text-center',//可选
                    },
                    {
                        title: '分类英文名称',
                        key: 'enname',
                        class: 'text-center',//可选
                    },
                    {
                        title: '创建时间',
                        key: 'create_time',
                        width: 200,//可选
                        class: 'text-center',//可选
                    },
                    {
                        title: '操作',
                        class: 'text-right',//可选
                        action: {
                            //修改
                            edit: function (id) {
                                return `/admin/category/edit/${id}`;
                            },
                            //删除
                            delete: function (id) {
                                return `/admin/category/delete/${id}`;
                            }
                        }
                    },
                ],
            },
        });
    }
}

module.exports = CategoryController;

```

### 8、定义路由
```js
// 创建分类界面
router.get('/admin/category/create', controller.admin.category.create);
//创建分类提交数据
router.post('/admin/category/save', controller.admin.category.save);
//创建分类列表页面
router.get('/admin/category/index', controller.admin.category.index);
```
