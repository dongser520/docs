---
navbar: true
sidebar: auto
title: 响应式后台管理系统：egg.js + bootstrap
---

## 一、搭建界面引入模版html文件
### ① 控制器新建文件夹处理后台界面和路由
新建： `app/controller/admin/manager.js`
```js
'use strict';

const Controller = require('egg').Controller;

class ManagerController extends Controller {

  async create() {
      const {ctx} = this;
      await ctx.render('admin/manager/create.html');
  }
}

module.exports = ManagerController;
```

### ② 新建后台模板文件夹
新建文件夹： `app/view/admin/manager` <br/>
新建文件： `app/view/admin/manager/create.html`
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>create页面</title>
</head>
<body>
    create
</body>
</html>
```

### ③ 路由配置
> 新建： `app/router/admin.js`
> ```js
> module.exports = app => {
>     const { router, controller } = app;
>     router.get('/admin/manager/create', controller.admin.manager.create);
> }
> ```
>> `app/router/router.js`
> ```js
> module.exports = app => {
>   const { router, controller } = app;
>   //路由分组
>   //...
>   require('./router/admin')(app);
> };
> ```

访问：<http://127.0.0.1:7001/admin/manager/create> 看效果


### ④ 模版代码替换create.html页面代码，并引入静态资源
> 发现页面排版有问题，是由于css等静态资源路径不对
>
> 将静态资源 `assets`文件夹放进`app/public`文件夹下，并替换页面的引入路径即可，路径替换方式：<br/>
`"assets/` 换成 `"/public/assets/` <br/>
>> 1. 修改网页标题： `<title>后台管理-创建管理员</title>`
>> 2. 修改栏目路径名称：`创建管理员`

### ⑤ 分离模版
> 大家发现后台页面的顶部，左边菜单栏每个页面都是一样的，因此我们可以抽离出来管理，让整个后台页面更加简洁。<br/><span style="text-decoration:underline;color:green;">另外，希望通过这个案例，同学们可以自己尝试抽离一下我们开发的企业网站。</span>

那么如何分离呢，此时就可以使用egg.js项目的模版引擎中的模版继承功能了。
#### 1. 创建模版文件夹
> 新建文件夹： `app/view/admin/layout` 一般取名layout <br/>
> 新建文件： `app/view/admin/layout/main_app.html` 把所有页面的相同部分抽离放到这个网页里面来 <br/>
> 
> <a href="/secondless/w-c/响应式后台界面示例代码" target="_blank">main_app.html实例代码（一）：初步抽离公共部分</a>
> 
#### 2.使用模版引擎语法
> 如果语法提示不好，可以安装一下另外一个扩展：`Better Nunjucks` <br/>
> 
> 1. `app/view/admin/layout/main_app.html`非公共部分代码如下：
> ```js
> {% block main %}{% endblock %}
> ```
> 
> 2. 此时，在 `app/view/admin/manager/create.html`文件，就可以继承`main_app.html`公共模版的内容：
> ```html
> {# 申明继承一下主布局 #}
> {% extends "admin/layout/main_app.html" %}
> 
> {# 对某个区块进行重新编写代码 #}
> {% block main %}
> 123456
> {% endblock %}
> ```
模版引擎语法：<a href="https://nunjucks.bootcss.com/templating.html" target="_blank">模版引擎语法：https://nunjucks.bootcss.com/templating.html</a>
#### 3. 对公共模版`main_app.html`进行细化分离头部、左侧菜单栏
> 1. 分离头部 `app/view/admin/layout/_header.html`    `放入相应的头部代码`
> 2. 分离左侧菜单栏 `app/view/admin/layout/_slider.html`   `放入相应的左侧菜单栏代码`
> 3. 处理公共模版 `app/view/admin/layout/main_app.html` 文件，把头部和左侧菜单栏引入进来
>> 通过模版引擎语法可知道：`include 可引入其他的模板，可以在多模板之间共享一些小模板，如果某个模板已使用了继承那么 include 将会非常有用。`
>> ```html
>> <!-- 头部 -->
>> {% include "admin/layout/_header.html" %}
>> <!-- /头部 -->
>> 
>> <!-- 左边菜单栏 -->
>> {% include "admin/layout/_slider.html" %}
>> <!-- /左边菜单栏 -->
>> ```

#### 4. 对公共模版`main_app.html`网页title进行分离标注
> `app/view/admin/layout/main_app.html` 
> ```html
> <title>网站后台- {% block title %}{% endblock %}</title>
> ```
> `app/view/admin/manager/create.html`
> ```html
> {% block title %}
> 创建管理员
> {% endblock %}
> ```

## 二、创建管理员（页面、创建数据库表及提交数据）
### ① 创建数据库管理员表
> 1. 分析`创建管理员页面`： 管理员最起码的字段：管理员账号 + 管理员密码 + 头像（可选）+ 其他字段（如果后期后台很复杂，还可以给管理员分配权限）等等字段后期再扩展 <br/>
> 2. `设计管理员数据库表`：<a href="/web/mysql/#二-管理员表-manager" target="_blank">管理员数据库表设计</a>
>> 涉及的知识点：
>> 1. 章节2：egg.js基础-五、<a href="/secondless/w-c/Egg.js.html#五、eggjs项目中sequelize模型创建mysql数据库" target="_blank">eggjs项目中sequelize模型创建mysql数据库</a>
>>
>> 创建迁移文件 命令：
>> ```js
>> npx sequelize migration:generate --name=init-manager
>> ```
>> 创建迁移文件：
>> ```js
>> 'use strict';
>> 
>> /** @type {import('sequelize-cli').Migration} */
>> module.exports = {
>>   async up (queryInterface, Sequelize) {
>>     const { INTEGER, STRING, DATE, ENUM, TEXT, BIGINT} = Sequelize;
>>     // 创建表 --- 类似我们sql语句定义表结构
>>     await queryInterface.createTable('manager', {
>>       id: { 
>>         type: INTEGER(20).UNSIGNED, 
>>         primaryKey: true, 
>>         autoIncrement: true,
>>         comment: '主键id'
>>       },
>>       username: { 
>>         type: STRING(30), 
>>         allowNull: false, 
>>         defaultValue: '', 
>>         comment: '管理员账号',
>>       },
>>       password: { 
>>         type: STRING(255), 
>>         allowNull: false, 
>>         defaultValue: '' , 
>>         comment: '管理员密码'
>>       },
>>       avatar : { 
>>         type: STRING(1000), 
>>         allowNull: true, 
>>         defaultValue: '/public/assets/img/profiles/avatar-01.jpg', 
>>         comment: '管理员头像' 
>>       },
>>       // sex: { type: ENUM, values: ['男','女','保密'], allowNull: true, defaultValue: '保密', comment: '留言用户性别'},
>>       create_time: {type: DATE, allowNull: false, defaultValue:Sequelize.fn('NOW')},
>>       update_time: {type: DATE, allowNull: false, defaultValue:Sequelize.fn('NOW')}
>>     });
>>   },
>> 
>>   async down (queryInterface, Sequelize) {
>>     await queryInterface.dropTable('manager')
>>   }
>> };
>> ```
>> 执行迁移文件命令生成数据库表：
>> ```js
>> // 升级数据库
>> npx sequelize db:migrate
>> ```

### ② 创建管理员模型并测试提交数据进入数据库
#### 1. 创建 `app/model/manager.js`模型文件
```js
'use strict';

module.exports = app => {
    const { INTEGER, STRING, DATE, ENUM, TEXT, BIGINT } = app.Sequelize;

    const Manager = app.model.define('manager', {
        id: {
            type: INTEGER(20).UNSIGNED,
            primaryKey: true,
            autoIncrement: true,
            comment: '管理员表主键id'
        },
        username: {
            type: STRING(30),
            allowNull: false,
            defaultValue: '',
            comment: '管理员账号'
        },
        password: {
            type: STRING(255),
            allowNull: false,
            defaultValue: '',
            comment: '管理员密码'
        },
        avatar: {
            type: STRING(1000),
            allowNull: true,
            defaultValue: '/public/assets/img/profiles/avatar-01.jpg',
            comment: '管理员头像（本地、网络图片地址）'
        },
        // sex: { type: ENUM, values: ['男','女','保密'], allowNull: true, defaultValue: '保密', comment: '留言用户性别'},
        create_time: { type: DATE, allowNull: false, defaultValue: app.Sequelize.fn('NOW') },
        update_time: { type: DATE, allowNull: false, defaultValue: app.Sequelize.fn('NOW') }
    });

    return Manager;
}
```
#### 2. 创建管理员页面调整 `app/view/admin/manager/create.html`
说两点：
1. `关于界面`：页面上的组件都是bootstrap的组件，如：<a href="https://www.runoob.com/bootstrap4/bootstrap4-forms-input-group.html" target="_blank">输入框组</a>
2. `关于提交数据`：我们在`第二学期学习过ajax提交数据`，另外，我们在讲表单的时候，form表单默认就有提交功能，这里我们`采用form表单默认提交功能`简单一些
3. `提交数据需要有一个api接口处理`：
> 1. 提交数据方法 `app/controller/admin/manager.js`
> ```js
> 'use strict';
> 
> const Controller = require('egg').Controller;
> 
> class ManagerController extends Controller {
> 
>   //创建管理员---创建页面表单
>   async create() {
>     const { ctx } = this;
>     await ctx.render('admin/manager/create.html');
>   }
> 
>   //创建管理员---提交数据
>   async save() {
>     //一般处理流程
>     // let params = this.ctx.request.body; 
>     let { username, password, avatar } = this.ctx.request.body;
>     //1.参数验证
>     //先判断一下管理员账号是否存在，不存在在写入数据库
>     //2.写入数据库
>     //3.成功之后给页面反馈
>     /*
>     let manager = await this.app.model.Manager.findOne({
>       where:{
>         username: username
>       }
>     });
>     */
>     if (await this.app.model.Manager.findOne({
>       where: {
>         username: username
>       }
>     })) {
>       this.ctx.status = 400;
>       return this.ctx.body = {
>         msg: 'fail',
>         data: '该管理员账号已存在'
>       }
>     }
>     //否则不存在账号写入数据库
>     let res = await this.app.model.Manager.create({
>       username,
>       password,
>       // avatar
>     });
>     this.ctx.status = 200;
>     this.ctx.body = {
>         msg: 'ok',
>         data: res
>     }
>   }
> }
> 
> module.exports = ManagerController;
> 
> ```
> 2. 提交数据路由定义 `app/router/admin.js`
> ```js
> module.exports = app => {
>     const { router, controller } = app;
>     // 创建管理员界面
>     router.get('/admin/manager/create', controller.admin.manager.create);
>     //创建管理员提交数据
>     router.post('/admin/manager/save', controller.admin.manager.save);
> }
> ```
4. 创建管理员页面 `app/view/admin/manager/create.html`
> ```html
> {# 申明继承一下主布局 #}
> {% extends "admin/layout/main_app.html" %}
> 
> {% block title %}
> 创建管理员
> {% endblock %}
> 
> {# 对某个区块进行重新编写代码 #}
> {% block main %}
> <div class="card">
>     <div class="card-body">
>         <form action="/admin/manager/save" method="post">
>             <div class="form-group row">
>                 <label class="col-form-label col-md-2">用户名</label>
>                 <div class="col-md-10">
>                     <input type="text" class="form-control" name="username" placeholder="用户名...">
>                 </div>
>             </div>
>             <div class="form-group row">
>                 <label class="col-form-label col-md-2">密码</label>
>                 <div class="col-md-10">
>                     <input type="password" class="form-control" name="password" placeholder="密码...">
>                 </div>
>             </div>
>             
>             <div class="form-group row">
>                 <label class="col-form-label col-md-2">头像</label>
>                 <div class="col-md-10">
>                     <input class="form-control" type="file" name="avatar">
>                 </div>
>             </div>
>             
>             <div class="text-right mt-3">											
>                 <button type="submit" class="btn btn-primary">提 交</button>
>             </div>
>         </form>
>     </div>
> </div>                               
> {% endblock %}
> ```