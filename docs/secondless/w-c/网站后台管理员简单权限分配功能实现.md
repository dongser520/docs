---
navbar: true
sidebar: auto
title: 网站后台管理员简单权限分配功能实现
---

## 一、分析权限分配界面并初步实现界面
控制器 `app/controller/admin/manager.js`
```js
//创建管理员---创建页面表单
  async create() {
    ...

    let data = [
      { id: 1, pid: 0, name: '网站', icon: 'fa fa-chrome', url: '' },
      { id: 2, pid: 1, name: '主面板', icon: 'fa fa-pie-chart', url: '/admin' },
      { id: 3, pid: 1, name: '管理员', icon: 'fe fe-user-plus', url: '/admin/manager/index' },
      { id: 4, pid: 1, name: '留言板', icon: 'fe fe-document', url: '/admin/message/index' },
      { id: 5, pid: 1, name: '分类管理', icon: 'fa fa-list', url: '/admin/category/index' },
      { id: 6, pid: 1, name: '新闻内容管理', icon: 'fa fa-file-text-o', url: '/admin/news/index' },
      { id: 7, pid: 1, name: '配置管理', icon: 'fa fa-wrench', url: '/admin/config/index' },
      { id: 8, pid: 0, name: '直播', icon: 'fa fa-video-camera', url: '' },
      { id: 9, pid: 8, name: '直播用户', icon: 'fa fa-venus-mars', url: '/admin/liveuser/index' },
      { id: 10, pid: 8, name: '直播礼物管理', icon: 'fa fa-gift', url: '/admin/livegift/index' },
      { id: 11, pid: 8, name: '直播订单管理', icon: 'fa fa-credit-card', url: '/admin/liveorder/index' },
      { id: 12, pid: 8, name: '直播间管理', icon: 'fa fa-tv', url: '/admin/live-/index' },
      
    ];

    data = this.app.transformToTree(data);
    // console.log('处理之后的data', JSON.stringify(data));
    // return;

    //渲染公共模版
    await ctx.renderTemplate({
      ...
      form: {
        ...
        //  字段
        fields: [
          ...
          {
            label: '权限分配',
            type: 'treeDataSelect', //树形结构数据选择
            name: 'auth',
            default: JSON.stringify(data),
          },
        ],
      },
      ...
    });
  }
```
模版 `app/view/admin/layout/_form.html`
```js
{# 定义一个可递归调用的子模板 #}
{% macro renderMenu(items,keyname) %}
{% for item in items %}
<div class="eveitem">
    <span class="dropdown-item" style="margin-left: {{item.level * 20}}px;
    cursor: pointer;background:none;"
    onmouseover="this.style.color = '#000000';this.style.fontWeight = 800;"
    onmouseout="this.style.color = '#002222';this.style.fontWeight = 'normal';"
    @click="dropdownItemClick('{{keyname}}','{{item.name}}','{{item.id}}')">
    <input type="checkbox" name="{{keyname}}" style="margin-right: 10px;">{{item.name}}</span>
</div>
...
{# 如果是树形结构数据选择 #}
{% elif item.type == 'treeDataSelect' %}
<div class="treeDataSelect">
    {# 使用定义好的子模板递归渲染菜单 #}
    <!-- 在上面的代码块之前或之外的合适位置，提前解析item.default为JSON对象 -->
    {% set itemDefaultParsed  = item.default | safe | fromJson %}
    {% call renderMenu(itemDefaultParsed,item.name) %}
    {% endcall %}
</div>
```