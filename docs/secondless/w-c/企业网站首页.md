---
navbar: true
sidebar: auto
title: 企业网站首页
---


## 一、数据库数据准备
> 通过模版页面分析网站所需要的分类，并上传测试或者真实数据用于页面展示【具体看课程视频111课】

## 二、读取数据库数据渲染到模版页面（以合作单位为例）
1. 控制器 `app/controller/api/template01/api.js`
```js
async index() {
    const { ctx,app } = this;
    // await ctx.render('api/template01/main_app.html',{
    //    title:'网站首页',
    //    tempType: 'index',
    // });

    //合作单位
    const cooperation_unit = await ctx.model.News.findAll({
        where:{
            category_id: 10,
            status: 1,
        },
        order: [
            ['order', 'asc'],
            ['id', 'DESC'],
        ],
        limit: 4,
        // 关联查询
        include: [
            {
                model: app.model.Category,// 需要查询的模型
                attributes: ['id', 'name', 'enname'],// 查询的字段 
            }
        ],
    });
    console.log('合作单位',JSON.parse(JSON.stringify(cooperation_unit)));

    let arr = [];
    arr.push({
        type:'cooperation_unit',
        sqldata:cooperation_unit
    });

    await ctx.renderApi({
        title:'网站首页',
        tempType: 'index',
        data:arr
    },'api/template01/main_app.html');
}
```
2. 扩展 `app/extend/context.js`
```js
  //前端模版渲染
  /**
   * 
   * @param {Object} params - 用于渲染模板的数据对象。应包含模板所需的所有键值对
   * @param {string} tplname - [tplname='api/template01/main_app.html'] - 模板文件的路径。默认为内置的基础API模板路径，可不填。
   * @returns {Promise<void>} - 返回一个Promise，表示渲染操作的完成状态。无具体返回值。
   * @throws {Error} - 如果模板加载或渲染过程中发生错误，可能会抛出异常。
   */
  async renderApi(params, tplname = 'api/template01/main_app.html') {
    await this.render(tplname,params);
  },
```
3. 模版 `app/view/api/template01/_index.html`
```html
{% for item in data %}
    {% if item.type == 'cooperation_unit' and item.sqldata.length > 0 %}
        <!-- 合作单位 -->
        <div id="cooperation_unit" class="flex justify-center py-5">
            <div style="width: 1200px;">
                <!-- 栏目名称 -->
                <div>
                    <!-- 圆角 -->
                    <div class="flex justify-center">
                        <div class="div-rounded"></div>
                    </div>
                    <!-- 英文 -->
                    <div class="flex justify-center mt-2">
                        <span class="span-en">{{item.sqldata[0].category.enname}}</span>
                    </div>
                    <!-- 中文 -->
                    <div class="flex justify-center">
                        <span class="span-ch">{{item.sqldata[0].category.name}}</span>
                    </div>
                </div>
                <!-- 栏目内容 -->
                <div class="flex justify-between  mt-5">
                    {# <img src="/public/api/template01/static/image/unit/unit01.jpg" >
                    <img src="/public/api/template01/static/image/unit/unit02.jpg" >
                    <img src="/public/api/template01/static/image/unit/unit03.jpg" >
                    <img src="/public/api/template01/static/image/unit/unit04.jpg" > #}
                    {% for item1 in item.sqldata %}
                    <img src="{{item1.attachment}}" >
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
{% endfor %}
```

## 三、封装通过分类id获取数据的方法到服务中，简化读取数据操作（以资讯中心为例）
1. 控制器 `app/controller/api/template01/api.js`
```js
async index() {
    const { ctx,app } = this;
    //合作单位
    const cooperation_unit = await ctx.service.news.getNewsByCategoryId(10,4);
    console.log('合作单位',JSON.parse(JSON.stringify(cooperation_unit)));
    //资讯中心（新闻中心）
    const news_center = await ctx.service.news.getNewsByCategoryId(6,3);
    console.log('资讯中心（新闻中心）',JSON.parse(JSON.stringify(news_center)));

    let arr = [];
    arr.push({type:'news_center',sqldata:news_center});
    arr.push({type:'cooperation_unit',sqldata:cooperation_unit});

    await ctx.renderApi({
        title:'网站首页',
        tempType:'index',
        data:arr
    },'api/template01/main_app.html');
}
```
2. 新建服务 `app/service/news.js`
```js
'use strict';

const Service = require('egg').Service;

class NewsService extends Service {
    // 根据分类id获取新闻信息
    /**
     * 
     * @param {number} category_id - 分类id,必填
     * @param {number} limit - 取多少条数据，默认：4 ，可选
     * @param {object} options - 排序规则，可选
     * @returns {Promise<object>} - 返回一个Promise，返回值是数据对象
     */
    async getNewsByCategoryId(category_id,limit = 4, options = {}){
        const { ctx, app } = this;
        //如果没有传排序规则
        if (!options.order) {
            options.order = [
                ['order','asc'],
                ['id','desc']
            ]
        }
        const res = await ctx.model.News.findAll({
            where:{
                status:1,
                category_id
            },
            limit,
            ...options,
            //关联查询
            include: [
                {
                    model: app.model.Category,// 需要查询的模型
                    attributes: ['id', 'name', 'enname'],// 查询的字段 
                }
            ],
        });
        return res;
    }
}

module.exports = NewsService;

```
3. 模版 `app/view/api/template01/_index.html`
```html
...
{% if item.type == 'news_center' and item.sqldata.length > 0 %}
...
<!-- 图片 -->
<div>
    <img 
    src="{{item.sqldata[0].attachment if item.sqldata[0].attachment else '/public/api/template01/static/image/newspic01.jpg'}}"
    style="width: 560px;height: 360px;">
</div>
<!-- 列表 -->
<div class="news-list flex justify-between flex-column" style="width: 575px;height: 360px;">
    {% for item1 in item.sqldata %}
    <div class="flex">
        <!-- 日期 -->
        <div style="width: 80px;flex-shrink: 0;" class="flex justify-start flex-column">
            <strong>{{item1.create_time.split(' ')[0].substring(8)}}</strong>
            <span>{{item1.create_time.split(' ')[0].substr(0,7).replace('-','/')}}</span>
        </div>
        <!-- 内容 -->
        <div style="flex: auto;width: 0;">
            <!-- 标题 -->
            <h3 class="mt-0 lines-1">{{item1.name}}</h3>
            <!-- 描述 -->
            <p class="lines-2 text-light-muted">{{item1.description}}</p>
        </div>
    </div>    
    {% endfor %}
</div>
...
{% endif %}
...
```
