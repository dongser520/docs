---
navbar: true
sidebar: auto
title: 章节6.加号扩展菜单功能（发语音）
---

## 一、 发语音界面开发
### 1. 初步开发：发语音和文字输入功能切换
在页面 `/pages/chat/chat.nvue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		
		<!-- 聊天内容区域 -->
		...

		<!-- 底部聊天输入区域 -->
		<view ...>
			<view class="flex align-center">
				<!-- 切换发语音 -->
				<!-- 键盘图标 -->
				<chat-navbar-icon-button v-if="sendMessageMode == 'audio'"
				@click="changeAudioOrText('text')">
					<text class="iconfont font-lg">&#xe644;</text>
				</chat-navbar-icon-button>
				<!-- 语音图标 -->
				<chat-navbar-icon-button v-else
				@click="changeAudioOrText('audio')">
					<text class="iconfont font-lg">&#xe643;</text>
				</chat-navbar-icon-button>
				<view class="flex align-center font-sm
				bg-white px-2 py-1 border rounded">
				    <!-- 按住发语音 -->
					<view v-if="sendMessageMode == 'audio'"
					style="width: 440rpx;height: 60rpx;"
					class="flex align-center justify-center bg-white rounded">
						<text class="font mr-2">按住</text>
						<text class="font">说话</text>
					</view>
				    <!-- 发文字 -->
					<textarea v-else
					...>
					</textarea>
				</view>
			</view>
			<view class="flex align-center">
				...
			</view>
		</view>
	
	</view>
</template>

<script>
	export default {
		...,
		methods: {
			// 切换文字输入或者语音
			changeAudioOrText(sendMessageMode){
				this.sendMessageMode = sendMessageMode;
			},
			...,
		},
	}
</script>

```

### 2. 按住录音状态界面开发
在页面 `/pages/chat/chat.nvue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		
		<!-- 聊天内容区域 -->
		...
			
		<!-- 底部聊天输入区域 -->
		<view ...>
			<view class="flex align-center">
				<!-- 切换发语音 -->
				<!-- 键盘图标 -->
				<chat-navbar-icon-button v-if="sendMessageMode == 'audio'"
				@click="changeAudioOrText('text')">
					<text class="iconfont font-lg">&#xe644;</text>
				</chat-navbar-icon-button>
				<!-- 语音图标 -->
				<chat-navbar-icon-button v-else
				@click="changeAudioOrText('audio')">
					<text class="iconfont font-lg">&#xe643;</text>
				</chat-navbar-icon-button>
				<view class="flex align-center font-sm px-2 py-1 border rounded"
				:class="[recorderStatus?'bg-hover-light':'bg-white',]">
				    <!-- 按住发语音 -->
					<view v-if="sendMessageMode == 'audio'"
					style="width: 440rpx;height: 60rpx;"
					class="flex flex-row align-center justify-center rounded"
					@touchstart="recorderTouchstart"
					@touchend="recorderTouchend"
					@touchcancel="recorderTouchcancel"
					@touchmove="recorderTouchmove">
						<text class="font mr-2" v-if="!recorderStatus">按住</text>
						<text class="font" v-if="!recorderStatus">说话</text>
						<text class="font mr-2" v-if="recorderStatus">松开</text>
						<text class="font" v-if="recorderStatus">发送</text>
					</view>
				    <!-- 发文字 -->
					<textarea v-else
					...>
					</textarea>
				</view>
			</view>
			<view class="flex align-center">
				...
			</view>
		</view>
	
	
	     <!-- 弹出菜单 -->
		 ...
			 
		 <!-- 发语音页面提示 -->	 
		 <view v-if="recorderStatus"
		 class="position-fixed left-0 right-0 flex flex-row align-center justify-center"
		 :style="chatContentStyle">
		     <view style="width: 400rpx;height: 400rpx;
			 background-color: rgba(0, 0, 0, 0.6);"
			 class="rounded-lg"></view>
		</view>
			 
	</view>
</template>

<script>
    ...
	export default {
		...,
		data(){
			return {
				recorderStatus: false, // 录音状态, 是否正在录音
				...,
			}
		},
		methods: {
			// 手指按上去
			recorderTouchstart(){
				console.log('手指按上去');
				this.recorderStatus = true;
			},
			// 手指松开
			recorderTouchend(){
				console.log('手指松开');
				this.recorderStatus = false;
			},
			// 触摸取消，比如来电话终止
			recorderTouchcancel(){
				console.log('触摸取消');
				this.recorderStatus = false;
			},
			// 手指滑动
			recorderTouchmove(){
				console.log('手指滑动');
			},
			...
		},
	}
</script>

```

### 3. 按住录音提示用户正在录音界面
正在录音素材： `https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/recorder.gif` <br/>
在页面 `/pages/chat/chat.nvue`
```vue
    <!-- 提示用户正在录音的界面 -->
	<view v-if="recorderStatus"
	class="position-fixed left-0 right-0 flex flex-row align-center justify-center"
	:style="chatContentStyle">
		<view style="width: 400rpx;height: 400rpx;background-color: rgba(0, 0, 0, 0.6);"
		class="rounded-lg flex flex-column align-center justify-center">
		<image src="https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/recorder.gif" style="width: 300rpx;height: 300rpx;"></image>
		<text class="font-sm text-white mt-1">正在录音 手指上划 取消发送</text>
		</view>
	</view>
```

### 4. 上移手指取消录音发送
在页面 `/pages/chat/chat.nvue`
```vue
<!-- 提示用户正在录音的界面 -->
<view v-if="recorderStatus"
class="position-fixed left-0 right-0 flex flex-row align-center justify-center"
:style="chatContentStyle">
	<view style="width: 400rpx;height: 400rpx;background-color: rgba(0, 0, 0, 0.6);"
	class="rounded-lg flex flex-column align-center justify-center">
	<image :src="recorderIcon" style="width: 300rpx;height: 300rpx;"></image>
	<text class="font-sm text-white mt-1">{{isRecorderCancel?'松开手指 取消发送':'正在录音 手指上划 取消发送'}}</text>
	</view>
</view>
...
<script>
    ...
	export default {
		...,
		data(){
			return {
				isRecorderCancel:false, // 是否取消录音
				recorderTouchstartY:0, // 录音开始手指纵坐标
				recorderIcon:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/recorder.gif',
				...,
			}
		},
		methods: {
			// 手指按上去
			recorderTouchstart(e){
				this.recorderStatus = true;
				// console.log('手指按上去',e.changedTouches[0].clientY);
				// #ifdef MP || H5
				this.recorderTouchstartY = e.changedTouches[0].clientY;
				// #endif
				// #ifdef APP
				this.recorderTouchstartY = e.changedTouches[0].screenY;
				// #endif
			},
			// 手指松开了
			recorderTouchend(){
				console.log('手指松开了');
				this.recorderStatus = false;
			},
			// 触摸取消 来点打断了 手机没电了
			recorderTouchcancel(){
				console.log('触摸取消');
				this.recorderStatus = false;
			},
			// 手指移动
			recorderTouchmove(e){
				console.log('手指移动');
				let y = 0;
				// #ifdef MP || H5
				y = e.changedTouches[0].clientY;
				// #endif
				// #ifdef APP
				y = e.changedTouches[0].screenY;
				// #endif
				// 判断手指上移 移出了录音按钮的区域
				let move = Math.abs(y - this.recorderTouchstartY);
				// console.log('移动的距离',move);
				this.isRecorderCancel = move > 55 ? true : false; 
			},
			...
		},
	}
</script>
```

### 5. 发语音功能实现
1. uni-app中的api接口：<https://uniapp.dcloud.net.cn/api/#媒体>
2. 录音接口: <https://uniapp.dcloud.net.cn/api/media/record-manager.html>
在页面 `/pages/chat/chat.nvue`
```vue
<template>
	<view>
		<!-- 提示用户正在录音的界面 -->
		 <view v-if="recorderStatus"
		 class="position-fixed left-0 right-0 flex flex-row align-center justify-center"
		 :style="chatContentStyle">
			 <view style="width: 400rpx;height: 400rpx;background-color: rgba(0, 0, 0, 0.6);"
			 class="rounded-lg flex flex-column align-center justify-center">
			     <image :src="recorderIcon" style="width: 300rpx;height: 300rpx;"></image>
				 <text class="font-sm text-white mt-1">{{isRecorderCancel ? 
				 '松开手指 取消发送' : '已录 ' + recorderDuration + ' 秒 手指上划 取消发送'}}</text>
			 </view>
		 </view>
	</view>
</template>

<script>
	// 获取全局唯一的录音管理器 recorderManager
	const recorderManager = uni.getRecorderManager();
    ...
	export default {
		mixins:[toolJs],
		data() {
			return {
				recorderDurationTimer:null, // 定时器
				recorderDuration:0, // 针对app没有录音时长的处理
				...
			}
		},
		mounted() {
			...
			
			//监听录音结束  拿到音频内容
			recorderManager.onStop(res=>{
				if(this.recorderDurationTimer){
					clearInterval(this.recorderDurationTimer);
					this.recorderDurationTimer = null;
				}
				console.log('拿到音频内容',res);
				if(!this.isRecorderCancel){
					res.duration = this.recorderDuration * 1000;
					this.sendMessage('audio',res);
				}
			});
			// 监听录音开始
			recorderManager.onStart(()=>{
				this.recorderDuration = 0;
				this.recorderDurationTimer = setInterval(()=>{
					this.recorderDuration ++;
				},1000);
			});
		},
		methods: {
			// 手指按上去
			async recorderTouchstart(e){
				// 查看录音权限情况
				try{
				   const permission = new UniPermission();
				   const granted =  await permission.requestPermission('microphone',
				   '需要您打开麦克风来录制语音','本功能需要您打开麦克风');
				   if(granted){
					   console.log('用户已授权开启麦克风，可以录音了');
					   this.recorderStatus = true;
					   // console.log('手指按上去',e.changedTouches[0].clientY);
					   // #ifdef MP || H5
					   this.recorderTouchstartY = e.changedTouches[0].clientY;
					   // #endif
					   // #ifdef APP
					   this.recorderTouchstartY = e.changedTouches[0].screenY;
					   // #endif
					   
					   // 可能正在录音来电话了被打断，此时的isRecorderCancel是true
					   this.isRecorderCancel = false; 
					   // 开始录音处理
					   recorderManager.start({
						   duration:60000, // 毫秒
						   format:'mp3',
						   hideTips:true,
					   });
					   
				   }else{
					   uni.showToast({
						  title: '您没有授权打开麦克风，无法录制语音',
						  icon:'none',
						  duration:3000
					   });
				   }
				}catch(error){
					console.error('权限申请异常：' + error);
					uni.showToast({
						title:'权限申请失败：' + error.message,
						icon:'none',
						duration:3000
					});
				}
			},
			// 手指松开了
			recorderTouchend(){
				console.log('手指松开了');
				this.recorderStatus = false;
				
				//停止录音
				recorderManager.stop();
			},
			// 触摸取消 来点打断了 手机没电了
			recorderTouchcancel(){
				console.log('触摸取消');
				this.recorderStatus = false;
				this.isRecorderCancel = true;
				//停止录音
				recorderManager.stop();
			},
			// 手指移动
			recorderTouchmove(e){
				console.log('手指移动');
				let y = 0;
				// #ifdef MP || H5
				y = e.changedTouches[0].clientY;
				// #endif
				// #ifdef APP
				y = e.changedTouches[0].screenY;
				// #endif
				// 判断手指上移 移出了录音按钮的区域
				let move = Math.abs(y - this.recorderTouchstartY);
				// console.log('移动的距离',move);
				this.isRecorderCancel = move > 55 ? true : false; 
			},
			...,
			//发送消息
			sendMessage(msgType, option = {}){
				...
				switch (msgType){
					...
					case 'audio':
					    console.log('audio的数据',option);
						msg.data = option.tempFilePath;
						msg.otherData = {
							duration:Math.round(option.duration / 1000),
						};
				}
				...
				// 清空发送的内容然后还要滚动到底部
				...
			},
			
		},
	}
</script>

```

### 6. 优化发语音功能
重点就要理解：`获取全局唯一的录音管理器 recorderManager` 进行处理 <br/>
很显然：
1. 定义全局唯一的录音管理器： 放在了当前`/pages/chat/chat.nvue`页面，如果其他页面也需要录音功能，那么这个定义就不唯一，更不是全局唯一
2. 在页面上，我们在`mounted`生命周期函数中，对录音管理器 recorderManager进行监听，我们应该执行全局监听事件

#### 1. 在页面 `/pages/chat/chat.nvue`中
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		
		<!-- 聊天内容区域 -->
		...
	
		<!-- 底部聊天输入区域 -->
		...
	
	    <!-- 弹出菜单 -->
		... 
		 
		<!-- 提示用户正在录音的界面 -->
		<view v-if="recorderStatus"
		 class="position-fixed left-0 right-0 flex flex-row align-center justify-center"
		 :style="chatContentStyle">
			<view style="width: 400rpx;height: 400rpx;background-color: rgba(0, 0, 0, 0.6);"
			 class="rounded-lg flex flex-column align-center justify-center">
			     <image :src="recorderIcon" style="width: 300rpx;height: 300rpx;"></image>
				 <text class="font-sm text-white mt-1">{{isRecorderCancel ? 
				 '松开手指 取消发送' : '已录 ' + recorderDuration + ' 秒 手指上划 取消发送'}}</text>
			</view>
		</view>
		 
	</view>
</template>

<script>
	//获取全局唯一的录音管理器 recorderManager
	//const recorderManager = uni.getRecorderManager();
    ...
	import {mapState,mapGetters,mapMutations,mapActions} from 'vuex';
	export default {
		mixins:[toolJs],
		data() {
			return {
				...
			}
		},
		mounted() {
			...
			
			// 全局注册一个发送语音的事件，然后进行全局处理
			this.regSendMessage(res=>{
				if(!this.isRecorderCancel){
					res.duration = this.recorderDuration * 1000;
					this.sendMessage('audio',res);
				}
			});
			
		},
		computed:{
			...mapState({
				recorderManager:state=>state.Audio.recorderManager,
				recorderDuration:state=>state.Audio.recorderDuration,
			}),
			...
		},
		methods: {
			...mapMutations(['regSendMessage']),
			// 手指按上去
			async recorderTouchstart(e){
				// 查看一下录音权限情况
				try{
				   ...
				   if(granted){
					   ...
					   // 开始录音
					   this.recorderManager.start({
						   duration:60000, // 毫秒
						   format:'mp3',
					   });
					   
				   }else{
					   ...
				   }
				}catch(error){
					...
				}
			},
			// 手指松开了
			recorderTouchend(){
				...
				//停止录音
				this.recorderManager.stop();
			},
			// 触摸取消 来点打断了 手机没电了
			recorderTouchcancel(){
				...
				//停止录音
				this.recorderManager.stop();
			},
			// 手指移动
			recorderTouchmove(e){
				...
			},
			...
		},
	}
</script>

```
#### 2. 项目初始化执行 `App.vue`
```vue
...
<script>
	export default {
		onLaunch: function() {
			console.log('App Launch')
			...
			// #ifdef APP-PLUS || MP
			// 初始化录音管理器
			this.$store.commit('initRecorderManager');
			// #endif
		},
		onShow: function() {
			...
		},
		onHide: function() {
			...
		}
	}
</script>
```

#### 3. 来到音频模块 `/store/modules/audio.js`
```js
export default{
	// 对应的mapState,在computed中引用导入
	// 类似于data,把全局或者公共部分放在这里
	state:{
		...
		// 全局唯一的录音管理器 recorderManager
		recorderManager:null,
		recorderDurationTimer:null, //定时器
		recorderDuration:0, // 针对app没有录音时长的处理
		sendMessage:null, // 发语音函数
	},
	// 同步的方法，在methods引入
	mutations:{
		// 初始化全局唯一的录音管理器 recorderManager
		initRecorderManager(state){
			console.log('初始化全局唯一的录音管理器');
			state.recorderManager = uni.getRecorderManager();
			// 监听录音结束 获取录音，
			state.recorderManager.onStop(res=>{
				if(state.recorderDurationTimer){
					clearInterval(state.recorderDurationTimer);
					state.recorderDurationTimer = null;
				}
				console.log('录音地址',res);
				// if(!this.isRecorderCancel){
				// 	res.duration = this.recorderDuration * 1000;
				// 	this.sendMessage('audio',res);
				// }
				if(typeof state.sendMessage == 'function'){
					state.sendMessage(res);
				}
				
			});
			
			// 监听录音开始
			state.recorderManager.onStart(()=>{
				state.recorderDuration = 0;
				state.recorderDurationTimer = setInterval(()=>{
					state.recorderDuration ++;
				},1000);
			});
		},
		// 注册一个发送音频事件
		regSendMessage(state,eventName){
			state.sendMessage = eventName;
		},
		...
	},
	// 异步的方法，在methods引入
	actions:{
		...
	}
}
```