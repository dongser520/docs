---
navbar: true
sidebar: auto
title: 章节7.用户（好友）相关功能处理
---

## 七、搜索用户
### 1. 搜索用户接口文档
搜索用户接口文档具体查看：<a href="/fourthless/w-a/eggjs.即时通讯接口.html#四、搜索用户" target="_blank" >四、搜索用户</a>
### 2. 搜索用户界面开发
#### ① 新建搜索用户页面 `/pages/search/search.vue` 
在 `pages.json`配置页面
```js
{
    "path" : "pages/search/search",
    "style" : 
    {
        "navigationBarTitleText" : "搜索",
        "navigationStyle": "custom"
    }
}
```
#### ② 在页面 `/pages/wode/wode.nvue` 跳转
```vue
<template>
	<view>
		<!-- 头像昵称 -->
		...
	    <!-- 间隔槽 -->
		...
		<!-- cell 单元格 -->
		<u-cell-group>
			<u-cell v-for="(item,index) in uCellMenus" :key="index"
			:icon="item.icon" :title="item.title"
			:border="false" clickable isLink
			:customStyle="customStyles"
			:iconStyle="iconStyles"
			:titleStyle="titleStyles"
			@click="openCell(item,index)"></u-cell>
		</u-cell-group>
		<!-- 间隔槽 -->
		...
	</view>
</template>

<script>
	...
	export default {
		data() {
			return {
				...
				uCellMenus:[
					{icon:'plus-people-fill',title:'添加朋友',url:'/pages/search/search'},
					{icon:'chat',title:'发起群聊',url:''},
					{icon:'scan',title:'扫一扫',url:''},
				],
			}
		},
		...
		methods: {
			// 点击栏目
			openCell(item,index){
				if(!item.url) return;
				if(!this.user || this.user.role == 'visitor'){
					return uni.navigateTo({
						url: '/pages/loginCenter/loginCenter',
					});
				}
				uni.navigateTo({
					url: item.url,
				});
			},
			...
		}
	}
</script>
```

#### ③ 在页面 `/pages/search/search.vue`
```vue
<template>
	<view class="page">
		<!-- 导航栏 -->
		<!-- #ifdef MP -->
		<chat-navbar  :fixed="true" :showPlus="false" :showUser="false" :showBack="true"
			navbarClass="navbar-bgColor" :h5WeiXinNeedNavbar="false">
		</chat-navbar>
		<!-- #endif -->
		<!-- 搜索框 -->
		<view class="flex align-center p-3">
			<u--input placeholder="搜 索" prefixIcon="search"
			prefixIconStyle="font-size:22px;color:#909399;"
			confirmType="search" v-model="keyword" clearable
			:maxlength="50" showWordLimit focus
			:adjustPosition="false"
			:customStyle="inputStyle"
			@input="searchData"></u--input>
			<text class="font text-primary ml-2" @click="navigateBack">取消</text>
		</view>
		<!-- 搜索结果 -->
		<view v-if="keyword">
			<view v-if="searchResStatus">
				<!-- 搜索用户的结果 -->
				<view v-if="searchRes.length"
				class="flex flex-column justify-center">
				    <u-list @scrolltolower="scrolltolower">
					  <u-list-item v-for="(item, index) in searchRes" :key="index">
						<u-cell :title="item.nickname || item.username">
						  <u-avatar
							slot="icon"
							shape="square"
							size="35"
							:src="item.avatar"
							customStyle="margin: -3px 5px -3px 0"
						  ></u-avatar>
						</u-cell>
					  </u-list-item>
					</u-list>
				</view>
				<view v-else>
					<u-empty mode="search"></u-empty>
				</view>
			</view>
			<view v-else class="flex align-center justify-center mt-3">
				<text class="font text-muted">正在搜索中...</text>
			</view>
		</view>
	</view>
</template>

<script>
	import toolJs from '@/common/mixins/tool.js';
	import {requestUrl} from '@/common/mixins/configData.js';
	import {mapState,mapGetters,mapMutations,mapActions} from 'vuex';
	export default {
		mixins:[toolJs],
		data() {
			return {
				inputStyle:{
					"background-color":"#ffffff",
				},
				chatuser_token: '',
				keyword:'',
				searchResStatus:false, // 搜索结果状态
				searchRes:[],
			}
		},
		computed:{
			...mapState({
				user : state => state.Chatuser.regloginUser,
			}),
		},
		onLoad() {
			this.chatuser_token = uni.getStorageSync('chatuser_token');
			if (!this.chatuser_token || this.user.role == 'visitor') {
				return uni.switchTab({
					url: '/pages/wode/wode'
				});
			}
		},
		methods: {
			searchData(e){
				// console.log('搜索内容',e);
				// console.log('搜索内容',this.keyword);
				this.searchResStatus = false;
				if(this.keyword.length >= 1) this.searchAjax();
			},
			searchAjax(){
				uni.$u.http.post(requestUrl.http + `/api/chat/searchUser`, {
					keyword:this.keyword,
				}, {
					header: {
						token: this.chatuser_token,
					},
				}).then(res => {
					console.log('服务器返回的结果', res);
					this.searchResStatus = true;
					this.searchRes = [];
					if(res.data.data.length){
						this.searchRes = res.data.data;
					}
					
				}).catch(err => {
					console.log('出错', err);
					if (err.data && err.data.data) {
						uni.showToast({
							title: err.data.data,
							icon: 'none',
							duration: 5000
						});
					}
				});
			},
			//加载跟多
			scrolltolower(){
				console.log('滚动条滚动到底部了加载更多搜索内容');
			},
		}
	}
</script>

<style>
    /* 导航栏背景色 */
	.navbar-bgColor {
		background-color: #ededed;
	}
</style>

```

## 八、查看用户信息
### 1. 搜索用户接口文档
搜索用户接口文档具体查看：<a href="/fourthless/w-a/eggjs.即时通讯websocket处理.html#_2-查看用户资料" target="_blank" >② 查看用户资料</a>
### 2. 搜索用户界面开发
#### ① 新建用户信息页面 `/pages/userinfo/userinfo.vue` 
在 `pages.json`配置页面
```js
{
	"path" : "pages/userinfo/userinfo",
	"style" : 
	{
		"navigationBarTitleText" : "用户信息展示",
		"navigationStyle": "custom"
	}
}
```
#### ② 在页面 `/pages/search/search.vue` 跳转
```vue
<template>
	<view class="page">
		...
		<!-- 搜索结果 -->
		<view v-if="keyword">
			<view v-if="searchResStatus">
				<!-- 搜索用户的结果 -->
				<view ...>
				    <u-list ...>
					  <u-list-item ...>
						<u-cell :title="item.nickname || item.username"
						@click="openUserInfo(item, index)">
						  ...
						</u-cell>
					  </u-list-item>
					</u-list>
				</view>
				<view v-else>
					<u-empty mode="search"></u-empty>
				</view>
			</view>
			<view ...>
				...
			</view>
		</view>
	</view>
</template>

<script>
	...
	export default {
		...
		methods: {
			openUserInfo(item, index){
				console.log('查看用户信息',item);
				uni.navigateTo({
					url: '/pages/userinfo/userinfo?uuid=' + encodeURIComponent(item.uuid),
				});
			},
			...
		}
	}
</script>

```
#### ③ 在页面 `/pages/userinfo/userinfo.vue`
```vue
<template>
	<view class="page">
		<!-- 导航栏 -->
		<chat-navbar  :fixed="true" :showPlus="false" :showUser="false" :showBack="true"
			navbarClass="navbar-bgColor" :h5WeiXinNeedNavbar="false">
		</chat-navbar>
		<!-- 介绍 -->
		<view class="p-3 flex align-center justify-between">
			<!-- 头像 -->
			<view class="ml-1 mr-3">
				<u--image mode="widthFix"
				:src="avatarShow"        
				width="120rpx" height="120rpx" radius="20rpx"></u--image>
			</view>
			<!-- 昵称 -->
			<view class="flex flex-1 flex-column justify-center">
				<text class="font-lg font-weight-bold">{{nicknameShow}}</text>
				<view class="flex justify-between mt-2">
					<text class="font text-light-muted">{{nicknameNextShow}}</text>
					<!-- <text class="font-lg text-light-muted iconfont">&#xe657;</text> -->
				</view>
			</view>
		</view>
		<!-- 处理 -->
		<view class="p-3 flex align-center">
			<u-button :text="btn.text" :type="btn.type" @click="sendMessageFun"
			:loading="btn.loading" :loadingText="btn.loadingText"
			:loadingMode="btn.loadingMode" :disabled="btn.disabled"></u-button>
		</view>
	</view>
</template>

<script>
	import toolJs from '@/common/mixins/tool.js';
	import {requestUrl} from '@/common/mixins/configData.js';
	import {mapState,mapGetters,mapMutations,mapActions} from 'vuex';
	export default {
		mixins:[toolJs],
		data() {
			return {
				uuid:'',
				user:null,
				// 按钮
				btn:{
					text:'发消息',
					type:'primary',
					loading:false,
					loadingText:'正在处理中',
					loadingMode:'circle', // spinner 雪花
					clicktype:'init', // 初始化
					disabled:false,
				},
			}
		},
		onLoad(e) {
			if(!e.uuid) return this.navigateBack();
			this.uuid = e.uuid;
			this.getUserInfo();
		},
		computed:{
			...mapState({
				me : state => state.Chatuser.regloginUser,
			}),
			//头像
			avatarShow(){
				let avatar = this.user && this.user.avatar;
				avatar = avatar && avatar.startsWith('http') ? avatar : `${requestUrl.http}${avatar}`;
				console.log(avatar);
				return avatar;
			},
			// 账号
			nicknameShow(){
				return this.user && (this.user.nickname || this.user.username);
			},
			// 账号下面的小字
			nicknameNextShow(){
				return this.user && (this.user.userinfo.location || ``);
			}
		},
		methods: {
			// 获取用户信息
			getUserInfo(){
				uni.$u.http.get(requestUrl.http + `/api/userinfo/${this.uuid}`).then(res => {
					console.log('服务器返回的结果', res);
					this.user = res.data.data;
				}).catch(err => {
					console.log('出错', err);
					if (err.data && err.data.data) {
						uni.showToast({
							title: err.data.data,
							icon: 'none',
							duration: 5000
						});
					}
				});
			},
			// 发消息
			sendMessageFun(){
				console.log('发消息逻辑处理',this.me);
				const role = this.me.role; // 'visitor'|'user'
				const { sendCount, needFollow } = this.user.chatset[role];
				// 1. 检查是否需要关注
				// if (needFollow && !this.me.hasFollowed) {
				// 	  console.log('请先关注对方才能发消息');
				// 	  return; // 终止后续逻辑
				// }
				// 2. 根据发送权限处理
				switch (sendCount) {
					case 0:
						if(role == 'visitor'){
							console.log('游客无法发送消息，请登录');
							this.btn.clicktype = 'needLogin';
						}else if(role == 'user'){
							console.log('请先添加对方为好友才能发消息');
							this.btn.clicktype = 'applyFriend';
						}
						break;
					case 1:
						console.log('可以发一条消息');
						this.btn.clicktype = 'sendOne';
						break;
						
					default: // sendCount >= 2
						console.log('发消息不受限制');
						// 实际发送操作...
				}
				// 3. 根据点击类型处理不同逻辑
				if(this.btn.clicktype == 'applyFriend'){
					this.btn.text = '对方设置为：需加为好友才能发消息';
					uni.showModal({
						content: '申请加对方为好友？',
						success:(res)=> {
							if (res.confirm) {
								console.log('处理申请的逻辑');
								this.btn.loading = true;
								this.btn.loadingText = '申请提交中';
								//和服务器提交申请数据
								setTimeout(()=>{
									this.btn.loading = false;
									this.btn.text = '申请提交成功，等待对方同意';
									this.btn.disabled = true;
									this.btn.type = 'success';
								},3000);
							} 
						}
					});
				}else if(this.btn.clicktype == 'needLogin'){
					this.btn.text = '请先登录才能发消息';
					uni.showModal({
						content: '是否去登录？',
						success: function (res) {
							if (res.confirm) {
								console.log('去登录页');
							} 
						}
					});
				}else if(this.btn.clicktype == 'sendOne'){
					this.btn.text = '发消息';
					console.log('跳转到聊天页');
				}
			},
		}
	}
</script>

<style>
    /* 导航栏背景色 */
	.navbar-bgColor {
		background-color: #ededed;
	}
</style>

```
