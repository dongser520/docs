---
navbar: true
sidebar: auto
title: 章节12.问题修复及使用场景举例
---


## 一、和我聊天设置（聊天条数限制）

### 1. 入口设置
除了可以在设置进入外，后端也把设置入口推送给了游客和登录用户，在首页就可以看到。

### 2. 功能实现
### ① 在聊天页点击用户头像进入
在组件 `/components/chat-item/chat-item.vue`
```js
<!-- 聊天内容 -->
<view ...>
    <!-- 好友 -->
    <!-- 头像 -->
    <u--image v-if="!isMe"
    :src="item.avatar" 
    mode="widthFix"
    width="80rpx" height="80rpx" radius="10rpx"
    @click="clickAvatar('notme')"></u--image>
    <!-- 气泡 -->
    <!-- 三角形 -->
    ...
    
    <!-- 聊天内容主体 -->
    ...
    
    <!-- 我 -->
    <text v-if="isMe && needQipaoClass"
    class="iconfont font-md chat-right-icon">&#xe640;</text>
    <u--image v-if="isMe"
    :src="item.avatar" 
    mode="widthFix"
    width="80rpx" height="80rpx" radius="10rpx"
    @click="clickAvatar('me')"></u--image>
</view>
...
methods:{
    //点击头像
    clickAvatar(who){
        if(who == 'me'){
            uni.switchTab({
                url:'/pages/wode/wode'
            });
        }else{
            uni.redirectTo({
                url:`/pages/userinfo/userinfo?uuid=${this.item.sendUUid}`,
            });
        }
    },
    ...
},    
```

### ② 新建混入文件 `/pages/userinfo/sendMessage.js`
```js
export default{
	methods:{
		//发消息
		sendMessageFun(){
			console.log('发消息的逻辑',this.me);
			if(this.me.ismygoodfriend){
				...
			}else{
				const role = this.me.role; //'visitor' | 'user'
				let userset = this.user.userset;
				console.log('看一下userset',userset);
				if(!userset){
					// 用户没有进行聊天的设置
					userset = new Object();
					userset.chatset = {
						visitor: {
							sendCount:1,
							needFollow:false,
						},
						user:{
							sendCount:1,
							needFollow:false,
						} 
					}
				}else{
					userset = JSON.parse(userset);
				}
				console.log('看一下userset',userset);
				const { sendCount, needFollow } = userset.chatset[role];
				// 1. 检查是否需要关注
				// if(needFollow && this.me.hasFollowed){
				// 	console.log('请先关注对方才能发消息');
				// 	return; // 程序结束
				// }
				// 2. 根据对方设置的聊天权限处理
				switch(sendCount){
					case 0:
					  ...
					  break;
					case 1:
					  console.log('可以发一条消息');
					  this.btn.clicktype = 'sendOne';
					  this.btn.text = '发消息';
					  console.log('去聊天页',this.user);
					  // uni.navigateTo({
					  // 	url: '/pages/chat/chat',
					  // });
					  this.groupOrSingleChatRedirect('single', {
						  id: this.user.id,
						  name: this.user.nickname || this.user.username,
						  avatar: this.user.avatar,
						  chatType: 'single',
					  });
					  break;
					default:
					  console.log('发消息不受限制');
					  this.groupOrSingleChatRedirect('single', {
						  id: this.user.id,
						  name: this.user.nickname || this.user.username,
						  avatar: this.user.avatar,
						  chatType: 'single',
					  });
					  break;
				}
							
			}
		},
		// 进群|单聊聊天跳转
		groupOrSingleChatRedirect(chatType = 'single', item = {}){
			// 进入聊天页 传一下用户的信息过去在页面展示
			const userchat = {
				id: item.id || this.chatpageset.id,
				name: item.name || this.chatpageset.name,
				avatar: item.avatar || this.chatpageset.avatar,
				chatType: item.chatType || chatType, // 单聊 single 群聊 group
			};
			uni.navigateTo({
				url: `/pages/chat/chat?arg=${encodeURIComponent(JSON.stringify(userchat))}`,
			});
		},
	},
}
```

### ③ 聊天设置页判断是否显示删除好友按钮
在页面 `/pages/setpageInfo/setpageInfo.vue`
```js
<!-- 聊天页设置 -->
<view v-if="setdata.action == 'chatpageset'">
    <view v-if="chatpageset.id && chatpageset.chatType">
        <!-- 头像部分 -->
        <view class="flex flex-wrap p-3">
            <!-- 单聊 -->
            ...
            <!-- 群聊 循环头像昵称 -->
            ...
            <!-- 加入群聊 -->
            <view v-if="!(me && me.role == 'visitor')"
            class="border flex align-center justify-center"
            style="width: 36px;height: 36px;border-style: dashed;"
            @click="clickCell('选择好友', 'addUserToGroup')">
                <u-icon name="plus" size="24" color="#999999"></u-icon>
            </view>
            <!-- 删除群聊用户 -->
            ...
        </view>
        <u-gap height="10" bgColor="#EDEDED"></u-gap>
        <!-- 群相关设置 -->
        ...
        <!-- 查找聊天内容 -->
        ...
        <!-- 消息设置 -->
        ...
        <!-- 解散群或退群或者删除好友 -->
        <view v-if="isShowDeleteOrQuit">
            <view class="p-3">
                <u-button type="primary" plain :text="deleteOrQuitGroup"
                @click="deleteOrQuitGroupfn"></u-button>
            </view>
            <u-gap height="10" bgColor="#EDEDED"></u-gap>
        </view>
    </view>
</view>
...
data() {
    return {
        ...
        chatpageset:{
            ...
            ismygoodfriend: false, // 是否是我的好友
        },
    }
},
onLoad(e) {
    ...
    // 动态生成数据
    if(e.action){
        this.setdata.action = e.action;
        if(this.setdata.action == 'chatset'){
            ...
        }else if(this.setdata.action == 'chatpageset'){
            ...
            // 群聊设置
            ...
            // 是否是我的好友
            if(this.chatpageset.chatType == 'single'){
                this.ismygoodfriend();
            }
        }else if(this.setdata.action == 'groupQrcode'){
            ...
        }else if(this.setdata.action == 'autoAddGroup'){
            ...
        }else if(this.setdata.action == 'userinfoSet'){
            ...
        }else if(this.setdata.action == 'avatarCut'){
            ...
        }else if(this.setdata.action == 'deleteUserFromGroup'){
            ...
        }else if(this.setdata.action == 'addUserFromGroup'){
            ...
        }else if(this.setdata.action == 'applyAddGroup'){
            ...
            
        }else if(this.setdata.action == 'applyAddMeFriendSet'){
            ...
        }
    }
},
computed:{
    ...,
    // 是否显示删除该好友按钮
    isShowDeleteOrQuit(){
        let show = true;
        if(this.chatpageset.chatType == 'single'){
            if(!this.chatpageset.ismygoodfriend){
                show = false;
            }
        }
        return show;
    },
},
methods: {
    // 查询某个用户是否我的好友
    ismygoodfriend(){
        // 我的信息
        // console.log('此时的this.me',this.me);return;
        uni.$u.http.post(requestUrl.http + `/api/chat/ismygoodfriend/${this.chatpageset.id}`,{},{
            header:{
                token: this.me.token,
            }
        }).then(res => {
                console.log('是不是我的好友',res.data.data);
                if(res.data.msg == 'ok'){
                    this.chatpageset.ismygoodfriend = res.data.data;
                }
        }).catch(err => {
            console.log('不是好友');
            this.chatpageset.ismygoodfriend = false;
        });
    },
    ...
},
```





















































