---
navbar: true
sidebar: auto
title: 章节6.加号扩展菜单功能
---

## 一、发图片功能
`从本地相册选择图片或使用相机拍照`，具体查看官网：<https://uniapp.dcloud.net.cn/api/media/image.html#chooseimage> <br/>
很明显发图片需要打开相册，因此需要授权相册权限。


### 1. 关于获取权限的重要说明
> 1. 我们开发的H5端、小程序、app包括（安卓、ios、鸿蒙）最后都是要上线到各个应用市场，而能够上线通过审核最关键的一点就是你的权限是否合法合规，各个应用市场对权限的申请原则都是：**最小权限原则**，**需要用到时候才申请**，也就是说`你申请的权限必须是你app实际需要的权限，不要在程序一开始都要求用户授权，需要明确告知权限的用途，不能多申请，否则审核不通过。` <br/>


### 2. 封装一个权限类用来处理权限的申请、设置、检查、提示
封装一个权限类 ：`/common/mixins/uni_permission.js` 
内容过多，在新页面打开，具体查看：<a href="/thirdless/w-b/06uni_permission类" target="_blank">`uni_permission.js`权限申请类（支持多端）</a>

### 3. 在页面调用并申请权限
#### ① 安卓端app需要在 `App.vue` 中添加以下代码
```vue
...
<script>
	export default {
		onLaunch: function() {
			console.log('App Launch')
			...
			// 监听应用状态变化
			// #ifdef APP-PLUS
			let appHideTime = 0;
			
			plus.globalEvent.addEventListener('pause', () => {
				console.log('应用进入后台');
				appHideTime = Date.now();
				uni.$emit('app_hide');
			});
			
			plus.globalEvent.addEventListener('resume', () => {
				console.log('应用回到前台');
				const hideDuration = Date.now() - appHideTime;
				console.log(`应用在后台停留时间: ${hideDuration}ms`);
				uni.$emit('app_show', { hideDuration });
			});
			// #endif
		},
		onShow: function() {
			console.log('App Show')
		},
		onHide: function() {
			console.log('App Hide')
		}
	}
</script>
```

#### ② 页面调用和发送图片
`/pages/chat/chat.nvue` 调用代码
```vue
<template>
	<view>
		...
	</view>
</template>

<script>
	import UniPermission from '@/common/mixins/uni_permission.js';
	import toolJs from '@/common/mixins/tool.js';
	export default {
		mixins:[toolJs],
		...,
		methods: {
			...,
			// 点击菜单项处理
			async swiperItemClick(item, itemIndex) {
				console.log('点击菜单项处理',item);
				if (!item) return; // 防止undefined错误
				if (this.sendMessageMode === 'icon') {
					...
				} else {
					...
					switch (item.eventType){
						case 'photo': // 照片功能
							await this.handlePhoto();
							break;
						case 'map':   // 位置功能
							await this.handleLocation();
							break;
						case 'camera': // 拍摄功能
							await this.handleCamera();
							break;
						case 'mingpian':
							break;
						case 'video':
							break;
					}
				}
			},
			// 处理相册照片
			async handlePhoto() {
			  try {
			    const permission = new UniPermission();
			    const granted = await permission.requestPermission(
			      'photo', 
			      '需要访问您的相册来选择照片',
			      '本功能需要您打开相册'
			    );
			    
			    if (granted) {
				  console.log('相册权限已授予，开始选择图片');
				  this.chooseImage();
			      // setTimeout(() => {this.chooseImage();}, 300);
			    } else {
			      uni.showToast({ title: '无相册权限', icon: 'none',duration: 2000});
			    }
			  } catch (error) {
			    console.error('权限申请异常:', error);
			    uni.showToast({ 
			      title: '权限申请失败: ' + error.message, 
			      icon: 'none',
			      duration: 3000
			    });
			  }
			},
			// 选择图片
			chooseImage() {
			  uni.chooseImage({
			    count: 1,
			    sizeType: ['compressed'],
			    sourceType: ['album'],
			    success: (res) => {
			      if (res.tempFilePaths && res.tempFilePaths.length > 0) {
			        this.sendMessage('image', { path: res.tempFilePaths[0] });
			      }
			    },
			    fail: (err) => {
			      console.error('选择图片失败:', err);
			      
			      let errorMsg = '选择图片失败';
			      if (err.errMsg.includes('permission')) {
			        errorMsg = '相册访问权限不足';
			      } else if (err.errMsg.includes('cancel')) {
			        return; // 用户取消不提示
			      }
			      
			      uni.showToast({ 
			        title: errorMsg, 
			        icon: 'none',
			        duration: 2000
			      });
			    }
			  });
			},
			// 处理位置权限
			async handleLocation() {
			  try {
				const permission = new UniPermission();
				const granted = await permission.requestPermission(
				  'location', 
				  '需要访问您的位置以获取当前位置信息'
				);
				
				if (granted) {
				  //this.getLocation();
				}
			  } catch (error) {
				console.error('位置权限申请失败:', error);
			  }
			},
			// 处理相机权限
			async handleCamera() {
			  try {
				const permission = new UniPermission();
				const granted = await permission.requestPermission(
				  'camera', 
				  '需要访问您的相机以进行拍摄'
				);
				
				if (granted) {
				  //this.openCamera();
				}
			  } catch (error) {
				console.error('相机权限申请失败:', error);
			  }
			},
			...,
			//发送消息
			sendMessage(msgType, option = {}){
				...
				switch (msgType){
					case 'text':
					    ...
					    break;
					case 'iconMenus':
					    ...
					    break;
					case 'image':
					    console.log('image的数据',option);
					    msg.data = option.path;
				}
				...
			},
			
		},
		
	}
</script>

```

#### ③ 图片展示
在组件 `/components/chat-item/chat-item.vue`
```vue
<template>
	<view class="px-3">
		<!-- 时间 -->
		...
		<!-- 撤回消息 -->
		...
		<!-- 聊天内容 -->
		<view v-else
		...>
			<!-- 好友 -->
			<!-- 头像 -->
			...
			<!-- 气泡 -->
			<!-- 三角形 -->
			...
			<!-- 内容 -->
			<view ...>
			    <!-- 情况1：表情里面的图片 -->
				<view v-if="item.type == 'iconMenus' && 
				item.dataType && item.dataType == 'image'">
					<u--image showLoading showMenuByLongpress
					:src="item.data" mode="widthFix"                    
					width="200rpx" height="200rpx" radius="10rpx"></u--image>
				</view>
				<!-- 情况2: 发图片 -->
				<view v-else-if="item.type == 'image'">
					<u--image showLoading showMenuByLongpress
					:src="item.data" mode="widthFix"                    
					width="260rpx" height="150px"  radius="10rpx"></u--image>
				</view>
			    <!-- 文字 -->
				<text v-else
				class="font" style="text-align: justify;">
					{{item.data}}
				</text>
			</view>
			
			<!-- 我 -->
			...
		</view>
    
	    <!-- 弹出菜单 -->
	    ...
	
	
	</view>
</template>


```

## 二、发多张图片及预览
具体看官网，预览图片：<https://uniapp.dcloud.net.cn/api/#%E5%AA%92%E4%BD%93> <br/>

### 1. 组件处理
在组件： `/components/chat-item/chat-item.vue`
```vue
<template>
	<view class="px-3">
		<!-- 时间 -->
		...
		<!-- 撤回消息 -->
		...
		<!-- 聊天内容 -->
		<view v-else ...>
			<!-- 好友 -->
			<!-- 头像 -->
			...
			<!-- 气泡 -->
			<!-- 三角形 -->
			...
			<!-- 内容 -->
			<view ...>
			    <!-- 情况1: 表情包里面的gif/png图片  -->
				<view ...>
					<u--image
					...
					@click="previewImage(item,index)"></u--image>
				</view>
				<!-- 情况2: 发图片  -->
				<view ...>
					<u--image mode="aspectFill"                    
					... radius="10rpx"
					@click="previewImage(item,index)"></u--image>
				</view>
			    <!-- 文字 -->
				...
			</view>
			
			<!-- 我 -->
			...
		</view>
    
	    ...
	    
	</view>
</template>

<script>
	...
	export default{
		...,
		methods:{
			//预览图片
			previewImage(item,index){
				console.log('预览图片',item);
				// 预览一张
				// uni.previewImage({
				// 	urls:[item.data]
				// });
				// 预览选择的多张图片
				this.$emit('previewImages',{
					item,
					index
				});
			},
			...,
		}
	}
</script>
```

### 2. 在页面处理
`/pages/chat/chat.nvue` 页面
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		
		<!-- 聊天内容区域 -->
		<scroll-view ...>
			<!-- 对话部分 -->
			<view ...>
				<chat-item ...  @previewImages="previewImages"></chat-item>
			</view>
		</scroll-view>
		<!-- 针对我们的app端点击聊天区域授权加号扩展菜单 -->
		...
		
		<!-- 底部聊天输入区域 -->
		...
	
	    <!-- 弹出菜单 -->
		...
	</view>
</template>

<script>
    ...
	export default {
		...,
		computed:{
			...,
			// 多图预览图片地址数组集合
			previewImagesList(){
				let arr = [];
				this.chatDataList.forEach(item =>{
					if(item.type == 'image' || (item.type == 'iconMenus' &&
				       item.dataType && item.dataType == 'image')){
						arr.push(item.data);
					}
				});
				return arr;
			},
		},
		methods: {
			...,
			//选择照片发送
			chooseImage(){
				uni.chooseImage({
					count:9,
					//sizeType:['original','compressed'],
					sourceType:['album'],
					success: (res) => {
						console.log('选择照片res',res);
						if(res.tempFilePaths && res.tempFilePaths.length){
							// 发送到服务器或者第三方云存储
							// 页面展示
							// 单张
							// this.sendMessage('image',{path:res.tempFilePaths[0]});
							// 多张
							res.tempFilePaths.forEach(item=>{
								this.sendMessage('image',{path:item});
							});
						}
					},
					fail: (err) => {
						...
					}
				});
			},
			//预览图片
			previewImages(e){
				console.log('页面预览图片',e);
				uni.previewImage({
					urls:this.previewImagesList,
					current:e.item.data,
					indicator:'default',
				});
			},
			...,
		},
		
	}
</script>
```

## 三、【选修】发图片自适应宽高显示
> 我们目前用的是uviewUI提供的`u--image`组件，只能给固定宽高，有同学希望发送的图片显示的时候是自适应宽高，那么我们可以这么来做。
### 1. 简单的按照最大宽度或者最大高度来处理
在组件： `/components/chat-item/chat-item.vue`
```vue
<template>
	<view class="px-3">
		<!-- 时间 -->
		...
		<!-- 撤回消息 -->
		...
		<!-- 聊天内容 -->
		<view ...>
			<!-- 好友 -->
			<!-- 头像 -->
			...
			<!-- 气泡 -->
			<!-- 三角形 -->
			...
			<!-- 内容 -->
			<view ...>
			    <!-- 情况1: 表情包里面的gif/png图片  -->
				<view v-if="item.type == 'iconMenus' &&
				item.dataType && item.dataType == 'image'">
				    <!-- nvue页面组件u--image的load事件有兼容问题 -->
					<!-- <u--image
					:src="item.data" mode="widthFix"                    
					width="200rpx" height="200rpx" radius="10rpx"
					@click="previewImage(item,index)" 
					@load="handleImageLoad($event, item,index)"></u--image> -->
					<image lazy-load mode="widthFix"
					:src="item.data"
					:style="imageShowStyle"
					class="rounded"
					@click="previewImage(item,index)"
					@load="handleImageLoad($event,item,index)"></image>
				</view>
				<!-- 情况2: 发图片  -->
				<view v-else-if="item.type == 'image'">
					<!-- nvue页面组件u--image的load事件有兼容问题 -->
					<!-- <u--image showMenuByLongpress showLoading
					:src="item.data" mode="aspectFill"                    
					width="260rpx" height="150px" radius="10rpx"
					@click="previewImage(item,index)" 
					@load="handleImageLoad($event, item,index)"></u--image> -->
					<image lazy-load mode="widthFix"
					:src="item.data"
					:style="imageShowStyle"
					class="rounded"
					@click="previewImage(item,index)"
					@load="handleImageLoad($event,item,index)"></image>
				</view>
			    <!-- 文字 -->
				...
			</view>
			
			<!-- 我 -->
			...
		</view>
    
	    <!-- 弹出菜单 -->
	    ...
	
	
	</view>
</template>

<script>
	...,
	export default{
		...,
		data(){
			return {
				...,
				// 图片显示宽高
				width:120,
				height:120,
			}
		},
		computed:{
			...,
			// 图片展示的等比例展示
			imageShowStyle(){
				return `width: ${this.width}px;height: ${this.height}px;`;
			},
		},
		methods:{
			// 加载预览图片
			handleImageLoad(e,item,index){
				console.log('加载预览图片',e);
				console.log('加载预览图片index,index',item,index);
				let width = e.detail.width;
				let height = e.detail.height;
				//聊天界面显示最大宽度 
				let maxWidth = uni.upx2px(300);
				// 按最大宽度300rpx 计算最大可显示的高度
				// if(width <= maxWidth){
				// 	// 实际宽高展示
				// 	this.width = width;
				// 	this.height = height;
				// 	return;
				// }
				// // 进行比例计算, 等比例缩放
				// //width / height = maxWidth / maxHeight;
				// let maxHeight = maxWidth * (height / width);
				// this.width = maxWidth;
				// this.height = maxHeight;
				// 按最大高度400rpx 计算可以显示的最大宽度 
				// let maxHeight = uni.upx2px(400);
				// if(height < maxHeight && width <= maxWidth){
				// 	// 实际宽高展示
				// 	this.width = width;
				// 	this.height = height;
				// 	return;
				// }
				// this.height = maxHeight;
				// // height / width = maxHeight / maxWidth;
				// this.width = maxHeight * (width / height);
				// 需要考虑 当图片达到最大高度，计算的宽度也超过最大宽度
				let maxHeight = uni.upx2px(400);
				if(height < maxHeight){
					// 实际宽高展示
					this.width = width <= maxWidth ? width : maxWidth;
					this.height = height;
					return;
				}
				this.height = maxHeight;
				// height / width = maxHeight / maxWidth;
				let _width = maxHeight * (width / height);
				this.width = _width <= maxWidth ? _width : maxWidth;
				
			},
			...
		}
	}
</script>
```

### 2. 考虑更多图片大小情况的优化方案
在组件： `/components/chat-item/chat-item.vue`
```vue
<template>
	<view class="px-3">
		<!-- 时间 -->
		...
		<!-- 撤回消息 -->
		...
		<!-- 聊天内容 -->
		<view ...>
			<!-- 好友 -->
			<!-- 头像 -->
			...
			<!-- 气泡 -->
			<!-- 三角形 -->
			...
			<!-- 内容 -->
			<view ...>
			    <!-- 情况1: 表情包里面的gif/png图片  -->
				<view v-if="item.type == 'iconMenus' &&
				item.dataType && item.dataType == 'image'">
				    <!-- nvue页面组件u--image的load事件有兼容问题 -->
					<!-- <u--image
					:src="item.data" mode="widthFix"                    
					width="200rpx" height="200rpx" radius="10rpx"
					@click="previewImage(item,index)" 
					@load="handleImageLoad(e, item,index)"></u--image> -->
					<!-- <image lazy-load mode="widthFix"
					:src="item.data"
					:style="imageShowStyle"
					class="rounded"
					@click="previewImage(item,index)"
					@load="handleImageLoad($event,item,index)"></image> -->
					<image lazy-load :mode="imageMode" 
				    :src="item.data"
				    :style="getImageStyle(index)"
				    class="rounded"
				    @click="previewImage(item,index)"
				    @load="handleImageLoad($event,item,index)"></image>
				</view>
				<!-- 情况2: 发图片  -->
				<view v-else-if="item.type == 'image'">
					<!-- nvue页面组件u--image的load事件有兼容问题 -->
					<!-- <u--image showMenuByLongpress showLoading
					:src="item.data" mode="aspectFill"                    
					width="260rpx" height="150px" radius="10rpx"
					@click="previewImage(item,index)" 
					@load="handleImageLoad(e, item,index)"></u--image> -->
					<!-- <image lazy-load mode="widthFix"
					:src="item.data"
					:style="imageShowStyle"
					class="rounded"
					@click="previewImage(item,index)"
					@load="handleImageLoad($event,item,index)"></image> -->
					<image lazy-load :mode="imageMode"
				    :src="item.data"
				    :style="getImageStyle(index)"
				    class="rounded"
				    @click="previewImage(item,index)"
				    @load="handleImageLoad($event,item,index)"></image>
				</view>
			    <!-- 文字 -->
				...
			</view>
			
			<!-- 我 -->
			...
		</view>
    
	    <!-- 弹出菜单 -->
	    ...
	
	</view>
</template>

<script>
	...,
	export default{
		...,
		data(){
			return {
				...,
				imageSizes: {}, // 存储每个图片的计算尺寸
				imageMode: 'widthFix' // 图片模式
			}
		},
		computed:{
			...,
		},
		methods:{
			// 加载预览图片 - 优化后的尺寸计算
			handleImageLoad(e, item, index) {
			  const { width: originWidth, height: originHeight } = e.detail;
			  const maxWidth = uni.upx2px(300); // 最大宽度300rpx转px
			  const maxHeight = uni.upx2px(400); // 最大高度400rpx转px
			  
			  // 计算缩放比例
			  const widthRatio = maxWidth / originWidth;
			  const heightRatio = maxHeight / originHeight;
			  const ratio = Math.min(widthRatio, heightRatio, 1); // 取最小比例且不超过1
			  
			  // 计算最终尺寸
			  let width = originWidth * ratio;
			  let height = originHeight * ratio;
			  
			  // 确保尺寸不超过最大值
			  if (width > maxWidth) width = maxWidth;
			  if (height > maxHeight) height = maxHeight;
			  
			  // 存储计算后的尺寸
			  this.$set(this.imageSizes, index, {
				width,
				height
			  });
			  
			  // 设置图片模式：宽>高时使用aspectFit，否则使用widthFix
			  if (originWidth > originHeight) {
				this.imageMode = 'aspectFit';
			  } else {
				this.imageMode = 'widthFix';
			  }
			},
			
			// 获取图片样式
			getImageStyle(index) {
			  const size = this.imageSizes[index] || {};
			  return {
				width: size.width ? `${size.width}px` : '120px',
				height: size.height ? `${size.height}px` : '120px'
			  };
			},
			...,
		}
	}
</script>

```