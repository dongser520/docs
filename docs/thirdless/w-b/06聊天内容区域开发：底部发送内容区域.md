---
navbar: true
sidebar: auto
title: 章节6.聊天内容区域开发：底部发送内容区域
---

## 一、解决输入内容时键盘弹起，页面整体上移

### 1. 禁用键盘弹起时，自动上推页面
详见`textarea`组件的`adjust-position`属性: <https://uniapp.dcloud.net.cn/component/textarea.html> <br/>
在页面： `/pages/chat/chat.nvue`
```vue
<textarea ... :adjust-position="false"></textarea>
```

### 2. 重新处理底部输入框的布局
#### 1. 用到监听键盘高度变化的事件
监听键盘高度变化: <https://uniapp.dcloud.net.cn/api/key.html#onkeyboardheightchange>
在页面： `/pages/chat/chat.nvue`
```vue
<script>
	export default {
		data() {
			return {
				...
				KeyboardHeight:0, // 键盘高度
			}
		},
		mounted() {
			...
			
			//监听键盘高度变化
			uni.onKeyboardHeightChange(res=>{
				console.log('键盘高度变化',res);
				this.KeyboardHeight = res.height;
			});
		},
		computed:{
			chatContentStyle(){
				let pbottom = this.bottomSafeAreaHeight == 0 ?
				uni.upx2px(12) : this.bottomSafeAreaHeight;
				let bottom = pbottom + uni.upx2px(90 + 12) + this.KeyboardHeight;
				return `top:${this.fixedHeight}px;bottom:${bottom}px;`;
			},
			chatBottomStyle(){
				let pbottom = this.bottomSafeAreaHeight == 0 ?
				uni.upx2px(12) : this.bottomSafeAreaHeight;
				return `padding-bottom: ${pbottom}px;bottom:${this.KeyboardHeight}px;`;
			}
		},
		...
	}
</script>
```

#### 2. 隐藏滚动条并默认滚动到聊天底部
```vue
<!-- 聊天内容区域 -->
<scroll-view ... :show-scrollbar="false"></scroll-view>
```
1. `weex` (app-plus-nvue)页面滚动参考：<https://weexapp.com/zh/docs/modules/dom.html#scrolltoelement> <br/>
2. 在小程序MP端，使用`scroll-view`组件的`scroll-into-view`属性，具体查看官网：<https://uniapp.dcloud.net.cn/component/scroll-view.html#scroll-view><br/>
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		
		<!-- 聊天内容区域 -->
		<scroll-view ...
		:scroll-into-view="scrollIntoViewId" @scroll="onScroll">
			<!-- 对话部分 -->
			<view ...
			:id="'chat-item-'+index">
				<chat-item ... :show-scrollbar="false"
				ref="chatItem"></chat-item>
			</view>
		</scroll-view>
		
		<!-- 底部聊天输入区域 -->
		...
		
	</view>
</template>

<script>
	export default {
		data() {
			return {
				...
				KeyboardHeight:0, // 键盘高度
				scrollIntoViewId: '', // 滚动到指定元素的id
				...
			}
		},
		mounted() {
			...
			
			//监听键盘高度变化
			uni.onKeyboardHeightChange(res=>{
				console.log('键盘高度变化',res);
				this.KeyboardHeight = res.height;
				if(this.KeyboardHeight){
					this.chatContentToBottom();
				}
			});
			// 页面加载完成后滚动到底部
			this.$nextTick(() => {
				this.chatContentToBottom();
			});
		},
		computed:{
			chatContentStyle(){
				...
				let bottom = pbottom + uni.upx2px(90 + 12) + this.KeyboardHeight;
				// #ifdef MP
				if(this.KeyboardHeight){
					bottom = uni.upx2px(90 + 12 + 12) + this.KeyboardHeight;
				}
				// #endif
				return ...;
			},
			chatBottomStyle(){
				...
				// #ifdef MP
				if(this.KeyboardHeight){
					pbottom = uni.upx2px(12);
				}
				// #endif
				return `padding-bottom: ${pbottom}px;bottom:${this.KeyboardHeight}px;`;
			}
		},
		methods: {
			...,
			//聊天内容滚动到底部
			chatContentToBottom(){
				// #ifdef APP
				let chatItems = this.$refs.chatItem;
				let lastIndex = chatItems.length - 1 == 0 ? 0 : chatItems.length - 1;
				let last = chatItems[lastIndex];
				const dom = weex.requireModule('dom');
				dom.scrollToElement(last, {});
				// #endif
				// #ifdef MP
				if (this.chatDataList.length === 0) return;
				const lastIndex = this.chatDataList.length - 1;
				this.scrollIntoViewId = `chat-item-${lastIndex}`;
				setTimeout(() => {
					this.scrollIntoViewId = '';
					this.$nextTick(() => {
						this.scrollIntoViewId = `chat-item-${lastIndex}`;
					});
				}, 100);
				// #endif
			},
			onScroll() {
				// 可添加滚动位置检测逻辑
				// console.log('页面发生了滚动');
			}
		},
		watch: {
			// 监听聊天数据变化，自动滚动到底部
			chatDataList: {
				handler() {
					this.$nextTick(() => {
						this.chatContentToBottom();
					});
				},
				deep: true
			}
		}
	}
</script>

<style>
   ...
</style>

```

## 二、聊天页底部发送信息功能（发送普通文字）功能
在页面： `/pages/chat/chat.nvue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		
		<!-- 聊天内容区域 -->
		...
		
		<!-- 底部聊天输入区域 -->
		<view ...>
		    <!-- 左边 -->
			<view ...>
				<!-- 图标 -->
				...
				<!-- 输入框 -->
				<view ...>
					<textarea ...
					v-model="messageValue"></textarea>
				</view>
			</view>
			<!-- 右边 -->
			<view ...>
				<!-- 表情 -->
				<chat-navbar-icon-button v-if="!messageValue">
					...
				</chat-navbar-icon-button>
				<!-- 加号 -->
				<chat-navbar-icon-button v-if="!messageValue">
					...
				</chat-navbar-icon-button>
				<!-- 发送按钮 -->
				<view v-if="messageValue"
				class="rounded bg-success px-2 py-1 mr-4"
				hover-class="bg-hover-success"
				@click="sendMessage('text')">
					<text class="text-white font">发送</text>
				</view>
			</view>
		</view>
		
	</view>
</template>

<script>
	export default {
		data() {
			return {
				...
				messageValue:'', //输入的消息内容
				...
			}
		},
		mounted() {
			...
		},
		computed:{
			...
		},
		methods: {
			// 发消息
			sendMessage(msgType){
				console.log('发送信息',msgType);
				let msg = {
					avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
					nickname: '小二哥',
					user_id: 2,
					chat_time: (new Date()).getTime(),
					data: '',
					type:msgType, //image,video
					isremove:false,
				};
				switch (msgType){
					case 'text':
					    msg.data = this.messageValue;
						break;

				}
				this.chatDataList.push(msg);
				// 清空及滚动到底部
				if(msgType == 'text') this.messageValue = '';
				this.chatContentToBottom();
			},
			...
		},
		...
	}
</script>

<style>
   ...
</style>

```

## 三、底部输入区域加号扩展菜单功能
### 1. 先确定好扩展菜单的高度和位置
1. 在组件： `/components/chat-tooltip/chat-tooltip.vue`中
```vue
methods: {
	hide() {
		...
		// 通知父组件或者页面弹出组件隐藏了
		this.$emit('hideTooltip');
	}
}
```
2. 在页面： `/pages/chat/chat.nvue`中
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		
		<!-- 聊天内容区域 -->
		...
		
		<!-- 底部聊天输入区域 -->
		<view ...>
		    <!-- 左边 -->
			...
			<!-- 右边 -->
			<view ...>
				<!-- 表情 -->
				...
				<!-- 加号 -->
				<chat-navbar-icon-button ...
				@click="openPlus">
					...
				</chat-navbar-icon-button>
				<!-- 发送按钮 -->
				...
			</view>
		</view>
		
		<!-- 加号扩展菜单 -->
		<chat-tooltip ref="tooltipPlus" :mask="true" 
	    :maskTransparent="true" :isBottom="true" 
	    :tooltipWidth="750"
	    :tooltipHeight="tooltipHeight"
		transformOrigin="center bottom"
		tooltipClass="bg-light border-0 rounded-0"
		@hideTooltip="hideTooltip">
			<view class="bg-warning border-top border-light-secondary">
				<swiper :indicator-dots="true" :duration="1000"
				:style="tooltipPlusMenuStyle">
					<!-- 第一页 -->
					<swiper-item>
						<view style="background-color: red;"
						:style="swiperItemStyle">
							<text>1</text>
						</view>
					</swiper-item>
				</swiper>
			</view>
		</chat-tooltip>
	</view>
</template>

<script>
	export default {
		data() {
			return {
				tooltipHeight:600, // 加号弹出菜单高度rpx
				...
			}
		},
		mounted() {
			...
		},
		computed:{
			...,
			// 加号菜单样式
			tooltipPlusMenuStyle(){
				let pbottom = 0;
				let height = uni.upx2px(this.tooltipHeight - 1) - pbottom;
				// #ifdef APP || MP
				pbottom = this.bottomSafeAreaHeight;
				// #endif
				return `padding-bottom:${pbottom}px;height:${height}px;`;
			},
			//加号菜单每页滑动样式
			swiperItemStyle(){
				let pbottom = 0;
				let height = uni.upx2px(this.tooltipHeight - 1) - pbottom;
				return `padding-bottom:${pbottom}px;height:${height}px;`;
			},
			
		},
		methods: {
			//点击加号
			openPlus(){
				console.log('点击了加号');
				this.$refs.tooltipPlus.show();
				// #ifdef APP || MP || H5
				this.KeyboardHeight = uni.upx2px(this.tooltipHeight);
				this.chatContentToBottom();
				// #endif
				
			},
			// 弹出框隐藏了
			hideTooltip(){
				console.log('弹出框隐藏了');
				// #ifdef APP || MP || H5
				this.KeyboardHeight = 0;
				this.chatContentToBottom();
				// #endif
			},
			...
		},
		...
	}
</script>

<style>
    ...
</style>

```

### 2. 加号扩展菜单内容布局
在页面： `/pages/chat/chat.nvue`中
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		
		<!-- 聊天内容区域 -->
		...
		
		<!-- 底部聊天输入区域 -->
		...
	
	
	     <!-- 弹出菜单 -->
	     <chat-tooltip ...>
	     	<view ...>
				<!-- 动态设置指示点 -->
				<!-- 动态设置指示点 -->
				<swiper :indicator-dots="pageCount > 1" :duration="1000"
				:style="tooltipPlusMenuStyle">
				    <!-- 动态生成分页 -->
					<swiper-item v-for="(page, index) in groupedPlusMenus" :key="index">
						<view class="flex flex-row justify-start flex-wrap"
						:style="swiperItemStyle">
						    <!-- 每页显示8个 -->
							<view class="col-3 flex flex-column 
							align-center justify-center" 
							v-for="(item, itemIndex) in page" :key="itemIndex"
							style="height: 260rpx;align-items: center;
							justify-content:center;"
							@click="swiperItemClick(item, itemIndex)">
							   <!-- 图标 -->
							    <view class="bg-white rounded-lg 
							    flex flex-row align-center justify-center mb-2"
							    style="width: 120rpx;height: 120rpx;">
							        <!-- 包含反斜杠\u的是自定义图标 -->
							        <text v-if="item.iconType == 'custom'"
							        class="iconfont" 
									style="font-size: 26px;color:#222222">{{item.icon}}</text>   
							        <!-- 否则是uView图标 -->
							        <u-icon v-if="item.iconType == 'uview'"
							        :name="item.icon" size="26" color="#222222"></u-icon>
							   </view>
							   <!-- 文字 -->
							   <text class="font-sm text-light-muted">{{item.name}}</text>
							</view>
						</view>
					</swiper-item>
				</swiper>
			</view>
	     </chat-tooltip>	
	</view>
</template>

<script>
	export default {
		data() {
			return {
				...,
				plusMenus:[ //加号扩展菜单
					{ name:"照片", icon:"photo",iconType:"uview", eventType:"photo"},
					{ name:"位置", icon:"map", iconType:"uview",eventType:"map"},
					{ name:"拍摄", icon:"\ue62c",iconType:"custom", eventType:"camera"},
					{ name:"我的名片", icon:"\ue69d",iconType:"custom", eventType:"mingpian"},
					{ name:"视频", icon:"\ue66d",iconType:"custom", eventType:"video"},
					// { name:"拍摄", icon:"\ue62c",iconType:"custom", eventType:""},
					// { name:"我的名片", icon:"\ue69d",iconType:"custom", eventType:""},
					// { name:"视频", icon:"\ue66d",iconType:"custom", eventType:""},
					// { name:"拍摄", icon:"\ue62c",iconType:"custom", eventType:""},
					// { name:"我的名片", icon:"\ue69d",iconType:"custom", eventType:""},
					// { name:"视频", icon:"\ue66d",iconType:"custom", eventType:""},
				],
				...,
			}
		},
		...,
		computed:{
			...,
			// 新增分页计算属性
			groupedPlusMenus() {
				const perPage = 8; // 每页8个
				const result = [];
				
				// 将数组按每页8个分组
				for (let i = 0; i < this.plusMenus.length; i += perPage) {
					result.push(this.plusMenus.slice(i, i + perPage));
				}
				
				return result;
			},
			
			// 计算总页数
			pageCount() {
				return Math.ceil(this.plusMenus.length / 8);
			}
		},
		methods: {
			//点击加号菜单的某一项
			swiperItemClick(item, itemIndex){
				console.log('点击加号菜单的某一项',item.eventType);
				switch(item.eventType){
					case 'photo':
						break;
					case 'map':
						break;
					case 'camera':
						break;
					case 'mingpian':
						break;
					case 'video':
						break;
				}
			},
			...,
		},
		...
	}
</script>

<style>
    ...
</style>

```

## 四、加号和键盘切换问题（主要针对app端）
> 针对app端：出现加号和输入内容时候键盘的bug，主要原因是我们在之前开发的时候没有考虑到多种消息发送情况的各种判定，因此我们要分析在发送消息的时候，有哪些情况，很显然，我们发送消息的时候有四种情况：1. 发送文本消息 2. 点击加号发送扩展菜单的内容 3. 发送表情 4. 发送语音消息 5. 其它情况。 <br/>

在页面： `/pages/chat/chat.nvue` 中
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		
		<!-- 聊天内容区域 -->
		...
		<!-- 针对app端点击聊天区域隐藏加号扩展菜单 -->
		<!-- #ifdef APP -->
		<view v-if="sendMessageMode == 'plus'" @click="scrollViewClick"
		class="position-fixed left-0 right-0 bg-success"
		:style="chatContentStyle"></view>
		<!-- #endif -->
		
		<!-- 底部聊天输入区域 -->
		<view ...>
		    <!-- 左边 -->
			<view ...>
				<!-- 图标 -->
				...
				<!-- 输入框 -->
				<view ...>
					<textarea ...
					@focus="textareaFocus"></textarea>
				</view>
			</view>
			<!-- 右边 -->
			...
		</view>
	
	
	     <!-- 弹出菜单 -->
	     ...
	</view>
</template>

<script>
	export default {
		data() {
			return {
				...,
				sendMessageMode:"text", //发送消息的情况：文本|加号|表情|语音
				// #ifdef MP || H5
				chatTooltipMask:true,
				// #endif
				// #ifdef APP
				chatTooltipMask:false,
				// #endif
				...
			}
		},
		mounted() {
			...
			// 监听键盘高度变化
			uni.onKeyboardHeightChange(res=>{
				console.log('键盘高度变化',res);
				// #ifdef MP || H5
				this.KeyboardHeight = res.height;
				// #endif
				// #ifdef APP
				console.log('此时的输入模式',this.sendMessageMode);
				if(this.sendMessageMode != 'plus'){
					this.KeyboardHeight = res.height;
				}
				// #endif
				if(this.KeyboardHeight){
					this.chatContentToBottom();
				}
			});
			...
		},
		computed:{
			...
		},
		methods: {
			...,
			// 点击聊天区域
			scrollViewClick(){
				// #ifdef APP
				console.log('点击聊天区域');
				this.KeyboardHeight = 0;
				uni.hideKeyboard();
				this.$refs.tooltipPlus.hide();
				this.sendMessageMode = "text";
				// #endif
			},
			// 文本输入聚焦
			textareaFocus(){
				// #ifdef APP
				this.sendMessageMode = "text";
				console.log('触发文本输入聚焦事件模式是',this.sendMessageMode);
				// #endif
			},
			//点击了加号
			openPlus(){
				console.log('点击了加号');
				// #ifdef APP
				// 改变发送模式，收起键盘
				this.sendMessageMode = "plus";
				uni.hideKeyboard();
				// #endif
				...
			},
			...
		},
		watch:{
			...,
			sendMessageMode(newVal,oldVal){
				// #ifdef APP
				console.log('监听发送模式',newVal);
				if(newVal != 'plus'){
					this.$refs.tooltipPlus.hide();
				}
				// #endif
			}
		},
	}
</script>

<style>
    ...
</style>

```
