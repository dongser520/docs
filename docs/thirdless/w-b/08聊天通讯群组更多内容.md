---
navbar: true
sidebar: auto
title: 章节8.聊天通讯（群组）
---

## 十七、修改群公告
### 1. 修改群公告接口说明
接口文档查看：<a href="/fourthless/w-a/eggjs.即时通讯接口.html#二十六、修改群公告-成功后通过websocket通知群聊用户" target="_blank">二十六、修改群公告（成功后通过webSocket通知群聊用户）</a>

### 2. 修改群公告功能实现
1. 修复上一节课的bug，进入单聊页面标题出错 <br/>
在页面 `/pages/chat/chat.nvue`
```js
onShow() {
    if(this.arg && this.arg.chatType == 'group'){
        this.arg.name = this.groupname || this.pagetitle;
        // #ifdef H5
        document.title = this.groupname || this.pagetitle;
        // #endif
    }
},
```


2. 在页面 `/pages/setpageInfo/setpageInfo.vue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		<!-- 内容 -->
		<view>
			<!-- 聊天相关 -->
			<view v-if="setdata.action == 'chatset'">
				...
			</view>
			<!-- 聊天页设置 -->
			<view v-if="setdata.action == 'chatpageset'">
				<view v-if="chatpageset.id && chatpageset.chatType">
					<!-- 头像部分 -->
					...
					<!-- 群相关设置 -->
					<view v-if="chatpageset.chatType == 'group'">
						<!-- 群名称 -->
						<u-cell-group>
							<u-cell>
								<view slot="title">
									<view class="mb-2">
										<text class="font-weight-bold">群名称</text>
									</view>
									<u-input ...
									customStyle="padding:20rpx;"></u-input>
								</view>
							</u-cell>
						</u-cell-group>
						...
						<!-- 群公告 -->
						<u-cell-group>
							<u-cell>
								<view slot="title">
									<view class="mb-2">
										<text class="font-weight-bold">群公告</text>
									</view>
									<u-textarea v-model="chatpageset.remark"
									border="none" :maxlength="500"
									...
									@confirm="groupremark"></u-textarea>
								</view>
							</u-cell>
						</u-cell-group>
						...
					</view>
					<!-- 查找聊天内容 -->
					...
					<!-- 消息设置 -->
					...
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	...
	export default {
		...,
		methods: {
			// 群公告
			groupremark(){
				const arg = {
					apiurl: '/api/chat/groupremark',
					params:{
						id: this.chatpageset.id,
						remark: this.chatpageset.remark,
					},
				}
				this.groupUpdate(arg).then(res =>{
					uni.showToast({title:'修改群公告成功', icon:'none'});
				});
			},
			// 更新群名称
			groupUpdateName(){
				const arg = {
					apiurl: '/api/chat/groupUpdateName',
					params:{
						id: this.chatpageset.id,
						name: this.chatpageset.name,
					},
				}
				this.groupUpdate(arg).then(res =>{
					uni.showToast({title:'群名称修改成功', icon:'none'});
					// 使用vuex兼容H5端nvue页面标题
					this.$store.dispatch('groupUpdateName',{
						name: this.chatpageset.name
					});
				});
			},
			// 更新群相关信息
			groupUpdate(arg){
				return new Promise((resolve,reject) => {
					uni.$u.http.post(requestUrl.http + `${arg.apiurl}`, arg.params, {
						header: {
							token: this.me.token,
						},
					}).then(res => {
						console.log('服务器返回群名称更新结果', res);
						if(res.data.data == 'ok'){
							resolve();
						}
						
					}).catch(err =>{
						uni.showModal({
							content:err.data.data,
							showCancel:false,
							confirmText:'我知道了'
						});
					});
				});
			},
			...
		}
	}
</script>

```


## 十八、修改我在群里面的昵称
### 1. 修改我在群里面的昵称接口说明
接口文档查看：<a href="/fourthless/w-a/eggjs.即时通讯接口.html#二十七、修改我在群里面的昵称" target="_blank">二十七、修改我在群里面的昵称</a>

### 2. 修改我在群里面的昵称功能实现
在页面 `/pages/setpageInfo/setpageInfo.vue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		<!-- 内容 -->
		<view>
			<!-- 聊天相关 -->
			<view v-if="setdata.action == 'chatset'">
				...
			</view>
			<!-- 聊天页设置 -->
			<view v-if="setdata.action == 'chatpageset'">
				<view v-if="chatpageset.id && chatpageset.chatType">
					<!-- 头像部分 -->
					...
					<!-- 群相关设置 -->
					<view v-if="chatpageset.chatType == 'group'">
						<!-- 我在群里的昵称 -->
						<u-cell-group>
							<u-cell>
								<view slot="title">
									<view class="mb-2">
										<text class="font-weight-bold">我在群里的昵称</text>
									</view>
									<u-input v-model="chatpageset.nickname"
									border="none" :maxlength="20"
									:adjustPosition="false" clearable
									placeholder="群昵称最多20个字"
									@confirm="groupnickname"
									customStyle="padding:20rpx;"></u-input>
								</view>
							</u-cell>
						</u-cell-group>
						<u-gap height="10" bgColor="#EDEDED"></u-gap>
						<!-- 群名称 -->
						...
						<!-- 群公告 -->
						...
					</view>
					<!-- 查找聊天内容 -->
					...
					<!-- 消息设置 -->
					...
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	...
	export default {
		...,
		onLoad(e) {
			...
			// 动态生成数据
			if(e.action){
				this.setdata.action = e.action;
				if(this.setdata.action == 'chatset'){
					...
				}else if(this.setdata.action == 'chatpageset'){
					...
					// 群聊设置
					if(this.chatpageset.chatType == 'group'){
						this.getgroupinfo();
					}
				}
			}
		},
		...,
		methods: {
			// 获取群资料消息
			getgroupinfo(){
				uni.$u.http.get(requestUrl.http + `/api/chat/groupinfo/${this.chatpageset.id}`, {
					header: {
						token: this.me.token,
					},
				}).then(res => {
					console.log('服务器返回群资料', res);
					let info = res.data.data;
					this.chatpageset.user_id = info.user_id;
					this.chatpageset.remark = info.remark;
					this.chatpageset.invite_confirm = info.invite_confirm;
					this.chatpageset.users = info.group_users;
					console.log('显示到页面的群资料',this.chatpageset);
					this.chatpageset.user_id =  this.chatpageset.user_id == this.me.id ? true : false; 
					// 我在群里的昵称
					let me_index = this.chatpageset.users.findIndex(v=> v.user_id == this.me.id);
					if(me_index != -1){
						this.chatpageset.nickname = this.chatpageset.users[me_index].nickname;
					}
				});
			},
			// 更新我在群里的昵称
			groupnickname(){
				const arg = {
					apiurl: '/api/chat/groupnickname',
					data: {
						id: this.chatpageset.id,
						nickname: this.chatpageset.nickname,
					},
				};
				this.groupUpdate(arg).then(res => {
					uni.showToast({title:'群昵称设置成功', icon:'none'});
					this.getgroupinfo();
				});
			},
			// 更新群公告
			...,
			// 更新群名称
			...,
			// 更新群信息
			...,
			...
		}
	}
</script>


```


## 十九、删除群（解散群）或退出群聊
说明：`（登录用户和游客都有这个功能，删除群（解散群）（群主可操作）或退出群（群成员可操作））` <br/>
### 1. 修改我在群里面的昵称接口说明
接口文档查看：<a href="/fourthless/w-a/eggjs.即时通讯接口.html#二十八、删除群-解散群-群主可操作-或退出群-群成员可操作" target="_blank">二十八、删除群（解散群）（群主可操作）或退出群（群成员可操作）</a>

### 2. 删除群（解散群）或退出群聊功能实现
在页面 `/pages/setpageInfo/setpageInfo.vue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		<!-- 内容 -->
		<view>
			<!-- 聊天相关 -->
			<view v-if="setdata.action == 'chatset'">
				...
			</view>
			<!-- 聊天页设置 -->
			<view v-if="setdata.action == 'chatpageset'">
				<view v-if="chatpageset.id && chatpageset.chatType">
					<!-- 头像部分 -->
					...
					<!-- 群相关设置 -->
					...
					<!-- 查找聊天内容 -->
					...
					<!-- 消息设置 -->
					...
					<!-- 解散群或者退群 -->
					<view class="p-3">
						<u-button type="primary" plain  :text="deleteOrQuitGroup"
						@click="deleteOrQuitGroupfn"></u-button>
					</view>
					<u-gap height="10" bgColor="#EDEDED"></u-gap>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	...
	export default {
		...,
		onLoad(e) {
			...
			// 动态生成数据
			if(e.action){
				...
				if(this.setdata.action == 'chatset'){
					...
				}else if(this.setdata.action == 'chatpageset'){
					...
					// 设置相关
					this.chatpageset = {
						// 单聊
						...this.chatpageset,
						istop: getChatPageSet && getChatPageSet.istop ? true : false ,
						shownickname: getChatPageSet && getChatPageSet.shownickname ? true : false,
						nowarn: getChatPageSet && getChatPageSet.nowarn ? true : false,
						stongwarn: getChatPageSet && getChatPageSet.stongwarn ? true : false,
						
						// 群聊还有以下字段
						...
					}
					...
				}
			}
		},
		...
		computed:{
			...,
			// 解散该群或者退出该群
			deleteOrQuitGroup(){
				if(this.chatpageset.chatType == 'group'){
					return this.chatpageset.user_id ? '解散该群' : '退出该群';
				}
				return ``;
			},
		},
		methods: {
			// 解散群或者退出群
			deleteOrQuitGroupfn(){
				const arg = {
					apiurl: '/api/chat/groupDeleteOrQuit',
					data: {
						id: this.chatpageset.id,
					},
				};
				this.groupUpdate(arg).then(res => {
					uni.showToast({title:'操作成功', icon:'none'});
					if(this.chatpageset.user_id){
						return this.navigateBack();
					}else{
						uni.switchTab({
							url:'/pages/xiaoxi/xiaoxi'
						});
					}
				});
			},
			// 获取群资料消息
			getgroupinfo(){
				uni.$u.http.get(requestUrl.http + `/api/chat/groupinfo/${this.chatpageset.id}`, {
					header: {
						token: this.me.token,
					},
				}).then(res => {
					...
				}).catch(err=>{
					this.navigateBack();
				});
			},
			...
		}
	}
</script>


```

## 二十、删除消息页消息记录
在页面 `/pages/xiaoxi/xiaoxi.nvue`
```js
// 删除某个聊天
deleteChat(){
	// this.chatList.splice(this.chatListIndex,1);
	let chatItem = this.chatList[this.chatListIndex];
	console.log('删除某个聊天',chatItem);
	this.chatClass.deleteChatInfo(chatItem.id, chatItem.chatType).then(()=>{
		this.getDataList();
	});
},
```

## 二十一、设置页(如：显示群成员昵称，置顶等处理)
### 1. 设置页进行设置
在页面 `/pages/setpageInfo/setpageInfo.vue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		<!-- 内容 -->
		<view>
			<!-- 聊天相关 -->
			<view v-if="setdata.action == 'chatset'">
				...
			</view>
			<!-- 聊天页设置 -->
			<view v-if="setdata.action == 'chatpageset'">
				<view v-if="chatpageset.id && chatpageset.chatType">
					<!-- 头像部分 -->
					...
					<!-- 群相关设置 -->
					...
					<!-- 查找聊天内容 -->
					...
					<!-- 消息设置 -->
					<u-cell-group>
						<u-cell  v-if="chatpageset.chatType == 'group'"
						title="是否显示群成员昵称"
						:border="false" clickable 
						:customStyle="customStyles"
						:iconStyle="iconStyles"
						:titleStyle="titleStyles">
						    <view slot="value">
						         <u-switch v-model="chatpageset.shownickname" 
								 @change="changeSwitch('shownickname')"></u-switch>
							</view>
						</u-cell>
						<u-cell  title="消息免打扰"
						:border="false" clickable 
						:customStyle="customStyles"
						:iconStyle="iconStyles"
						:titleStyle="titleStyles">
						    <view slot="value">
						         <u-switch v-model="chatpageset.nowarn" @change="changeSwitch('nowarn')"></u-switch>
							</view>
						</u-cell>
						...
						...
					</u-cell-group>
					...
					<!-- 解散群或退群 -->
					<view v-if="chatpageset.chatType == 'group'">
						<view class="p-3">
							<u-button type="primary" plain :text="deleteOrQuitGroup"
							@click="deleteOrQuitGroupfn"></u-button>
						</view>
						<u-gap height="10" bgColor="#EDEDED"></u-gap>
					</view>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	...
	export default {
		...,
		methods: {
			...,
			// 点击开关
			changeSwitch(key){
				console.log(`点击开关${key}`,this.chatpageset[key]);
				console.log('通过开关设置单聊或者群聊',this.chatpageset);
				this.chatClass.updateSomeOneChatItem({
					id: this.chatpageset.id,
					chatType: this.chatpageset.chatType,
				}, this.chatpageset).then((res)=>{
					console.log('设置之后的数据', res);
					// 方式一: 通知聊天页
					// 方式二: 聊天页重新获取聊天信息
				});
			},
			...
		}
	}
</script>

```

### 2. 聊天页重新获取聊天信息（对应消息列表信息，设置信息在这个里面）
在页面 `/pages/chat/chat.nvue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		
		<!-- 聊天内容区域 -->
		<scroll-view ...>
			<!-- 对话部分 -->
			<view ...>
				<chat-item ...
				:setdata="setdata"></chat-item>
			</view>
		</scroll-view>
		<!-- 针对我们的app端点击聊天区域授权加号扩展菜单 -->
		...
		
		
		<!-- 底部聊天输入区域 --><!-- 修改：添加ref获取textarea实例 -->
		 ...
	
	     <!-- 弹出菜单 --><!-- 主要修改区域 -->
		 ...
		 
		 <!-- 提示用户正在录音的界面 -->
		 ...
		 
	</view>
</template>

<script>
    ...
	export default {
		...,
		computed:{
			...mapState({
				...,
				xiaoxiList :state=>state.Chatuser.xiaoxiList,
			}),
			//是否显示群昵称(传递设置信息)
			setdata(){
				// 拿到最新一条消息的设置
				let index = this.xiaoxiList.findIndex(v => v.id == this.arg.id &&
				v.chatType == this.arg.chatType);
				if(index != -1){
					console.log('找到了当前单聊或者群聊的设置信息',this.xiaoxiList[index]);
					return this.xiaoxiList[index];
				}
				return {};
			},
			...,
		},
		...,
		
	}
</script>


```


### 3. 组件处理
在组件 `/components/chat-item/chat-item.vue`
```vue
<template>
	<view class="px-3">
		...
		
		<!-- 聊天内容 -->
		<view ...>
			<!-- 好友 -->
			...
			
			<!-- 聊天内容主体 -->
			<view class="flex flex-column">
				<!-- 昵称的显示  -->
				<view v-if="setdata.shownickname"
				...>
					...
				</view>
				<!-- 内容 -->
				...
				
			</view>
			
			<!-- 我 -->
			...
		</view>
    
	    <!-- 给服务器发消息状态 -->
		...
	
	    <!-- 弹出菜单 -->
	    ...
	
	
	</view>
</template>

<script>
    ...
	export default{
		...,
		props:{
			...,
			// 是否显示群成员昵称(设置信息)
			setdata: {
				type: Object,
				default: {},
			},
		},
		...
	}
</script>

```




































































































