---
navbar: true
sidebar: auto
title: ç« èŠ‚13.å³æ—¶é€šè®¯é€‰ä¿®è¯¾
---

è¯´æ˜ï¼š<br/>
- æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚å·²ç»è®²å®Œäº†æœ¬å­£è¯¾ç¨‹çš„æ‰€æœ‰å†…å®¹ï¼Œä»æœ¬èŠ‚è¯¾å¼€å§‹ä¸ºé€‰ä¿®è¯¾ï¼Œéå¿…ä¿®è¯¾ï¼ŒåŒå­¦ä»¬å¯æ ¹æ®å…´è¶£é€‰æ‹©å­¦ä¹ ã€‚
- æœ¬ç« èŠ‚å†…å®¹ä¸»è¦æ˜¯å¯¹æˆ‘ä»¬é¡¹ç›®ä»£ç çš„ä¼˜åŒ–ï¼Œæ–¹ä¾¿åæœŸè¿›è¡ŒäºŒæ¬¡å¼€å‘åŠä¾¿äºåç«¯ç®¡ç†ã€‚
- - æœ‰ä»¥ä¸‹æ–¹é¢çš„ä¼˜åŒ–ï¼š<br/>
- - 1. å°†é¡µé¢ä¸Šç”¨åˆ°çš„å›¾ç‰‡ã€è§†é¢‘ç­‰èµ„æºç»Ÿä¸€æ”¾ç½®äºé…ç½®æ–‡ä»¶ç®¡ç†ï¼Œæ–¹ä¾¿åæœŸç®¡ç†ã€‚<br/>
- - 2. é¦–é¡µæ¨é€æ¶ˆæ¯ä¸­çš„å¤´åƒæ›´æ–°ã€‚<br/>
- - 3. æœç´¢åŠ å¥½å‹åŠŸèƒ½ä¼˜åŒ–ã€‚<br/>
- - 4. å…¶å®ƒåŠŸèƒ½ <br/>

## ä¸€ã€æ•°æ®ç»Ÿä¸€åœ¨é…ç½®æ–‡ä»¶ç®¡ç†
### 1 æ¶ˆæ¯é¡µåˆå§‹åŒ–æ•°æ®æ¸…ç©º
é¡µé¢ `/pages/xiaoxi/xiaoxi.nvue` ä¸­ï¼Œdataä¸­çš„æ•°æ® `chatList` è®¾ç½®ä¸º `chatList = []`;
### 2 èŠå¤©é¡µæ•°æ®å¤„ç†
åœ¨æ–‡ä»¶ `/pages/chat/plusIconAction.js`ä¸­
- `chatDataList = []`; // èŠå¤©æ•°æ®æ¸…ç©º
> ```js
>     import {requestUrl, uploadfileSaveType, chatPageInit} from '@/common/mixins/configData.js';
>     ...
>     data(){
> 		return {
> 			// è§†é¢‘å°é¢å ä½å›¾ç‰‡
> 			videoPlaceHolderPoster: chatPageInit.videoPlaceHolderPoster,
> 			// æŒ‰ä½å½•éŸ³æ˜¾ç¤ºçš„å›¾ç‰‡
> 			recorderIcon: chatPageInit.recorderIcon,
> 			// è¡¨æƒ…åŒ…æ•°æ®
> 			iconMenus: chatPageInit.iconMenus,
> 			// åŠ å·æ‰©å±•èœå•æ ç›®
> 			plusMenus: chatPageInit.plusMenus,
> 			chatDataList: [],
> 										
> 		}
> 	},
> ```
- å°†æ•°æ®å®šä¹‰åœ¨ `/common/mixins/configData.js`
- - gifåŠ¨ç”»è¡¨æƒ…åŒ…ï¼Œå¤§å®¶å¯ä»¥åœ¨ç½‘ä¸Šè‡ªè¡Œä¸‹è½½ä½ å–œæ¬¢çš„ï¼Œå¦‚ <https://www.fabiaoqing.com/>ï¼Œç„¶åæ”¾åœ¨æœ¬åœ°æ–‡ä»¶static/emojiæ–‡ä»¶å¤¹ä¸‹æˆ–è€…æ”¾åœ¨é˜¿é‡Œäº‘ossäº‘å­˜å‚¨ä¸Šï¼Œç„¶åå°±å¯ä»¥å¼•å…¥ä½¿ç”¨äº† <br/>
- - emoji æ–‡å­—è¡¨æƒ…åŒ…ï¼Œå¯ä»¥æŸ¥çœ‹è¿™ä¸ªç½‘ç«™é€‰æ‹©ä½ å–œæ¬¢çš„ <https://www.emojiall.com/zh-hans/all-emojis>
```js
...
// èŠå¤©é¡µåˆå§‹åŒ–æ•°æ®
export const chatPageInit = {
	// è§†é¢‘å°é¢å ä½å›¾ç‰‡
	videoPlaceHolderPoster:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/video/video_placeholder.jpg',
	// æŒ‰ä½å½•éŸ³æ˜¾ç¤ºçš„å›¾ç‰‡
	recorderIcon:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/recorder.gif',
	// è¡¨æƒ…åŒ…æ•°æ®
	iconMenus:[
		// { name:"å¾®ç¬‘", icon:"/static/tabbar/index.png",
		// iconType:"image", eventType:"smile" },
		{ name:"å˜¿å˜¿", icon:"ğŸ˜€",
		iconType:"emoji", eventType:"heihei" },
		{ name: "å—¯ï¼Œå“¼", icon: "https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/iconMenus/en.gif", 
		iconType: "image", eventType: "enheng" },
		{ name:"å˜»å˜»", icon:"ğŸ˜",
		iconType:"emoji", eventType:"xixi" },
		{ name:"ç¬‘å“­äº†", icon:"ğŸ˜‚",
		iconType:"emoji", eventType:"xiaokule" },
		{ name:"å“ˆå“ˆ", icon:"ğŸ˜ƒ",
		iconType:"emoji", eventType:"haha" },
		{ name:"å¤§ç¬‘", icon:"ğŸ˜„",
		iconType:"emoji", eventType:"daxiao" },
		{ name:"è‹¦ç¬‘", icon:"ğŸ˜…",
		iconType:"emoji", eventType:"kuxiao" },
		{ name:"æ–œçœ¼ç¬‘", icon:"ğŸ˜†",
		iconType:"emoji", eventType:"xieyanxiao" },
		{ name:"å¾®ç¬‘å¤©ä½¿", icon:"ğŸ˜‡",
		iconType:"emoji", eventType:"weixiaotianshi" },
		{ name:"çœ¨çœ¼", icon:"ğŸ˜‰",
		iconType:"emoji", eventType:"zhayan" },
		{ name:"ç¾æ¶©å¾®ç¬‘", icon:"ğŸ˜Š",
		iconType:"emoji", eventType:"xiuseweixiao" },
		{ name:"å‘µå‘µ", icon:"ğŸ™‚",
		iconType:"emoji", eventType:"hehe" },
		{ name:"å€’è„¸", icon:"ğŸ™ƒ",
		iconType:"emoji", eventType:"daolian" },
		{ name:"ç¬‘å¾—æ»¡åœ°æ‰“æ»š", icon:"ğŸ¤£",
		iconType:"emoji", eventType:"xiaodemandidagun" },
	],
	// åŠ å·æ‰©å±•èœå•æ ç›®
	plusMenus:[ 
	    { name:"èŠå¤©è®¾ç½®", icon:"setting-fill", iconType:"uview", eventType:"openMore" },
	    // #ifndef H5
	    { name:"ç›¸å†Œç…§ç‰‡", icon:"photo", iconType:"uview", eventType:"photo" },
	    { name:"æ‹ç…§ç‰‡", icon:"\ue62c", iconType:"custom", eventType:"cameraPhoto" },
	    { name:"æ‹è§†é¢‘", icon:"\ue682", iconType:"custom", eventType:"cameraVideo" },
	    { name:"ç›¸å†Œè§†é¢‘", icon:"\ue66d", iconType:"custom", eventType:"video" },
	    // #endif
		// #ifdef H5
		{ name:"ç…§ç‰‡", icon:"photo", iconType:"uview", eventType:"photo" },
		{ name:"è§†é¢‘", icon:"\ue66d", iconType:"custom", eventType:"video" },
		// #endif
		{ name:"ä½ç½®", icon:"map", iconType:"uview", eventType:"map" },
	    { name:"æˆ‘çš„åç‰‡", icon:"\ue69d", iconType:"custom", eventType:"mingpian" },
		
	],
};
```


## äºŒã€æœç´¢åŠ å¥½å‹åŠŸèƒ½ä¼˜åŒ–
- å…³äº `é¦–é¡µæ¨é€æ¶ˆæ¯ä¸­çš„å¤´åƒæ›´æ–°` ä¸»è¦æ˜¯è°ƒæ•´ä¸€ä¸‹èŠå¤©ç±»æ–‡ä»¶ `/common/js/chatClass.js`çš„ä»£ç ï¼Œå¤§å®¶å¯ä»¥æŠŠæœ€æ–°çš„ä»£ç æ›´æ–°åˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œæœ€æ–°çš„å®Œæ•´ä»£ç æŸ¥çœ‹ï¼š<a href="/thirdless/w-b/11chatClass.jsç±»æ–‡ä»¶å®Œæ•´ä»£ç .html" target="_blank">eggjså³æ—¶é€šè®¯ï¼šç±»æ–‡ä»¶chatClass.jså®Œæ•´ä»£ç </a>

### 1. åœ¨é¡µé¢ `/pages/chat/chat.nvue`
```js
<script>
    ...
	import pageActionJs from '@/pages/chat/pageAction.js';
	export default {
		mixins:[toolJs,plusIconActionJs,pageActionJs],
		...
		onLoad(e) {
			...
			try{
				...
				// æŸ¥è¯¢èŠå¤©å†…å®¹
				...
				
				// æŸ¥ä¸€ä¸‹ç»™å¯¹æ–¹å‘æ¶ˆæ¯çš„æ¡æ•°é™åˆ¶
				if(this.arg && this.arg.chatType == 'single'){
					this.searchChatObjSet();
				}
			}catch{
				...
			}

		},
		...
	}
</script>
```

### 2. æ–°å»ºæ··å…¥æ–‡ä»¶ `/pages/chat/pageAction.js`
```js
import {requestUrl, UserChatSet} from '@/common/mixins/configData.js';
export default {
	methods:{
		// å•èŠæ—¶æŸ¥ä¸€ä¸‹ç»™å¯¹æ–¹å‘æ¶ˆæ¯çš„æ¡æ•°é™åˆ¶å’Œæ˜¯å¦æ˜¯å¥½å‹æƒ…å†µ
		searchChatObjSet(){
			console.log('å•èŠæ—¶æŸ¥ä¸€ä¸‹ç»™å¯¹æ–¹å‘æ¶ˆæ¯çš„æ¡æ•°é™åˆ¶å’Œæ˜¯å¦æ˜¯å¥½å‹æƒ…å†µ',this.me);
			this.initGetUseraSetInfo().then(SetInfo=>{
				console.log('è·å–ç”¨æˆ·è®¾ç½®ä¿¡æ¯', SetInfo);
				// å¦‚æœä¸æ˜¯å¥½å‹
				if(!SetInfo.isgoodfriend){
					if(SetInfo.invite_confirm == 0){
						console.log('å¦‚æœä¸æ˜¯å¥½å‹ï¼Œä½†æ˜¯åŠ å¯¹æ–¹ä¸ºå¥½å‹ï¼Œå¯¹æ–¹åˆä¸ç”¨å®¡æ ¸');
						// åˆ™è‡ªåŠ¨åŠ ä¸ºå¥½å‹
						this.autoAddFriendAndAgree().then(res=>{
							console.log('è‡ªåŠ¨åŠ ä¸ºå¥½å‹', res.data.data);
						});
					}else{
						console.log('å¦‚æœä¸æ˜¯å¥½å‹ï¼Œä½†æ˜¯åŠ å¯¹æ–¹ä¸ºå¥½å‹ï¼Œå¯¹æ–¹è¦å®¡æ ¸ï¼Œæ­¤æ—¶æŸ¥çœ‹èŠå¤©æ¡æ•°',SetInfo.userset);
						let userset = null;
						if(!SetInfo.userset){
							userset = UserChatSet;
						}else{
							userset = JSON.parse(SetInfo.userset);
						}
						console.log('æœ€ç»ˆçš„ç”¨æˆ·è®¾ç½®',userset);
						let sendCount = userset.chatset[this.me.role].sendCount;
						if(sendCount == 1){
							// èŠå¤©ç•Œé¢ç»™ä¸€ä¸ªæç¤º - ä¸éœ€è¦å­˜åœ¨æœ¬åœ°
							let msg = {
								id: 'systemNotice-applyAddfriend',
								from_id: this.me.id,
								from_name: this.me.nickname || this.me.username,
								from_avatar: this.me.avatar,
								to_id: this.arg.id,
								to_name: this.arg.name,
								to_avatar: this.arg.avatar,
								chatType: "single",
								type: "systemNotice",
								data: "æ‚¨å’Œå¯¹æ–¹ä¸æ˜¯å¥½å‹å…³ç³»ï¼Œå¯¹æ–¹åªå…è®¸æ‚¨ç»™ä»–å‘ä¸€æ¡æ¶ˆæ¯",
								chat_time: (new Date()).getTime(),
								redirect:{
									text: 'åŠ ä¸ºå¥½å‹',
									role: this.me.role == 'visitor' ? '[æ¸¸å®¢]' : '[å¹³å°ç”¨æˆ·]',
								},
							};
							let _index = this.chatDataList.findIndex(v => v.id == 'systemNotice-applyAddfriend');
							if(_index == -1){
								this.chatDataList.unshift(msg);
							}
						}
					}
				}
			});
		},
		// è·å–ç”¨æˆ·è®¾ç½®ä¿¡æ¯ - é¡µé¢åˆå§‹åŒ–å°±è¦æ‰§è¡Œ
		async initGetUseraSetInfo(){
			return new Promise((resolve,reject)=>{
				uni.$u.http.post(requestUrl.http + `/api/chat/getUserSetInfo`,{
					userid: this.arg.id,
				},{
					header:{
						token: this.me.token,
					}
				}).then(res=>{
					let UserSetInfo = res.data.data;
					resolve(UserSetInfo);
				});
			});
		},
		// è‡ªåŠ¨åŠ å¯¹æ–¹ä¸ºå¥½å‹å¹¶åŒæ„
		async autoAddFriendAndAgree(){
			return new Promise((resolve,reject)=>{
				// æˆ‘çš„ä¿¡æ¯
				let meInfo = uni.getStorageSync('chatuser');
				meInfo = meInfo ? JSON.parse(meInfo) : '';
				let nickname = ``;
				if(meInfo){
					nickname = meInfo.nickname || meInfo.username;
					nickname += meInfo.role == 'visitor' ? `[æ¸¸å®¢]` : `[å¹³å°æ³¨å†Œç”¨æˆ·]`;
					// äº¤äº’
					uni.$u.http.post(requestUrl.http + `/api/chat/autoAddFriendAndAgree`,{
						friend_id: this.arg.id,
						nickname: `æˆ‘æ˜¯${nickname},ç³»ç»Ÿè‡ªåŠ¨åŠ ä½ ä¸ºå¥½å‹çš„`,
					},{
						header:{
							token: meInfo.token,
						}
					}).then(res=>{
						resolve(res);
					});
				}
			});
		},
		
	}
}
```

### 3. æ•°æ®é…ç½®æ–‡ä»¶å®šä¹‰ç”¨æˆ·è®¾ç½®ä¿¡æ¯
åœ¨æ–‡ä»¶ `/common/mixins/configData.js`
```js
// ç”¨æˆ·è®¾ç½®ä¿¡æ¯
export const UserChatSet = {
	// èŠå¤©ç›¸å…³è®¾ç½®
	chatset: {
		visitor: {
			sendCount:1,
			needFollow:false,
		},
		user:{
			sendCount:1,
			needFollow:false,
		} 
	},
};
```


### 4. åœ¨æ–‡ä»¶ `/pages/userinfo/sendMessage.js`
```js
import {requestUrl, UserChatSet} from '@/common/mixins/configData.js';
...
if(!userset){
    // ç”¨æˆ·æ²¡æœ‰è¿›è¡ŒèŠå¤©çš„è®¾ç½®
    userset = UserChatSet;
}else{
    userset = JSON.parse(userset);
}
...
```


### 5. åœ¨ç»„ä»¶ `/components/chat-item/chat-item.vue`
```js
...
<!-- è¿›ç¾¤é¦–æ¡æ¶ˆæ¯æç¤º -->
<view v-if="item.type == 'systemNotice'"
class="flex flex-column align-center justify-center py-3">
    <text class="font-sm text-light-muted">{{item.data}}</text>
    <view v-if="item.redirect"
    class="flex flex-row align-center justify-center mt-2">
        <text class="font-sm text-primary"
        @click="applyAddFriend">{{item.redirect.text}}</text>
    </view>
</view>
...
// ç”³è¯·åŠ å¯¹æ–¹ä¸ºå¥½å‹
applyAddFriend(){
    console.log('ç”³è¯·åŠ å¯¹æ–¹ä¸ºå¥½å‹',this.item);
    uni.$u.http.post(requestUrl.http + `/api/chat/applyfriend`,{
        friend_id: this.item.to_id,
        nickname: `æˆ‘æ˜¯${this.item.from_name}${this.item.redirect && this.item.redirect.role},ç”³è¯·åŠ ä½ ä¸ºå¥½å‹`,
    },{
        header:{
            token: uni.getStorageSync('chatuser_token'),
        }
    }).then(res=>{
        uni.showToast({title: `ç­‰å¾…å¯¹æ–¹åŒæ„`, icon:'success'});
    }).catch(err=>{
        uni.showToast({title: err.data.data, icon:'none', duration:5000});
    });
},
```






























































































































