---
navbar: true
sidebar: auto
title: 章节11.游客聊天处理
---

## 一、多进程处理前端调整
在项目上线前，为了应对高并发量和高可用性的海量webscoket请求，后端[具体文档查看：<a href="/fourthless/w-a/eggjs.多进程处理.html" target="_blank">eggjs多进程处理</a>]会使用多进程处理，那么对应前端部分基本不用改动什么，只是对有些地方请求websocket的逻辑做一下调整即可。

### 1. 针对登录用户（角色为user的用户）
在类文件 `/common/js/chatClass.js`
```js
    ...
    // 连接websocket
	connectSocket() {
		this.chatSocket = uni.connectSocket({
			// http://192.168.2.7:7001
			// ws://192.168.2.7:7001/ws
			// https://lesson07.51yrc.com
			// wss://lesson07.51yrc.com/ws
			url: this.url + `/ws?token=${this.user.token}`,
			complete: () => {},
			timeout: 10000, // 10秒超时
		});

		// 连接成功
		this.chatSocket.onOpen(() => {
			console.log('websocket连接成功');
			// 调用方法
			this.onOpen();
			//启动心跳
			this.heartbeatTimer = setInterval(() => {
				if (this.chatSocket && this.chatSocket.readyState === 1) {
					// 确保发送的是字符串格式的JSON
					const heartbeatMsg = JSON.stringify({
						type: 'ping',
						token: this.user.token,
						timestamp: Date.now() // 添加时间戳便于调试
					});
					// console.log('发送心跳消息:', heartbeatMsg);
					// this.chatSocket.send(heartbeatMsg);
				}
			}, 5000); // 每隔5秒发送一次心跳
		});
		// 接收信息
		this.chatSocket.onMessage(res => {
			// 处理一下不同平台消息格式
			try {
				const data = typeof res.data === 'string' ?
					JSON.parse(res.data) : res.data;
				console.log('监听接收消息', data);
				// 处理接收的websocket消息
				this.onMessage(data);
				// 如果服务器返回ping
				if (data.type === 'ping') {
					console.log('响应服务器心跳');
					// 响应心跳 -- 自由发挥
				}
			} catch (e) {
				console.error('接收信息错误', e);
			}
		});
		// 断开连接
		this.chatSocket.onClose(res => {
			console.log('断开连接的原因', res);
			// 清除心跳
			clearInterval(this.heartbeatTimer); 
			this.heartbeatTimer = null;
			//调用方法
			this.onClose();
			
			// 对用户做个提示
			if(this.user.role == 'user'){
				// 如果修改服务器代码可能异常关闭1006，这种情况除外
				if(!(res.code && res.code == 1006)){
					uni.showModal({
						title: '账号异地登录',
						content: '您的账号在异地登录，本设备将会退出',
						showCancel: false,
						confirmText: '我知道了',
						success: res => {},
					});
					console.log('则清空本地登录信息，在换成游客模式');
					let _that = this;
					store.dispatch('logoutAction', ()=>{
						_that.doRegisterGuest();
					});
				}else{
					// 尝试重新连接
					setTimeout(() => {
						console.log('断开连接尝试重新连接websocket');
						//dispatch('initChatuserAction');
						this.connectSocket();
					}, 1000);
				}
			}else{
				// 游客尝试重新连接
				setTimeout(() => {
					console.log('断开连接尝试重新连接websocket');
					//dispatch('initChatuserAction');
					this.connectSocket();
				}, 1000);
			}

		});
		// 错误处理
		this.chatSocket.onError(err => {
			console.error('websocket 错误：', err);
			// 清除心跳
			clearInterval(this.heartbeatTimer); 
			this.heartbeatTimer = null;
			//调用方法
			this.onClose();
			
			// 尝试重新连接
			setTimeout(() => {
				console.log('错误处理尝试重新连接websocket');
				//dispatch('initChatuserAction');
				this.connectSocket();
			}, 1000);
		});
	}

    ...

    // 关闭链接
	close() {
		// 用户退出登录
		// 调用socketTask 对象 close方法
		if (this.chatSocket) {
			this.chatSocket.close();
		}
	}
    ...
    // 获取离线消息（不在线的时候别人或者群发的消息）
	chatGetmessageOffLine(){
		uni.$u.http.post(requestUrl.http + `/api/chat/chatGetmessageOffLine`, {}, {
			header: {
				token: this.user.token,
			},
		}).then(res => {
			console.log('服务器返回离线消息', res);
		}).catch(err => {
			console.log('服务器返回离线消息失败', err);
			if(err.data && err.data.data == 'Token 令牌不合法！'){
				if(this.user.role == 'visitor'){
					console.log('游客如果token令牌错误，重新获取token并连接websocket');
					// this.registerGuestAndConnect(); // 游客不需要提示，会自动重连的
				}else if(this.user.role == 'user'){
					console.log('登录用户token不正确，说明在的别的设备登录了，则清空本地登录信息，在换成游客模式');
					store.dispatch('logoutAction', ()=>{
						this.doRegisterGuest();
					});
				}
			}
		});
	}
    ...
```


### 2. 类文件 `/common/js/chatClass.js` 完整代码
具体查看：<a href="/thirdless/w-b/11chatClass.js类文件完整代码.html" target="_blank">类文件 `/common/js/chatClass.js` 完整代码</a>

### 3. 聊天页
在页面 `/pages/chat/chat.nvue`
```js
	<!-- 底部聊天输入区域 --><!-- 修改：添加ref获取textarea实例 -->
	<view v-if="arg.action != 'searhChatData' && arg.id"
	...>
	</view>
	...

	computed:{
		...
		//标题
		pagetitle(){
			if(this.arg && this.arg.name){
				// #ifdef H5 || APP
				if(this.arg.name.length > 15){
					return this.arg.name.substring(0,15) + '...';
				}
				return this.arg.name;
				// #endif
				// #ifdef MP
				if(this.arg.name.length > 5){
					return this.arg.name.substring(0,5) + '...';
				}
				return this.arg.name;
				// #endif
			}
			return ``;
		},
		...
	}
```


## 游客（用户也可以）扫码加入群聊
### 1. H5端扫码（比如用微信扫一扫、手机浏览器等）
说明：
1. 注意H5端打开群二维码，需要用ip地址作为前缀，不要用localhost打开，否则页面无法开发；



























































































