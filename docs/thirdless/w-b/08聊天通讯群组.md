---
navbar: true
sidebar: auto
title: 章节8.聊天通讯（群组）
---

## 九、聊天页设置界面开发和数据渲染
### 1. 聊天页设置相关信息获取
在类文件 `/common/js/chatClass.js`
```js
...
// 聊天页设置相关信息获取
getChatPageSet(to_id, chatType){
    let xiaoxiList = this.getXiaoXiList();
    // 找到当前聊天
    let index = xiaoxiList.findIndex(v => v.id == to_id && v.chatType == chatType);
    if(index != -1){
        // 找到了
        return xiaoxiList[index];
    }
    return null;
}
```

### 2. 进入设置页面
在页面 `/pages/chat/chat.nvue`
```js
//点击了三个点图标
openMore(){
    console.log('点击了三个点图标',this.arg);
    let op = {
        action:'chatpageset',
        title:'设置',
        id: this.arg.id,
        chatType: this.arg.chatType,
        avatar : this.arg.avatar,
        name : this.arg.name,
    };
    uni.navigateTo({
        url: `/pages/setpageInfo/setpageInfo?action=${op.action}&title=${encodeURIComponent(op.title)}&id=${op.id}&chatType=${op.chatType}&avatar=${encodeURIComponent(op.avatar)}&name=${encodeURIComponent(op.name)}`,
    });
},
```

### 3. 设置页面开发
在页面 `/pages/setpageInfo/setpageInfo.vue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		...
		<!-- 内容 -->
		<view>
			<!-- 聊天相关 -->
			...
			<!-- 聊天页设置 -->
			<view v-if="setdata.action == 'chatpageset'">
				<view v-if="chatpageset.id && chatpageset.chatType">
					<!-- 头像部分 -->
				    <view class="flex flex-wrap p-3">
						<!-- 单聊 -->
						<view v-if="chatpageset.chatType == 'single'"
						class="flex flex-column justify-center align-center mr-2">
							<u-avatar :src="chatpageset.avatar" shape="square"
							customStyle="border:1px solid #eeeeee;"></u-avatar>
							<text class="font-sm mt-1 text-muted">{{chatpageset.name}}</text>
						</view>
						<!-- 群聊 循环头像昵称 -->
						<!-- 加人组群 -->
						<view class="border flex align-center justify-center" 
						style="width: 40px;height: 40px;border-style: dashed;"
						@click="clickCell('加人组群', 'addUserToGroup')">
						   <u-icon name="plus" size="24" color="#999999"></u-icon>
						</view>
						<!-- 删除群聊用户 -->
						<view v-if="chatpageset.chatType == 'group'"
						class="border flex align-center justify-center ml-2" 
						style="width: 40px;height: 40px;border-style: dashed;"
						@click="clickCell('群组删除某个用户', 'deleteUserFromGroup')">
						   <u-icon name="minus" size="24" color="#999999"></u-icon>
						</view>
					</view>
					<u-gap height="10" bgColor="#EDEDED"></u-gap>
					<!-- 查找聊天内容 -->
					<u-cell-group>
						<u-cell title="查找聊天内容"
						:border="false" clickable isLink
						:customStyle="customStyles"
						:iconStyle="iconStyles"
						:titleStyle="titleStyles"
						@click="clickCell('查找聊天内容', 'searchChatData')"></u-cell>
					</u-cell-group>
					<u-gap height="10" bgColor="#EDEDED"></u-gap>
					<!-- 消息设置 -->
					<u-cell-group>
						<u-cell title="消息免打扰"
						:border="false" clickable
						:customStyle="customStyles"
						:iconStyle="iconStyles"
						:titleStyle="titleStyles">
						   <view slot="value">
							   <u-switch v-model="chatpageset.nowarn" @change="switchChange('nowarn')"></u-switch>
						   </view>
						</u-cell>
						<u-cell title="置顶聊天"
						:border="false" clickable
						:customStyle="customStyles"
						:iconStyle="iconStyles"
						:titleStyle="titleStyles">
						   <view slot="value">
							   <u-switch v-model="chatpageset.istop" @change="switchChange('istop')"></u-switch>
						   </view>
						</u-cell>
						<u-cell title="提醒"
						:border="false" clickable
						:customStyle="customStyles"
						:iconStyle="iconStyles"
						:titleStyle="titleStyles">
						   <view slot="value">
							   <u-switch v-model="chatpageset.stongwarn" @change="switchChange('stongwarn')"></u-switch>
						   </view>
						</u-cell>
					</u-cell-group>
					<u-gap height="10" bgColor="#EDEDED"></u-gap>
					<!-- 清空聊天记录 -->
					<u-cell-group>
						<u-cell title="清空聊天记录"
						:border="false" clickable 
						:customStyle="customStyles"
						:iconStyle="iconStyles"
						:titleStyle="titleStyles"
						@click="clickCell('清空聊天记录', 'deleteChatData')"></u-cell>
					</u-cell-group>
					<u-gap height="10" bgColor="#EDEDED"></u-gap>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	...
	export default {
		mixins:[toolJs],
		data() {
			return {
				...,
				chatpageset:{},
			}
		},
		onLoad(e) {
			...
			// 动态生成数据
			if(e.action){
				this.setdata.action = e.action;
				if(this.setdata.action == 'chatset'){
					...
				}else if(this.setdata.action == 'chatpageset'){
					this.chatpageset.id = e.id;
					this.chatpageset.chatType = e.chatType;
					this.chatpageset.avatar = decodeURIComponent(e.avatar);
					this.chatpageset.name = decodeURIComponent(e.name);
					// 聊天页设置相关信息获取
					let getChatPageSet = this.chatClass.getChatPageSet(this.chatpageset.id,this.chatpageset.chatType);
					console.log('聊天页设置信息', getChatPageSet);
					// 设置相关
					this.chatpageset = {
						...this.chatpageset,
						// 单聊
						istop: getChatPageSet.istop,
						shownickname: getChatPageSet.shownickname ? true : false,
						nowarn: getChatPageSet.nowarn ? true : false,
						stongwarn: getChatPageSet.stongwarn ? true : false,
						// 群聊还有以下字段
						user_id: 0,
						remark:'',
						invite_confirm: 0,
					};
					console.log('设置相关',this.chatpageset);
					
				}
			}
		},
		computed:{
			...mapState({
				me : state => state.Chatuser.regloginUser,
				chatClass : state => state.Chatuser.chatClass,
			}),
			customStyles(){
				return `padding-top:20rpx;padding-bottom:20rpx`;
			},
			iconStyles(){
				return `font-size:52rpx;margin-right:30rpx;color:#5696da`;
			},
			titleStyles(){
				return `font-size:32rpx;`;
			},
		},
		methods: {
			switchChange(key){
				console.log(`switch开关${key}`, this.chatpageset[key]);
			},
			// 点击某一项
			clickCell(title, type){
				console.log(title, type);
			},
			submitSet(){
				...
			}
		}
	}
</script>

<style>

</style>

```

## 十、添加好友到群聊
### 1. 新增进入聊天页设置的功能入口
考虑到微信小程序和H5（微信打开）没有三个点进入`聊天页设置`, 我们在聊天页扩展菜单新增一个入口。<br/>
在文件 `/pages/chat/plusIconAction.js`
```js
data(){
    return {
	    ...
	    plusMenus:[ // 加号扩展菜单栏目
			{ name:"聊天设置", icon:"setting-fill", iconType:"uview", eventType:"openMore" },
			...
	    ],
	    ...
    }
},
methods:{
	//点击加号扩展菜单的某一项
	async swiperItemClick(item, itemIndex) {
		...
		if (this.sendMessageMode === 'icon') {
			...
		} else {
			...
			switch (item.eventType){
				case 'openMore':
					this.openMore();
					break;
				case 'photo':
					...
					break;
				case 'video':
					...
					break;
				case 'cameraPhoto':
					...
					break;
				case 'cameraVideo':
					...
					break;
				case 'map':
					break;
				case 'mingpian':
					break;
				
			}
		}
	},
	...
},
```

### 2. 聊天页设置点击加号进入添加好友到群聊
在页面 `/pages/setpageInfo/setpageInfo.vue`
```js
clickCell(title, type){
	console.log(title, type);
	if(type == 'addUserToGroup'){
		let op = {
			action:'addUserToGroup',
			title:encodeURIComponent(title),
		};
		uni.navigateTo({
			url: `/pages/friendsList/friendsList?action=${op.action}&title=${op.title}`,
		});
	}
},
```

### 3. 添加好友到群聊页面布局开发
在页面 `/pages/friendsList/friendsList.nvue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		<chat-navbar :title="title" ...></chat-navbar>
		
		<!-- 朋友列表 -->
		<u-index-list :indexList="indexList">
			<view slot="header" class="list" v-if="action == 'friendList'">
				...
			</view>
			<!-- 列表 -->
			<!-- 选择框 -->
			<checkbox-group @change="checkboxChange">
				<template v-for="(item, index) in itemArr">
					<!-- #ifdef APP-NVUE -->
					<u-index-anchor :text="indexList[index]" :key="index"></u-index-anchor>
					<!-- #endif -->
					<u-index-item :key="index">
						<!-- #ifndef APP-NVUE -->
						<u-index-anchor :text="indexList[index]"></u-index-anchor>
						<!-- #endif -->
						<view class="list" v-for="(item1, index1) in item" :key="index1">
							<view class="list__item"
							@click="openUserInfo(item1,'info')">
								<!-- 选择框 -->
								<view class="mr-2">
									<checkbox iconColor="#4cd964" :value="`${item1.id}`"></checkbox>
								</view>
								<image class="list__item__avatar" :src="item1.url"></image>
								<text class="list__item__user-name">{{item1.name}}</text>
							</view>
							<u-line></u-line>
						</view>
					</u-index-item>
				</template>
			</checkbox-group>
			<view slot="footer" ...>
				...
			</view>
		</u-index-list>
		
		<!-- 底部完成选择按钮 -->
		<view v-if="action == 'addUserToGroup'">
			<!-- 占位 -->
			<view :style="btnBottomHeight"></view>
			<!-- 底部按钮 -->
			<view class="position-fixed left-0 right-0 bottom-0 bg-light 
			flex flex-row p-3 align-center justify-end"
			style="z-index: 100;"
			:style="btnBottomStyle">
			    <view style="height: 90rpx;" class="flex flex-row align-center">
					<text v-if="addUserToGroup.userIds"
					class="text-muted flex-shrink mr-2">已选：
					{{addUserToGroup.userIds.length}} 个好友</text>
					<u-button text="确定加入群聊" type="success" 
					@click="btnBottomSubmit"></u-button>
				</view>
			</view>
		</view>
		
	</view>
</template>

<script>
	...
	export default {
		mixins:[toolJs],
		data() {
			return {
				...,
				title:'好友列表',
				action:'friendList',
				bottomSafeAreaHeight:0, // 底部安全距离
				addUserToGroup:{
					userIds:false, // 选择加入群聊的用户id
				}, 
			}
		},
		onLoad(e) {
			...
			
			//选择好友加入群聊
			if(e && e.action == 'addUserToGroup' ){
				this.title = e.title ? decodeURIComponent(e.title) : '选择好友';
				uni.setNavigationBarTitle({title:this.title});
				this.action = 'addUserToGroup';
			}
		},
		onShow() {
			...
		},
		mounted() {
			let info = uni.getSystemInfoSync();
			this.bottomSafeAreaHeight = info.safeAreaInsets.bottom;
	    },
		computed: {
			...mapState({
				...
			}),
			btnBottomStyle(){
				let pbottom = this.bottomSafeAreaHeight == 0 ?
				uni.upx2px(30) : this.bottomSafeAreaHeight + uni.upx2px(30);
				return `padding-bottom: ${pbottom}px;`;
			},
			btnBottomHeight(){
				let pbottom = this.bottomSafeAreaHeight == 0 ?
				uni.upx2px(30) : this.bottomSafeAreaHeight + uni.upx2px(30);
                return `height:${uni.upx2px(30 + 90) + pbottom}px;`;
			},
			itemArr() {
				...
				return newList && newList.map(item => {
					const arr = [];
					for(let i = 0; i < item.list.length; i++){
						...
						arr.push({
							...,
							id: item.list[i].id,
						})
					}
					return arr
				});
			},
			indexList(){
				...
			},
		},
		methods: {
			checkboxChange(e){
				console.log('选择框',e);
				this.addUserToGroup.userIds = e.detail.value;
				console.log('已选',this.addUserToGroup.userIds);
			},
			btnBottomSubmit(){
				if(!this.addUserToGroup.userIds || !this.addUserToGroup.userIds.length){
					return uni.showToast({title: '请选择要加入群聊的好友',icon:'none'});
				}
				let userIds = this.addUserToGroup.userIds.filter(v=> parseInt(v))
				.map(i=> parseInt(i));
				console.log('提交选择的好友加入群聊',userIds);
			},
			...,
			openUserInfo(item1,action){
				if(this.action == 'addUserToGroup') return;
				uni.navigateTo({
					url: `/pages/userinfo/userinfo?uuid=${item1.uuid}`,
				});
			},
		}
	}
</script>

```

## 十一、创建群聊
### 1. 创建群聊接口说明
创建群聊接口，具体查看： <a href="/fourthless/w-a/eggjs.即时通讯接口.html#二十一、创建群聊-成功后通过websocket通知群聊用户" target="_blank">二十一、创建群聊（成功后通过webSocket通知群聊用户）</a>

### 2. 提交创建群聊
在页面 `/pages/friendsList/friendsList.nvue`
```js
btnBottomSubmit(){
	...
	console.log('提交选择的好友加入群聊',userIds);
	uni.showLoading({title: '正在创建中...',mask: false});
	uni.$u.http.post(requestUrl.http + `/api/chat/group/create`, {
		userIds: userIds,
	}, {
		header: {
			token: this.me.token,
		},
	}).then(res => {
		console.log('加入群聊服务器返回',res);
		if(res.data.data == 'ok'){
			uni.switchTab({
				url:'/pages/xiaoxi/xiaoxi'
			});
		}
	}).finally(()=>{
		uni.hideLoading();
	});
},
```
如果没有出现提示，看一下类文件 `/common/js/chatClass.js` 中 方法(`消息页的聊天列表更新一下`)： `updateXiaoXiList` 中有没有添加群聊的逻辑。没有的话，替换到这个方法：<a href="/thirdless/w-b/08聊天通讯.html#六、发消息前把消息添加到本地历史记录-消息页的聊天列表更新一下-发完之后更新一下本地历史记录"  target="_blank">六、发消息前把消息添加到本地历史记录，消息页的聊天列表更新一下，发完之后更新一下本地历史记录</a>

### 3. 创建群聊成功后，消息页通知信息头像、标题等处理
在组件 `/components/chat-chatlist/chat-chatlist.vue`
```vue
<template>
	<view ...>
		<!-- 头像 -->
		<view ...>
			<!-- 头像地址 -->
			<!-- <image :src="item.avatar" mode="widthFix" style="width: 90rpx;height: 90rpx;" 
			class="rounded">
			</image> -->
			<view v-if="avatar">
				<!-- 一张 -->
				<view v-if="avatar.length == 1">
					<!-- <u--image :src="avatar[0]" mode="widthFix"
					width="90rpx" height="90rpx" radius="8rpx"></u--image> -->
					<u-avatar :src="avatar[0]" shape="square" size="90rpx"></u-avatar>
				</view>
				<!-- 多张 -->
				<view v-else style="width: 90rpx;background-color: #eeeeee;"
				class="rounded">
				    <!-- 2张 3张 4张-->
					<view v-if="avatar.length == 2 || avatar.length == 3 || avatar.length == 4"
					class="flex flex-row flex-wrap align-center justify-center"
					style="align-content: center;height:90rpx;">
						<u-avatar v-for="(v,k) in avatar" :key="k"
						:src="v" shape="square" size="45rpx"></u-avatar>
					</view>
					<!-- 5张到9张 -->
					<view v-if="avatar.length >= 5"
					class="flex flex-row flex-wrap align-center justify-center"
					style="align-content: center;height:90rpx;">
						<u-avatar v-for="(v,k) in avatar" :key="k"
						:src="v" shape="square" size="30rpx"></u-avatar>
					</view>
				</view>
			</view>
			<!-- 消息数量 角标-->
			<!-- <text class="bg-danger rounded-circle text-white font-sm position-absolute"
			style="padding-left: 14rpx;padding-right: 14rpx;
			padding-top: 2rpx;padding-bottom: 2rpx;
			top: 16rpx;right:10rpx;z-index: 100;">9</text> -->
			<u-badge :isDot="false" :value="item.datacount" 
			absolute :offset="['10rpx','18rpx']"
			max="999" shape="circle" numberType="limit"></u-badge>
		</view>
		<!-- 右边 -->
		<view class="flex flex-column border-bottom border-light-secondary flex-1 pr-3"
		style="padding-top: 24rpx;padding-bottom: 24rpx;">
			<!-- 上面：昵称 + 时间 -->
			<view class="flex justify-between align-center mb-1">
				<text style="font-size: 32rpx;">{{nickname}}</text>
				<text class="font-small text-light-muted">{{item.chat_time}}</text>
			</view>
			<!-- 下面：聊天内容 -->
			<view class="pr-5">
				<text class="text-light-muted u-line-1" 
				style="font-size: 24rpx;">{{item.data}}</text>
			</view>
		</view>
	</view>
</template>

<script>
	...
	import {requestUrl} from '@/common/mixins/configData.js';
	export default{
		...
		methods:{
			...
		},
		computed:{
			...,
			//昵称显示
			nickname(){
				if(this.item.nickname.length > 15){
					return this.item.nickname.substring(0,15) + '...';
				}
				return this.item.nickname;
			},
			// 头像显示
			avatar(){
				let arr = this.item.avatar && this.item.avatar.split(',');
				arr = arr.map(v => {
					if(v.startsWith('http')){
						return v;
					}else{
						return requestUrl.http + v;
					}
				});
				console.log('头像',arr);
				return arr;
			}
		}
	}
</script>

...
```

## 十二、进入群聊发消息及接收群聊消息
### 1. 点击群聊进入聊天页显示群聊提示
在组件 `/components/chat-item/chat-item.vue`
```vue
<template>
	<view class="px-3">
		<!-- 时间 -->
		<view v-if="chatShowTime"
		class="flex align-center justify-center py-3">
			<text class="font-sm text-light-muted">{{chatShowTime}}</text>
		</view>
		<!-- 撤回消息 -->
		<view v-if="item.isremove"
		class="flex align-center justify-center py-3">
			<text class="font-sm text-light-muted">您撤回了一条信息</text>
		</view>
		<!-- 进群首条消息提示 -->
		<view v-if="item.type == 'systemNotice'"
		class="flex align-center justify-center py-3">
			<text class="font-sm text-light-muted">{{item.nickname + `创建了一个群聊，大家可以聊天了`}}</text>
		</view>
		<!-- 聊天内容 -->
		<view v-if="!item.isremove && item.type != 'systemNotice'"
		class="flex align-start position-relative py-3"
		:class="[!isMe ? 'justify-start' : 'justify-end']">
			<!-- 好友 -->
			<!-- 头像 -->
			...
			<!-- 气泡 -->
			<!-- 三角形 -->
			...
			<!-- 内容 -->
			<view class="flex flex-column">
				<!-- 昵称显示 -->
				<view class="position-absolute"
				style="max-width: 500rpx;top:-36rpx;"
				:style="contentStyle"
				v-if="shownickname"
				:class="[isMe ? 'right-0':'left-0']">
				   <text class="text-light-muted" style="font-size: 20rpx;">{{item.nickname}}</text>
				</view>
				<!-- 消息内容 -->
				...
			</view>
			
			<!-- 我 -->
			...
		</view>
    
	    <!-- 给服务器发消息状态 -->
		...
	
	    <!-- 弹出菜单 -->
	    ...
	
	
	</view>
</template>

<script>
	...
	export default{
		...
		props:{
			...,
			// 是否显示昵称
			shownickname:{
				type: Boolean,
				default: false,
			}
		},
		...
	}
</script>


```

### 2. 聊天页接收消息及标题等处理
在页面 `/pages/chat/chat.nvue`
```vue
<template>
	<view>
		<!-- 导航栏 -->
		<chat-navbar :title="pagetitle" ...>
            ...
		</chat-navbar>
		
		<!-- 聊天内容区域 -->
		...
		
		
		<!-- 底部聊天输入区域 --><!-- 修改：添加ref获取textarea实例 -->
		...
	
	
	    <!-- 弹出菜单 --><!-- 主要修改区域 -->
		...
		 
		<!-- 提示用户正在录音的界面 -->
		...
		 
	</view>
</template>

<script>
    ...
	export default {
		...,
		onLoad(e) {
			...
			try{
				...
				// 监听处理接收到的消息
				uni.$on('onMessage', v => {
					console.log('监听处理接收到的消息在聊天页',v);	
					// 这是私聊的判断
					/*
					if(v.from_id == this.arg.id && v.chatType == this.arg.chatType){
						this.chatDataList.push(this.formatServerMsg(v));
					}
					*/
				    if((v.from_id == this.arg.id && v.chatType == 'single') ||
					(v.chatType == 'group' && this.arg.id == v.to_id)){
						this.chatDataList.push(this.formatServerMsg(v));
					}
				});
			}catch{
				...
			}

		},
		...,
		computed:{
			...mapState({
				...
			}),
			//标题
			pagetitle(){
				if(this.arg && this.arg.name){
					// #ifdef APP || H5
					if(this.arg.name.length > 15){
						return this.arg.name.substring(0,15) + '...';
					}
					return this.arg.name;
					// #endif
					// #ifdef MP
					if(this.arg.name.length > 7){
						return this.arg.name.substring(0,7) + '...';
					}
					return this.arg.name;
					// #endif
				}
				return ``;
			},
			...
			
		},
		
		
	}
</script>

```








































































