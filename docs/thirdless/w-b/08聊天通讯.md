---
navbar: true
sidebar: auto
title: 章节8.聊天通讯
---

## 一、连接即时通讯websocket
### 1. 在初始化登录的时候链接
关于websocket的链接，`uni-app`官网：<https://uniapp.dcloud.net.cn/api/request/websocket.html> <br/>
在 `/store/modules/chatuser.js`文件
```js
import {requestUrl} from '@/common/mixins/configData.js';
export default {
	// 对应的mapState,在computed中引用导入
	// 类似于data,把全局或者公共部分放在这里
	state: {
		...
	},
	// 异步的方法，在methods引入
	actions: {
		//注册登录后续的操作
		...,
		// 用户退出登录
		...,
		// 初始化登录注册状态（避免刷新页面state没有数据）
		initChatuserAction({commit,state,dispatch}) {
			console.log('初始化登录注册状态', state);
			// 给state赋值
			let user = uni.getStorageSync('chatuser') ?
				JSON.parse(uni.getStorageSync('chatuser')) : '';
			if (user) {
				state.regloginUser = user;
				console.log('初始化登录注册状态', state);
				//获取好友申请的信息
				dispatch('getGoodfriendapply');
				// 连接websocket服务
				dispatch('connectWebsocket',user);
			}
		},
		//获取好友申请的信息
		...,
		// 获取好友列表
		...,
		// 连接websocket服务
		connectWebsocket({commit,state,dispatch}, payload = {}){
			// 链接即时通讯websocket
			let chatSocket = uni.connectSocket({
				//http://192.168.2.7:7001
				//ws://192.168.2.7:7001/ws
				url: 'ws' + requestUrl.http.replace('http','').replace('s','') + `/ws?
                token=${payload.token}`,
				complete: () => {},
				timeout: 10000 // 10秒超时
			});
			// 心跳
			let heartbeatTimer = null;
			//链接成功
			chatSocket.onOpen(() => {
			    console.log('websocket链接成功');
			  
			    // 启动心跳
				heartbeatTimer = setInterval(() => {
					if (chatSocket && chatSocket.readyState === 1) {
					  chatSocket.send(JSON.stringify({ type: 'ping' }));
					}
				}, 25000); // 每25秒发送一次心跳
			});
			// 接收信息
			chatSocket.onMessage(res => {
				// 处理不同平台的消息格式
				try {
					const data = typeof res.data === 'string' 
						? JSON.parse(res.data) 
						: res.data;
						
					console.log('websocket接收信息', data);
				
					if (data.type === 'ping') {
						// 响应心跳
						chatSocket.send(JSON.stringify({ type: 'pong' }));
					}
				} catch (e) {
					console.error('消息解析错误', e);
				}
			});
			// 断开连接
			chatSocket.onClose((res) => {
			    console.log('断开连接原因:', res);
			    clearInterval(heartbeatTimer); // 清除心跳
				heartbeatTimer = null;
			  
			    // 尝试重新连接
				setTimeout(() => {
					console.log('尝试重新连接 WebSocket');
					dispatch('initChatuserAction');
				}, 3000);
			});
			// 错误处理
			chatSocket.onError(err => {
				console.error('WebSocket 错误:', err);
				clearInterval(heartbeatTimer);
				heartbeatTimer = null;
				setTimeout(() => {
					console.log('错误处理尝试重新连接 WebSocket');
					dispatch('initChatuserAction');
				}, 5000);
			});
		},
	},
}
```

### 2. 调用类的形式执行websocket
我们可以编写一个类来调用websocket，方便我们后期扩展
### 1. 新建js类文件： `/common/js/chatClass.js`
```js
import {requestUrl} from '@/common/mixins/configData.js';
class chatClass {
	//构造函数
	constructor(){
		// ws地址
		this.url = '';
		if(requestUrl.http.startsWith('http')){
			this.url = 'ws' + requestUrl.http.replace('http','');
		}else if(requestUrl.http.startsWith('https')){
			this.url = 'wss' + requestUrl.http.replace('https','');
		}
		// 是否上线
		this.isOnline = false;
		// socketTask 对象
		this.chatSocket = null;
		// 我的信息vuex或者本地获取
		const user = uni.getStorageSync('chatuser') ?
		JSON.parse(uni.getStorageSync('chatuser')) : '';
		this.user = user;
		// 连接websocket
		if(this.user && this.user.token){
			this.connectSocket();
		}
		// 心跳
		this.heartbeatTimer = null;
	}
	// 连接websocket
	connectSocket(){
		// 链接即时通讯websocket
		this.chatSocket = uni.connectSocket({
			//http://192.168.2.7:7001
			//ws://192.168.2.7:7001/ws
			url: this.url + `/ws?token=${this.user.token}`,
			complete: () => {},
			timeout: 10000 // 10秒超时
		});
		// 心跳
		//let heartbeatTimer;
		//链接成功
		this.chatSocket.onOpen(() => {
		    console.log('websocket链接成功');
		  
		    // 启动心跳
			this.heartbeatTimer = setInterval(() => {
				//（跨平台兼容）小程序环境中没有 WebSocket.OPEN，使用数字 1 表示 OPEN 状态
				if (this.chatSocket && this.chatSocket.readyState === 1) {
				  this.chatSocket.send(JSON.stringify({ type: 'ping' }));
				}
			}, 25000); // 每25秒发送一次心跳
		});
		// 接收信息
		this.chatSocket.onMessage(res => {
			// 处理不同平台的消息格式
		    try {
			    const data = typeof res.data === 'string' 
					? JSON.parse(res.data) 
					: res.data;
					
				console.log('websocket接收信息', data);
			
			    if (data.type === 'ping') {
					// 响应心跳
					this.chatSocket.send(JSON.stringify({ type: 'pong' }));
				}
		    } catch (e) {
			    console.error('消息解析错误', e);
		    }
		});
		// 断开连接
		this.chatSocket.onClose((res) => {
		    console.log('断开连接原因:', res);
		    clearInterval(this.heartbeatTimer); // 清除心跳
		    this.heartbeatTimer = null;
		  
		    // 尝试重新连接
			setTimeout(() => {
				console.log('尝试重新连接 WebSocket');
				//dispatch('initChatuserAction');
				this.connectSocket();
			}, 3000);
		});
		// 错误处理
		this.chatSocket.onError(err => {
			console.error('WebSocket 错误:', err);
			clearInterval(this.heartbeatTimer);
			this.heartbeatTimer = null;
			setTimeout(() => this.connectSocket(), 5000);
		});
	}
}

export default chatClass;
```

### 2. 在vuex中调用
在 `/store/modules/chatuser.js` 中代码
```js
...
import chatClass  from '@/common/js/chatClass.js';
export default {
	// 对应的mapState,在computed中引用导入
	// 类似于data,把全局或者公共部分放在这里
	state: {
		...
	},
	// 异步的方法，在methods引入
	actions: {
		//注册登录后续的操作
		...,
		// 用户退出登录
		...,
		// 初始化登录注册状态（避免刷新页面state没有数据）
		initChatuserAction({commit,state,dispatch}) {
			console.log('初始化登录注册状态', state);
			// 给state赋值
			let user = uni.getStorageSync('chatuser') ?
				JSON.parse(uni.getStorageSync('chatuser')) : '';
			if (user) {
				state.regloginUser = user;
				console.log('初始化登录注册状态', state);
				//获取好友申请的信息
				dispatch('getGoodfriendapply');
				// 连接websocket服务
				// dispatch('connectWebsocket',user);
				// 实例化后自动执行构造函数
				new chatClass(); 
			}
		},
		//获取好友申请的信息
		...,
		// 获取好友列表
		...,
		// 连接websocket服务
		connectWebsocket({commit,state,dispatch}, payload = {}){
			...
		},
	},
}
```




























