---
navbar: true
sidebar: auto
title: 章节8.聊天通讯
---

## 一、连接即时通讯websocket
### 1. 在初始化登录的时候链接
关于websocket的链接，`uni-app`官网：<https://uniapp.dcloud.net.cn/api/request/websocket.html> <br/>
在 `/store/modules/chatuser.js`文件
```js
import {requestUrl} from '@/common/mixins/configData.js';
export default {
	// 对应的mapState,在computed中引用导入
	// 类似于data,把全局或者公共部分放在这里
	state: {
		...
	},
	// 异步的方法，在methods引入
	actions: {
		//注册登录后续的操作
		...,
		// 用户退出登录
		...,
		// 初始化登录注册状态（避免刷新页面state没有数据）
		initChatuserAction({commit,state,dispatch}) {
			console.log('初始化登录注册状态', state);
			// 给state赋值
			let user = uni.getStorageSync('chatuser') ?
				JSON.parse(uni.getStorageSync('chatuser')) : '';
			if (user) {
				state.regloginUser = user;
				console.log('初始化登录注册状态', state);
				//获取好友申请的信息
				dispatch('getGoodfriendapply');
				// 连接websocket服务
				dispatch('connectWebsocket',user);
			}
		},
		//获取好友申请的信息
		...,
		// 获取好友列表
		...,
		// 连接websocket服务
		connectWebsocket({commit,state,dispatch}, payload = {}){
			// 链接即时通讯websocket
			let chatSocket = uni.connectSocket({
				//http://192.168.2.7:7001
				//ws://192.168.2.7:7001/ws
				url: 'ws' + requestUrl.http.replace('http','').replace('s','') + `/ws?
                token=${payload.token}`,
				complete: () => {},
				timeout: 10000 // 10秒超时
			});
			// 心跳
			let heartbeatTimer;
			//链接成功
			chatSocket.onOpen(() => {
			    console.log('websocket链接成功');
			  
			    // 启动心跳
				heartbeatTimer = setInterval(() => {
					if (chatSocket.readyState === WebSocket.OPEN) {
					  chatSocket.send(JSON.stringify({ type: 'ping' }));
					}
				}, 25000); // 每25秒发送一次心跳
			});
			// 接收信息
			chatSocket.onMessage(res => {
			    try {
				    const data = JSON.parse(res.data);
				    console.log('websocket接收信息', data);
				
				    if (data.type === 'ping') {
						// 响应心跳
						chatSocket.send(JSON.stringify({ type: 'pong' }));
					}
			    } catch (e) {
				    console.error('消息解析错误', e);
			    }
			});
			// 断开连接
			chatSocket.onClose((res) => {
			    console.log('断开连接原因:', res);
			    clearInterval(heartbeatTimer); // 清除心跳
			  
			    // 尝试重新连接
				setTimeout(() => {
					console.log('尝试重新连接 WebSocket');
					dispatch('initChatuserAction');
				}, 300000);
			});
		},
	},
}
```