---
navbar: true
sidebar: auto
title: 章节6.播放视频及发视频
---

## 一、消息页视频播放封面开发
素材准备，给大家提供一下视频素材和封面，大家也可以用自己的素材测试
1. 视频素材： `https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/video/videoDemo.mp4`
2. 视频封面素材： `https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/video/videoDemoPoster.jpg`

### 1. 页面补充数据
在页面 `/pages/chat/chat.nvue`
```js
...
{
    avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
    nickname: '小二哥',
    chat_time: 1750148999,
    data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/video/videoDemoPoster.jpg',
    otherData:{
        duration:'1:18', // 时长
        poster:"https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/video/videoDemoPoster.jpg",
        videoData:"https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/video/videoDemo.mp4",
    },
    user_id: 2,
    type:'video', //image,video
    isremove:false,
},
```

### 2. 组件新增视频播放情况
在组件 `/components/chat-item/chat-item.vue`
```vue
<!-- 情况4: 视频  -->
<view v-else-if="item.type == 'video'">
    <chat-item-video-poster :item="item" :index="index">
    </chat-item-video-poster>
</view>
```

### 3. 新增视频封面组件
新增 `/components/chat-item-video-poster/chat-item-video-poster.vue`
```vue
<template>
	<view class="position-relative" @click="openVideoShow">
		<!-- 视频封面 -->
		<chat-item-image :item="item" :index="index"
		imageClass="rounded"
		:maxWidth="300" :maxHeight="400"></chat-item-image>
		<!-- 蒙版 -->
		<view class="position-absolute left-0 right-0 top-0 bottom-0 rounded"
		style="z-index: 98;background-color: rgba(0, 0, 0, 0.4);"></view>
		<!-- 时长 -->
		<view class="position-absolute left-0 top-0 right-0 bottom-0 flex flex-row align-end justify-end mr-1 mb-1" style="z-index: 99;">
			<text class="font-sm text-white">{{item.otherData.duration}}</text>
		</view>
		<!-- 播放图标 -->
		<view class="position-absolute left-0 top-0 right-0 bottom-0 flex flex-row align-center justify-center" style="z-index: 100;">
			<text class="iconfont text-white"
			:style="videoPlayIconStyle">&#xe710;</text>
		</view>
	</view>
</template>

<script>
	export default{
		name:"chat-item-video-poster",
		props:{
			item:Object,
			index:Number,
		},
		data(){
			return {
				// 播放图片大小默认70rpx
				videoPlayIcon:70,
			}
		},
		methods:{
			openVideoShow(){
				//打开视频
				const videoUrl = this.item.otherData.videoData;
				const title = this.item.title || '视频';
				const poster = encodeURIComponent(this.item.otherData.poster || '');
				
				uni.navigateTo({
					url: `/pages/videoShow/videoShow?videoUrl=${videoUrl}&title=${title}&poster=${poster}`,
					animationType:'zoom-fade-out',
				});
			},
		},
		computed:{
			videoPlayIconStyle(){
				return `font-size: ${this.videoPlayIcon}rpx;`;
			}
		}
	}
</script>

<style>
	/* #ifdef H5 */
	@import '/common/css/common.nvue.vue.css';
	/* #endif */
</style>
```

## 二、视频播放页开发
### 1. 新建页面及配置
1. 新建页面  `/pages/videoShow/videoShow.nvue`
2. 配置页面 `pages.json`中
```json
{
	"path" : "pages/videoShow/videoShow",
	"style" : {
		"navigationBarTitleText":"视频播放",
		"app-plus":{
			"scrollIndicator":"none",
			"titleNView":false
		},
		"navigationStyle":"custom"
	}
}
```

### 2. 进入页面传递参数
从组件 `/components/chat-item-video-poster/chat-item-video-poster.vue` 进入
```js
    methods:{
		openVideoShow(){
			//打开视频
			const videoUrl = this.item.otherData.videoData;
			const title = this.item.title || '视频';
			const poster = encodeURIComponent(this.item.otherData.poster || '');
			
			uni.navigateTo({
				url: `/pages/videoShow/videoShow?videoUrl=${videoUrl}&title=${title}&poster=${poster}`,
				animationType:'zoom-fade-out',
			});
		},
	},
```

### 3. 页面视频播放
在页面 `/pages/videoShow/videoShow.nvue`
用到uni-app提供的`<video>`组件：<https://uniapp.dcloud.net.cn/component/video.html>
```vue
<template>
	<view class="position-relative bg-dark">
		<video :src="videoUrl"  autoplay loop  :controls="true" 
		page-gesture show-progress
		enable-play-gesture  :http-cache="true" 
		:show-fullscreen-btn="false"
		x5-video-player-type='h5-page'
		:poster="posterUrl"
		style="width: 750rpx;" :style="'height:'+windowHeight+'px;'" 
		:direction="0" id="myVideo" :title="titleText"
		@ended="videoEnd" 
		@fullscreenchange="fullscreenchange"
		@fullscreenclick="fullscreenclick" 
		@controlstoggle="controlstoggle"
		@loadedmetadata="loadedmetadata">
		    <!-- #ifndef MP -->
		    <cover-view class="text-white position-absolute font-lg" 
			@click="navigateBack"
			style="left: 30rpx;bottom: 140rpx;">
			    <view style="background-color: rgba(255,255,220,0.2);
				height: 60rpx;border-radius: 35rpx;" 
				class="py-1 px-2 justify-center align-center flex flex-row">
					<u-icon name="close" size="18" color="#f9f9f9"></u-icon>
					<text class="font text-white ml-1">关闭视频</text>
				</view>
			</cover-view>
			<!-- #endif -->
		</video>
		<!-- #ifdef MP -->
		<view class="position-absolute" @click="navigateBack"
		style="left: 30rpx;bottom: 140rpx;">
		    <view style="background-color: rgba(255,255,220,0.2);
			height: 60rpx;border-radius: 35rpx;"
		    class="py-1 px-2 justify-center align-center flex flex-row">
		        <u-icon name="close" size="18" color="#f9f9f9"></u-icon>
		    	<text class="font text-white ml-1">关闭视频</text>
		    </view>
		</view>
		<!-- #endif -->
	</view>
</template>

<script>
	import toolJs from '@/common/mixins/tool.js'; 
	export default {
		mixins:[toolJs],
		data() {
			return {
				//避免props冲突
				//uni-app会自动将URL参数注入为页面props，使用同名变量会导致冲突
				//通过重命名变量，明确区分URL参数和本地数据
				//遵循Vue数据流规范：
				//不直接修改props，而是使用本地变量存储需要修改的数据
				//保持单向数据流，避免不可预测的行为
				windowHeight:500,
				// 使用本地变量存储URL参数
				//将 url 改为 videoUrl
				//将 title 改为 titleText
				//将 poster 改为 posterUrl
				videoUrl: '',      // 视频URL
				posterUrl: '',     // 封面URL
				titleText: '',     // 标题文本
			}
		},
		onReady(){
			//动态获取高度
			let res=uni.getSystemInfoSync()
			console.log('onready',res);
			this.windowHeight=res.windowHeight
		},
		onLoad(e) {
			//在 onLoad 中将URL参数赋值给本地变量，而不是直接修改可能作为prop注入的变量
			console.log('到了视频界面', e);
			if(!e.videoUrl || e.videoUrl === ''){
				this.navigateBack();
				return uni.showToast({
					title:'非法视频',
					icon:'none'
				})
			}
			// 将URL参数赋值给本地变量
			this.videoUrl = e.videoUrl;
			
			if(e.title){
				this.titleText = e.title
				uni.setNavigationBarTitle({
					title:this.titleText,
				})
			}
			
			if(e.poster){
				this.posterUrl = decodeURIComponent(e.poster)
				console.log('封面地址',this.posterUrl);
			}
		},
		methods: {
			videoEnd(){
				console.log('视频播放完了');
			},
			fullscreenchange(e){
				console.log('当视频进入和退出全屏时触发',e);
			},
			fullscreenclick(e){
				console.log('视频播放全屏播放时点击事件',e);
			},
			controlstoggle(e){
				console.log('切换 controls 显示隐藏时触发',e.detail);
			},
			loadedmetadata(e){
				console.log('视频元数据加载完成时触发',e.detail);
			}
		}
	}
</script>

<style>
	/* #ifdef H5 */
	@import '/common/css/common.nvue.vue.css';
	/* #endif */
</style>
```