---
navbar: true
sidebar: auto
title: ç« èŠ‚6.åŠ å·æ‰©å±•èœå•åŠŸèƒ½ï¼ˆè¯­éŸ³æ’­æ”¾ï¼‰
---

## ä¸€ã€è¯­éŸ³æ’­æ”¾
å¤§å®¶å¯ä»¥åœ¨ç½‘ä¸Šæ‰¾ä¸€äº›éŸ³é¢‘æµ‹è¯•ï¼Œå¦‚ï¼š<https://aspx.sc.chinaz.com/query.aspx?classid=&keyword=%E5%8D%A1%E5%86%9C> <br/>
ç»™å¤§å®¶å‡†å¤‡äº†å‡ ä¸ªéŸ³é¢‘è¯­éŸ³æµ‹è¯•ï¼š
1. å‘æ¶ˆæ¯æˆåŠŸéŸ³é¢‘: `https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/sendMessage.mp3`
2. æ¥æ”¶æ¶ˆæ¯éŸ³é¢‘ï¼š `https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/getMessage.mp3`
3. å¡é¾™éŸ³ä¹ï¼š`https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/kalong.mp3`
4. å¾®ä¿¡è¯­éŸ³ï¼š `https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/weixinYuYing.mp3`

### 1. åœ¨é¡µé¢è¡¥å……éŸ³é¢‘æ•°æ®å¹¶æµ‹è¯•éŸ³é¢‘æ’­æ”¾
1. åœ¨é¡µé¢ `/pages/chat/chat.nvue` ä¸­è¡¥å……éŸ³é¢‘æ•°æ®
```js
{
    avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
    nickname: 'å°äºŒå“¥',
    chat_time: 1750148979,
    data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/kalong.mp3',
    user_id: 2,
    type:'audio', //image,video
    isremove:false,
},
{
    avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
    nickname: 'å°äºŒå“¥',
    chat_time: 1750148989,
    data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/weixinYuYing.mp3',
    user_id: 2,
    type:'audio', //image,video
    isremove:false,
},
```
2. æ¥å£APIæŸ¥çœ‹  <https://uniapp.dcloud.net.cn/api/#%E5%AA%92%E4%BD%93> <br/>
`æ’­æ”¾éŸ³é¢‘` <https://uniapp.dcloud.net.cn/api/media/audio-context.html> <br/>
åœ¨ç»„ä»¶ `/components/chat-item/chat-item.vue` <br/>
```js
<!-- æƒ…å†µ3: è¯­éŸ³ -->
<view v-else-if="item.type == 'audio'"
class="flex align-center"
@click="playAudio(item,index)">
    <text class="font">43'</text>
</view>
...
<script>
    export default{
        data(){
            return {
                ...
                // éŸ³é¢‘ä¸Šä¸‹æ–‡
                innerAudioContext:null,
                
            }
        },
        destroyed() {
            // é”€æ¯éŸ³é¢‘
            if(this.innerAudioContext){
                this.innerAudioContext.destroy();
                this.innerAudioContext = null;
            }
        },
        methods:{
            // æ’­æ”¾è¯­éŸ³
            playAudio(item,index){
                if(!this.innerAudioContext){
                    this.innerAudioContext = uni.createInnerAudioContext();
                    this.innerAudioContext.src = item.data;
                    this.innerAudioContext.play();
                }
            },
        }
    }
</script>
```

### 2. éŸ³é¢‘åˆ‡æ¢æ’­æ”¾
1. éœ€è¦ç”¨åˆ°vueä¸­çš„çŠ¶æ€ç®¡ç†ï¼š`vuex` (ä¹‹å‰è®²vueåŸºç¡€çš„æ—¶å€™æ²¡æœ‰è®²åˆ°è¿™å—ï¼Œè¿™é‡Œç›´æ¥é€šè¿‡è®²éŸ³é¢‘åˆ‡æ¢æ’­æ”¾æ¥è®²è§£vuexçš„ä½¿ç”¨) <https://uniapp.dcloud.net.cn/tutorial/vue-vuex.html> <br/>
2. `uni-app`å®˜æ–¹æä¾›äº†å…±äº«å˜é‡å’Œæ•°æ®çš„æ–¹æ¡ˆï¼Œå…¶ä¸­å°±åŒ…æ‹¬ `vuex` <https://uniapp.dcloud.net.cn/tutorial/nvue-api.html#sharevar>

#### â‘  å­¦ä¼šå¦‚ä½•åœ¨uni-appä¸­å¼•å…¥å’Œä½¿ç”¨vuexçš„åŸºæœ¬ç”¨æ³•
##### 1. ç»„è£…æ¨¡å—å¹¶å¯¼å‡º store çš„åœ°æ–¹
æ–°å»º `/store/index.js`
```js
import Vue from 'vue';
import Vuex from 'vuex';

Vue.use(Vuex);

export default new Vuex.Store({
	// å¯¹åº”mapStateï¼Œåœ¨computedä¸­å¼•å…¥
    // ç±»ä¼¼data,æŠŠå…¨å±€æˆ–å…±ç”¨éƒ¨åˆ†æ”¾è¿™é‡Œ
	state:{
		testVuex:'å³æ—¶é€šè®¯',
	}
});
```

##### 2. åœ¨ `main.js` ä¸­å¼•å…¥å¹¶ä½¿ç”¨store
```js
import App from './App'

// #ifndef VUE3
import Vue from 'vue'
import Store from './store'; // å¼•å…¥vuex

Vue.prototype.$store = Store; // æŒ‚è½½åˆ°vueçš„åŸå‹è¿›è¡Œå…±äº«

// main.js
...
const app = new Vue({
  Store, //vuex
  ...App
})
app.$mount()
// #endif

// #ifdef VUE3
...
// #endif
```

##### 3. åœ¨é¡µé¢æˆ–è€…ç»„ä»¶ä¸­ä½¿ç”¨vuex
å¦‚ï¼Œåœ¨ç»„ä»¶ `/components/chat-item/chat-item.vue`
```vue
<script>
	...
	import { mapState } from 'vuex';
	export default{
        computed:{
			//vuexçš„stateæ•°æ®
			...mapState({
				testVuexValue: state => state.testVuex,
			}),
        },
        mounted() {
			console.log('çœ‹ä¸€ä¸‹vuexä¸­stateçš„å€¼',this.testVuexValue);
		},
    }
</script>
```

##### 4. vuex åˆ†æ¨¡å—ç®¡ç†
è¯´æ˜ï¼š<br/>
æˆ‘ä»¬åœ¨ç¬¬äºŒå­¦æœŸç¬¬äºŒå­£è¯¾ç¨‹é‡Œé¢è®²vue.jsåŸºç¡€çš„æ—¶å€™ï¼Œæ²¡æœ‰è®²åˆ°vuexï¼Œæ‰€ä»¥åŒå­¦ä»¬åˆšå¼€å§‹å­¦ä¹ çš„æ—¶å€™ï¼Œä¼šæœ‰äº›å¬ä¸æ‡‚ï¼Œè¿™ä¸ªæ²¡å…³ç³»ï¼Œä½ å¤šå¬å‡ éï¼Œç„¶åè·Ÿç€è€å¸ˆæ•²ä»£ç ï¼Œçœ‹å¦‚ä½•å¼•å…¥vuexå’Œä½¿ç”¨ï¼Œå¤šæ•²ä¸¤éä½ å°±ç†Ÿç»ƒäº†ï¼Œå…³äºvuexçš„æ›´å¤šç”¨æ³•æˆ‘ä»¬åœ¨åé¢çš„è¯¾ç¨‹ä¹Ÿä¼šæ·±å…¥è®²è§£ï¼Œç›®å‰å¤§å®¶åªéœ€è¦è·Ÿç€è€å¸ˆæ•²ä»£ç å­¦ä¼šä½¿ç”¨å³å¯ã€‚<br/>

æ–°å»ºæ¨¡å—æ–‡ä»¶å¤¹ï¼Œè¿›è¡Œæ¨¡å—ç®¡ç† `/store/modules/audio.js` 
1. `modules`æ¨¡å—æ–‡ä»¶å¤¹ 
2. `audio.js`è¯­éŸ³ï¼ˆéŸ³é¢‘ï¼‰æ¨¡å—
##### â‘  `/store/modules/audio.js` è¯­éŸ³ï¼ˆéŸ³é¢‘ï¼‰æ¨¡å—
```js
export default {
	// å¯¹åº”çš„mapState,åœ¨computedä¸­å¼•å…¥
    // ç±»ä¼¼data,æŠŠå…¨å±€æˆ–å…±ç”¨éƒ¨åˆ†æ”¾è¿™é‡Œ
	state:{
		testVuex:'å³æ—¶é€šè®¯',
	},
}
``` 
##### â‘¡ `/store/index.js` ç»„è£…æ¨¡å—å¹¶å¯¼å‡º store çš„åœ°æ–¹
```js
import Vue from 'vue';
import Vuex from 'vuex';

Vue.use(Vuex);

// å¼•å…¥éŸ³é¢‘æ¨¡å—
import Audio from '@/store/modules/audio.js';

export default new Vuex.Store({
	// å¯¹åº”çš„mapState,åœ¨computedä¸­å¼•å…¥
	// state:{
	// 	testVuex:'å³æ—¶é€šè®¯',
	// },
	// å¼•å…¥æ¨¡å—
	modules:{
		Audio, // å¼•å…¥éŸ³é¢‘æ¨¡å—
	}
});
```
##### â‘¢ ç»„ä»¶æˆ–è€…é¡µé¢ä½¿ç”¨ vuex
å¦‚ç»„ä»¶ `/components/chat-item/chat-item.vue`
```vue
<script>
	...
	import { mapState,mapGetters,mapMutations } from 'vuex';
	export default{
        computed:{
			//vuexçš„stateæ•°æ®
			...mapState({
				// testVuexValue: state => state.testVuex,// ä¸»æ–‡ä»¶index.jsä¸­æ‹¿state
				testVuexValue:state=>state.Audio.testVuex,// æ¨¡å—æ‹¿
			}),
        },
        mounted() {
			console.log('çœ‹ä¸€ä¸‹vuexä¸­stateçš„å€¼',this.testVuexValue);
		},
    }
</script>
```

##### 5. éŸ³é¢‘åˆ‡æ¢æ’­æ”¾ï¼ˆæ’­æ”¾æŸä¸ªéŸ³é¢‘åœæ­¢å…¶å®ƒéŸ³é¢‘ï¼‰
åˆ†æï¼šæˆ‘ä»¬å¸Œæœ›å½“æˆ‘ç‚¹å‡»æŸä¸ªéŸ³é¢‘çš„æ—¶å€™ï¼Œå…¶å®ƒéŸ³é¢‘åœæ­¢æ’­æ”¾ï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬éœ€è¦é€šçŸ¥å¤šä¸ªå…¶å®ƒéŸ³é¢‘ç»„ä»¶å…¨éƒ¨åœæ­¢æ’­æ”¾ï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œä¸èƒ½å•çº¯ä½¿ç”¨`this.$emit`ï¼Œè€Œæ˜¯è¦è¿›è¡Œå…¨å±€é€šçŸ¥ï¼Œ`uni-app`æä¾›äº†å…¨å±€é€šçŸ¥`uni.$emit`,å…¨éƒ¨ç›‘å¬`uni.$on`ï¼Œå…·ä½“æŸ¥çœ‹ï¼š<https://uniapp.dcloud.net.cn/api/window/communication.html>

### â‘  æ–¹å¼ä¸€ï¼š vuexå…¨å±€ç›‘å¬ï¼ˆäº†è§£ï¼‰
> æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹vuexå¦‚ä½•åœ¨éŸ³é¢‘åˆ‡æ¢ä¸­ä½¿ç”¨ï¼Œéœ€è¦ç”¨åˆ°vuexä¸­çš„`mutations` `åŒæ­¥ä¸€äº›æ–¹æ³•`ï¼ˆåœ¨`methods`ä¸­å¼•å…¥ï¼‰ <br/> (å¼‚æ­¥ä¸€äº›æ–¹æ³• `actions`)  
>> 1. éŸ³é¢‘æ¨¡å—ä»£ç  `/store/modules/audio.js`
>> ```js
>> export default {
>> 	// å¯¹åº”çš„mapState,åœ¨computedä¸­å¼•å…¥
>> 	// ç±»ä¼¼data,æŠŠå…¨å±€æˆ–å…±ç”¨éƒ¨åˆ†æ”¾è¿™é‡Œ
>> 	state:{
>> 		testVuex:'å³æ—¶é€šè®¯',
>> 		// å‚¨å­˜å…¨å±€äº‹ä»¶åç§°çš„æ•°ç»„
>> 		eventNames:[],
>> 	},
>> 	// åŒæ­¥ä¸€äº›æ–¹æ³•
>> 	mutations:{
>> 		// å†™ä¸€ä¸ªæ³¨å†Œå…¨å±€äº‹ä»¶çš„å‡½æ•°ï¼ˆæ–¹æ³•ï¼‰
>> 		regGlobalEvent(state,eventName){
>> 			// å¦‚æœç”¨æˆ·è°ƒç”¨äº†mutationsé‡Œé¢çš„æ–¹æ³•
>> 			// æŠŠç”¨æˆ·è°ƒç”¨çš„è¿™ä¸ªæ–¹æ³•åç§°å­˜è¿›stateä¸­çš„eventNamesæ•°ç»„
>> 			console.log('æ³¨å†Œå…¨å±€äº‹ä»¶:' + eventName);
>> 			state.eventNames.push(eventName);
>> 		},
>> 		// æ‰§è¡Œå…¨å±€äº‹ä»¶å‡½æ•°ï¼ˆæ–¹æ³•ï¼‰æ¯ä¸ªeventName
>> 		executeEventName(state,params){
>> 			state.eventNames.forEach(eventName=>{
>> 				eventName(params);
>> 			});
>> 		},
>> 		// æ³¨æ„å…¨å±€äº‹ä»¶ä¸ç”¨è¦åŠæ—¶æ³¨é”€ç§»é™¤
>> 		removeEventName(state,eventName){
>> 			// å…ˆæ‰¾åˆ°å¯¹åº”äº‹ä»¶ï¼ˆæ–¹æ³•ï¼‰
>> 			let index = state.eventNames.
>> 			findIndex(ename => ename === eventName);
>> 			// å¦‚æœæ‰¾åˆ°äº†äº‹ä»¶ï¼ˆæ–¹æ³•ï¼‰ï¼Œåˆ™åˆ é™¤è¿™ä¸ªäº‹ä»¶ï¼ˆæ–¹æ³•ï¼‰
>> 			if(index > -1){
>>              console.log('æ³¨é”€ç§»é™¤äº†äº‹ä»¶:' + eventName);
>> 				state.eventNames.splice(index,1);
>> 			}
>> 		},
>> 	},
>> 	// å¼‚æ­¥ä¸€äº›æ–¹æ³•
>> 	actions:{
>> 		// å¤„ç†regGlobalEventè¿™äº›å‡½æ•°ï¼ˆæ–¹æ³•ï¼‰
>> 		$onGlobalEvent({commit},eventName){
>> 			commit('regGlobalEvent',eventName);
>> 		},
>> 		// æ‰§è¡ŒexecuteEventNameå‡½æ•°ï¼ˆæ–¹æ³•ï¼‰
>> 		$emitEventName({commit},params){
>> 			commit('executeEventName',params);
>> 		},
>> 		// æ‰§è¡ŒremoveEventNameå‡½æ•°ï¼ˆæ–¹æ³•ï¼‰
>> 		$offEventName({commit},eventName){
>> 			commit('removeEventName',eventName);
>> 		},
>> 	},
>> }
>> ```
>> 2. åœ¨ç»„ä»¶è°ƒç”¨ `/components/chat-item/chat-item.vue`
>> ```vue
>> <template>
>> 	<view class="px-3">
>> 		...
>> 	</view>
>> </template>
>> 
>> <script>
>> 	...
>> 	import {mapState,mapGetters,mapMutations,mapActions} from 'vuex';
>> 	export default{
>> 		...,
>> 		data(){
>> 			return {
>> 				...,
>> 				// éŸ³é¢‘ä¸Šä¸‹æ–‡
>> 				innerAudioContext:null,
>> 			}
>> 		},
>> 		computed:{
>> 			...mapState({
>> 				// testVuexValue:state=>state.testVuex, // ä¸»æ–‡ä»¶æ‹¿
>> 				testVuexValue:state=>state.Audio.testVuex,// æ¨¡å—æ‹¿
>> 			}),
>> 			...,
>> 		},
>> 		mounted() {
>> 			// æ‰§è¡Œvuexä¸­actionsé‡Œé¢çš„æ–¹æ³•
>> 			/*
>> 			this.$onGlobalEvent(res=>{
>> 				console.log('æ‰§è¡Œvuexä¸­actionsé‡Œé¢çš„æ–¹æ³•',res);
>> 			});
>> 			*/
>> 		    /*
>> 		    if(this.item.type == 'audio'){
>> 				this.$onGlobalEvent(res=>{
>> 					console.log('æ‰§è¡Œvuexä¸­actionsé‡Œé¢çš„æ–¹æ³•',res);
>> 				});
>> 			}
>> 			*/
>> 		    if(this.item.type == 'audio'){
>> 				// ç›‘å¬æ’­æ”¾è¯­éŸ³çš„å…¨å±€äº‹ä»¶
>> 				this.$onGlobalEvent(this.onplayAudio);
>> 			}
>> 			
>> 			console.log('vuexä¸­çš„stateçš„å€¼',this.testVuexValue);
>> 		},
>> 		destroyed() {
>> 			//æ³¨é”€æ’­æ”¾è¯­éŸ³çš„å…¨å±€äº‹ä»¶
>> 			this.$offEventName(this.onplayAudio);
>> 			//é”€æ¯éŸ³é¢‘
>> 			if(this.innerAudioContext){
>> 				this.innerAudioContext.destroy();
>> 				this.innerAudioContext = null;
>> 			}
>> 		},
>> 		methods:{
>> 			//å¼•å…¥actionsé‡Œé¢çš„æ–¹æ³•
>> 			...mapActions(['$onGlobalEvent','$emitEventName','$offEventName']),
>> 			//æ’­æ”¾è¯­éŸ³çš„å…¨å±€äº‹ä»¶
>> 			onplayAudio(res){
>> 				console.log('æ‰§è¡Œvuexä¸­actionsé‡Œé¢çš„æ–¹æ³•',res);
>> 			},
>> 			//æ’­æ”¾è¯­éŸ³
>> 			playAudio(item,index){
>> 				this.$emitEventName('æ‰§è¡Œä¸€ä¸ªå…¨å±€äº‹ä»¶ä¼ è¦æ’­æ”¾éŸ³é¢‘çš„ç´¢å¼•:' + index);
>> 				return;
>> 				if(!this.innerAudioContext){
>> 					this.innerAudioContext = uni.createInnerAudioContext();
>> 					this.innerAudioContext.src = item.data;
>> 					this.innerAudioContext.play();
>> 				}
>> 			},
>> 			...,
>> 		}
>> 	}
>> </script>
>> 
>> ```

### â‘¡ æ–¹å¼äºŒï¼šuni-appæä¾›çš„å…¨å±€äº‹ä»¶
> åœ¨ç»„ä»¶è°ƒç”¨ `/components/chat-item/chat-item.vue`
>> ```vue
>> <template>
>> 	<view class="px-3">
>> 		...
>> 	</view>
>> </template>
>> 
>> <script>
>> 	...
>> 	import {mapState,mapGetters,mapMutations,mapActions} from 'vuex';
>> 	export default{
>> 		...,
>> 		data(){
>> 			return {
>> 				...,
>> 				// éŸ³é¢‘ä¸Šä¸‹æ–‡
>> 				innerAudioContext:null,
>> 			}
>> 		},
>> 		computed:{
>> 			...mapState({
>> 				// testVuexValue:state=>state.testVuex, // ä¸»æ–‡ä»¶æ‹¿
>> 				testVuexValue:state=>state.Audio.testVuex,// æ¨¡å—æ‹¿
>> 			}),
>> 			...,
>> 		},
>> 		mounted() {
>> 			// æ‰§è¡Œvuexä¸­actionsé‡Œé¢çš„æ–¹æ³•
>> 			/*
>> 			this.$onGlobalEvent(res=>{
>> 				console.log('æ‰§è¡Œvuexä¸­actionsé‡Œé¢çš„æ–¹æ³•',res);
>> 			});
>> 			*/
>> 		    /*
>> 		    if(this.item.type == 'audio'){
>> 				this.$onGlobalEvent(res=>{
>> 					console.log('æ‰§è¡Œvuexä¸­actionsé‡Œé¢çš„æ–¹æ³•',res);
>> 				});
>> 			}
>> 			*/
>> 		    if(this.item.type == 'audio'){
>> 				// ç›‘å¬æ’­æ”¾è¯­éŸ³çš„å…¨å±€äº‹ä»¶
>> 				//this.$onGlobalEvent(this.onplayAudio);
>>              uni.$on('onplayAudio',res=>{
>> 					console.log('çœ‹ä¸€ä¸‹uni.$onç›‘å¬ç»“æœ',res);
>> 					this.onplayAudio(res);
>> 				});
>> 			}
>> 			
>> 			console.log('vuexä¸­çš„stateçš„å€¼',this.testVuexValue);
>> 		},
>> 		destroyed() {
>> 			//æ³¨é”€æ’­æ”¾è¯­éŸ³çš„å…¨å±€äº‹ä»¶
>> 			//this.$offEventName(this.onplayAudio);
>>          uni.$off('onplayAudio');
>> 			//é”€æ¯éŸ³é¢‘
>> 			if(this.innerAudioContext){
>> 				this.innerAudioContext.destroy();
>> 				this.innerAudioContext = null;
>> 			}
>> 		},
>> 		methods:{
>> 			//å¼•å…¥actionsé‡Œé¢çš„æ–¹æ³•
>> 			...mapActions(['$onGlobalEvent','$emitEventName','$offEventName']),
>> 			//æ’­æ”¾è¯­éŸ³çš„å…¨å±€äº‹ä»¶
>> 			onplayAudio(res){
>> 				console.log('æ‰§è¡Œvuexä¸­actionsé‡Œé¢çš„æ–¹æ³•',res);
>>              if(this.innerAudioContext){
>>					// åœæ­¢éç‚¹å‡»æ’­æ”¾çš„éŸ³é¢‘
>>					if(this.index !== res){
>>						this.innerAudioContext.stop();
>>					}
>>				}
>> 			},
>> 			//æ’­æ”¾è¯­éŸ³
>> 			playAudio(item,index){
>> 				//this.$emitEventName('æ‰§è¡Œä¸€ä¸ªå…¨å±€äº‹ä»¶ä¼ è¦æ’­æ”¾éŸ³é¢‘çš„ç´¢å¼•:' + index);
>> 				//return;
>>              // é€šçŸ¥å…¶å®ƒéç‚¹å‡»æ’­æ”¾çš„éŸ³é¢‘åœæ­¢æ’­æ”¾
>>				//this.$emitEventName(index);
>>				uni.$emit('onplayAudio',{index:index});
>> 				if(!this.innerAudioContext){
>> 					this.innerAudioContext = uni.createInnerAudioContext();
>> 					this.innerAudioContext.src = item.data;
>> 					this.innerAudioContext.play();
>> 				}else{
>>					this.innerAudioContext.stop();
>>					this.innerAudioContext.play();
>>				}
>> 			},
>> 			...,
>> 		}
>> 	}
>> </script>
>> 
>> ```

## äºŒã€ è§£å†³ä¸€ä¸ªbugï¼šå‘å›¾ç‰‡åœ¨å°ç¨‹åºä¸Šä¸å…¼å®¹çš„é—®é¢˜
åœ¨ç»„ä»¶è°ƒç”¨ `/components/chat-item-image/chat-item-image.vue`
```vue
<template>
	<view>
		<!-- ä½¿ç”¨u--imageç»„ä»¶å›ºå®šå®½é«˜æ˜¾ç¤ºå›¾ç‰‡ -->
		<!-- <u--image showMenuByLongpress showLoading
		:src="item.data" mode="aspectFill"                    
		width="260rpx" height="150px" radius="10rpx"
		@click="previewImage(item,index)"
		@load="handleImageLoad($event,item,index)"></u--image> -->
		<!-- è®¡ç®—å®½é«˜è‡ªé€‚åº”æ˜¾ç¤ºå›¾ç‰‡ -->
		<!-- <image :src="item.data"
		lazy-load mode="widthFix"
		:style="imageShowStyle"
		class="rounded"
		@click="previewImage(item,index)"
		@load="auto_handleImageLoad($event,item,index)"></image> -->
		<!-- ä¼˜åŒ–åçš„æ–¹æ¡ˆ-å°ç¨‹åºä¸å…¼å®¹ -->
		<!-- <image lazy-load :mode="imageMode"
		:src="item.data"
		:style="getImageStyle(index)"
		:class="imageClass"
		@click="$emit('click')"
		@load="handleImageLoad($event,item,index)"></image> -->
		<!-- æœ€ç»ˆæ–¹æ¡ˆ å¤šç«¯å…¼å®¹ -->
		<image lazy-load :mode="imageMode"
		:src="item.data"
		:style="computedStyles[index]"
		:class="imageClass"
		@click="$emit('click')"
		@load="good_handleImageLoad($event,item,index)"></image>
	</view>
</template>

<script>
	export default{
		name:"chat-item-image",
		props:{
			item:Object,
			index:Number,
			// class
			imageClass:{
				type:String,
				default:'rounded'
			},
			//æœ€å¤§å®½åº¦é»˜è®¤300rpx
			maxWidth:{
				type:Number,
				default:300
			},
			// æœ€å¤§é«˜åº¦é»˜è®¤400rpx
			maxHeight:{
				type:Number,
				default:400
			}
		},
		data(){
			return {
				// æ¶ˆæ¯å›¾
				width:120,
				height:120,
				imageSizes: {}, // å­˜å‚¨æ¯ä¸ªå›¾ç‰‡çš„è®¡ç®—å°ºå¯¸
				imageMode: 'widthFix' // å›¾ç‰‡æ¨¡å¼
			}
		},
		computed:{
			// å›¾ç‰‡ç­‰æ¯”ä¾‹å±•ç¤º
			imageShowStyle(){
				return `width:${this.width}px;height: ${this.height}px;`;
			},
			// æœ€ç»ˆæ–¹æ¡ˆ ä¸ºæ¯ä¸ªç´¢å¼•åˆ›å»ºè®¡ç®—å±æ€§
			computedStyles() {
				const styles = {};
				
				// éå†æ‰€æœ‰å·²è®¡ç®—å°ºå¯¸çš„å›¾ç‰‡
				for (const index in this.imageSizes) {
					const size = this.imageSizes[index];
					
					// åˆ›å»ºå¸¦å•ä½çš„æ ·å¼å­—ç¬¦ä¸²
					styles[index] = {
						width: `${size.width}px`,
						height: `${size.height}px`
					};
				}
				
				return styles;
			}
		},
		methods:{
			// åŠ è½½é¢„è§ˆå›¾ç‰‡å¹¶åšè‡ªé€‚åº”å¤„ç†
			auto_handleImageLoad(e,item,index){
				console.log('åŠ è½½é¢„è§ˆå›¾ç‰‡event',e);
				console.log('åŠ è½½é¢„è§ˆå›¾ç‰‡item,index',item,index);
				let width =  e.detail.width;
				let height = e.detail.height;
				// èŠå¤©ç•Œé¢æ˜¾ç¤ºå›¾ç‰‡ å®šä¹‰ä¸€ä¸ªæœ€å¤§å®½åº¦300rpx
				let maxWidth = uni.upx2px(300);
				// æŒ‰ç…§æœ€å¤§å®½åº¦300rpx è®¡ç®—æœ€å¤§å¯æ˜¾ç¤ºçš„é«˜åº¦
				// if(width <= maxWidth){
				// 	//å°±ç”¨å®é™…å®½é«˜
				// 	this.width = width;
				// 	this.height = heigth;
				// 	return;
				// }
				// this.width = maxWidth;
				// //width / height = maxWidth / maxHeight;
				// let maxHeight = maxWidth * (height / width);
				// this.height = maxHeight;
				// æŒ‰ç…§æœ€å¤§é«˜åº¦400rpx æ¥è®¡ç®—ä¸€ä¸‹å®½åº¦
				let maxHeight = uni.upx2px(400);
				// if(height <= maxHeight && width <= maxWidth){
				// 	this.width = width;
				// 	this.height = heigth;
				// 	return;
				// }
				// this.height = maxHeight;
				// // height / width = maxHeight / maxWidth;
				// this.width = maxHeight * (width/height);
				// éœ€è¦è€ƒè™‘ å½“å›¾ç‰‡è¾¾åˆ°æœ€å¤§é«˜åº¦ï¼Œè®¡ç®—çš„å®½åº¦ä¹Ÿè¶…è¿‡æœ€å¤§å®½åº¦
				if(height <= maxHeight){
					this.width = width <= maxWidth ? width : maxWidth;
					this.height = heigth;
					return;
				}
				this.height = maxHeight;
				let _width = maxHeight * (width/height);
				this.width = _width <= maxWidth ? _width : maxWidth;
			},
			// ä¼˜åŒ–åçš„å›¾ç‰‡å±•ç¤º
			handleImageLoad(e, item, index) {
			  const { width: originWidth, height: originHeight } = e.detail;
			  const maxWidth = uni.upx2px(this.maxWidth); // æœ€å¤§å®½åº¦300rpxè½¬px
			  const maxHeight = uni.upx2px(this.maxHeight); // æœ€å¤§é«˜åº¦400rpxè½¬px
			  
			  // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
			  const widthRatio = maxWidth / originWidth;
			  const heightRatio = maxHeight / originHeight;
			  const ratio = Math.min(widthRatio, heightRatio, 1); // å–æœ€å°æ¯”ä¾‹ä¸”ä¸è¶…è¿‡1
			  
			  // è®¡ç®—æœ€ç»ˆå°ºå¯¸
			  let width = originWidth * ratio;
			  let height = originHeight * ratio;
			  
			  // ç¡®ä¿å°ºå¯¸ä¸è¶…è¿‡æœ€å¤§å€¼
			  if (width > maxWidth) width = maxWidth;
			  if (height > maxHeight) height = maxHeight;
			  
			  // å­˜å‚¨è®¡ç®—åçš„å°ºå¯¸
			  this.$set(this.imageSizes, index, {
				width,
				height
			  });
			  
			  // è®¾ç½®å›¾ç‰‡æ¨¡å¼ï¼šå®½>é«˜æ—¶ä½¿ç”¨aspectFitï¼Œå¦åˆ™ä½¿ç”¨widthFix
			  //if (originWidth > originHeight) {
				//this.imageMode = 'aspectFit';
			  //} else {
				//this.imageMode = 'widthFix';
			  //}
			},
			// ä¼˜åŒ–åçš„è·å–å›¾ç‰‡æ ·å¼
			getImageStyle(index) {
			  const size = this.imageSizes[index] || {};
			  return {
				width: size.width ? `${size.width}px` : '120px',
				height: size.height ? `${size.height}px` : '120px'
			  };
			},
            // æœ€ç»ˆæ–¹æ¡ˆ å¤šç«¯å…¼å®¹
		    good_handleImageLoad(e, item, index) {
				const { width: originWidth, height: originHeight } = e.detail;
				const maxWidth = uni.upx2px(this.maxWidth);
				const maxHeight = uni.upx2px(this.maxHeight);
				
				// è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
				const widthRatio = maxWidth / originWidth;
				const heightRatio = maxHeight / originHeight;
				const ratio = Math.min(widthRatio, heightRatio, 1);
				
				// è®¡ç®—æœ€ç»ˆå°ºå¯¸
				let width = Math.floor(originWidth * ratio);
				let height = Math.floor(originHeight * ratio);
				
				// ç¡®ä¿å°ºå¯¸ä¸è¶…è¿‡æœ€å¤§å€¼
				if (width > maxWidth) width = maxWidth;
				if (height > maxHeight) height = maxHeight;
				
				// å­˜å‚¨è®¡ç®—åçš„å°ºå¯¸
				this.$set(this.imageSizes, index, {
					width,
					height
				});
			}
		}
	}
</script>

<style>
	/* #ifdef H5 */
	@import '/common/css/common.nvue.vue.css';
	/* #endif */
	/* æœ€ç»ˆæ–¹æ¡ˆ é»˜è®¤å›¾ç‰‡æ ·å¼ */
	/* #ifndef APP-PLUS-NVUE */
	image {
		width: 120px;
		height: 120px;
		border-radius: 10rpx;
	}
	/* #endif */
</style>
```


## ä¸‰ã€æ’­æ”¾è¯­éŸ³æœ‰åŠ¨ç”»æç¤ºå¹¶å°†è¯­éŸ³æ’­æ”¾å°è£…æˆç»„ä»¶
ç´ æå¦‚ä¸‹ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥è‡ªå·±åˆ¶ä½œç´ æï¼š
1. `æˆ‘`æ²¡æœ‰æ’­æ”¾è¯­éŸ³æ—¶å€™çš„ç´ æï¼š`https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png`
2. `æˆ‘`æ’­æ”¾è¯­éŸ³æ—¶å€™çš„ç´ æï¼š`https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif`
3. `å¯¹æ–¹(å¥½å‹)`æ²¡æœ‰æ’­æ”¾è¯­éŸ³æ—¶å€™çš„ç´ æï¼š`https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.png`
4. `å¯¹æ–¹(å¥½å‹)`æ’­æ”¾è¯­éŸ³æ—¶å€™çš„ç´ æï¼š`https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.gif`
5. èŠå¤©ç•Œé¢ `pages/chat/chat.nvue` è¡¥å……è¯­éŸ³èŠå¤©ä¿¡æ¯ï¼š
```js
...,
{
	avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-06.png',
	nickname: 'å½¦ç¥–',
	chat_time: 1750148999,
	data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/kalong.mp3',
	user_id: 1,
	type:'audio', //image,video
	isremove:false,
},
```

### 1. æ’­æ”¾è¯­éŸ³æœ‰åŠ¨ç”»æç¤ºåŠŸèƒ½å®ç°
åœ¨ç»„ä»¶ `/components/chat-item/chat-item.vue`
```vue
<template>
	<view class="px-3">
		<!-- æ—¶é—´ -->
		...
		<!-- æ’¤å›æ¶ˆæ¯ -->
		...
		<!-- èŠå¤©å†…å®¹ -->
		...
			<!-- å¥½å‹ -->
			<!-- å¤´åƒ -->
			...
			<!-- æ°”æ³¡ -->
			<!-- ä¸‰è§’å½¢ -->
			...
			<!-- å†…å®¹ -->
			<view ...>
			    <!-- æƒ…å†µ1: è¡¨æƒ…åŒ…é‡Œé¢çš„gif/pngå›¾ç‰‡  -->
				...
				<!-- æƒ…å†µ2: å‘å›¾ç‰‡  -->
				...
				<!-- æƒ…å†µ3: è¯­éŸ³  -->
				<view v-else-if="item.type == 'audio'"
				class="flex align-center"
				@click="playAudio(item,index)">
				    <view v-if="!isMe">
				    	<image :src="audioPlayStatus ? audioIconList.notme.play:audioIconList.notme.stop"
				    	style="width: 36rpx;height: 36rpx;"></image>
				    </view>
					<text class="font" :class="[isMe?'mr-1':'ml-1']">43'</text>
					<!-- æˆ‘ è¯­éŸ³ ç´ æ -->
					<!-- é™æ­¢ -->
					<!-- <image src="https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png"
					style="width: 36rpx;height: 36rpx;"></image> -->
					<!-- æ’­æ”¾è¯­éŸ³ -->
					<!-- <image src="https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif"
					style="width: 36rpx;height: 36rpx;"></image> -->
					<view v-if="isMe">
						<image :src="audioPlayStatus ? audioIconList.me.play:audioIconList.me.stop"
						style="width: 36rpx;height: 36rpx;"></image>
					</view>
				</view>
			    <!-- æ–‡å­— -->
				...
			</view>
			
			<!-- æˆ‘ -->
			...
		</view>
    
	    <!-- å¼¹å‡ºèœå• -->
	    ...
	
	
	</view>
</template>

<script>
	...
	export default{
		...,
		data(){
			return {
				...,
				// æ’­æ”¾è¯­éŸ³åŠ¨ç”»ç´ æ
				audioIconList:{
					me:{
						stop:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png',
						play:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif',
					},
					notme:{
						stop:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.png',
						play:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.gif',
					}
				},
				// æ’­æ”¾çŠ¶æ€
				audioPlayStatus:false,
			}
		},
		...,
		methods:{
			...,
			//æ’­æ”¾è¯­éŸ³
			playAudio(item,index){
				...
				if(!this.innerAudioContext){
					this.innerAudioContext = uni.createInnerAudioContext();
					this.innerAudioContext.src = item.data;
					this.innerAudioContext.play();
					// ç›‘å¬éŸ³é¢‘æ’­æ”¾
					this.innerAudioContext.onPlay(()=>{
						this.audioPlayStatus = true;
					});
					// ç›‘å¬éŸ³é¢‘æš‚åœ
					this.innerAudioContext.onPause(()=>{
						this.audioPlayStatus = false;
					});
					// ç›‘å¬éŸ³é¢‘åœæ­¢
					this.innerAudioContext.onStop(()=>{
						this.audioPlayStatus = false;
					});
					// ç›‘å¬éŸ³é¢‘é”™è¯¯
					this.innerAudioContext.onError(()=>{
						this.audioPlayStatus = false;
					});
				}else{
					...
				}
			},
			
		}
	}
</script>

```

### 2. è¯­éŸ³æ’­æ”¾å°è£…æˆç»„ä»¶
#### â‘  æ–°å»ºéŸ³é¢‘ç»„ä»¶åŠä»£ç 
`/components/chat-item-audio/chat-item-audio.vue`
```vue
<template>
	<view class="flex align-center"
	@click="playAudio(item,index)">
		<view v-if="!isMe">
			<image :src="audioPlayStatus ? audioIconList.notme.play:audioIconList.notme.stop"
			style="width: 36rpx;height: 36rpx;"></image>
		</view>
		<text class="font" :class="[isMe?'mr-1':'ml-1']">43'</text>
		<!-- æˆ‘ è¯­éŸ³ ç´ æ -->
		<!-- é™æ­¢ -->
		<!-- <image src="https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png"
		style="width: 36rpx;height: 36rpx;"></image> -->
		<!-- æ’­æ”¾è¯­éŸ³ -->
		<!-- <image src="https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif"
		style="width: 36rpx;height: 36rpx;"></image> -->
		<view v-if="isMe">
			<image :src="audioPlayStatus ? audioIconList.me.play:audioIconList.me.stop"
			style="width: 36rpx;height: 36rpx;"></image>
		</view>
	</view>
</template>

<script>
	import {mapState,mapGetters,mapMutations,mapActions} from 'vuex';
	export default{
		name:"chat-item-audio",
		props:{
			item:Object,
			index:Number,
			isMe:Boolean,
		},
		data(){
			return {
				// éŸ³é¢‘ä¸Šä¸‹æ–‡
				innerAudioContext:null,
				// æ’­æ”¾è¯­éŸ³åŠ¨ç”»ç´ æ
				audioIconList:{
					me:{
						stop:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png',
						play:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif',
					},
					notme:{
						stop:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.png',
						play:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.gif',
					}
				},
				// æ’­æ”¾çŠ¶æ€
				audioPlayStatus:false,
			}
		},
		computed:{
			...mapState({
				// testVuexValue:state=>state.testVuex,
				testVuexValue:state=>state.Audio.testVuex,
			}),
		},
		mounted() {
			if(this.item.type == 'audio'){
				// this.$onGlobalEvent(res=>{
				// 	console.log('ç›‘å¬$emitEventNameæ–¹æ³•çš„æ¶ˆæ¯',res);
				// });
				//this.$onGlobalEvent(this.onplayAudio);
				uni.$on('onplayAudio',res=>{
					// console.log('é€šè¿‡uni.$onæ¥å—çš„ç»“æœ',res);
					this.onplayAudio(res);
				})
			}
			
			console.log('vuexä¸­çš„stateçš„å€¼',this.testVuexValue);
		},
		destroyed() {
			// this.$offEventName(this.onplayAudio);
			uni.$off('onplayAudio');
			//é”€æ¯éŸ³é¢‘
			if(this.innerAudioContext){
				this.innerAudioContext.destroy();
				this.innerAudioContext = null;
			}
		},
		methods:{
			// å¼•å…¥actionsé‡Œé¢çš„æ–¹æ³•
			...mapActions(['$onGlobalEvent','$emitEventName','$offEventName']),
			// å…¨å±€ç›‘å¬æ’­æ”¾è¯­éŸ³çš„å¤„ç†
			onplayAudio(res){
				// console.log('ç›‘å¬$emitEventNameæ–¹æ³•çš„æ¶ˆæ¯',res);
				if(this.innerAudioContext){
					//åœæ­¢éç‚¹å‡»çš„éŸ³é¢‘
					if(res != this.index){
						this.innerAudioContext.stop();
					}
				}
			},
			//æ’­æ”¾è¯­éŸ³
			playAudio(item,index){
				// this.$emitEventName('æ‰§è¡Œä¸€ä¸ªå…¨å±€äº‹ä»¶ä¼ ä¸€ä¸ªè¦æ’­æ”¾çš„éŸ³é¢‘ç´¢å¼•ï¼š' + index);
				// return;
				// é€šçŸ¥å…¶å®ƒéç‚¹å‡»éŸ³é¢‘åœæ­¢æ’­æ”¾
				//this.$emitEventName(index);
				uni.$emit('onplayAudio',{index:index});
				if(!this.innerAudioContext){
					this.innerAudioContext = uni.createInnerAudioContext();
					this.innerAudioContext.src = item.data;
					this.innerAudioContext.play();
					// ç›‘å¬éŸ³é¢‘æ’­æ”¾
					this.innerAudioContext.onPlay(()=>{
						this.audioPlayStatus = true;
					});
					// ç›‘å¬éŸ³é¢‘æš‚åœ
					this.innerAudioContext.onPause(()=>{
						this.audioPlayStatus = false;
					});
					// ç›‘å¬éŸ³é¢‘åœæ­¢
					this.innerAudioContext.onStop(()=>{
						this.audioPlayStatus = false;
					});
					// ç›‘å¬éŸ³é¢‘é”™è¯¯
					this.innerAudioContext.onError(()=>{
						this.audioPlayStatus = false;
					});
				}else{
					this.innerAudioContext.stop();
					this.innerAudioContext.play();
				}
			},
		},
	}
</script>

<style>
	/* #ifdef H5 */
	@import '/common/css/common.nvue.vue.css';
	/* #endif */
</style>
```

#### â‘¡ åœ¨`/components/chat-item/chat-item.vue`ä¸­å¼•å…¥éŸ³é¢‘ç»„ä»¶
```vue
<!-- æƒ…å†µ3: è¯­éŸ³  -->
<view v-else-if="item.type == 'audio'">
	<chat-item-audio :item="item" :index="index"
	:isMe="isMe"></chat-item-audio>
</view>
```


## å››ã€è¯­éŸ³æ’­æ”¾æ ¹æ®æ—¶é•¿æ˜¾ç¤ºé•¿åº¦
### â‘  è¡¥å……æ—¶é•¿æ•°æ®
åœ¨é¡µé¢ `/pages/chat/chat.nvue`
```js
...
{
	avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
	nickname: 'å°äºŒå“¥',
	chat_time: 1750148889,
	data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/kalong.mp3',
	otherData:{
		duration:60, //å•ä½ç§’
	},
	user_id: 2,
	type:'audio', //image,video
	isremove:false,
},
{
	avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
	nickname: 'å°äºŒå“¥',
	chat_time: 1750148899,
	data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/weixinYuYing.mp3',
	otherData:{
		duration:3, //å•ä½ç§’
	},
	user_id: 2,
	type:'audio', //image,video
	isremove:false,
},
{
	avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-06.png',
	nickname: 'å½¦ç¥–',
	chat_time: 1750148999,
	data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/kalong.mp3',
	otherData:{
		duration:43, //å•ä½ç§’
	},
	user_id: 1,
	type:'audio', //image,video
	isremove:false,
},
```

### â‘¡ åœ¨`/components/chat-item-audio/chat-item-audio.vue`ä¸­æ—¶é•¿æ˜¾ç¤º
```vue
<template>
	<view ...
	:class="[isMe ? 'justify-end' : 'justify-start']">
		...
		<text class="font"
		:class="[isMe?'mr-1':'ml-1']">{{item.otherData.duration + "'"}}</text>
		...
	</view>
</template>

```

### â‘¢ åœ¨`/components/chat-item/chat-item.vue`ä¸­
```vue
<!-- å†…å®¹ -->
<view ...
:style="contentStyle"
...>
	...
</view>
<script>
	export default{
		computed:{
            // èŠå¤©å†…å®¹éŸ³é¢‘æ ·å¼
			contentStyle(){
				if(this.item.type == 'audio'){
					const duration = this.item.otherData.duration || 0;
					// æœ€é•¿æ—¶é•¿60ç§’
					const ratio = duration / 60 ;
					// æœ€å¤§å®½åº¦500rpx  æœ€å°120rpx
					const width = 500 * ratio < 120 ? 120 : 500 * ratio;
					return `width:${width}rpx`;
				}
			},
		},
	}
</script>	
```


## äº”ã€è¯­éŸ³æ’­æ”¾é¡µé¢å’Œç»„ä»¶å®Œæ•´ä»£ç 
### â‘  é¡µé¢ `/pages/chat/chat.nvue`
```vue
<template>
	<view>
		<!-- å¯¼èˆªæ  -->
		<chat-navbar title="èŠå¤©" :fixed="true"
		:showPlus="false" :showUser="false"
		:showBack="true" navbarClass="bg-light"
		:h5WeiXinNeedNavbar="h5WeiXinNeedNavbar">
		    <chat-navbar-icon-button slot="right"
			@click="openMore" >
		    	<text class="iconfont font-lg">&#xe626;</text>
		    </chat-navbar-icon-button>
		</chat-navbar>
		
		<!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
		<scroll-view scroll-y class="bg-light position-fixed left-0 right-0"
		:style="chatContentStyle" :show-scrollbar="false" @scroll="onScroll"
		:scroll-into-view="scrollIntoViewId" >
			<!-- å¯¹è¯éƒ¨åˆ† -->
			<view v-for="(item,index) in chatDataList" :key="index"
			:id="'chat-item-'+index">
				<chat-item :item="item" :index="index"
				:prevTime="index>0 ? chatDataList[index-1].chat_time : 0"
				ref="chatItem" @previewImages="previewImages"></chat-item>
			</view>
		</scroll-view>
		<!-- é’ˆå¯¹æˆ‘ä»¬çš„appç«¯ç‚¹å‡»èŠå¤©åŒºåŸŸæˆæƒåŠ å·æ‰©å±•èœå• -->
		<!-- #ifdef APP -->
		<view v-if="sendMessageMode == 'plus' || sendMessageMode == 'icon'"
		class="position-fixed left-0 right-0"
		:style="chatContentStyle"
		@click="scrollViewClick"></view>
		<!-- #endif -->
		
		
		<!-- åº•éƒ¨èŠå¤©è¾“å…¥åŒºåŸŸ --><!-- ä¿®æ”¹ï¼šæ·»åŠ refè·å–textareaå®ä¾‹ -->
		<view class="position-fixed bottom-0 border-top
		flex flex-row align-center justify-between"
		style="background-color: #f7f7f7;width: 750rpx;
		min-height: 90rpx;max-height: 320rpx;
		padding-top: 12rpx;"
		:style="chatBottomStyle">
			<view class="flex align-center">
				<chat-navbar-icon-button>
					<text class="iconfont font-lg">&#xe643;</text>
				</chat-navbar-icon-button>
				<view class="flex align-center font-sm
				bg-white px-2 py-1 border rounded">
					<textarea ref="textarea" fixed auto-height :maxlength="-1"
					style="width: 440rpx;min-height: 60rpx;
					max-height: 274rpx;overflow-y: scroll;
					text-align: justify;"
					:adjust-position="false"
					v-model="messageValue"
					@focus="textareaFocus"
					@input="onTextareaInput" 
					@blur="onTextareaBlur" ><!-- æ–°å¢ï¼šç›‘å¬å¤±ç„¦äº‹ä»¶ --><!-- æ–°å¢ï¼šç›‘å¬è¾“å…¥äº‹ä»¶ -->
					</textarea>
				</view>
			</view>
			<view class="flex align-center">
				<chat-navbar-icon-button v-if="!messageValue"
				@click="openIcon">
					<text class="iconfont font-lg">&#xe642;</text>
				</chat-navbar-icon-button>
				<chat-navbar-icon-button v-if="!messageValue"
				@click="openPlus">
					<text class="iconfont font-lg">&#xe637;</text>
				</chat-navbar-icon-button>
				<view v-if="messageValue"
				class="rounded bg-success px-2 py-1 mr-4"
				hover-class="bg-hover-success" 
				@click="sendMessage('text')">
				   <text class="font text-white">å‘é€</text>
				</view>
			</view>
		</view>
	
	
	     <!-- å¼¹å‡ºèœå• --><!-- ä¸»è¦ä¿®æ”¹åŒºåŸŸ -->
		 <chat-tooltip ref="tooltipPlus" :mask="chatTooltipMask" 
		 :maskTransparent="true" :isBottom="true" 
		 :tooltipWidth="750"
		 :tooltipHeight="tooltipHeight"
		 transformOrigin = "center bottom"
		 tooltipClass ="bg-light border-0 rounded-0"
		 @hideTooltip="hideTooltip">
			<view class="border-top border-light-secondary">
				<!-- è¡¨æƒ…èœå• -->
				<swiper v-if="sendMessageMode === 'icon'" 
				:indicator-dots="groupedIconMenus.length > 1" 
				:duration="1000"
				:style="tooltipPlusMenuStyle"
				@change="handleSwiperChange"><!-- æ·»åŠ åˆ†é¡µåˆ‡æ¢äº‹ä»¶ -->
					<!-- ç¬¬ä¸€é¡µï¼šemojiè¡¨æƒ…ï¼ˆæ»šåŠ¨æ˜¾ç¤ºï¼‰ -->
					<swiper-item v-if="emojiPageItems.length > 0">
						<scroll-view scroll-y style="height: 100%;">
							<view class="flex flex-row flex-wrap justify-start">
								<view v-for="(item,itemIndex) in emojiPageItems" 
								:key="itemIndex"
								class="flex flex-column justify-center align-center"
								style="width: 12.5%; height: 120rpx; padding: 10rpx;"
								@click="insertEmoji(item)">
									<text style="font-size: 50rpx;">{{item.icon}}</text>
								</view>
							</view>
						</scroll-view>
					</swiper-item>
					
					<!-- å…¶ä»–ç±»å‹è¡¨æƒ…åˆ†é¡µæ˜¾ç¤º -->
					<swiper-item v-for="(page,pageIndex) in otherPages" 
					:key="pageIndex">
						<view class="flex flex-row flex-wrap justify-start">
							<view v-for="(item,itemIndex) in page" 
							:key="pageIndex+itemIndex"
							class="col-3 flex flex-column justify-center align-center"
							style="height: 260rpx;"
							@click="item ? swiperItemClick(item,itemIndex) : null"
							><!-- å°ç¨‹åºæ·»åŠ ç©ºå€¼æ£€æŸ¥ -->
								<view class="bg-white rounded-lg flex flex-row 
								align-center justify-center mb-2"
								style="width:120rpx;height: 120rpx;">
									<u--image v-if="item.iconType == 'image'"
									:src="item.icon" mode="aspectFit"
									width="120rpx" height="120rpx" radius="0rpx"></u--image>
									<text v-if="item.iconType == 'emoji'"
									style="font-size: 40px;color: #222222;">{{item.icon}}</text>
									<text v-if="item.iconType == 'custom'"
									class="iconfont"
									style="font-size: 26px;color: #222222;">{{item.icon}}</text>
									<u-icon v-if="item.iconType == 'uview'"
									:name="item.icon" color="#222222" size="26"></u-icon>
								</view>
								<text class="font-sm text-light-muted">{{item.name}}</text>
							</view>
						</view>
					</swiper-item>
				</swiper>
				
				<!-- åŠ å·èœå•ï¼ˆä¿æŒä¸å˜ï¼‰ -->
				<swiper v-else-if="sendMessageMode === 'plus'"
				:indicator-dots="pageCount > 1" :duration="1000"
				:style="tooltipPlusMenuStyle">
					<swiper-item v-for="(page,index) in groupedPlusMenus" :key="index">
						<view class="flex flex-row justify-start flex-wrap"
						:style="swiperItemStyle">
							<view class="col-3 flex flex-column justify-center align-center"
							style="height: 260rpx;"
							v-for="(item,itemIndex) in page" :key="itemIndex"
							@click="swiperItemClick(item,itemIndex)">
								<view class="bg-white rounded-lg 
								flex flex-row align-center justify-center mb-2"
								style="width:120rpx;height: 120rpx;">
									<u--image v-if="item.iconType == 'image'"
									:src="item.icon" mode="aspectFit"
									width="120rpx" height="120rpx" radius="0rpx"></u--image>
									<text v-if="item.iconType == 'emoji'"
									style="font-size: 40px;color: #222222;">{{item.icon}}</text>
									<text v-if="item.iconType == 'custom'"
									class="iconfont"
									style="font-size: 26px;color: #222222;">{{item.icon}}</text>
									<u-icon v-if="item.iconType == 'uview'"
									:name="item.icon" color="#222222" size="26"></u-icon>
								</view>
								<text class="font-sm text-light-muted">{{item.name}}</text>
							</view>
						</view>
					</swiper-item>
				</swiper>
			</view>
		 </chat-tooltip>	
	</view>
</template>

<script>
    import toolJs from '@/common/mixins/tool.js';
	import UniPermission from '@/common/mixins/uni_permission.js';
	export default {
		mixins:[toolJs],
		data() {
			return {
				cursorPos: 0, // æ–°å¢ï¼šè®°å½•textareaå…‰æ ‡ä½ç½®
				h5WeiXinNeedNavbar:false, // h5ç«¯å¾®ä¿¡ä¸Šæ˜¯å¦éœ€è¦å¯¼èˆªæ 
				statusBarHeight:0,//çŠ¶æ€æ é«˜åº¦åŠ¨æ€è®¡ç®—
				fixedHeight:0, //å ä½ï¼šçŠ¶æ€æ +å¯¼èˆªæ 
				bottomSafeAreaHeight:0, // åº•éƒ¨å®‰å…¨è·ç¦»
				KeyboardHeight:0, //é”®ç›˜é«˜åº¦
				scrollIntoViewId:'', // æ»šåŠ¨åˆ°æŒ‡å®šçš„å…ƒç´ id
				messageValue:'', // å‘é€çš„å†…å®¹ä¿¡æ¯
				tooltipHeight:600, // åŠ å·å¼¹å‡ºèœå•çš„é«˜åº¦rpx
				sendMessageMode:"text",//å‘é€æ¶ˆæ¯çš„æƒ…å†µï¼šæ–‡å­—|è¯­éŸ³|åŠ å·|è¡¨æƒ…
				// #ifdef MP || H5
				chatTooltipMask:true,
				// #endif
				// #ifdef APP
				chatTooltipMask:false,
				// #endif
				iconMenus:[
					{ name:"å¾®ç¬‘", icon:"/static/tabbar/index.png",
					iconType:"image", eventType:"smile" },
					{ name:"å˜¿å˜¿", icon:"ğŸ˜€",
					iconType:"emoji", eventType:"heihei" },
					{ name: "å—¯ï¼Œå“¼", icon: "https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/iconMenus/en.gif", iconType: "image", eventType: "enheng" },
					{ name:"å˜»å˜»", icon:"ğŸ˜",
					iconType:"emoji", eventType:"xixi" },
					{ name:"ç¬‘å“­äº†", icon:"ğŸ˜‚",
					iconType:"emoji", eventType:"xiaokule" },
					{ name:"å“ˆå“ˆ", icon:"ğŸ˜ƒ",
					iconType:"emoji", eventType:"haha" },
					{ name:"å¤§ç¬‘", icon:"ğŸ˜„",
					iconType:"emoji", eventType:"daxiao" },
					{ name:"è‹¦ç¬‘", icon:"ğŸ˜…",
					iconType:"emoji", eventType:"kuxiao" },
					{ name:"æ–œçœ¼ç¬‘", icon:"ğŸ˜†",
					iconType:"emoji", eventType:"xieyanxiao" },
					{ name:"å¾®ç¬‘å¤©ä½¿", icon:"ğŸ˜‡",
					iconType:"emoji", eventType:"weixiaotianshi" },
					{ name:"çœ¨çœ¼", icon:"ğŸ˜‰",
					iconType:"emoji", eventType:"zhayan" },
					{ name:"ç¾æ¶©å¾®ç¬‘", icon:"ğŸ˜Š",
					iconType:"emoji", eventType:"xiuseweixiao" },
					{ name:"å‘µå‘µ", icon:"ğŸ™‚",
					iconType:"emoji", eventType:"hehe" },
					{ name:"å€’è„¸", icon:"ğŸ™ƒ",
					iconType:"emoji", eventType:"daolian" },
					{ name:"ç¬‘å¾—æ»¡åœ°æ‰“æ»š", icon:"ğŸ¤£",
					iconType:"emoji", eventType:"xiaodemandidagun" },
				],
				plusMenus:[ // åŠ å·æ‰©å±•èœå•æ ç›®
					{ name:"ç…§ç‰‡", icon:"photo", iconType:"uview", eventType:"photo" },
					{ name:"ä½ç½®", icon:"map", iconType:"uview", eventType:"map" },
					{ name:"æ‹æ‘„", icon:"\ue62c", iconType:"custom", eventType:"camera" },
					{ name:"æˆ‘çš„åç‰‡", icon:"\ue69d", iconType:"custom", eventType:"mingpian" },
					{ name:"è§†é¢‘", icon:"\ue66d", iconType:"custom", eventType:"video" },
					// { name:"æ‹æ‘„", icon:"\ue62c", iconType:"custom", eventType:"camera" },
					// { name:"æˆ‘çš„åç‰‡", icon:"\ue69d", iconType:"custom", eventType:"mingpian" },
					// { name:"è§†é¢‘", icon:"\ue66d", iconType:"custom", eventType:"video" },
					// { name:"æ‹æ‘„", icon:"\ue62c", iconType:"custom", eventType:"camera" },
					// { name:"æˆ‘çš„åç‰‡", icon:"\ue69d", iconType:"custom", eventType:"mingpian" },
					// { name:"è§†é¢‘", icon:"\ue66d", iconType:"custom", eventType:"video" },
				],
				chatDataList:[
					{
						avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-06.png',
						nickname: 'å½¦ç¥–',
						chat_time: 1750148439,
						data: 'è€å¸ˆä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹æœ¬å­£è¯¾ç¨‹ï¼Œå¦‚æœæˆ‘ä¸å­¦ä¹ ä¸Šä¸€ä¸ªå­£åº¦ï¼Œå¯ä»¥ç›´æ¥å­¦ä¹ æœ¬å­£åº¦å—ï¼Ÿ',
						user_id: 1,
						type:'text', //image,video
						isremove:false,
					},
					{
						avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
						nickname: 'å°äºŒå“¥',
						chat_time: 1750148449,
						data: 'åŒå­¦ä½ å¥½ï¼Œå¦‚æœä¸å­¦ä¹ ä¸Šä¸€ä¸ªå­£åº¦è¯¾ç¨‹ï¼Œå¦‚æœä½ æœ‰vueçš„åŸºç¡€å’Œjsçš„åŸºç¡€çŸ¥è¯†ï¼Œä¹Ÿå¯ä»¥å­¦ä¹ æœ¬å­£åº¦è¯¾ç¨‹',
						user_id: 2,
						type:'text', //image,video
						isremove:false,
					},
					{
						avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-06.png',
						nickname: 'å½¦ç¥–',
						chat_time: 1750148759,
						data: 'å¥½çš„ï¼Œæˆ‘äº†è§£äº†ï¼Œè°¢è°¢è€å¸ˆ',
						user_id: 1,
						type:'text', //image,video
						isremove:false,
					},
					{
						avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
						nickname: 'å°äºŒå“¥',
						chat_time: 1750148859,
						data: 'ä¸ç”¨è°¢',
						user_id: 2,
						type:'text', //image,video
						isremove:false,
					},
					{
						avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-06.png',
						nickname: 'å½¦ç¥–',
						chat_time: 1750148879,
						data: 'ok',
						user_id: 1,
						type:'text', //image,video
						isremove:false,
					},
					{
						avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-06.png',
						nickname: 'å½¦ç¥–',
						chat_time: 1750148879,
						data: 'å“ˆå“ˆå“ˆ',
						user_id: 1,
						type:'text', //image,video
						isremove:false,
					},
					{
						avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-06.png',
						nickname: 'å½¦ç¥–',
						chat_time: 1750148879,
						data: 'å—¯å•¦',
						user_id: 1,
						type:'text', //image,video
						isremove:false,
					},
					{
						avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
						nickname: 'å°äºŒå“¥',
						chat_time: 1750148889,
						data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/kalong.mp3',
						otherData:{
							duration:60, //å•ä½ç§’
						},
						user_id: 2,
						type:'audio', //image,video
						isremove:false,
					},
					{
						avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
						nickname: 'å°äºŒå“¥',
						chat_time: 1750148899,
						data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/weixinYuYing.mp3',
						otherData:{
							duration:3, //å•ä½ç§’
						},
						user_id: 2,
						type:'audio', //image,video
						isremove:false,
					},
					{
						avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-06.png',
						nickname: 'å½¦ç¥–',
						chat_time: 1750148999,
						data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/kalong.mp3',
						otherData:{
							duration:43, //å•ä½ç§’
						},
						user_id: 1,
						type:'audio', //image,video
						isremove:false,
					},
				],
			}
		},
		mounted() {
			let info = uni.getSystemInfoSync();
			this.statusBarHeight = info.statusBarHeight;
			this.fixedHeight = this.statusBarHeight + uni.upx2px(90);
			this.bottomSafeAreaHeight = info.safeAreaInsets.bottom;
			// ç›‘å¬é”®ç›˜é«˜åº¦å˜åŒ–
			uni.onKeyboardHeightChange(res=>{
				console.log('é”®ç›˜é«˜åº¦å˜åŒ–',res);
				// #ifdef H5 || MP
				this.KeyboardHeight = res.height;
				// #endif
				// #ifdef APP
				console.log('æ­¤æ—¶çš„è¾“å…¥æ¨¡å¼', this.sendMessageMode);
				if(this.sendMessageMode != 'plus' && this.sendMessageMode != 'icon'){
					this.KeyboardHeight = res.height;
				}
				// #endif
				if(this.KeyboardHeight){
					this.chatContentToBottom();
				}
			});
			// é¡µé¢åŠ è½½å®Œäº†ä¹‹åå°±åº”è¯¥æ»šåŠ¨åˆ°åº•éƒ¨
			this.$nextTick(()=>{
				this.chatContentToBottom();
			});
		},
		computed:{
			chatContentStyle(){
				let pbottom = this.bottomSafeAreaHeight == 0 ?
				uni.upx2px(12) : this.bottomSafeAreaHeight;
				let bottom = pbottom + uni.upx2px(90 + 12) + this.KeyboardHeight;
				//å¦‚æœæ˜¯h5ç«¯ç”¨å¾®ä¿¡æ‰“å¼€å¹¶ä¸”ä¸éœ€è¦å¯¼èˆªæ çš„æ—¶å€™
				if(this.isWeixinBrowser() && !this.h5WeiXinNeedNavbar){
					this.fixedHeight = this.statusBarHeight + 0;
					uni.setNavigationBarTitle({
						title:'é˜¿ç¥–'
					});
				}
				// #ifdef APP || MP
				if(this.KeyboardHeight){
					bottom = uni.upx2px(90 + 12 + 12) + this.KeyboardHeight;
				}
				// #endif
				return `top:${this.fixedHeight}px;bottom:${bottom}px;`;
			},
			chatBottomStyle(){
				let pbottom = this.bottomSafeAreaHeight == 0 ?
				uni.upx2px(12) : this.bottomSafeAreaHeight;
				// #ifdef APP || MP
				if(this.KeyboardHeight){
					pbottom = uni.upx2px(12);
				}
				// #endif
				return `padding-bottom: ${pbottom}px;bottom:${this.KeyboardHeight}px;`;
			},
			//åŠ å·èœå•æ¯é¡µçš„æ»‘åŠ¨æ ·å¼
			tooltipPlusMenuStyle(){
				let pbottom = 0;
				let height = uni.upx2px(this.tooltipHeight - 1) - pbottom;
				// #ifdef APP || MP
				pbottom = this.bottomSafeAreaHeight;
				// #endif
				return `padding-bottom:${pbottom}px;height:${height}px;`;
			},
			//åŠ å·èœå•æ¯é¡µçš„å¸ƒå±€æ ·å¼
			swiperItemStyle(){
				let pbottom = 0;
				let height = uni.upx2px(this.tooltipHeight - 1) - pbottom;
				return `padding-bottom:${pbottom}px;height:${height}px;`;
			},
			// åŠ å·èœå•åˆ†é¡µ
			// groupedPlusMenus(){
			// 	const perPage = 8; // æ¯é¡µ8ä¸ª
			// 	const result = [];
			// 	// å°†æ•°ç»„plusMenusæˆ–è€…iconMenusæ¯é¡µ8ä¸ªåˆ†ç»„
			// 	for(let i=0;i<this.tooltipPlusMenusOrIconMenus.length; i += perPage){
			// 		result.push(this.tooltipPlusMenusOrIconMenus.slice(i, i + perPage))
			// 	}
			// 	return result;
			// },
			//è®¡ç®—æ€»é¡µæ•°
			// pageCount(){
			// 	return Math.ceil(this.tooltipPlusMenusOrIconMenus.length / 8);
			// },
			// æ‰©å±•èœå•æˆ–è€…è¡¨æƒ…åŒ…æ•°æ®æº
			tooltipPlusMenusOrIconMenus(){
				if(this.sendMessageMode == 'plus' || this.sendMessageMode == 'icon'){
					return this[`${this.sendMessageMode}Menus`]
				}
				return [];
			},
			// ä¿®æ”¹ï¼šåŠ å·èœå•åˆ†é¡µè®¡ç®—
			groupedPlusMenus() {
				const perPage = 8; // æ¯é¡µ8ä¸ªï¼ˆ2è¡Œï¼‰
				const result = [];
				for (let i = 0; i < this.plusMenus.length; i += perPage) {
					result.push(this.plusMenus.slice(i, i + perPage));
				}
				return result;
			},
			// ä¿®æ”¹ï¼šè®¡ç®—æ€»é¡µæ•°ï¼ˆåˆ†åˆ«å¤„ç†ä¸¤ç§èœå•ï¼‰
			pageCount() {
				if (this.sendMessageMode === 'plus') {
					return Math.ceil(this.plusMenus.length / 8);
				} else if (this.sendMessageMode === 'icon') {
					return this.groupedIconMenus.length;
				}
				return 0;
			},
			// æ–°å¢ï¼šè¡¨æƒ…èœå•è®¡ç®—å±æ€§
			emojiList() {
				return this.iconMenus.filter(item => item.iconType === 'emoji');
			},
			otherList() {
				return this.iconMenus.filter(item => item.iconType !== 'emoji');
			},
			emojiPageItems() {
				return this.emojiList; // æ‰€æœ‰emojiè¡¨æƒ…æ”¾åœ¨ç¬¬ä¸€é¡µ
			},
			otherPages() {
				const perPage = 8; // æ¯é¡µ8ä¸ªï¼ˆ2è¡Œï¼‰
				const pages = [];
				for (let i = 0; i < this.otherList.length; i += perPage) {
					pages.push(this.otherList.slice(i, i + perPage));
				}
				return pages;
			},
			groupedIconMenus() {
				// æ€»é¡µæ•° = 1 (emojié¡µ) + å…¶ä»–ç±»å‹é¡µæ•°
				const pages = [];
				if (this.emojiPageItems.length > 0) {
					pages.push(this.emojiPageItems); // ç¬¬ä¸€é¡µæ”¾emoji
				}
				return pages.concat(this.otherPages);
			},
			// å¤šå›¾é¢„è§ˆå›¾ç‰‡åœ°å€çš„æ•°ç»„é›†åˆ
			previewImagesList(){
				let arr = [];
				this.chatDataList.forEach(item=>{
					if(item.type == 'image' || (item.type == 'iconMenus' &&
				       item.dataType && item.dataType == 'image')){
						arr.push(item.data);
					}
				});
				return arr;
			},
		},
		methods: {
			// æ–°å¢ï¼štextareaè¾“å…¥äº‹ä»¶è®°å½•å…‰æ ‡ä½ç½®
			onTextareaInput(e) {
				// #ifdef H5 || APP
				this.cursorPos = e.detail.cursor;
				// #endif
			},
			// æ–°å¢ï¼štextareaå¤±ç„¦äº‹ä»¶è®°å½•å…‰æ ‡ä½ç½®
			onTextareaBlur(e) {
				this.cursorPos = e.detail.cursor || this.messageValue.length;
			},
						
			// æ–°å¢ï¼šæ’å…¥è¡¨æƒ…åˆ°textarea
			insertEmoji(item) {
				if (!item || !item.icon) return;
				
				const emoji = item.icon;
				const text = this.messageValue || '';
				
				// æ’å…¥åˆ°å½“å‰å…‰æ ‡ä½ç½®
				const newText = text.substring(0, this.cursorPos) + 
							   emoji + 
							   text.substring(this.cursorPos);
				
				this.messageValue = newText;
				
				// æ›´æ–°å…‰æ ‡ä½ç½®ï¼ˆåœ¨æ’å…¥çš„è¡¨æƒ…åé¢ï¼‰
				const newCursorPos = this.cursorPos + emoji.length;
				this.cursorPos = newCursorPos;
				
				// è®¾ç½®å…‰æ ‡ä½ç½®ï¼ˆH5/APPæ”¯æŒï¼‰
				this.$nextTick(() => {
					if (!this.$refs.textarea) return;
					
					let textarea;
					
					// å¤„ç† H5 å¹³å°çš„ç‰¹æ®Šæƒ…å†µ
					// #ifdef H5
					textarea = this.$refs.textarea.$el; // è·å–åŸç”Ÿ DOM å…ƒç´ 
					// #endif
					
					// #ifndef H5
					textarea = this.$refs.textarea;
					// #endif
					
					if (textarea) {
						// å°è¯•è®¾ç½®å…‰æ ‡ä½ç½®
						if (typeof textarea.setSelectionRange === 'function') {
							try {
								textarea.setSelectionRange(newCursorPos, newCursorPos);
							} catch (e) {
								console.warn('è®¾ç½®å…‰æ ‡ä½ç½®å¤±è´¥', e);
							}
						}
						
						// ç¡®ä¿è¾“å…¥æ¡†èšç„¦
						if (typeof textarea.focus === 'function') {
							try {
								textarea.focus();
							} catch (e) {
								console.warn('èšç„¦è¾“å…¥æ¡†å¤±è´¥', e);
							}
						}
					}
				});
			},
			//ç‚¹å‡»åŠ å·æ‰©å±•èœå•çš„æŸä¸€é¡¹
			// swiperItemClick(item,itemIndex){
			// 	if(this.sendMessageMode == 'icon'){
			// 		console.log('ç‚¹å‡»äº†è¡¨æƒ…åŒ…é‡Œé¢çš„æŸä¸ªè¡¨æƒ…');
			// 		// this.messageValue +=  `[${item.name}]`;
			// 		this.sendMessage('iconMenus',item)
					
			// 	}else{
			// 		console.log('ç‚¹å‡»åŠ å·æ‰©å±•èœå•çš„æŸä¸€é¡¹',item.eventType);
			// 		switch (item.eventType){
			// 			case 'phote':
			// 				break;
			// 			case 'map':
			// 				break;
			// 			case 'camera':
			// 				break;
			// 			case 'mingpian':
			// 				break;
			// 			case 'video':
			// 				break;
			// 		}
			// 	}
			// },
			// ä¿®æ”¹ï¼šç‚¹å‡»èœå•é¡¹å¤„ç†
			async swiperItemClick(item, itemIndex) {
				console.log('ç‚¹å‡»èœå•é¡¹å¤„ç†',item);
				if (!item) return; // é˜²æ­¢undefinedé”™è¯¯
				if (this.sendMessageMode === 'icon') {
					if (item.iconType === 'emoji') {
						this.insertEmoji(item); // emojiæ’å…¥è¾“å…¥æ¡†
					} else {
						this.sendMessage('iconMenus', item); // å…¶ä»–ç±»å‹ç›´æ¥å‘é€
					}
				} else {
					console.log('ç‚¹å‡»åŠ å·æ‰©å±•èœå•çš„æŸä¸€é¡¹',item.eventType);
					switch (item.eventType){
						case 'photo':
						    await this.handlePhoto();
							break;
						case 'map':
							break;
						case 'camera':
							break;
						case 'mingpian':
							break;
						case 'video':
							break;
					}
				}
			},
			// å‘å›¾ç‰‡
			async handlePhoto(){
				try{
				   const permission = new UniPermission();
				   const granted =  await permission.requestPermission('photo',
				   'éœ€è¦è®¿é—®æ‚¨çš„ç›¸å†Œæ¥é€‰æ‹©å›¾ç‰‡','æœ¬åŠŸèƒ½éœ€è¦æ‚¨æ‰“å¼€ç›¸å†Œ');
				   if(granted){
					   console.log('ç”¨æˆ·å·²æˆæƒå¼€å¯ç›¸å†Œï¼Œå¯ä»¥é€‰æ‹©ç…§ç‰‡äº†');
					   this.chooseImage();
				   }else{
					   uni.showToast({
						  title: 'æ‚¨æ²¡æœ‰æˆæƒå¼€å¯ç›¸å†Œï¼Œæ— æ³•å‘å›¾ç‰‡',
						  icon:'none',
						  duration:3000
					   });
				   }
				}catch(error){
					console.error('æƒé™ç”³è¯·å¼‚å¸¸ï¼š' + error);
					uni.showToast({
						title:'æƒé™ç”³è¯·å¤±è´¥ï¼š' + error.message,
						icon:'none',
						duration:3000
					});
				}
			},
			//é€‰æ‹©ç…§ç‰‡å‘é€
			chooseImage(){
				uni.chooseImage({
					count:9,
					//sizeType:['original','compressed'],
					sourceType:['album'],
					success: (res) => {
						console.log('é€‰æ‹©ç…§ç‰‡res',res);
						if(res.tempFilePaths && res.tempFilePaths.length){
							// å‘é€åˆ°æœåŠ¡å™¨æˆ–è€…ç¬¬ä¸‰æ–¹äº‘å­˜å‚¨
							// é¡µé¢æ•ˆæœæ¸²æŸ“æ•ˆæœ
							//å•å¼ 
							//this.sendMessage('image',{path:res.tempFilePaths[0]});
							// å¤šå¼ 
							res.tempFilePaths.forEach(item=>{
								this.sendMessage('image',{path:item});
							});
						}
					},
					fail: (err) => {
						console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥ï¼š', err);
						let errorMsg = 'é€‰æ‹©å›¾ç‰‡å¤±è´¥';
						if(err.errMsg.includes('permission')){
							errorMsg = 'ç›¸å†Œè®¿é—®æƒé™ä¸è¶³';
						}else if(err.errMsg.includes('cancel')){
							return; // ç”¨æˆ·ä¸æˆæƒä¸æç¤º
						}
						uni.showToast({
							title:errorMsg,icon:'none',duration:3000
						});
					}
				});
			},
			//é¢„è§ˆå¤šå¼ å›¾ç‰‡
			previewImages(e){
				console.log('é¢„è§ˆå¤šå¼ å›¾ç‰‡åœ¨é¡µé¢',e);
				uni.previewImage({
					urls:this.previewImagesList,
					current:e.item.data,
					indicator:'default',
				});
			},
			handleSwiperChange(e) {
			    console.log('åˆ†é¡µåˆ‡æ¢', e.detail.current);
			    // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†åˆ†é¡µåˆ‡æ¢é€»è¾‘
			},
			//ç‚¹å‡»èŠå¤©åŒºåŸŸ
			scrollViewClick(){
				// #ifdef APP
				console.log('ç‚¹å‡»èŠå¤©åŒºåŸŸ');
				this.KeyboardHeight = 0;
				uni.hideKeyboard();
				this.$refs.tooltipPlus.hide();
				this.sendMessageMode = "text";
				// #endif
			},
			// æ–‡æœ¬è¾“å…¥æ¡†èšç„¦
			textareaFocus(){
				// #ifdef APP
				this.sendMessageMode = "text";
				// #endif
			},
			//ç‚¹å‡»ç¬‘è„¸å›¾æ ‡
			openIcon(){
				console.log('ç‚¹å‡»äº†ç¬‘è„¸');
				// #ifdef APP
				this.sendMessageMode = "icon";
				uni.hideKeyboard();
				// #endif
				// #ifdef H5 || MP
				this.sendMessageMode = "icon";
				// #endif
				this.$refs.tooltipPlus.show();
				// #ifdef APP || MP || H5
				this.KeyboardHeight = uni.upx2px(this.tooltipHeight);
				this.chatContentToBottom();
				// #endif
			},
			//ç‚¹å‡»äº†åŠ å·
			openPlus(){
				console.log('ç‚¹å‡»äº†åŠ å·');
				// #ifdef APP
				this.sendMessageMode = "plus";
				uni.hideKeyboard();
				// #endif
				// #ifdef H5 || MP
				this.sendMessageMode = "plus";
				// #endif
				this.$refs.tooltipPlus.show();
				// #ifdef APP || MP || H5
				this.KeyboardHeight = uni.upx2px(this.tooltipHeight);
				this.chatContentToBottom();
				// #endif
			},
			// å¼¹å‡ºæ¡†éšè—äº†
			hideTooltip(){
				console.log('å¼¹å‡ºæ¡†éšè—äº†');
				// #ifdef APP || MP || H5
				this.KeyboardHeight = 0;
				this.chatContentToBottom();
				// #endif
			},
			//å‘é€æ¶ˆæ¯
			sendMessage(msgType, option = {}){
				console.log('å‘é€æ¶ˆæ¯',msgType);
				let msg = {
					avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
					nickname: 'å°äºŒå“¥',
					user_id: 2,
					chat_time: (new Date()).getTime(),
					data: '',
					type:msgType, //image,video
					isremove:false,
				};
				switch (msgType){
					case 'text':
					    msg.data = this.messageValue;
					    break;
					case 'iconMenus':
					    console.log('iconMenusçš„æ•°æ®',option);
					    msg.data = option.icon;
						msg.dataType = option.iconType;
					    break;
					case 'image':
					    console.log('imageçš„æ•°æ®',option);
						msg.data = option.path;
					    break;
				}
				this.chatDataList.push(msg);
				// æ¸…ç©ºå‘é€çš„å†…å®¹ç„¶åè¿˜è¦æ»šåŠ¨åˆ°åº•éƒ¨
				if(msgType == 'text') this.messageValue = '';
				this.chatContentToBottom();
			},
			openMore(){
				console.log('ç‚¹å‡»äº†ä¸‰ä¸ªç‚¹å›¾æ ‡');
			},
			//èŠå¤©å†…å®¹æ»šåˆ°åˆ°åº•éƒ¨
			chatContentToBottom(){
				// #ifdef APP
				let chatItems =  this.$refs.chatItem;
				let lastIndex = chatItems.length - 1 == 0 ? 0 : chatItems.length - 1;
				let last = chatItems[lastIndex];
				const dom =  weex.requireModule('dom');
				dom.scrollToElement(last, {});
				// #endif
				// #ifdef MP || H5
				if(this.chatDataList.length == 0) return;
				const lastIndex = this.chatDataList.length - 1;
				this.scrollIntoViewId = `chat-item-${lastIndex}`;
				setTimeout(()=>{
					this.scrollIntoViewId = '';
					this.$nextTick(()=>{
						this.scrollIntoViewId = `chat-item-${lastIndex}`;
					});
				},100)
				// #endif
			},
			onScroll(){
				console.log('é¡µé¢å‘ç”Ÿäº†æ»šåŠ¨');
			}
		},
		watch:{
			// ç›‘å¬èŠå¤©è®°å½•æ•°æ®å˜åŒ–ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
			chatDataList:{
				handler(){
					this.$nextTick(()=>{
						this.chatContentToBottom();
					});
				},
				deep:true
			},
			sendMessageMode(newVal,oldVal){
				// #ifdef APP
				console.log('ç›‘å¬å‘é€æ¨¡å¼',newVal);
				if(newVal != 'plus' && newVal != 'icon'){
					this.$refs.tooltipPlus.hide();
				}
				// #endif
			},
		},
	}
</script>

<style>
    /* #ifdef H5 */
	@import '/common/css/common.nvue.vue.css';
	/* #endif */
	
	
</style>
```
### â‘¡ ç»„ä»¶ `/pages/chat-item/chat-item.vue`
```vue
<template>
	<view class="px-3">
		<!-- æ—¶é—´ -->
		<view v-if="chatShowTime"
		class="flex align-center justify-center pt-2 pb-2">
			<text class="font-sm text-light-muted">{{chatShowTime}}</text>
		</view>
		<!-- æ’¤å›æ¶ˆæ¯ -->
		<view v-if="item.isremove"
		class="flex align-center justify-center pt-2 pb-2">
			<text class="font-sm text-light-muted">æ‚¨æ’¤å›äº†ä¸€æ¡ä¿¡æ¯</text>
		</view>
		<!-- èŠå¤©å†…å®¹ -->
		<view v-else
		class="flex align-start mb-3 position-relative"
		:class="[!isMe ? 'justify-start' : 'justify-end']">
			<!-- å¥½å‹ -->
			<!-- å¤´åƒ -->
			<u--image v-if="!isMe"
			:src="item.avatar" 
			mode="widthFix"
			width="80rpx" height="80rpx" radius="10rpx"></u--image>
			<!-- æ°”æ³¡ -->
			<!-- ä¸‰è§’å½¢ -->
			<text v-if="!isMe && needQipaoClass"
			class="iconfont font-md chat-left-icon">&#xe609;</text>
			<!-- å†…å®¹ -->
			<view class="p-2 rounded"
			style="max-width: 500rpx;"
			:style="contentStyle"
			:class="[!isMe ? 'ml-1':'mr-1',`chatItem${index}`,
			!isMe && needQipaoClass ? 'chat-left-content-bg pt-2' : 'pt-0',
			isMe && needQipaoClass ? 'chat-right-content-bg pt-2' : 'pt-0',]"
			:ref="'chatItem' + index"
			@longpress="onLongpress($event,index,item)">
			    <!-- æƒ…å†µ1: è¡¨æƒ…åŒ…é‡Œé¢çš„gif/pngå›¾ç‰‡  -->
				<view v-if="item.type == 'iconMenus' &&
				item.dataType && item.dataType == 'image'">
					<chat-item-image :item="item" :index="index"
					@click="previewImage(item,index)"
					imageClass="rounded"
					:maxWidth="300" :maxHeight="300"></chat-item-image>
				</view>
				<!-- æƒ…å†µ2: å‘å›¾ç‰‡  -->
				<view v-else-if="item.type == 'image'">
					<chat-item-image :item="item" :index="index"
					@click="previewImage(item,index)"
					imageClass="rounded"
					:maxWidth="300" :maxHeight="400"></chat-item-image>
				</view>
				<!-- æƒ…å†µ3: è¯­éŸ³  -->
				<view v-else-if="item.type == 'audio'">
				    <chat-item-audio :item="item" :index="index"
					:isMe="isMe"></chat-item-audio>
				</view>
			    <!-- æ–‡å­— -->
				<text v-else
				class="font" style="text-align: justify;">
					{{item.data}}
				</text>
			</view>
			
			<!-- æˆ‘ -->
			<text v-if="isMe && needQipaoClass"
			class="iconfont font-md chat-right-icon">&#xe640;</text>
			<u--image v-if="isMe"
			:src="item.avatar" 
			mode="widthFix"
			width="80rpx" height="80rpx" radius="10rpx"></u--image>
		</view>
    
	    <!-- å¼¹å‡ºèœå• -->
	    <chat-tooltip ref="chatTooltip" :mask="true" 
	    :maskTransparent="true" :isBottom="false" 
	    :tooltipWidth="tooltipWidth"
	    :tooltipHeight="60"
		tooltipClass="bg-dark border-0 text-white">
	    	<view class="flex flex-row flex-1">
	    		<view class="flex-1 align-center justify-center" 
				hover-class="bg-hover-dark"
	    			v-for="(item,index) in getmenuList" :key="index" 
					@click="clickType(item.type)">
	    			<text class="text-white">{{item.name}}</text>
	    		</view>
	    	</view>
			<!-- ç®­å¤´ -->
			<text class="position-fixed iconfont text-dark"
			style="font-size: 40rpx;"
			:style="jiantouStyle">&#xe649;</text>
	    </chat-tooltip>
	
	
	</view>
</template>

<script>
	import parseTimeJs from '@/common/mixins/parseTime.js';
	export default{
		name:"chat-item",
		mixins:[parseTimeJs],
		props:{
			item:Object,
			index:Number,
			//ä¸Šä¸€æ¡æ—¶é—´
			prevTime:[Number,String],
		},
		data(){
			return {
				menuEveHeight: 80, //æ¯ä¸ªèœå•é»˜è®¤é«˜åº¦æ˜¯60rpx
				menuList: [{
						name: "å¤åˆ¶",
						type: 'copy'
					},
					{
						name: "æ’¤å›",
						type: 'removeChatItem'
					},
				],
				tooltipLeft:0, //å¼¹å‡ºèœå•ç»„ä»¶left x
				tooltipTop:0, //å¼¹å‡ºèœå•ç»„ä»¶top y
				// ç»„ä»¶å†…å®¹è¶…è¿‡è¿™ä¸ªå®½åº¦ï¼Œèœå•å±…ä¸­ï¼Œ
				//å¦åˆ™èœå•å¼¹å‡ºä½ç½®ç”±ç‚¹å‡»ä½ç½®å†³å®š
				rectmaxWidth:0,
				longpressObj:null, // å­˜å‚¨é•¿æŒ‰ä¿¡æ¯å†…å®¹
				
			}
		},
		computed:{
			// æˆ‘çš„åˆ¤æ–­, å‡è®¾æˆ‘çš„id=2ï¼ŒåæœŸç”±å®é™…æ•°æ®åœ¨æ›´æ¢
			isMe(){
				let user_id = 2;
				return this.item.user_id === user_id;
			},
			// æ˜¾ç¤ºèŠå¤©æ—¶é—´
			chatShowTime(){
				return parseTimeJs.getChatTime(this.item.chat_time,this.prevTime);
			},
			tooltipHeight() {
				return this.getmenuList.length * this.menuEveHeight;
			},
			tooltipWidth(){
				return this.getmenuList.length * 120;
			},
			jiantouStyle(){
				let left = uni.upx2px(750-40) / 2;
				let top = this.tooltipTop + uni.upx2px(40 + 5);
				let jiantouCss = ``;
				if(this.longpressObj && this.longpressObj.rect.width < this.rectmaxWidth){
					top = this.longpressObj.y - 10;
					left = this.longpressObj.x + 5;
					jiantouCss = `transform:rotate(180deg);`;
					
				}
				return `left:${left}px;top:${top}px;${jiantouCss}`;
			},
			// å¼¹çª—èœå•å¤„ç†
			getmenuList(){
				return this.menuList.filter(v=>{
					if(v.name == 'æ’¤å›' && !this.isMe){
						return false
					}
					return true;
				})
			},
			// éœ€è¦æ°”æ³¡æ ·å¼
			needQipaoClass(){
				return this.item.type === 'text' ||
				this.item.type === 'audio' ||
				(this.item.type === 'iconMenus' && this.item.dataType === 'emoji');
			},
			// èŠå¤©å†…å®¹æ ·å¼
			contentStyle(){
				if(this.item.type == 'audio'){
					const duration = this.item.otherData.duration || 0;
					// æœ€é•¿æ—¶é•¿60ç§’
					const ratio = duration / 60 ;
					// æœ€å¤§å®½åº¦500rpx  æœ€å°120rpx
					const width = 500 * ratio < 120 ? 120 : 500 * ratio;
					return `width:${width}rpx`;
				}
			},
		},
		methods:{
			//é¢„è§ˆå›¾ç‰‡
			previewImage(item,index){
				console.log('é¢„è§ˆå›¾ç‰‡',item);
				// é¢„è§ˆå•ä¸ªå›¾ç‰‡
				// uni.previewImage({
				// 	urls:[item.data]
				// })
				// é¢„è§ˆå¤šå¼ å›¾ç‰‡
				this.$emit('previewImages',{
					item,
					index
				});
			},
			clickType(e) {
				console.log('ç‚¹å‡»èœå•',e);
				switch (e){
					case 'copy':
						break;
					case 'removeChatItem':
					    this.item.isremove = true;
						break;
				}
				this.$refs.chatTooltip.hide();
			},
			onLongpress(e,index,item){
				console.log('ç»„ä»¶é‡Œé¢çš„äº‹ä»¶å¯¹è±¡',e);
				let x = 0,
					y = 0;
				// #ifdef H5 || MP
				x = e.changedTouches[0].clientX;
				y = e.changedTouches[0].clientY;
				// #endif
				// #ifdef APP
				x = e.changedTouches[0].screenX;
				y = e.changedTouches[0].screenY;
				// #endif
				/*
				this.$emit('Longpress',{
					x,
					y,
					index,
					item
				});
				*/
				// #ifdef H5 || MP
				const query = uni.createSelectorQuery().in(this);
				query.select(`.chatItem${index}`).boundingClientRect(rect=>{
					if(rect){
						console.log('å†…å®¹éƒ¨åˆ†è·ç¦»å„ä¸ªæ–¹å‘',rect);
						this.longpressfn({
							x,
							y,
							index,
							item,
							rect:rect
						});
					}
				}).exec();
				// #endif
				// #ifdef APP
				const refName = 'chatItem' + index;
				const ref = this.$refs[refName];
				if (!ref) {
					console.error('æœªæ‰¾åˆ°å…ƒç´ å¼•ç”¨: ' + refName);
					return;
				}
				// ä½¿ç”¨ Weex çš„ dom æ¨¡å—è·å–ä½ç½®
				const dom = weex.requireModule('dom');
				dom.getComponentRect(ref, result => {
					if (result && result.result) {
						const rect = result.size;
						console.log('ç»„ä»¶è·ç¦»å„ä¸ªæ–¹å‘è·ç¦»:', rect);  
						this.longpressfn({
							x,
							y,
							index,
							item,
							rect:rect
						   });
					} else {
						console.error('è·å–ä½ç½®å¤±è´¥', result);
					}
				});
				// #endif
				
			},
			longpressfn(e){
				this.longpressObj = e;
				console.log('é•¿æŒ‰å¾—åˆ°longpressObj', e);
				// ç»„ä»¶å†…å®¹è¶…è¿‡è¿™ä¸ªå®½åº¦ï¼Œèœå•å±…ä¸­ï¼Œ
				//å¦åˆ™èœå•å¼¹å‡ºä½ç½®ç”±ç‚¹å‡»ä½ç½®å†³å®š
				this.rectmaxWidth = uni.upx2px((750 - 60 - 80 - (35 + 10 - 5)) / 2);
				console.log('å†…å®¹æœ€å¤§å®½åº¦',this.rectmaxWidth);
				if(e.rect.width >= this.rectmaxWidth){
					this.tooltipLeft = (uni.upx2px(750 - this.tooltipWidth)) / 2;
					this.tooltipTop = e.y - uni.upx2px(60 + 40 - 15);
				}else{
					this.tooltipLeft = e.x;
					this.tooltipTop = e.y;
				}
				this.$refs.chatTooltip.show(this.tooltipLeft, this.tooltipTop);
			}
		}
	}
</script>

<style scoped>
	/* #ifdef H5 */
	@import '/common/css/common.nvue.vue.css';
	/* #endif */
	
	.chat-left-icon{
		left:25rpx;top: 20rpx;z-index: 100;color:#ffffff;
	}
	.chat-right-icon{
		right:25rpx;top: 20rpx;z-index: 100;color:#95ec69;
	}
	.chat-left-content-bg{
		background-color: #ffffff;
	}
	.chat-right-content-bg{
		background-color: #95ec69;
	}
</style>
```
### â‘¢ è¯­éŸ³æ’­æ”¾ç»„ä»¶ `/pages/chat-item-audio/chat-item-audio.vue`
```vue
<template>
	<view class="flex align-center" @click="playAudio(item,index)"
	:class="[isMe ? 'justify-end' : 'justify-start']">
		<view v-if="!isMe">
			<image :src="audioPlayStatus ? audioIconList.notme.play:audioIconList.notme.stop" 
			style="width: 36rpx;height: 36rpx;"></image>
		</view>
		<text class="font"
		:class="[isMe?'mr-1':'ml-1']">{{item.otherData.duration + "'"}}</text>
		<!-- æˆ‘ éŸ³é¢‘ ç´ æå›¾ç‰‡ -->
		<view v-if="isMe">
			<image :src="audioPlayStatus ? audioIconList.me.play :audioIconList.me.stop" 
			style="width: 36rpx;height: 36rpx;"></image>
		</view>
	</view>
</template>

<script>
	import {mapState,mapGetters,mapMutations,mapActions} from 'vuex';
	export default{
		name:"chat-item-audio",
		props:{
			item:Object,
			index:Number,
			isMe:Boolean,
		},
		data(){
			return {
				// éŸ³é¢‘ä¸Šä¸‹æ–‡
				innerAudioContext:null,
				// æ’­æ”¾è¯­éŸ³åŠ¨ç”»ç´ æ
				audioIconList:{
					me:{
						stop:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png',
						play:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif'
					},
					notme:{
						stop:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.png',
						play:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.gif'
					},
				},
				// æ’­æ”¾çŠ¶æ€
				audioPlayStatus:false,
			}
		},
		computed:{
			...mapState({
				// testVuexValue:state=>state.testVuex,
				testVuexValue:state=>state.Audio.testVuex,
			}),
		},
		mounted() {
			if(this.item.type == 'audio'){
				// this.$onGlobalEvent(res=>{
				// 	console.log('ç›‘å¬$emitEventNameæ–¹æ³•çš„æ¶ˆæ¯',res);
				// });
				//this.$onGlobalEvent(this.onplayAudio);
				uni.$on('onplayAudio',res=>{
					// console.log('é€šè¿‡uni.$onæ¥å—çš„ç»“æœ',res);
					this.onplayAudio(res);
				})
			}
			
			console.log('vuexä¸­çš„stateçš„å€¼',this.testVuexValue);
		},
		destroyed() {
			// this.$offEventName(this.onplayAudio);
			uni.$off('onplayAudio');
			//é”€æ¯éŸ³é¢‘
			if(this.innerAudioContext){
				this.innerAudioContext.destroy();
				this.innerAudioContext = null;
			}
		},
		methods:{
			// å¼•å…¥actionsé‡Œé¢çš„æ–¹æ³•
			...mapActions(['$onGlobalEvent','$emitEventName','$offEventName']),
			// å…¨å±€ç›‘å¬æ’­æ”¾è¯­éŸ³çš„å¤„ç†
			onplayAudio(res){
				// console.log('ç›‘å¬$emitEventNameæ–¹æ³•çš„æ¶ˆæ¯',res);
				if(this.innerAudioContext){
					//åœæ­¢éç‚¹å‡»çš„éŸ³é¢‘
					if(res != this.index){
						this.innerAudioContext.stop();
					}
				}
			},
			//æ’­æ”¾è¯­éŸ³
			playAudio(item,index){
				// this.$emitEventName('æ‰§è¡Œä¸€ä¸ªå…¨å±€äº‹ä»¶ä¼ ä¸€ä¸ªè¦æ’­æ”¾çš„éŸ³é¢‘ç´¢å¼•ï¼š' + index);
				// return;
				// é€šçŸ¥å…¶å®ƒéç‚¹å‡»éŸ³é¢‘åœæ­¢æ’­æ”¾
				//this.$emitEventName(index);
				uni.$emit('onplayAudio',{index:index});
				if(!this.innerAudioContext){
					this.innerAudioContext = uni.createInnerAudioContext();
					this.innerAudioContext.src = item.data;
					this.innerAudioContext.play();
					// ç›‘å¬è¯­éŸ³æ’­æ”¾
					this.innerAudioContext.onPlay(()=>{
						this.audioPlayStatus = true;
					});
					// ç›‘å¬è¯­éŸ³æš‚åœ
					this.innerAudioContext.onPause(()=>{
						this.audioPlayStatus = false;
					});
					// ç›‘å¬è¯­éŸ³åœæ­¢
					this.innerAudioContext.onStop(()=>{
						this.audioPlayStatus = false;
					});
					// ç›‘å¬è¯­éŸ³é”™è¯¯
					this.innerAudioContext.onError(()=>{
						this.audioPlayStatus = false;
					});
				}else{
					this.innerAudioContext.stop();
					this.innerAudioContext.play();
				}
			},
		},
	}
</script>

<style>
	/* #ifdef H5 */
	@import '/common/css/common.nvue.vue.css';
	/* #endif */
</style>
```

## å…­ã€åŠ å·æ‰©å±•èœå•åŠŸèƒ½
å†…å®¹è¿‡å¤šï¼Œåœ¨æ–°é¡µé¢æ‰“å¼€ï¼Œå…·ä½“æŸ¥çœ‹ï¼š<br/>
1. <a href="/thirdless/w-b/06åŠ å·æ‰©å±•èœå•åŠŸèƒ½" target="_blank">èŠå¤©é¡µè¾“å…¥åŒºåŸŸï¼šåŠ å·æ‰©å±•èœå•åŠŸèƒ½ï¼ˆå‘å›¾ç‰‡ï¼‰</a>
2. <a href="/thirdless/w-b/06å‘è¯­éŸ³" target="_blank">èŠå¤©é¡µè¾“å…¥åŒºåŸŸï¼šåŠ å·æ‰©å±•èœå•åŠŸèƒ½ï¼šè¯­éŸ³åŠŸèƒ½ï¼ˆè¯­éŸ³æ’­æ”¾ï¼‰</a>
2. <a href="/thirdless/w-b/06å‘è¯­éŸ³åŠŸèƒ½" target="_blank">èŠå¤©é¡µè¾“å…¥åŒºåŸŸï¼šåŠ å·æ‰©å±•èœå•åŠŸèƒ½ï¼šè¯­éŸ³åŠŸèƒ½ï¼ˆå‘è¯­éŸ³ï¼‰</a>