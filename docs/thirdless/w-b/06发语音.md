---
navbar: true
sidebar: auto
title: 章节6.加号扩展菜单功能（发语音）
---

## 一、语音播放
大家可以在网上找一些音频测试，如：<https://aspx.sc.chinaz.com/query.aspx?classid=&keyword=%E5%8D%A1%E5%86%9C> <br/>
给大家准备了几个音频语音测试：
1. 发消息成功音频: `https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/sendMessage.mp3`
2. 接收消息音频： `https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/getMessage.mp3`
3. 卡龙音乐：`https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/kalong.mp3`
4. 微信语音： `https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/weixinYuYing.mp3`

### 1. 在页面补充音频数据并测试音频播放
1. 在页面 `/pages/chat/chat.nvue` 中补充音频数据
```js
{
    avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
    nickname: '小二哥',
    chat_time: 1750148979,
    data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/kalong.mp3',
    user_id: 2,
    type:'audio', //image,video
    isremove:false,
},
{
    avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-07.png',
    nickname: '小二哥',
    chat_time: 1750148989,
    data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/weixinYuYing.mp3',
    user_id: 2,
    type:'audio', //image,video
    isremove:false,
},
```
2. 接口API查看  <https://uniapp.dcloud.net.cn/api/#%E5%AA%92%E4%BD%93> <br/>
`播放音频` <https://uniapp.dcloud.net.cn/api/media/audio-context.html> <br/>
在组件 `/components/chat-item/chat-item.vue` <br/>
```js
<!-- 情况3: 语音 -->
<view v-else-if="item.type == 'audio'"
class="flex align-center"
@click="playAudio(item,index)">
    <text class="font">43'</text>
</view>
...
<script>
    export default{
        data(){
            return {
                ...
                // 音频上下文
                innerAudioContext:null,
                
            }
        },
        destroyed() {
            // 销毁音频
            if(this.innerAudioContext){
                this.innerAudioContext.destroy();
                this.innerAudioContext = null;
            }
        },
        methods:{
            // 播放语音
            playAudio(item,index){
                if(!this.innerAudioContext){
                    this.innerAudioContext = uni.createInnerAudioContext();
                    this.innerAudioContext.src = item.data;
                    this.innerAudioContext.play();
                }
            },
        }
    }
</script>
```

### 2. 音频切换播放
1. 需要用到vue中的状态管理：`vuex` (之前讲vue基础的时候没有讲到这块，这里直接通过讲音频切换播放来讲解vuex的使用) <https://uniapp.dcloud.net.cn/tutorial/vue-vuex.html> <br/>
2. `uni-app`官方提供了共享变量和数据的方案，其中就包括 `vuex` <https://uniapp.dcloud.net.cn/tutorial/nvue-api.html#sharevar>

#### ① 学会如何在uni-app中引入和使用vuex的基本用法
##### 1. 组装模块并导出 store 的地方
新建 `/store/index.js`
```js
import Vue from 'vue';
import Vuex from 'vuex';

Vue.use(Vuex);

export default new Vuex.Store({
	// 对应mapState，在computed中引入
    // 类似data,把全局或共用部分放这里
	state:{
		testVuex:'即时通讯',
	}
});
```

##### 2. 在 `main.js` 中引入并使用store
```js
import App from './App'

// #ifndef VUE3
import Vue from 'vue'
import Store from './store'; // 引入vuex

Vue.prototype.$store = Store; // 挂载到vue的原型进行共享

// main.js
...
const app = new Vue({
  Store, //vuex
  ...App
})
app.$mount()
// #endif

// #ifdef VUE3
...
// #endif
```

##### 3. 在页面或者组件中使用vuex
如，在组件 `/components/chat-item/chat-item.vue`
```vue
<script>
	...
	import { mapState } from 'vuex';
	export default{
        computed:{
			//vuex的state数据
			...mapState({
				testVuexValue: state => state.testVuex,
			}),
        },
        mounted() {
			console.log('看一下vuex中state的值',this.testVuexValue);
		},
    }
</script>
```

##### 4. vuex 分模块管理
说明：<br/>
我们在第二学期第二季课程里面讲vue.js基础的时候，没有讲到vuex，所以同学们刚开始学习的时候，会有些听不懂，这个没关系，你多听几遍，然后跟着老师敲代码，看如何引入vuex和使用，多敲两遍你就熟练了，关于vuex的更多用法我们在后面的课程也会深入讲解，目前大家只需要跟着老师敲代码学会使用即可。<br/>

新建模块文件夹，进行模块管理 `/store/modules/audio.js` 
1. `modules`模块文件夹 
2. `audio.js`语音（音频）模块
##### ① `/store/modules/audio.js` 语音（音频）模块
```js
export default {
	// 对应的mapState,在computed中引入
    // 类似data,把全局或共用部分放这里
	state:{
		testVuex:'即时通讯',
	},
}
``` 
##### ② `/store/index.js` 组装模块并导出 store 的地方
```js
import Vue from 'vue';
import Vuex from 'vuex';

Vue.use(Vuex);

// 引入音频模块
import Audio from '@/store/modules/audio.js';

export default new Vuex.Store({
	// 对应的mapState,在computed中引入
	// state:{
	// 	testVuex:'即时通讯',
	// },
	// 引入模块
	modules:{
		Audio, // 引入音频模块
	}
});
```
##### ③ 组件或者页面使用 vuex
如组件 `/components/chat-item/chat-item.vue`
```vue
<script>
	...
	import { mapState,mapGetters,mapMutations } from 'vuex';
	export default{
        computed:{
			//vuex的state数据
			...mapState({
				// testVuexValue: state => state.testVuex,// 主文件index.js中拿state
				testVuexValue:state=>state.Audio.testVuex,// 模块拿
			}),
        },
        mounted() {
			console.log('看一下vuex中state的值',this.testVuexValue);
		},
    }
</script>
```

##### 5. 音频切换播放（播放某个音频停止其它音频）
分析：我们希望当我点击某个音频的时候，其它音频停止播放，很显然我们需要通知多个其它音频组件全部停止播放，因此我们这里不能单纯使用`this.$emit`，而是要进行全局通知，`uni-app`提供了全局通知`uni.$emit`,全部监听`uni.$on`，具体查看：<https://uniapp.dcloud.net.cn/api/window/communication.html>

### ① 方式一： vuex全局监听（了解）
> 接下来我们看一下vuex如何在音频切换中使用，需要用到vuex中的`mutations` `同步一些方法`（在`methods`中引入） <br/> (异步一些方法 `actions`)  
>> 1. 音频模块代码 `/store/modules/audio.js`
>> ```js
>> export default {
>> 	// 对应的mapState,在computed中引入
>> 	// 类似data,把全局或共用部分放这里
>> 	state:{
>> 		testVuex:'即时通讯',
>> 		// 储存全局事件名称的数组
>> 		eventNames:[],
>> 	},
>> 	// 同步一些方法
>> 	mutations:{
>> 		// 写一个注册全局事件的函数（方法）
>> 		regGlobalEvent(state,eventName){
>> 			// 如果用户调用了mutations里面的方法
>> 			// 把用户调用的这个方法名称存进state中的eventNames数组
>> 			console.log('注册全局事件:' + eventName);
>> 			state.eventNames.push(eventName);
>> 		},
>> 		// 执行全局事件函数（方法）每个eventName
>> 		executeEventName(state,params){
>> 			state.eventNames.forEach(eventName=>{
>> 				eventName(params);
>> 			});
>> 		},
>> 		// 注意全局事件不用要及时注销移除
>> 		removeEventName(state,eventName){
>> 			// 先找到对应事件（方法）
>> 			let index = state.eventNames.
>> 			findIndex(ename => ename === eventName);
>> 			// 如果找到了事件（方法），则删除这个事件（方法）
>> 			if(index > -1){
>>              console.log('注销移除了事件:' + eventName);
>> 				state.eventNames.splice(index,1);
>> 			}
>> 		},
>> 	},
>> 	// 异步一些方法
>> 	actions:{
>> 		// 处理regGlobalEvent这些函数（方法）
>> 		$onGlobalEvent({commit},eventName){
>> 			commit('regGlobalEvent',eventName);
>> 		},
>> 		// 执行executeEventName函数（方法）
>> 		$emitEventName({commit},params){
>> 			commit('executeEventName',params);
>> 		},
>> 		// 执行removeEventName函数（方法）
>> 		$offEventName({commit},eventName){
>> 			commit('removeEventName',eventName);
>> 		},
>> 	},
>> }
>> ```
>> 2. 在组件调用 `/components/chat-item/chat-item.vue`
>> ```vue
>> <template>
>> 	<view class="px-3">
>> 		...
>> 	</view>
>> </template>
>> 
>> <script>
>> 	...
>> 	import {mapState,mapGetters,mapMutations,mapActions} from 'vuex';
>> 	export default{
>> 		...,
>> 		data(){
>> 			return {
>> 				...,
>> 				// 音频上下文
>> 				innerAudioContext:null,
>> 			}
>> 		},
>> 		computed:{
>> 			...mapState({
>> 				// testVuexValue:state=>state.testVuex, // 主文件拿
>> 				testVuexValue:state=>state.Audio.testVuex,// 模块拿
>> 			}),
>> 			...,
>> 		},
>> 		mounted() {
>> 			// 执行vuex中actions里面的方法
>> 			/*
>> 			this.$onGlobalEvent(res=>{
>> 				console.log('执行vuex中actions里面的方法',res);
>> 			});
>> 			*/
>> 		    /*
>> 		    if(this.item.type == 'audio'){
>> 				this.$onGlobalEvent(res=>{
>> 					console.log('执行vuex中actions里面的方法',res);
>> 				});
>> 			}
>> 			*/
>> 		    if(this.item.type == 'audio'){
>> 				// 监听播放语音的全局事件
>> 				this.$onGlobalEvent(this.onplayAudio);
>> 			}
>> 			
>> 			console.log('vuex中的state的值',this.testVuexValue);
>> 		},
>> 		destroyed() {
>> 			//注销播放语音的全局事件
>> 			this.$offEventName(this.onplayAudio);
>> 			//销毁音频
>> 			if(this.innerAudioContext){
>> 				this.innerAudioContext.destroy();
>> 				this.innerAudioContext = null;
>> 			}
>> 		},
>> 		methods:{
>> 			//引入actions里面的方法
>> 			...mapActions(['$onGlobalEvent','$emitEventName','$offEventName']),
>> 			//播放语音的全局事件
>> 			onplayAudio(res){
>> 				console.log('执行vuex中actions里面的方法',res);
>> 			},
>> 			//播放语音
>> 			playAudio(item,index){
>> 				this.$emitEventName('执行一个全局事件传要播放音频的索引:' + index);
>> 				return;
>> 				if(!this.innerAudioContext){
>> 					this.innerAudioContext = uni.createInnerAudioContext();
>> 					this.innerAudioContext.src = item.data;
>> 					this.innerAudioContext.play();
>> 				}
>> 			},
>> 			...,
>> 		}
>> 	}
>> </script>
>> 
>> ```

### ② 方式二：uni-app提供的全局事件
> 在组件调用 `/components/chat-item/chat-item.vue`
>> ```vue
>> <template>
>> 	<view class="px-3">
>> 		...
>> 	</view>
>> </template>
>> 
>> <script>
>> 	...
>> 	import {mapState,mapGetters,mapMutations,mapActions} from 'vuex';
>> 	export default{
>> 		...,
>> 		data(){
>> 			return {
>> 				...,
>> 				// 音频上下文
>> 				innerAudioContext:null,
>> 			}
>> 		},
>> 		computed:{
>> 			...mapState({
>> 				// testVuexValue:state=>state.testVuex, // 主文件拿
>> 				testVuexValue:state=>state.Audio.testVuex,// 模块拿
>> 			}),
>> 			...,
>> 		},
>> 		mounted() {
>> 			// 执行vuex中actions里面的方法
>> 			/*
>> 			this.$onGlobalEvent(res=>{
>> 				console.log('执行vuex中actions里面的方法',res);
>> 			});
>> 			*/
>> 		    /*
>> 		    if(this.item.type == 'audio'){
>> 				this.$onGlobalEvent(res=>{
>> 					console.log('执行vuex中actions里面的方法',res);
>> 				});
>> 			}
>> 			*/
>> 		    if(this.item.type == 'audio'){
>> 				// 监听播放语音的全局事件
>> 				//this.$onGlobalEvent(this.onplayAudio);
>>              uni.$on('onplayAudio',res=>{
>> 					console.log('看一下uni.$on监听结果',res);
>> 					this.onplayAudio(res);
>> 				});
>> 			}
>> 			
>> 			console.log('vuex中的state的值',this.testVuexValue);
>> 		},
>> 		destroyed() {
>> 			//注销播放语音的全局事件
>> 			//this.$offEventName(this.onplayAudio);
>>          uni.$off('onplayAudio');
>> 			//销毁音频
>> 			if(this.innerAudioContext){
>> 				this.innerAudioContext.destroy();
>> 				this.innerAudioContext = null;
>> 			}
>> 		},
>> 		methods:{
>> 			//引入actions里面的方法
>> 			...mapActions(['$onGlobalEvent','$emitEventName','$offEventName']),
>> 			//播放语音的全局事件
>> 			onplayAudio(res){
>> 				console.log('执行vuex中actions里面的方法',res);
>>              if(this.innerAudioContext){
>>					// 停止非点击播放的音频
>>					if(this.index !== res){
>>						this.innerAudioContext.stop();
>>					}
>>				}
>> 			},
>> 			//播放语音
>> 			playAudio(item,index){
>> 				//this.$emitEventName('执行一个全局事件传要播放音频的索引:' + index);
>> 				//return;
>>              // 通知其它非点击播放的音频停止播放
>>				//this.$emitEventName(index);
>>				uni.$emit('onplayAudio',{index:index});
>> 				if(!this.innerAudioContext){
>> 					this.innerAudioContext = uni.createInnerAudioContext();
>> 					this.innerAudioContext.src = item.data;
>> 					this.innerAudioContext.play();
>> 				}else{
>>					this.innerAudioContext.stop();
>>					this.innerAudioContext.play();
>>				}
>> 			},
>> 			...,
>> 		}
>> 	}
>> </script>
>> 
>> ```

## 二、 解决一个bug：发图片在小程序上不兼容的问题
在组件调用 `/components/chat-item-image/chat-item-image.vue`
```vue
<template>
	<view>
		<!-- 使用u--image组件固定宽高显示图片 -->
		<!-- <u--image showMenuByLongpress showLoading
		:src="item.data" mode="aspectFill"                    
		width="260rpx" height="150px" radius="10rpx"
		@click="previewImage(item,index)"
		@load="handleImageLoad($event,item,index)"></u--image> -->
		<!-- 计算宽高自适应显示图片 -->
		<!-- <image :src="item.data"
		lazy-load mode="widthFix"
		:style="imageShowStyle"
		class="rounded"
		@click="previewImage(item,index)"
		@load="auto_handleImageLoad($event,item,index)"></image> -->
		<!-- 优化后的方案-小程序不兼容 -->
		<!-- <image lazy-load :mode="imageMode"
		:src="item.data"
		:style="getImageStyle(index)"
		:class="imageClass"
		@click="$emit('click')"
		@load="handleImageLoad($event,item,index)"></image> -->
		<!-- 最终方案 多端兼容 -->
		<image lazy-load :mode="imageMode"
		:src="item.data"
		:style="computedStyles[index]"
		:class="imageClass"
		@click="$emit('click')"
		@load="good_handleImageLoad($event,item,index)"></image>
	</view>
</template>

<script>
	export default{
		name:"chat-item-image",
		props:{
			item:Object,
			index:Number,
			// class
			imageClass:{
				type:String,
				default:'rounded'
			},
			//最大宽度默认300rpx
			maxWidth:{
				type:Number,
				default:300
			},
			// 最大高度默认400rpx
			maxHeight:{
				type:Number,
				default:400
			}
		},
		data(){
			return {
				// 消息图
				width:120,
				height:120,
				imageSizes: {}, // 存储每个图片的计算尺寸
				imageMode: 'widthFix' // 图片模式
			}
		},
		computed:{
			// 图片等比例展示
			imageShowStyle(){
				return `width:${this.width}px;height: ${this.height}px;`;
			},
			// 最终方案 为每个索引创建计算属性
			computedStyles() {
				const styles = {};
				
				// 遍历所有已计算尺寸的图片
				for (const index in this.imageSizes) {
					const size = this.imageSizes[index];
					
					// 创建带单位的样式字符串
					styles[index] = {
						width: `${size.width}px`,
						height: `${size.height}px`
					};
				}
				
				return styles;
			}
		},
		methods:{
			// 加载预览图片并做自适应处理
			auto_handleImageLoad(e,item,index){
				console.log('加载预览图片event',e);
				console.log('加载预览图片item,index',item,index);
				let width =  e.detail.width;
				let height = e.detail.height;
				// 聊天界面显示图片 定义一个最大宽度300rpx
				let maxWidth = uni.upx2px(300);
				// 按照最大宽度300rpx 计算最大可显示的高度
				// if(width <= maxWidth){
				// 	//就用实际宽高
				// 	this.width = width;
				// 	this.height = heigth;
				// 	return;
				// }
				// this.width = maxWidth;
				// //width / height = maxWidth / maxHeight;
				// let maxHeight = maxWidth * (height / width);
				// this.height = maxHeight;
				// 按照最大高度400rpx 来计算一下宽度
				let maxHeight = uni.upx2px(400);
				// if(height <= maxHeight && width <= maxWidth){
				// 	this.width = width;
				// 	this.height = heigth;
				// 	return;
				// }
				// this.height = maxHeight;
				// // height / width = maxHeight / maxWidth;
				// this.width = maxHeight * (width/height);
				// 需要考虑 当图片达到最大高度，计算的宽度也超过最大宽度
				if(height <= maxHeight){
					this.width = width <= maxWidth ? width : maxWidth;
					this.height = heigth;
					return;
				}
				this.height = maxHeight;
				let _width = maxHeight * (width/height);
				this.width = _width <= maxWidth ? _width : maxWidth;
			},
			// 优化后的图片展示
			handleImageLoad(e, item, index) {
			  const { width: originWidth, height: originHeight } = e.detail;
			  const maxWidth = uni.upx2px(this.maxWidth); // 最大宽度300rpx转px
			  const maxHeight = uni.upx2px(this.maxHeight); // 最大高度400rpx转px
			  
			  // 计算缩放比例
			  const widthRatio = maxWidth / originWidth;
			  const heightRatio = maxHeight / originHeight;
			  const ratio = Math.min(widthRatio, heightRatio, 1); // 取最小比例且不超过1
			  
			  // 计算最终尺寸
			  let width = originWidth * ratio;
			  let height = originHeight * ratio;
			  
			  // 确保尺寸不超过最大值
			  if (width > maxWidth) width = maxWidth;
			  if (height > maxHeight) height = maxHeight;
			  
			  // 存储计算后的尺寸
			  this.$set(this.imageSizes, index, {
				width,
				height
			  });
			  
			  // 设置图片模式：宽>高时使用aspectFit，否则使用widthFix
			  //if (originWidth > originHeight) {
				//this.imageMode = 'aspectFit';
			  //} else {
				//this.imageMode = 'widthFix';
			  //}
			},
			// 优化后的获取图片样式
			getImageStyle(index) {
			  const size = this.imageSizes[index] || {};
			  return {
				width: size.width ? `${size.width}px` : '120px',
				height: size.height ? `${size.height}px` : '120px'
			  };
			},
            // 最终方案 多端兼容
		    good_handleImageLoad(e, item, index) {
				const { width: originWidth, height: originHeight } = e.detail;
				const maxWidth = uni.upx2px(this.maxWidth);
				const maxHeight = uni.upx2px(this.maxHeight);
				
				// 计算缩放比例
				const widthRatio = maxWidth / originWidth;
				const heightRatio = maxHeight / originHeight;
				const ratio = Math.min(widthRatio, heightRatio, 1);
				
				// 计算最终尺寸
				let width = Math.floor(originWidth * ratio);
				let height = Math.floor(originHeight * ratio);
				
				// 确保尺寸不超过最大值
				if (width > maxWidth) width = maxWidth;
				if (height > maxHeight) height = maxHeight;
				
				// 存储计算后的尺寸
				this.$set(this.imageSizes, index, {
					width,
					height
				});
			}
		}
	}
</script>

<style>
	/* #ifdef H5 */
	@import '/common/css/common.nvue.vue.css';
	/* #endif */
	/* 最终方案 默认图片样式 */
	/* #ifndef APP-PLUS-NVUE */
	image {
		width: 120px;
		height: 120px;
		border-radius: 10rpx;
	}
	/* #endif */
</style>
```


## 三、播放语音有动画提示并将语音播放封装成组件
素材如下，大家也可以自己制作素材：
1. `我`没有播放语音时候的素材：`https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png`
2. `我`播放语音时候的素材：`https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif`
3. `对方(好友)`没有播放语音时候的素材：`https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.png`
4. `对方(好友)`播放语音时候的素材：`https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.gif`
5. 聊天界面 `pages/chat/chat.nvue` 补充语音聊天信息：
```js
...,
{
	avatar: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/avatar-06.png',
	nickname: '彦祖',
	chat_time: 1750148999,
	data: 'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/kalong.mp3',
	user_id: 1,
	type:'audio', //image,video
	isremove:false,
},
```

### 1. 播放语音有动画提示功能实现
在组件 `/components/chat-item/chat-item.vue`
```vue
<template>
	<view class="px-3">
		<!-- 时间 -->
		...
		<!-- 撤回消息 -->
		...
		<!-- 聊天内容 -->
		...
			<!-- 好友 -->
			<!-- 头像 -->
			...
			<!-- 气泡 -->
			<!-- 三角形 -->
			...
			<!-- 内容 -->
			<view ...>
			    <!-- 情况1: 表情包里面的gif/png图片  -->
				...
				<!-- 情况2: 发图片  -->
				...
				<!-- 情况3: 语音  -->
				<view v-else-if="item.type == 'audio'"
				class="flex align-center"
				@click="playAudio(item,index)">
				    <view v-if="!isMe">
				    	<image :src="audioPlayStatus ? audioIconList.notme.play:audioIconList.notme.stop"
				    	style="width: 36rpx;height: 36rpx;"></image>
				    </view>
					<text class="font" :class="[isMe?'mr-1':'ml-1']">43'</text>
					<!-- 我 语音 素材 -->
					<!-- 静止 -->
					<!-- <image src="https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png"
					style="width: 36rpx;height: 36rpx;"></image> -->
					<!-- 播放语音 -->
					<!-- <image src="https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif"
					style="width: 36rpx;height: 36rpx;"></image> -->
					<view v-if="isMe">
						<image :src="audioPlayStatus ? audioIconList.me.play:audioIconList.me.stop"
						style="width: 36rpx;height: 36rpx;"></image>
					</view>
				</view>
			    <!-- 文字 -->
				...
			</view>
			
			<!-- 我 -->
			...
		</view>
    
	    <!-- 弹出菜单 -->
	    ...
	
	
	</view>
</template>

<script>
	...
	export default{
		...,
		data(){
			return {
				...,
				// 播放语音动画素材
				audioIconList:{
					me:{
						stop:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png',
						play:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif',
					},
					notme:{
						stop:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.png',
						play:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.gif',
					}
				},
				// 播放状态
				audioPlayStatus:false,
			}
		},
		...,
		methods:{
			...,
			//播放语音
			playAudio(item,index){
				...
				if(!this.innerAudioContext){
					this.innerAudioContext = uni.createInnerAudioContext();
					this.innerAudioContext.src = item.data;
					this.innerAudioContext.play();
					// 监听音频播放
					this.innerAudioContext.onPlay(()=>{
						this.audioPlayStatus = true;
					});
					// 监听音频暂停
					this.innerAudioContext.onPause(()=>{
						this.audioPlayStatus = false;
					});
					// 监听音频停止
					this.innerAudioContext.onStop(()=>{
						this.audioPlayStatus = false;
					});
					// 监听音频错误
					this.innerAudioContext.onError(()=>{
						this.audioPlayStatus = false;
					});
				}else{
					...
				}
			},
			
		}
	}
</script>

```

### 2. 语音播放封装成组件
#### ① 新建音频组件及代码
`/components/chat-item-audio/chat-item-audio.vue`
```vue
<template>
	<view class="flex align-center"
	@click="playAudio(item,index)">
		<view v-if="!isMe">
			<image :src="audioPlayStatus ? audioIconList.notme.play:audioIconList.notme.stop"
			style="width: 36rpx;height: 36rpx;"></image>
		</view>
		<text class="font" :class="[isMe?'mr-1':'ml-1']">43'</text>
		<!-- 我 语音 素材 -->
		<!-- 静止 -->
		<!-- <image src="https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png"
		style="width: 36rpx;height: 36rpx;"></image> -->
		<!-- 播放语音 -->
		<!-- <image src="https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif"
		style="width: 36rpx;height: 36rpx;"></image> -->
		<view v-if="isMe">
			<image :src="audioPlayStatus ? audioIconList.me.play:audioIconList.me.stop"
			style="width: 36rpx;height: 36rpx;"></image>
		</view>
	</view>
</template>

<script>
	import {mapState,mapGetters,mapMutations,mapActions} from 'vuex';
	export default{
		name:"chat-item-audio",
		props:{
			item:Object,
			index:Number,
			isMe:Boolean,
		},
		data(){
			return {
				// 音频上下文
				innerAudioContext:null,
				// 播放语音动画素材
				audioIconList:{
					me:{
						stop:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.png',
						play:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-me-icon.gif',
					},
					notme:{
						stop:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.png',
						play:'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/audio/audio-icon/audio-friend-icon.gif',
					}
				},
				// 播放状态
				audioPlayStatus:false,
			}
		},
		computed:{
			...mapState({
				// testVuexValue:state=>state.testVuex,
				testVuexValue:state=>state.Audio.testVuex,
			}),
		},
		mounted() {
			if(this.item.type == 'audio'){
				// this.$onGlobalEvent(res=>{
				// 	console.log('监听$emitEventName方法的消息',res);
				// });
				//this.$onGlobalEvent(this.onplayAudio);
				uni.$on('onplayAudio',res=>{
					// console.log('通过uni.$on接受的结果',res);
					this.onplayAudio(res);
				})
			}
			
			console.log('vuex中的state的值',this.testVuexValue);
		},
		destroyed() {
			// this.$offEventName(this.onplayAudio);
			uni.$off('onplayAudio');
			//销毁音频
			if(this.innerAudioContext){
				this.innerAudioContext.destroy();
				this.innerAudioContext = null;
			}
		},
		methods:{
			// 引入actions里面的方法
			...mapActions(['$onGlobalEvent','$emitEventName','$offEventName']),
			// 全局监听播放语音的处理
			onplayAudio(res){
				// console.log('监听$emitEventName方法的消息',res);
				if(this.innerAudioContext){
					//停止非点击的音频
					if(res != this.index){
						this.innerAudioContext.stop();
					}
				}
			},
			//播放语音
			playAudio(item,index){
				// this.$emitEventName('执行一个全局事件传一个要播放的音频索引：' + index);
				// return;
				// 通知其它非点击音频停止播放
				//this.$emitEventName(index);
				uni.$emit('onplayAudio',{index:index});
				if(!this.innerAudioContext){
					this.innerAudioContext = uni.createInnerAudioContext();
					this.innerAudioContext.src = item.data;
					this.innerAudioContext.play();
					// 监听音频播放
					this.innerAudioContext.onPlay(()=>{
						this.audioPlayStatus = true;
					});
					// 监听音频暂停
					this.innerAudioContext.onPause(()=>{
						this.audioPlayStatus = false;
					});
					// 监听音频停止
					this.innerAudioContext.onStop(()=>{
						this.audioPlayStatus = false;
					});
					// 监听音频错误
					this.innerAudioContext.onError(()=>{
						this.audioPlayStatus = false;
					});
				}else{
					this.innerAudioContext.stop();
					this.innerAudioContext.play();
				}
			},
		},
	}
</script>

<style>
	/* #ifdef H5 */
	@import '/common/css/common.nvue.vue.css';
	/* #endif */
</style>
```

#### ② 在`/components/chat-item/chat-item.vue`中引入音频组件
```vue
<!-- 情况3: 语音  -->
<view v-else-if="item.type == 'audio'">
	<chat-item-audio :item="item" :index="index"
	:isMe="isMe"></chat-item-audio>
</view>
```