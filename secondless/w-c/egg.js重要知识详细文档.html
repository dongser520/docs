<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>egg.js重要知识详细文档 | 睿晨网</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/assets/img/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="#icon-pengyouquan" href="/icons/iconfont.svg" color="#3eaf7c">
    <meta name="description" content="睿晨网|睿晨编程|零基础学做网站、app、小程序就从这里开始">
    <meta name="keywords" content="睿晨网,睿晨编程,零基础学做网站,零基础学app,零基础学小程序">
    <meta name="author" content="睿晨网,睿晨编程,阿东老师">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.0c241f14.css" as="style"><link rel="preload" href="/assets/js/app.4c1fa2f2.js" as="script"><link rel="preload" href="/assets/js/10.a1858127.js" as="script"><link rel="preload" href="/assets/js/2.641709ae.js" as="script"><link rel="preload" href="/assets/js/115.73763f96.js" as="script"><link rel="preload" href="/assets/js/4.68f7b7e9.js" as="script"><link rel="prefetch" href="/assets/js/100.18619803.js"><link rel="prefetch" href="/assets/js/101.795bb579.js"><link rel="prefetch" href="/assets/js/102.b2af91e0.js"><link rel="prefetch" href="/assets/js/103.addaf7eb.js"><link rel="prefetch" href="/assets/js/104.9cadff90.js"><link rel="prefetch" href="/assets/js/105.78b9c2c5.js"><link rel="prefetch" href="/assets/js/106.2e311b0f.js"><link rel="prefetch" href="/assets/js/107.719537c8.js"><link rel="prefetch" href="/assets/js/108.ee801dcb.js"><link rel="prefetch" href="/assets/js/109.7be9e3da.js"><link rel="prefetch" href="/assets/js/11.e11c94df.js"><link rel="prefetch" href="/assets/js/110.bef17d75.js"><link rel="prefetch" href="/assets/js/111.ae05aad1.js"><link rel="prefetch" href="/assets/js/112.348a918b.js"><link rel="prefetch" href="/assets/js/113.0377bb8f.js"><link rel="prefetch" href="/assets/js/114.7ce59f50.js"><link rel="prefetch" href="/assets/js/116.8c4955c8.js"><link rel="prefetch" href="/assets/js/117.f57f0ca7.js"><link rel="prefetch" href="/assets/js/118.ac987a87.js"><link rel="prefetch" href="/assets/js/119.191506f9.js"><link rel="prefetch" href="/assets/js/12.77b4f171.js"><link rel="prefetch" href="/assets/js/120.a9d0f345.js"><link rel="prefetch" href="/assets/js/121.74ec567e.js"><link rel="prefetch" href="/assets/js/122.9e1dbf90.js"><link rel="prefetch" href="/assets/js/123.2ae10c73.js"><link rel="prefetch" href="/assets/js/124.1e2930d5.js"><link rel="prefetch" href="/assets/js/125.bd54db16.js"><link rel="prefetch" href="/assets/js/126.501951f4.js"><link rel="prefetch" href="/assets/js/127.78e8444c.js"><link rel="prefetch" href="/assets/js/128.4e853ac8.js"><link rel="prefetch" href="/assets/js/129.b8b424a4.js"><link rel="prefetch" href="/assets/js/13.06be6eff.js"><link rel="prefetch" href="/assets/js/130.97044db5.js"><link rel="prefetch" href="/assets/js/131.a16e7627.js"><link rel="prefetch" href="/assets/js/132.1de37703.js"><link rel="prefetch" href="/assets/js/133.d99212b9.js"><link rel="prefetch" href="/assets/js/134.92f94379.js"><link rel="prefetch" href="/assets/js/135.e4a78e00.js"><link rel="prefetch" href="/assets/js/136.4977877f.js"><link rel="prefetch" href="/assets/js/137.4c4703c5.js"><link rel="prefetch" href="/assets/js/138.c199cd62.js"><link rel="prefetch" href="/assets/js/139.3ae48ccb.js"><link rel="prefetch" href="/assets/js/14.f75e8140.js"><link rel="prefetch" href="/assets/js/140.41d910b1.js"><link rel="prefetch" href="/assets/js/141.c93ed5fd.js"><link rel="prefetch" href="/assets/js/142.a30bcabf.js"><link rel="prefetch" href="/assets/js/143.8b1aaf58.js"><link rel="prefetch" href="/assets/js/144.f9b2970c.js"><link rel="prefetch" href="/assets/js/145.7363c390.js"><link rel="prefetch" href="/assets/js/146.1d5c8a1d.js"><link rel="prefetch" href="/assets/js/147.e121f839.js"><link rel="prefetch" href="/assets/js/148.add78a99.js"><link rel="prefetch" href="/assets/js/149.f27cc0ff.js"><link rel="prefetch" href="/assets/js/15.f10318c8.js"><link rel="prefetch" href="/assets/js/150.ced8ecaa.js"><link rel="prefetch" href="/assets/js/151.0bf12333.js"><link rel="prefetch" href="/assets/js/152.40f21e31.js"><link rel="prefetch" href="/assets/js/153.b262de48.js"><link rel="prefetch" href="/assets/js/154.50c64325.js"><link rel="prefetch" href="/assets/js/155.426015ec.js"><link rel="prefetch" href="/assets/js/156.4b9bf962.js"><link rel="prefetch" href="/assets/js/157.95c0b8d1.js"><link rel="prefetch" href="/assets/js/158.74450c14.js"><link rel="prefetch" href="/assets/js/159.cc9c20a2.js"><link rel="prefetch" href="/assets/js/16.49a0cfe4.js"><link rel="prefetch" href="/assets/js/160.01c4a8c7.js"><link rel="prefetch" href="/assets/js/161.d4c19dfb.js"><link rel="prefetch" href="/assets/js/162.42a1c4fb.js"><link rel="prefetch" href="/assets/js/163.d3b4d63d.js"><link rel="prefetch" href="/assets/js/164.f9f007d4.js"><link rel="prefetch" href="/assets/js/165.9f7441e0.js"><link rel="prefetch" href="/assets/js/166.1d96f480.js"><link rel="prefetch" href="/assets/js/167.5856d771.js"><link rel="prefetch" href="/assets/js/168.dd367256.js"><link rel="prefetch" href="/assets/js/169.cf1362a6.js"><link rel="prefetch" href="/assets/js/17.9cf0aeef.js"><link rel="prefetch" href="/assets/js/170.aca266de.js"><link rel="prefetch" href="/assets/js/171.599ff2d4.js"><link rel="prefetch" href="/assets/js/172.9e0826cc.js"><link rel="prefetch" href="/assets/js/173.d30914b5.js"><link rel="prefetch" href="/assets/js/174.d7494b91.js"><link rel="prefetch" href="/assets/js/175.b32a1bb2.js"><link rel="prefetch" href="/assets/js/176.decc27de.js"><link rel="prefetch" href="/assets/js/177.c0b71cf9.js"><link rel="prefetch" href="/assets/js/178.4e28a1ff.js"><link rel="prefetch" href="/assets/js/179.f6a019b1.js"><link rel="prefetch" href="/assets/js/18.f506f436.js"><link rel="prefetch" href="/assets/js/180.f853a887.js"><link rel="prefetch" href="/assets/js/181.b2de00b7.js"><link rel="prefetch" href="/assets/js/182.22b42a53.js"><link rel="prefetch" href="/assets/js/183.4d3486a4.js"><link rel="prefetch" href="/assets/js/184.25831409.js"><link rel="prefetch" href="/assets/js/185.d01fcfd3.js"><link rel="prefetch" href="/assets/js/186.49c41f4f.js"><link rel="prefetch" href="/assets/js/187.34eb1a96.js"><link rel="prefetch" href="/assets/js/188.651bcdfa.js"><link rel="prefetch" href="/assets/js/189.e75e375d.js"><link rel="prefetch" href="/assets/js/19.f216d96e.js"><link rel="prefetch" href="/assets/js/190.1ec83dea.js"><link rel="prefetch" href="/assets/js/191.bbb68c4d.js"><link rel="prefetch" href="/assets/js/192.1e4bd575.js"><link rel="prefetch" href="/assets/js/193.c560196e.js"><link rel="prefetch" href="/assets/js/194.ea7c96fd.js"><link rel="prefetch" href="/assets/js/195.279e9c3a.js"><link rel="prefetch" href="/assets/js/196.79b5d677.js"><link rel="prefetch" href="/assets/js/197.78f10001.js"><link rel="prefetch" href="/assets/js/198.d665ee5a.js"><link rel="prefetch" href="/assets/js/199.37013295.js"><link rel="prefetch" href="/assets/js/20.c9849598.js"><link rel="prefetch" href="/assets/js/200.2347a83a.js"><link rel="prefetch" href="/assets/js/201.19063bbd.js"><link rel="prefetch" href="/assets/js/202.32e5ace2.js"><link rel="prefetch" href="/assets/js/203.1f87638d.js"><link rel="prefetch" href="/assets/js/204.03cf582a.js"><link rel="prefetch" href="/assets/js/205.80fe2051.js"><link rel="prefetch" href="/assets/js/206.a0d9b926.js"><link rel="prefetch" href="/assets/js/207.3502356e.js"><link rel="prefetch" href="/assets/js/208.a4c9af93.js"><link rel="prefetch" href="/assets/js/209.9511055d.js"><link rel="prefetch" href="/assets/js/21.7d11fd8e.js"><link rel="prefetch" href="/assets/js/210.dc1b8bd8.js"><link rel="prefetch" href="/assets/js/211.eec86519.js"><link rel="prefetch" href="/assets/js/212.e26acd4d.js"><link rel="prefetch" href="/assets/js/213.9a9ec01e.js"><link rel="prefetch" href="/assets/js/214.19bf4a95.js"><link rel="prefetch" href="/assets/js/215.ede08fd2.js"><link rel="prefetch" href="/assets/js/216.a9443bde.js"><link rel="prefetch" href="/assets/js/217.845fad4f.js"><link rel="prefetch" href="/assets/js/218.10a24507.js"><link rel="prefetch" href="/assets/js/219.582bf77f.js"><link rel="prefetch" href="/assets/js/22.a81c6dd1.js"><link rel="prefetch" href="/assets/js/220.75958238.js"><link rel="prefetch" href="/assets/js/221.25aa9b7d.js"><link rel="prefetch" href="/assets/js/23.e3f76b3b.js"><link rel="prefetch" href="/assets/js/24.53929924.js"><link rel="prefetch" href="/assets/js/25.6da15d03.js"><link rel="prefetch" href="/assets/js/26.208cb02b.js"><link rel="prefetch" href="/assets/js/27.0055f1bf.js"><link rel="prefetch" href="/assets/js/28.c22d8dbb.js"><link rel="prefetch" href="/assets/js/29.5274de73.js"><link rel="prefetch" href="/assets/js/3.a5ce401d.js"><link rel="prefetch" href="/assets/js/30.0c8e8d20.js"><link rel="prefetch" href="/assets/js/31.dabb2430.js"><link rel="prefetch" href="/assets/js/32.4b69344f.js"><link rel="prefetch" href="/assets/js/33.2a6fe3fa.js"><link rel="prefetch" href="/assets/js/34.b7d7a9a6.js"><link rel="prefetch" href="/assets/js/35.fc527240.js"><link rel="prefetch" href="/assets/js/36.96422d34.js"><link rel="prefetch" href="/assets/js/37.7cd0e507.js"><link rel="prefetch" href="/assets/js/38.adb87b54.js"><link rel="prefetch" href="/assets/js/39.142ea250.js"><link rel="prefetch" href="/assets/js/40.2d6a4bf1.js"><link rel="prefetch" href="/assets/js/41.6dc1c411.js"><link rel="prefetch" href="/assets/js/42.c8355471.js"><link rel="prefetch" href="/assets/js/43.eba2417f.js"><link rel="prefetch" href="/assets/js/44.cdafd4da.js"><link rel="prefetch" href="/assets/js/45.5dfd5868.js"><link rel="prefetch" href="/assets/js/46.4cde5b6f.js"><link rel="prefetch" href="/assets/js/47.1fa112a3.js"><link rel="prefetch" href="/assets/js/48.cc7fe259.js"><link rel="prefetch" href="/assets/js/49.3df09ad7.js"><link rel="prefetch" href="/assets/js/5.6ac3d9b4.js"><link rel="prefetch" href="/assets/js/50.419588dd.js"><link rel="prefetch" href="/assets/js/51.c48be90d.js"><link rel="prefetch" href="/assets/js/52.c461b61e.js"><link rel="prefetch" href="/assets/js/53.4f6ab812.js"><link rel="prefetch" href="/assets/js/54.3293f69e.js"><link rel="prefetch" href="/assets/js/55.4d866de2.js"><link rel="prefetch" href="/assets/js/56.31a53067.js"><link rel="prefetch" href="/assets/js/57.19c7e76e.js"><link rel="prefetch" href="/assets/js/58.d8dc7186.js"><link rel="prefetch" href="/assets/js/59.bdfff1b6.js"><link rel="prefetch" href="/assets/js/6.f6f62d21.js"><link rel="prefetch" href="/assets/js/60.17072b43.js"><link rel="prefetch" href="/assets/js/61.035209e3.js"><link rel="prefetch" href="/assets/js/62.0d160a8a.js"><link rel="prefetch" href="/assets/js/63.cf07039a.js"><link rel="prefetch" href="/assets/js/64.4ac28cb2.js"><link rel="prefetch" href="/assets/js/65.c4b56fcb.js"><link rel="prefetch" href="/assets/js/66.fe14252b.js"><link rel="prefetch" href="/assets/js/67.f5182f00.js"><link rel="prefetch" href="/assets/js/68.29ba900b.js"><link rel="prefetch" href="/assets/js/69.8e3c6d8f.js"><link rel="prefetch" href="/assets/js/7.5ecdfcdb.js"><link rel="prefetch" href="/assets/js/70.272781c2.js"><link rel="prefetch" href="/assets/js/71.ba3c0143.js"><link rel="prefetch" href="/assets/js/72.0036a802.js"><link rel="prefetch" href="/assets/js/73.6bd6be40.js"><link rel="prefetch" href="/assets/js/74.d81dedf2.js"><link rel="prefetch" href="/assets/js/75.757237b7.js"><link rel="prefetch" href="/assets/js/76.f5792d24.js"><link rel="prefetch" href="/assets/js/77.d8aadd25.js"><link rel="prefetch" href="/assets/js/78.e4843ab3.js"><link rel="prefetch" href="/assets/js/79.a1f0575e.js"><link rel="prefetch" href="/assets/js/8.f3b4934d.js"><link rel="prefetch" href="/assets/js/80.ea9aa602.js"><link rel="prefetch" href="/assets/js/81.2cd439e3.js"><link rel="prefetch" href="/assets/js/82.9af7b0cb.js"><link rel="prefetch" href="/assets/js/83.77ac7dfb.js"><link rel="prefetch" href="/assets/js/84.17214734.js"><link rel="prefetch" href="/assets/js/85.0775f854.js"><link rel="prefetch" href="/assets/js/86.569d43a8.js"><link rel="prefetch" href="/assets/js/87.74196356.js"><link rel="prefetch" href="/assets/js/88.fa5aad52.js"><link rel="prefetch" href="/assets/js/89.11b2daa6.js"><link rel="prefetch" href="/assets/js/9.4d480772.js"><link rel="prefetch" href="/assets/js/90.3140661f.js"><link rel="prefetch" href="/assets/js/91.3d978faa.js"><link rel="prefetch" href="/assets/js/92.41c51097.js"><link rel="prefetch" href="/assets/js/93.70f92b88.js"><link rel="prefetch" href="/assets/js/94.7d09f78c.js"><link rel="prefetch" href="/assets/js/95.d7859f94.js"><link rel="prefetch" href="/assets/js/96.104638ee.js"><link rel="prefetch" href="/assets/js/97.fa2e330a.js"><link rel="prefetch" href="/assets/js/98.e49c1821.js"><link rel="prefetch" href="/assets/js/99.c5e10809.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0c241f14.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">睿晨网</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/aboutless.html" class="nav-link">
  第一期企业网页开发
</a></div><div class="nav-item"><a href="/secondless/" class="nav-link router-link-active">
  第二期企业网站开发
</a></div><div class="nav-item"><a href="/thirdless/" class="nav-link">
  第三期移动端(H5/小程序/App)课程
</a></div><div class="nav-item"><a href="/fourthless/" class="nav-link">
  第四期web全栈课程
</a></div><div class="nav-item"><a href="/fiveless/" class="nav-link">
  第五期python课程
</a></div><div class="nav-item"><a href="/web/software/" class="nav-link">
  课程软件小案例
</a></div><div class="nav-item"><a href="/web/mysql/" class="nav-link">
  课程案例数据表
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程答疑汇总" class="dropdown-title"><span class="title">课程答疑</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程答疑汇总" class="mobile-dropdown-title"><span class="title">课程答疑</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/answer/课程常见问题.html" class="nav-link">
  课程常见问题
</a></li><li class="dropdown-item"><!----> <a href="/deploy/" class="nav-link">
  项目部署
</a></li><li class="dropdown-item"><!----> <a href="/web/answer/免费部署SSL证书.html" class="nav-link">
  免费部署SSL证书
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程学习网站" class="dropdown-title"><span class="title">课程学习网站</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程学习网站" class="mobile-dropdown-title"><span class="title">课程学习网站</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          视频学习网站
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://study.163.com/provider/480000002289674/index.htm?share=2&amp;shareId=480000002289674" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网易云课堂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://space.bilibili.com/3493114067028034/pugv" target="_blank" rel="noopener noreferrer" class="nav-link external">
  B站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实用菜单" class="dropdown-title"><span class="title">实用网站和方法</span> <span class="arrow down"></span></button> <button type="button" aria-label="实用菜单" class="mobile-dropdown-title"><span class="title">实用网站和方法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          实用方法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/定位相关.html" class="nav-link">
  定位相关
</a></li><li class="dropdown-subitem"><a href="/web/methods/地图相关.html" class="nav-link">
  地图相关
</a></li><li class="dropdown-subitem"><a href="/web/methods/树形结构数据转换.html" class="nav-link">
  树形结构数据转换
</a></li></ul></li><li class="dropdown-item"><h4>
          uni-app专栏
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/uni-app专栏.html" class="nav-link">
  uni-app的UI框架
</a></li><li class="dropdown-subitem"><a href="/web/methods/uni-app如何引入库.html" class="nav-link">
  uni-app如何引入js库
</a></li></ul></li><li class="dropdown-item"><h4>
          Egg.js专栏
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/secondless/w-c/Egg.js.html" class="nav-link">
  Egg.js基础
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/egg.js基础总结.html" class="nav-link">
  Egg.js基础总结
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/egg.js重要知识详细文档.html" class="nav-link">
  Egg.js重要知识详细文档
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/ValParams API 说明.html" class="nav-link">
  Egg.js参数验证说明
</a></li><li class="dropdown-subitem"><a href="/web/mysql/Sequelize数据类型.html" class="nav-link">
  Egg.js迁移文件Sequelize数据类型
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/Egg.js接口安全防护方案.html" class="nav-link">
  Egg.js接口安全防护方案
</a></li><li class="dropdown-subitem"><a href="/web/answer/课程常见问题.html#_3-eggjs如何重置数据表-保证id每次从1开始计算" class="nav-link">
  Egg.js重置数据表每次ID为1
</a></li></ul></li><li class="dropdown-item"><h4>
          实用网站
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/实用接口.html" class="nav-link">
  实用接口
</a></li><li class="dropdown-subitem"><a href="/web/css/" class="nav-link">
  css
</a></li><li class="dropdown-subitem"><a href="/web/vue.js/" class="nav-link">
  Vue.js
</a></li><li class="dropdown-subitem"><a href="/web/Vue3+ElementPlus/" class="nav-link">
  Vue3+ElementPlus系统
</a></li><li class="dropdown-subitem"><a href="/web/echarts/" class="nav-link">
  echarts图表
</a></li><li class="dropdown-subitem"><a href="/web/bootstrap/" class="nav-link">
  Bootstrap
</a></li><li class="dropdown-subitem"><a href="/web/IIS/" class="nav-link">
  IIS
</a></li><li class="dropdown-subitem"><a href="/web/github/" class="nav-link">
  Github
</a></li><li class="dropdown-subitem"><a href="/web/Vanta.js/" class="nav-link">
  Vanta.js网页3D背景
</a></li><li class="dropdown-subitem"><a href="/web/shop/" class="nav-link">
  商城系统推荐
</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/aboutless.html" class="nav-link">
  第一期企业网页开发
</a></div><div class="nav-item"><a href="/secondless/" class="nav-link router-link-active">
  第二期企业网站开发
</a></div><div class="nav-item"><a href="/thirdless/" class="nav-link">
  第三期移动端(H5/小程序/App)课程
</a></div><div class="nav-item"><a href="/fourthless/" class="nav-link">
  第四期web全栈课程
</a></div><div class="nav-item"><a href="/fiveless/" class="nav-link">
  第五期python课程
</a></div><div class="nav-item"><a href="/web/software/" class="nav-link">
  课程软件小案例
</a></div><div class="nav-item"><a href="/web/mysql/" class="nav-link">
  课程案例数据表
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程答疑汇总" class="dropdown-title"><span class="title">课程答疑</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程答疑汇总" class="mobile-dropdown-title"><span class="title">课程答疑</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/answer/课程常见问题.html" class="nav-link">
  课程常见问题
</a></li><li class="dropdown-item"><!----> <a href="/deploy/" class="nav-link">
  项目部署
</a></li><li class="dropdown-item"><!----> <a href="/web/answer/免费部署SSL证书.html" class="nav-link">
  免费部署SSL证书
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程学习网站" class="dropdown-title"><span class="title">课程学习网站</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程学习网站" class="mobile-dropdown-title"><span class="title">课程学习网站</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          视频学习网站
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://study.163.com/provider/480000002289674/index.htm?share=2&amp;shareId=480000002289674" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网易云课堂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://space.bilibili.com/3493114067028034/pugv" target="_blank" rel="noopener noreferrer" class="nav-link external">
  B站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实用菜单" class="dropdown-title"><span class="title">实用网站和方法</span> <span class="arrow down"></span></button> <button type="button" aria-label="实用菜单" class="mobile-dropdown-title"><span class="title">实用网站和方法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          实用方法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/定位相关.html" class="nav-link">
  定位相关
</a></li><li class="dropdown-subitem"><a href="/web/methods/地图相关.html" class="nav-link">
  地图相关
</a></li><li class="dropdown-subitem"><a href="/web/methods/树形结构数据转换.html" class="nav-link">
  树形结构数据转换
</a></li></ul></li><li class="dropdown-item"><h4>
          uni-app专栏
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/uni-app专栏.html" class="nav-link">
  uni-app的UI框架
</a></li><li class="dropdown-subitem"><a href="/web/methods/uni-app如何引入库.html" class="nav-link">
  uni-app如何引入js库
</a></li></ul></li><li class="dropdown-item"><h4>
          Egg.js专栏
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/secondless/w-c/Egg.js.html" class="nav-link">
  Egg.js基础
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/egg.js基础总结.html" class="nav-link">
  Egg.js基础总结
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/egg.js重要知识详细文档.html" class="nav-link">
  Egg.js重要知识详细文档
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/ValParams API 说明.html" class="nav-link">
  Egg.js参数验证说明
</a></li><li class="dropdown-subitem"><a href="/web/mysql/Sequelize数据类型.html" class="nav-link">
  Egg.js迁移文件Sequelize数据类型
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/Egg.js接口安全防护方案.html" class="nav-link">
  Egg.js接口安全防护方案
</a></li><li class="dropdown-subitem"><a href="/web/answer/课程常见问题.html#_3-eggjs如何重置数据表-保证id每次从1开始计算" class="nav-link">
  Egg.js重置数据表每次ID为1
</a></li></ul></li><li class="dropdown-item"><h4>
          实用网站
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/实用接口.html" class="nav-link">
  实用接口
</a></li><li class="dropdown-subitem"><a href="/web/css/" class="nav-link">
  css
</a></li><li class="dropdown-subitem"><a href="/web/vue.js/" class="nav-link">
  Vue.js
</a></li><li class="dropdown-subitem"><a href="/web/Vue3+ElementPlus/" class="nav-link">
  Vue3+ElementPlus系统
</a></li><li class="dropdown-subitem"><a href="/web/echarts/" class="nav-link">
  echarts图表
</a></li><li class="dropdown-subitem"><a href="/web/bootstrap/" class="nav-link">
  Bootstrap
</a></li><li class="dropdown-subitem"><a href="/web/IIS/" class="nav-link">
  IIS
</a></li><li class="dropdown-subitem"><a href="/web/github/" class="nav-link">
  Github
</a></li><li class="dropdown-subitem"><a href="/web/Vanta.js/" class="nav-link">
  Vanta.js网页3D背景
</a></li><li class="dropdown-subitem"><a href="/web/shop/" class="nav-link">
  商城系统推荐
</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>egg.js重要知识详细文档</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#安装egg" class="sidebar-link">安装egg</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#目录结构" class="sidebar-link">目录结构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#路由相关" class="sidebar-link">路由相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_1-get传值" class="sidebar-link">1. get传值</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_2-4种配置方法" class="sidebar-link">2. 4种配置方法</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#重定向" class="sidebar-link">重定向</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_1-ctx" class="sidebar-link">1. ctx</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_2-路由重定向" class="sidebar-link">2. 路由重定向</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_3-路由分组" class="sidebar-link">3.路由分组</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#控制器" class="sidebar-link">控制器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#自定义-controller-基类" class="sidebar-link">自定义 Controller 基类</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#模板引擎" class="sidebar-link">模板引擎</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_1-安装和使用ejs" class="sidebar-link">1. 安装和使用ejs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_1-安装" class="sidebar-link">（1）安装：</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_2-配置-config" class="sidebar-link">（2）配置：/config</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_3-使用" class="sidebar-link">（3）使用</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#服务-模型" class="sidebar-link">服务（模型）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#模型和数据库" class="sidebar-link">模型和数据库</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#配置和创建迁移文件" class="sidebar-link">配置和创建迁移文件</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#配置" class="sidebar-link">配置</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#创建数据迁移表" class="sidebar-link">创建数据迁移表</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#已创建新增字段" class="sidebar-link">已创建新增字段</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#创建模型" class="sidebar-link">创建模型</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#模型其他参数" class="sidebar-link">模型其他参数</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#sequelize-命令" class="sidebar-link">sequelize 命令</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#外键约束-重要" class="sidebar-link">外键约束（重要）</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#创建第一个种子" class="sidebar-link">创建第一个种子</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#运行种子" class="sidebar-link">运行种子</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#撤销种子" class="sidebar-link">撤销种子</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#关联操作" class="sidebar-link">关联操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#一对一" class="sidebar-link">一对一</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#一对多" class="sidebar-link">一对多</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#多对多" class="sidebar-link">多对多</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#关联常用操作" class="sidebar-link">关联常用操作</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#获取器和修改器" class="sidebar-link">获取器和修改器</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#模型钩子" class="sidebar-link">模型钩子</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#查询" class="sidebar-link">查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#主键查询" class="sidebar-link">主键查询</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#查找不存在则创建" class="sidebar-link">查找不存在则创建</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#查找并计数" class="sidebar-link">查找并计数</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#查询多个-常用" class="sidebar-link">查询多个（常用）</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#复合过滤-or-not-查询" class="sidebar-link">复合过滤 / OR / NOT 查询</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#用限制-偏移-顺序和分组操作数据集" class="sidebar-link">用限制,偏移,顺序和分组操作数据集</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#字段过滤" class="sidebar-link">字段过滤</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#where" class="sidebar-link">Where</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#基础" class="sidebar-link">基础</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#操作符" class="sidebar-link">操作符</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#范围选项" class="sidebar-link">范围选项</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#组合" class="sidebar-link">组合</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#关系-关联" class="sidebar-link">关系 / 关联</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#分页-限制" class="sidebar-link">分页 / 限制</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#排序" class="sidebar-link">排序</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#count-计算数据库中元素的出现次数" class="sidebar-link">count - 计算数据库中元素的出现次数</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#max-获取特定表中特定属性的最大值" class="sidebar-link">max - 获取特定表中特定属性的最大值</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#min-获取特定表中特定属性的最小值" class="sidebar-link">min - 获取特定表中特定属性的最小值</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#sum-特定属性的值求和" class="sidebar-link">sum - 特定属性的值求和</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#预加载" class="sidebar-link">预加载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#使用预加载模型的顶层-where" class="sidebar-link">使用预加载模型的顶层 WHERE</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#包括所有" class="sidebar-link">包括所有</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#包括软删除的记录" class="sidebar-link">包括软删除的记录</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#排序预加载关联" class="sidebar-link">排序预加载关联</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#嵌套预加载" class="sidebar-link">嵌套预加载</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#新增" class="sidebar-link">新增</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#字段限制" class="sidebar-link">字段限制</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#新增单个" class="sidebar-link">新增单个</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#批量新增" class="sidebar-link">批量新增</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#修改" class="sidebar-link">修改</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#字段限制-2" class="sidebar-link">字段限制</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#单个修改" class="sidebar-link">单个修改</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#批量修改" class="sidebar-link">批量修改</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#递增" class="sidebar-link">递增</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#递减" class="sidebar-link">递减</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#删除" class="sidebar-link">删除</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#软删除" class="sidebar-link">软删除</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#查询包括软删除内容" class="sidebar-link">查询包括软删除内容</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#彻底删除" class="sidebar-link">彻底删除</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#恢复软删除的实例" class="sidebar-link">恢复软删除的实例</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#条件删除" class="sidebar-link">条件删除</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#批量删除" class="sidebar-link">批量删除</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#重载实例" class="sidebar-link">重载实例</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#模型自定义方法" class="sidebar-link">模型自定义方法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#scopes-作用域-重点" class="sidebar-link">Scopes - 作用域（重点）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#合并" class="sidebar-link">合并</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#合并-include" class="sidebar-link">合并 include</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#关联" class="sidebar-link">关联</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#扩展" class="sidebar-link">扩展</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#中间件" class="sidebar-link">中间件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_1-定义" class="sidebar-link">1. 定义</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_2-配置" class="sidebar-link">2. 配置</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_3-使用-2" class="sidebar-link">3. 使用</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#路由中使用" class="sidebar-link">路由中使用</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#使用-koa-的中间件-gzip压缩" class="sidebar-link">使用 Koa 的中间件（gzip压缩）</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#表单提交" class="sidebar-link">表单提交</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#post" class="sidebar-link">post</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#cookie" class="sidebar-link">cookie</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#session" class="sidebar-link">session</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#定时任务" class="sidebar-link">定时任务</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#api" class="sidebar-link">API</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#_1-context" class="sidebar-link">1. context</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#curl" class="sidebar-link">curl</a></li></ul></li><li><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#常用插件" class="sidebar-link">常用插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#缓存" class="sidebar-link">缓存</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#验证" class="sidebar-link">验证</a></li><li class="sidebar-sub-header"><a href="/secondless/w-c/egg.js%E9%87%8D%E8%A6%81%E7%9F%A5%E8%AF%86%E8%AF%A6%E7%BB%86%E6%96%87%E6%A1%A3.html#加密" class="sidebar-link">加密</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="安装egg"><a href="#安装egg" class="header-anchor">#</a> 安装egg</h2> <p>我们推荐直接使用脚手架，只需几条简单指令，即可快速生成项目（<code>npm &gt;=6.1.0</code>）:</p> <div class="language- extra-class"><pre class="language-text"><code>mkdir egg-example &amp;&amp; cd egg-example
npm init egg --type=simple
npm i
</code></pre></div><p>启动项目:</p> <div class="language- extra-class"><pre class="language-text"><code>npm run dev
open http://localhost:7001
</code></pre></div><h2 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h2> <div class="language- extra-class"><pre class="language-text"><code>egg-project
├── package.json
├── app.js (可选)
├── agent.js (可选)
├── app（-----------核心------------）
|   ├── router.js（路由）
│   ├── controller（控制器）
│   |   └── home.js
│   ├── service (模型)
│   |   └── user.js
│   ├── middleware (中间件)
│   |   └── response_time.js
│   ├── schedule (可选)
│   |   └── my_task.js
│   ├── public (静态资源)
│   |   └── reset.css
│   ├── view (模板视图)
│   |   └── home.tpl
│   └── extend (扩展)
│       ├── helper.js (可选)
│       ├── request.js (可选)
│       ├── response.js (可选)
│       ├── context.js (可选)
│       ├── application.js (可选)
│       └── agent.js (可选)
├── config
|   ├── plugin.js
|   ├── config.default.js
│   ├── config.prod.js
|   ├── config.test.js (可选)
|   ├── config.local.js (可选)
|   └── config.unittest.js (可选)
└── test
    ├── middleware
    |   └── response_time.test.js
    └── controller
        └── home.test.js
</code></pre></div><h2 id="路由相关"><a href="#路由相关" class="header-anchor">#</a> 路由相关</h2> <h3 id="_1-get传值"><a href="#_1-get传值" class="header-anchor">#</a> 1. get传值</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// router.js</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// controller</span>
<span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取路由get传值参数（路由:id）</span>
    ctx<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token comment">// 获取url的问号get传值参数</span>
    ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-4种配置方法"><a href="#_2-4种配置方法" class="header-anchor">#</a> 2. 4种配置方法</h3> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">verb</span><span class="token punctuation">(</span><span class="token string">'path-match'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">verb</span><span class="token punctuation">(</span><span class="token string">'router-name'</span><span class="token punctuation">,</span> <span class="token string">'path-match'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 第一个参数可以给name</span>
router<span class="token punctuation">.</span><span class="token function">verb</span><span class="token punctuation">(</span><span class="token string">'path-match'</span><span class="token punctuation">,</span> middleware1<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">,</span> middlewareN<span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">verb</span><span class="token punctuation">(</span><span class="token string">'router-name'</span><span class="token punctuation">,</span> <span class="token string">'path-match'</span><span class="token punctuation">,</span> middleware1<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">,</span> middlewareN<span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="重定向"><a href="#重定向" class="header-anchor">#</a> 重定向</h2> <h3 id="_1-ctx"><a href="#_1-ctx" class="header-anchor">#</a> 1. ctx</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">301</span><span class="token punctuation">;</span> <span class="token comment">// 把重定向改为301</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/admin/add'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认临时重定向 302</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-路由重定向"><a href="#_2-路由重定向" class="header-anchor">#</a> 2. 路由重定向</h3> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'/home/index'</span><span class="token punctuation">,</span> <span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-路由分组"><a href="#_3-路由分组" class="header-anchor">#</a> 3.路由分组</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/news'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router/admin'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// app/router/news.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/news/list'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/news/detail'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// app/router/admin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/user'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/log'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="控制器"><a href="#控制器" class="header-anchor">#</a> 控制器</h2> <h3 id="自定义-controller-基类"><a href="#自定义-controller-基类" class="header-anchor">#</a> 自定义 Controller 基类</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/core/base_controller.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">BaseController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      data<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">notFound</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    msg <span class="token operator">=</span> msg <span class="token operator">||</span> <span class="token string">'not found'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> BaseController<span class="token punctuation">;</span>
</code></pre></div><p>此时在编写应用的 Controller 时，可以继承 BaseController，直接使用基类上的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//app/controller/post.js</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../core/base_controller'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">listByUser</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>posts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="模板引擎"><a href="#模板引擎" class="header-anchor">#</a> 模板引擎</h2> <h2 id="_1-安装和使用ejs"><a href="#_1-安装和使用ejs" class="header-anchor">#</a> 1. 安装和使用ejs</h2> <h3 id="_1-安装"><a href="#_1-安装" class="header-anchor">#</a> （1）安装：</h3> <div class="language- extra-class"><pre class="language-text"><code>npm i egg-view-ejs --save
</code></pre></div><h3 id="_2-配置-config"><a href="#_2-配置-config" class="header-anchor">#</a> （2）配置：/config</h3> <p>config/config.default.js</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">appInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    
    config<span class="token punctuation">.</span>view <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">mapping</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">'.html'</span><span class="token operator">:</span> <span class="token string">'ejs'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
	<span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>config/plugin.js</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token comment">// 配置ejs</span>
    <span class="token literal-property property">ejs</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'egg-view-ejs'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-使用"><a href="#_3-使用" class="header-anchor">#</a> （3）使用</h3> <p>app/controller</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
     <span class="token comment">// 渲染变量</span>
     <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token string">&quot;测试内容&quot;</span><span class="token punctuation">;</span>
     <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token comment">// 渲染模板（render需要加await）</span>
     <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
         msg<span class="token punctuation">,</span>
         list
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>app/view/index.html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--渲染变量--&gt;</span>
    &lt;%=msg%&gt;
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
            &lt;% for(var i=0; i &lt; list.length; i++){ %&gt;
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
                    &lt;%=list[i]%&gt;
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
                &lt;% } %&gt;
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!--加载 app/public 下的资源文件--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/public/images/find.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="服务-模型"><a href="#服务-模型" class="header-anchor">#</a> 服务（模型）</h2> <p>控制器调用 <code>home</code> 模型的 <code>ceshi</code> 方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>home<span class="token punctuation">.</span><span class="token function">ceshi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>模型之间相互调用（同上）</p> <h2 id="模型和数据库"><a href="#模型和数据库" class="header-anchor">#</a> 模型和数据库</h2> <h3 id="配置和创建迁移文件"><a href="#配置和创建迁移文件" class="header-anchor">#</a> 配置和创建迁移文件</h3> <h3 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h3> <ol><li>安装并配置<a href="https://github.com/eggjs/egg-sequelize" target="_blank" rel="noopener noreferrer">egg-sequelize<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>插件（它会辅助我们将定义好的 Model 对象加载到 app 和 ctx 上）和<a href="https://github.com/sidorares/node-mysql2" target="_blank" rel="noopener noreferrer">mysql2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>模块：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>npm install <span class="token operator">--</span>save egg<span class="token operator">-</span>sequelize mysql2
</code></pre></div><ol start="2"><li>在<code>config/plugin.js</code>中引入 egg-sequelize 插件</li></ol> <div class="language- extra-class"><pre class="language-text"><code>exports.sequelize = {
  enable: true,
  package: 'egg-sequelize',
};
</code></pre></div><ol start="3"><li>在<code>config/config.default.js</code></li></ol> <div class="language-js extra-class"><pre class="language-js"><code>config<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">dialect</span><span class="token operator">:</span>  <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">host</span><span class="token operator">:</span>  <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">password</span><span class="token operator">:</span>  <span class="token string">'root'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span>  <span class="token number">3306</span><span class="token punctuation">,</span>
    <span class="token literal-property property">database</span><span class="token operator">:</span>  <span class="token string">'friends'</span><span class="token punctuation">,</span>
    <span class="token comment">// 中国时区</span>
    <span class="token literal-property property">timezone</span><span class="token operator">:</span>  <span class="token string">'+08:00'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">define</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 取消数据表名复数</span>
        <span class="token literal-property property">freezeTableName</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 自动写入时间戳 created_at updated_at</span>
        <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// 字段生成软删除时间戳 deleted_at</span>
        <span class="token literal-property property">paranoid</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">createdAt</span><span class="token operator">:</span> <span class="token string">'created_at'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token string">'updated_at'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">deletedAt</span><span class="token operator">:</span> <span class="token string">'deleted_at'</span><span class="token punctuation">,</span>
        <span class="token comment">// 所有驼峰命名格式化</span>
        <span class="token literal-property property">underscored</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ol start="4"><li>sequelize 提供了<a href="https://github.com/sequelize/cli" target="_blank" rel="noopener noreferrer">sequelize-cli<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>工具来实现<a href="http://docs.sequelizejs.com/manual/tutorial/migrations.html" target="_blank" rel="noopener noreferrer">Migrations<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，我们也可以在 egg 项目中引入 sequelize-cli。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>npm install <span class="token operator">--</span>save<span class="token operator">-</span>dev sequelize<span class="token operator">-</span>cli
</code></pre></div><ol start="5"><li>egg 项目中，我们希望将所有数据库 Migrations 相关的内容都放在<code>database</code>目录下，所以我们在项目根目录下新建一个<code>.sequelizerc</code>配置文件：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">config</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'database/config.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string-property property">'migrations-path'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'database/migrations'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string-property property">'seeders-path'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'database/seeders'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string-property property">'models-path'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'app/model'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ol start="6"><li>初始化 Migrations 配置文件和目录</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>npx sequelize init<span class="token operator">:</span>config
npx sequelize init<span class="token operator">:</span>migrations
<span class="token comment">// npx sequelize init:models</span>
</code></pre></div><ol start="7"><li>行完后会生成<code>database/config.json</code>文件和<code>database/migrations</code>目录，我们修改一下<code>database/config.json</code>中的内容，将其改成我们项目中使用的数据库配置：</li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;development&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;database&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dialect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;timezone&quot;</span><span class="token operator">:</span> <span class="token string">&quot;+08:00&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="8"><li>创建数据库</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>npx sequelize db<span class="token operator">:</span>create
</code></pre></div><h3 id="创建数据迁移表"><a href="#创建数据迁移表" class="header-anchor">#</a> 创建数据迁移表</h3> <div class="language-js extra-class"><pre class="language-js"><code>npx sequelize migration<span class="token operator">:</span>generate <span class="token operator">--</span>name<span class="token operator">=</span>init<span class="token operator">-</span>users
</code></pre></div><p>1.执行完命令后，会在database / migrations / 目录下生成数据表迁移文件，然后定义</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">up</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">ENUM</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span>
        <span class="token comment">// 创建表</span>
        <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">UNSIGNED</span><span class="token punctuation">,</span> <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">'用户名称'</span><span class="token punctuation">,</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">160</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">'用户邮箱'</span><span class="token punctuation">,</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">avatar_url</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">mobile</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">'用户手机'</span><span class="token punctuation">,</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">prifix</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">abstract</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">role_id</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
                <span class="token comment">//  定义外键（重要）</span>
                <span class="token literal-property property">references</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token comment">// 对应表名称（数据表名称）</span>
                    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'id'</span> <span class="token comment">// 对应表的主键</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">onUpdate</span><span class="token operator">:</span> <span class="token string">'restrict'</span><span class="token punctuation">,</span> <span class="token comment">// 更新时操作</span>
                <span class="token literal-property property">onDelete</span><span class="token operator">:</span> <span class="token string">'cascade'</span>  <span class="token comment">// 删除时操作</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">gender</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">ENUM</span><span class="token punctuation">,</span> <span class="token literal-property property">values</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'男'</span><span class="token punctuation">,</span><span class="token string">'女'</span><span class="token punctuation">,</span><span class="token string">'保密'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token string">'男'</span><span class="token punctuation">,</span> <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">'用户性别'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
            <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">engine</span><span class="token operator">:</span> <span class="token string">'MYISAM'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加索引</span>
        queryInterface<span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'gender'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加唯一索引</span>
        queryInterface<span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 索引名称</span>
            <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 唯一索引</span>
            <span class="token literal-property property">fields</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token comment">// 索引对应字段</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">down</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token parameter">queryInterface</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>执行 migrate 进行数据库变更</li></ul> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment"># 升级数据库</span>
npx sequelize db<span class="token punctuation">:</span>migrate
<span class="token comment"># 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更</span>
<span class="token comment"># npx sequelize db:migrate:undo</span>
<span class="token comment"># 可以通过 `db:migrate:undo:all` 回退到初始状态</span>
<span class="token comment"># npx sequelize db:migrate:undo:all</span>
</code></pre></div><h3 id="已创建新增字段"><a href="#已创建新增字段" class="header-anchor">#</a> 已创建新增字段</h3> <p>1.创建迁移文件：</p> <div class="language- extra-class"><pre class="language-text"><code>npx sequelize migration:generate --name=user-addcolumn
</code></pre></div><p>2.执行完命令后，会在database / migrations / 目录下生成数据表迁移文件，然后定义</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span>sequelize<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
          queryInterface<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'role_id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">transaction</span><span class="token operator">:</span> t <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          queryInterface<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'ceshi'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">transaction</span><span class="token operator">:</span> t <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span>sequelize<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
          queryInterface<span class="token punctuation">.</span><span class="token function">removeColumn</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'role_id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">transaction</span><span class="token operator">:</span> t <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          queryInterface<span class="token punctuation">.</span><span class="token function">removeColumn</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'ceshi'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">transaction</span><span class="token operator">:</span> t <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>3.执行 migrate 进行数据库变更</p> <div class="language- extra-class"><pre class="language-text"><code>npx sequelize db:migrate
</code></pre></div><h3 id="创建模型"><a href="#创建模型" class="header-anchor">#</a> 创建模型</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app / model / user.js</span>

<span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>
  <span class="token comment">// 配置（重要：一定要配置详细，一定要！！！）</span>
  <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
    <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否自动写入时间戳</span>
    <span class="token literal-property property">tableName</span><span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token comment">// 自定义数据表名称</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这个 Model 就可以在 Controller 和 Service 中通过 <code>app.model.User</code> 或者 <code>ctx.model.User</code> 访问到了，例如我们编写 <code>app/controller/users.js</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/users.js</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">toInt</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> str <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> str<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>str<span class="token punctuation">)</span> <span class="token keyword">return</span> str<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token function">toInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>limit<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token function">toInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>offset<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">toInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">toInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController<span class="token punctuation">;</span>
</code></pre></div><p>最后我们将这个 controller 挂载到路由上：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token string">'/users'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>针对 <code>users</code> 表的 CURD 操作的接口就开发完了</p> <h3 id="模型其他参数"><a href="#模型其他参数" class="header-anchor">#</a> 模型其他参数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 配置（重要）</span>
  <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
    <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token comment">// 自定义表名</span>
      <span class="token string-property property">'freezeTableName'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">'tableName'</span><span class="token operator">:</span> <span class="token string">'xyz_users'</span><span class="token punctuation">,</span>

      <span class="token comment">// 是否需要增加createdAt、updatedAt、deletedAt字段</span>
      <span class="token string-property property">'timestamps'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

      <span class="token comment">// 不需要createdAt字段</span>
      <span class="token string-property property">'createdAt'</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>

      <span class="token comment">// 将updatedAt字段改个名</span>
      <span class="token string-property property">'updatedAt'</span><span class="token operator">:</span> <span class="token string">'utime'</span><span class="token punctuation">,</span>

      <span class="token comment">// 将deletedAt字段改名</span>
      <span class="token comment">// 同时需要设置paranoid为true（此种模式下，删除数据时不会进行物理删除，而是设置deletedAt为当前时间</span>
      <span class="token string-property property">'deletedAt'</span><span class="token operator">:</span> <span class="token string">'dtime'</span><span class="token punctuation">,</span>
      <span class="token string-property property">'paranoid'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="sequelize-命令"><a href="#sequelize-命令" class="header-anchor">#</a> sequelize 命令</h3> <table><thead><tr><th style="text-align:left;">命令</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">sequelize db:migrate</td> <td style="text-align:left;">运行迁移文件</td></tr> <tr><td style="text-align:left;">sequelize db:migrate:status</td> <td style="text-align:left;">列出所有迁移的状态</td></tr> <tr><td style="text-align:left;">sequelize db:migrate:undo</td> <td style="text-align:left;">隔离数据库：迁移：撤消</td></tr> <tr><td style="text-align:left;">sequelize db:migrate:undo:all</td> <td style="text-align:left;">还原所有运行的迁移</td></tr> <tr><td style="text-align:left;">sequelize db:create</td> <td style="text-align:left;">创建由配置指定的数据库</td></tr> <tr><td style="text-align:left;">sequelize db:drop</td> <td style="text-align:left;">删除由配置指定的数据库</td></tr></tbody></table> <h3 id="外键约束-重要"><a href="#外键约束-重要" class="header-anchor">#</a> 外键约束（重要）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 迁移文件</span>
queryInterface<span class="token punctuation">.</span><span class="token function">addConstraint</span><span class="token punctuation">(</span><span class="token string">'tableName'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'foreign key'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'user_id'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">references</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">//Required field</span>
        <span class="token literal-property property">table</span><span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">field</span><span class="token operator">:</span> <span class="token string">'id'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">onDelete</span><span class="token operator">:</span> <span class="token string">'cascade'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">onUpdate</span><span class="token operator">:</span> <span class="token string">'cascade'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="创建第一个种子"><a href="#创建第一个种子" class="header-anchor">#</a> 创建第一个种子</h3> <p>假设我们希望在默认情况下将一些数据插入到几个表中. 如果我们跟进前面的例子,我们可以考虑为 <code>User</code> 表创建演示用户.</p> <p>要管理所有数据迁移,你可以使用 <code>seeders</code>. 种子文件是数据的一些变化,可用于使用样本数据或测试数据填充数据库表.</p> <p>让我们创建一个种子文件,它会将一个演示用户添加到我们的 <code>User</code> 表中.</p> <div class="language- extra-class"><pre class="language-text"><code>npx sequelize seed:generate --name demo-user
</code></pre></div><p>这个命令将会在 <code>seeders</code> 文件夹中创建一个种子文件.文件名看起来像是 <code>XXXXXXXXXXXXXX-demo-user.js</code>,它遵循相同的 <code>up/down</code> 语义,如迁移文件.</p> <p>现在我们应该编辑这个文件,将演示用户插入<code>User</code>表.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkInsert</span><span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'John'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Doe'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token string">'demo@demo.com'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">createdAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkDelete</span><span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="运行种子"><a href="#运行种子" class="header-anchor">#</a> 运行种子</h3> <p>在上一步中,你创建了一个种子文件. 但它还没有保存到数据库. 为此,我们需要运行一个简单的命令.</p> <div class="language- extra-class"><pre class="language-text"><code>npx sequelize db:seed:all
</code></pre></div><p>这将执行该种子文件,你将有一个演示用户插入 <code>User</code> 表.</p> <p><strong>注意:</strong> _ <code>seeders</code> 执行不会存储在任何使用 <code>SequelizeMeta</code> 表的迁移的地方. 如果你想覆盖这个,请阅读 <code>存储</code> 部分_</p> <h3 id="撤销种子"><a href="#撤销种子" class="header-anchor">#</a> 撤销种子</h3> <p>Seeders 如果使用了任何存储那么就可以被撤消. 有两个可用的命令</p> <p>如果你想撤消最近的种子</p> <div class="language- extra-class"><pre class="language-text"><code>npx sequelize db:seed:undo
</code></pre></div><p>如果你想撤消特定的种子</p> <div class="language- extra-class"><pre class="language-text"><code>npx sequelize db:seed:undo --seed name-of-seed-as-in-data
</code></pre></div><p>如果你想撤消所有的种子</p> <div class="language- extra-class"><pre class="language-text"><code>npx sequelize db:seed:undo:all
</code></pre></div><h2 id="关联操作"><a href="#关联操作" class="header-anchor">#</a> 关联操作</h2> <h3 id="一对一"><a href="#一对一" class="header-anchor">#</a> 一对一</h3> <p>模型层：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 一个用户对应一个用户资料</span>

<span class="token comment">// app/model/user.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

    <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
        <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
        <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关联关系</span>
    User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 关联用户资料 一对一</span>
        User<span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Userinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// app/model/userinfo.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>
    <span class="token keyword">const</span> userinfo <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'userinfo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">nickname</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span>
        <span class="token literal-property property">user_id</span><span class="token operator">:</span> <span class="token constant">INTEGER</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关联用户表</span>
    userinfo<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Userinfo<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userinfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>控制器调用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/users.js</span>
<span class="token comment">// 显示单条</span>
<span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据主键查询 查询一条用findOne</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 主表查询字段限制</span>
        <span class="token literal-property property">attributes</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 关联查询</span>
        <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token comment">// 需要查询的模型</span>
            <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Userinfo<span class="token punctuation">,</span>
            <span class="token comment">// 副表查询的字段</span>
            <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'nickname'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 主表条件</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="一对多"><a href="#一对多" class="header-anchor">#</a> 一对多</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">City</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
City<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">countryCode</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize<span class="token punctuation">,</span> <span class="token literal-property property">modelName</span><span class="token operator">:</span> <span class="token string">'city'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Country</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Country<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">isoCode</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize<span class="token punctuation">,</span> <span class="token literal-property property">modelName</span><span class="token operator">:</span> <span class="token string">'country'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在这里,我们可以根据国家代码连接国家和城市</span>
Country<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>City<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">'countryCode'</span><span class="token punctuation">,</span> <span class="token literal-property property">sourceKey</span><span class="token operator">:</span> <span class="token string">'isoCode'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
City<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>Country<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">'countryCode'</span><span class="token punctuation">,</span> <span class="token literal-property property">targetKey</span><span class="token operator">:</span> <span class="token string">'isoCode'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="多对多"><a href="#多对多" class="header-anchor">#</a> 多对多</h3> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Project<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Tasks'</span><span class="token punctuation">,</span> <span class="token literal-property property">through</span><span class="token operator">:</span> <span class="token string">'worker_tasks'</span><span class="token punctuation">,</span> <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">'userId'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
Project<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Workers'</span><span class="token punctuation">,</span> <span class="token literal-property property">through</span><span class="token operator">:</span> <span class="token string">'worker_tasks'</span><span class="token punctuation">,</span> <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">'projectId'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="关联常用操作"><a href="#关联常用操作" class="header-anchor">#</a> 关联常用操作</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取关联模型对象，n对一不需要加s</span>
<span class="token keyword">let</span> userinfo <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getUserinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// n对多需要加s</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 关联操作</span>
<span class="token comment">// 1：用户创建文章（一对多）</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Post<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;第一篇文章&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">user_id</span><span class="token operator">:</span> user<span class="token punctuation">.</span>id
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2.获取当前用户所有文章</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span><span class="token string">&quot;测试&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3：用户删除文章（一对多）</span>
<span class="token comment">// (1) 获取当前用户的所有文章</span>
<span class="token keyword">let</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
posts <span class="token operator">=</span> posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Post<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> posts
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 场景三：用户关注话题（多对多）</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TopicUser<span class="token punctuation">.</span><span class="token function">bulkCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token literal-property property">user_id</span><span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    <span class="token literal-property property">topic_id</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token literal-property property">user_id</span><span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    <span class="token literal-property property">topic_id</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 用户关注话题（多对多）</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TopicUser<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">user_id</span><span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        <span class="token literal-property property">topic_id</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="获取器和修改器"><a href="#获取器和修改器" class="header-anchor">#</a> 获取器和修改器</h2> <p>模型层</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/model/user.js</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

    <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 单独字段的getter，查询时都会调用</span>
            <span class="token comment">// this.getDataValue('name') 获取原始值</span>
            <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'年龄：'</span> <span class="token operator">+</span> age<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
            <span class="token comment">// 单独字段的setter，新增和更新时调用</span>
            <span class="token comment">// this.setDataValue('name') 设置原始值</span>
            <span class="token function">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> val <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
        <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关联用户资料</span>
    User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Userinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>控制器层</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据主键查询</span>
    <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取原始值 user.getDataValue('name')</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="模型钩子"><a href="#模型钩子" class="header-anchor">#</a> 模型钩子</h2> <p>模型层</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   
    <span class="token operator">...</span>

    <span class="token comment">// 钩子</span>
    <span class="token comment">// 查询前</span>
    User<span class="token punctuation">.</span><span class="token function">beforeFind</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'查询前'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查询后</span>
    User<span class="token punctuation">.</span><span class="token function">afterFind</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'查询后'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 新增前</span>
    User<span class="token punctuation">.</span><span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'新增前'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 新增后</span>
    User<span class="token punctuation">.</span><span class="token function">afterCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'新增后'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 修改前</span>
    User<span class="token punctuation">.</span><span class="token function">beforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'修改前'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 修改后</span>
    User<span class="token punctuation">.</span><span class="token function">afterUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'修改后'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 真正修改才会触发，数据相同不会触发</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除前</span>
    User<span class="token punctuation">.</span><span class="token function">beforeDestroy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'删除前'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除后</span>
    User<span class="token punctuation">.</span><span class="token function">afterDestroy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'删除后'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="查询"><a href="#查询" class="header-anchor">#</a> 查询</h2> <h3 id="主键查询"><a href="#主键查询" class="header-anchor">#</a> 主键查询</h3> <div class="language-js extra-class"><pre class="language-js"><code>Model<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="查找不存在则创建"><a href="#查找不存在则创建" class="header-anchor">#</a> 查找不存在则创建</h3> <p>方法 <code>findOrCreate</code> 可用于检查数据库中是否已存在某个元素. 如果是这种情况,则该方法将生成相应的实例. 如果元素不存在,将会被创建.</p> <p>如果是这种情况,则该方法将导致相应的实例. 如果元素不存在,将会被创建.</p> <p>假设我们有一个空的数据库,一个 <code>User</code> 模型有一个 <code>username</code> 和 <code>job</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code>User
  <span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'sdepold'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">defaults</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">job</span><span class="token operator">:</span> <span class="token string">'Technical Lead JavaScript'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span> <span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>user<span class="token punctuation">,</span> created<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">plain</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>created<span class="token punctuation">)</span>

    <span class="token comment">/*
    findOrCreate 返回一个包含已找到或创建的对象的数组,找到或创建的对象和一个布尔值,如果创建一个新对象将为true,否则为false,像这样:

    [ {
        username: 'sdepold',
        job: 'Technical Lead JavaScript',
        id: 1,
        createdAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET),
        updatedAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET)
      },
      true ]

在上面的例子中,第三行的数组将分成2部分,并将它们作为参数传递给回调函数,在这种情况下将它们视为 &quot;user&quot; 和 &quot;created&quot; .(所以“user”将是返回数组的索引0的对象,并且 &quot;created&quot; 将等于 &quot;true&quot;.)
    */</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>代码创建了一个新的实例. 所以当我们已经有一个实例了 ...</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'fnord'</span><span class="token punctuation">,</span> <span class="token literal-property property">job</span><span class="token operator">:</span> <span class="token string">'omnomnom'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> User<span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'fnord'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">defaults</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">job</span><span class="token operator">:</span> <span class="token string">'something else'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>user<span class="token punctuation">,</span> created<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">plain</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>created<span class="token punctuation">)</span>

    <span class="token comment">/*
    在这个例子中,findOrCreate 返回一个如下的数组:
    [ {
        username: 'fnord',
        job: 'omnomnom',
        id: 2,
        createdAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET),
        updatedAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET)
      },
      false
    ]
    由findOrCreate返回的数组通过第三行的数组扩展为两部分,并且这些部分将作为2个参数传递给回调函数,在这种情况下将其视为 &quot;user&quot; 和 &quot;created&quot; .(所以“user”将是返回数组的索引0的对象,并且 &quot;created&quot; 将等于 &quot;false&quot;.)
    */</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>...现有条目将不会更改. 看到第二个用户的 &quot;job&quot;,并且实际上创建操作是假的.</p> <h3 id="查找并计数"><a href="#查找并计数" class="header-anchor">#</a> 查找并计数</h3> <p><code>findAndCountAll</code> - 在数据库中搜索多个元素,返回数据和总计数</p> <p>这是一个方便的方法,它结合了 <code>findAll</code> 和 <code>count</code>(见下文),当处理与分页相关的查询时,这是有用的,你想用 <code>limit</code> 和 <code>offset</code> 检索数据,但也需要知道总数与查询匹配的记录数:</p> <p>处理程序成功将始终接收具有两个属性的对象:</p> <ul><li><code>count</code> - 一个整数,总数记录匹配where语句和关联的其它过滤器</li> <li><code>rows</code> - 一个数组对象,记录在limit和offset范围内匹配where语句和关联的其它过滤器,</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>Project
  <span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'foo%'</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
     <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>它支持 include. 只有标记为 <code>required</code> 的 include 将被添加到计数部分:</p> <p>假设你想查找附有个人资料的所有用户:</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span>
     <span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> Profile<span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>因为 <code>Profile</code> 的 include 有 <code>required</code> 设置,这将导致内部连接,并且只有具有 profile 的用户将被计数. 如果我们从 include 中删除<code>required</code>,那么有和没有 profile 的用户都将被计数. 在include中添加一个 <code>where</code> 语句会自动使它成为 required:</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span>
     <span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> Profile<span class="token punctuation">,</span> <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的查询只会对具有 active profile 的用户进行计数,因为在将 where 语句添加到 include 时,<code>required</code> 被隐式设置为 true.</p> <p>传递给 <code>findAndCountAll</code> 的 options 对象与 <code>findAll</code> 相同(如下所述).</p> <h3 id="查询多个-常用"><a href="#查询多个-常用" class="header-anchor">#</a> 查询多个（常用）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 找到多个条目</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">projects</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// projects 将是所有 Project 实例的数组</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 搜索特定属性 - 使用哈希</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'A Project'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">projects</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// projects将是一个具有指定 name 的 Project 实例数组</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 在特定范围内进行搜索</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">projects</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// projects将是一系列具有 id 1,2 或 3 的项目</span>
  <span class="token comment">// 这实际上是在做一个 IN 查询</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>and<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span>           <span class="token comment">// 且 (a = 5)</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// (a = 5 或 a = 6)</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>                <span class="token comment">// id &gt; 6</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gte<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>               <span class="token comment">// id &gt;= 6</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>lt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>               <span class="token comment">// id &lt; 10</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>lte<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment">// id &lt;= 10</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>ne<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>               <span class="token comment">// id != 20</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>between<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment">// 在 6 和 10 之间</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>notBetween<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 不在 11 和 15 之间</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>in<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>           <span class="token comment">// 在 [1, 2] 之中</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>notIn<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment">// 不在 [1, 2] 之中</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%hat'</span><span class="token punctuation">,</span>         <span class="token comment">// 包含 '%hat'</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>notLike<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%hat'</span><span class="token punctuation">,</span>       <span class="token comment">// 不包含 '%hat'</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>iLike<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%hat'</span><span class="token punctuation">,</span>         <span class="token comment">// 包含 '%hat' (不区分大小写)  (仅限 PG)</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>notILike<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%hat'</span><span class="token punctuation">,</span>      <span class="token comment">// 不包含 '%hat'  (仅限 PG)</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>overlap<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token comment">// &amp;&amp; [1, 2] (PG数组重叠运算符)</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>contains<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token comment">// @&gt; [1, 2] (PG数组包含运算符)</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>contained<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment">// &lt;@ [1, 2] (PG数组包含于运算符)</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>any<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token comment">// 任何数组[2, 3]::INTEGER (仅限 PG)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>not<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>           <span class="token comment">// status 不为 FALSE</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="复合过滤-or-not-查询"><a href="#复合过滤-or-not-查询" class="header-anchor">#</a> 复合过滤 / OR / NOT 查询</h3> <p>你可以使用多层嵌套的 AND,OR 和 NOT 条件进行一个复合的 where 查询. 为了做到这一点,你可以使用 <code>or</code> , <code>and</code> 或 <code>not</code> <code>运算符</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code>Project<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'a project'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Project<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'a project'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这两段代码将生成以下内容:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">SELECT</span> <span class="token operator">*</span>
<span class="token constant">FROM</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Projects</span><span class="token template-punctuation string">`</span></span>
<span class="token constant">WHERE</span> <span class="token punctuation">(</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Projects</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name</span><span class="token template-punctuation string">`</span></span> <span class="token operator">=</span> <span class="token string">'a project'</span>
   <span class="token constant">AND</span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Projects</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">id</span><span class="token template-punctuation string">`</span></span> <span class="token constant">IN</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token constant">OR</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Projects</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">id</span><span class="token template-punctuation string">`</span></span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token constant">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p><code>not</code> 示例:</p> <div class="language-js extra-class"><pre class="language-js"><code>Project<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'a project'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>not<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>contains<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将生成:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">SELECT</span> <span class="token operator">*</span>
<span class="token constant">FROM</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Projects</span><span class="token template-punctuation string">`</span></span>
<span class="token constant">WHERE</span> <span class="token punctuation">(</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Projects</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name</span><span class="token template-punctuation string">`</span></span> <span class="token operator">=</span> <span class="token string">'a project'</span>
   <span class="token constant">AND</span> <span class="token constant">NOT</span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Projects</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">id</span><span class="token template-punctuation string">`</span></span> <span class="token constant">IN</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token constant">OR</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Projects</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">array</span><span class="token template-punctuation string">`</span></span> @<span class="token operator">&gt;</span> <span class="token constant">ARRAY</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token operator">:</span><span class="token constant">INTEGER</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token constant">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="用限制-偏移-顺序和分组操作数据集"><a href="#用限制-偏移-顺序和分组操作数据集" class="header-anchor">#</a> 用限制,偏移,顺序和分组操作数据集</h3> <p>要获取更多相关数据,可以使用限制,偏移,顺序和分组:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 限制查询的结果</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 跳过前10个元素</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 跳过前10个元素,并获取2个</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>分组和排序的语法是相同的,所以下面只用一个单独的例子来解释分组,而其余的则是排序. 你下面看到的所有内容也可以对分组进行</p> <div class="language-js extra-class"><pre class="language-js"><code>Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 生成 ORDER BY title DESC</span>

Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">group</span><span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 生成 GROUP BY name</span>
</code></pre></div><p>请注意,在上述两个示例中,提供的字符串逐字插入到查询中,所以不会转义列名称. 当你向 order / group 提供字符串时,将始终如此. 如果要转义列名,你应该提供一个参数数组,即使你只想通过单个列进行 order / group</p> <div class="language-js extra-class"><pre class="language-js"><code>something<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 将返回 `name`</span>
    <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 将返回 `username` DESC</span>
    <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 将返回 max(`age`)</span>
    sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'max'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 将返回 max(`age`) DESC</span>
    <span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'max'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 将返回 otherfunction(`col1`, 12, 'lalala') DESC</span>
    <span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'otherfunction'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'col1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">'lalala'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 将返回 otherfunction(awesomefunction(`col`)) DESC,这个嵌套是可以无限的！</span>
    <span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'otherfunction'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'awesomefunction'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'col'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>回顾一下,order / group数组的元素可以是以下内容:</p> <ul><li>String - 将被引用</li> <li>Array - 第一个元素将被引用,第二个将被逐字地追加</li> <li>Object -
<ul><li>raw 将被添加逐字引用</li> <li>如果未设置 raw,一切都被忽略,查询将失败</li></ul></li> <li>Sequelize.fn 和 Sequelize.col 返回函数和引用的列名</li></ul> <h3 id="字段过滤"><a href="#字段过滤" class="header-anchor">#</a> 字段过滤</h3> <p>想要只选择某些属性,可以使用 <code>attributes</code> 选项. 通常是传递一个数组:</p> <div class="language-js extra-class"><pre class="language-js"><code>Model<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>SELECT foo, bar ...</p></blockquote> <p>属性可以使用嵌套数组来重命名:</p> <div class="language-js extra-class"><pre class="language-js"><code>Model<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>SELECT foo, bar AS baz ...</p></blockquote> <p>也可以使用 <code>sequelize.fn</code> 来进行聚合:</p> <div class="language-js extra-class"><pre class="language-js"><code>Model<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'COUNT'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'hats'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'no_hats'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>SELECT COUNT(hats) AS no_hats ...</p></blockquote> <p>使用聚合功能时,必须给它一个别名,以便能够从模型中访问它. 在上面的例子中,你可以使用 <code>instance.get('no_hats')</code> 获得帽子数量.</p> <p>有时,如果你只想添加聚合,则列出模型的所有属性可能令人厌烦:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// This is a tiresome way of getting the number of hats...</span>
Model<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">,</span> <span class="token string">'quz'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'COUNT'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'hats'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'no_hats'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This is shorter, and less error prone because it still works if you add / remove attributes</span>
Model<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'COUNT'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'hats'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'no_hats'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">SELECT</span> id<span class="token punctuation">,</span> foo<span class="token punctuation">,</span> bar<span class="token punctuation">,</span> baz<span class="token punctuation">,</span> quz<span class="token punctuation">,</span> <span class="token constant">COUNT</span><span class="token punctuation">(</span>hats<span class="token punctuation">)</span> <span class="token constant">AS</span> no_hats <span class="token operator">...</span>
</code></pre></div><p>同样,它也可以排除一些指定的表字段:</p> <div class="language-js extra-class"><pre class="language-js"><code>Model<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'baz'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">SELECT</span> id<span class="token punctuation">,</span> foo<span class="token punctuation">,</span> bar<span class="token punctuation">,</span> quz <span class="token operator">...</span>
</code></pre></div><h3 id="where"><a href="#where" class="header-anchor">#</a> Where</h3> <p>无论你是通过 findAll/find 或批量 updates/destroys 进行查询,都可以传递一个 <code>where</code> 对象来过滤查询.</p> <p><code>where</code> 通常用 attribute:value 键值对获取一个对象,其中 value 可以是匹配等式的数据或其他运算符的键值对象.</p> <p>也可以通过嵌套 <code>or</code> 和 <code>and</code> <code>运算符</code> 的集合来生成复杂的 AND/OR 条件.</p> <h3 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Op <span class="token operator">=</span> Sequelize<span class="token punctuation">.</span>Op<span class="token punctuation">;</span>

Post<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">authorId</span><span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// SELECT * FROM post WHERE authorId = 2</span>

Post<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">authorId</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'active'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// SELECT * FROM post WHERE authorId = 12 AND status = 'active';</span>

Post<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">authorId</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">authorId</span><span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// SELECT * FROM post WHERE authorId = 12 OR authorId = 13;</span>

Post<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">authorId</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// SELECT * FROM post WHERE authorId = 12 OR authorId = 13;</span>

Post<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'inactive'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// DELETE FROM post WHERE status = 'inactive';</span>

Post<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">deletedAt</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>ne<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// UPDATE post SET updatedAt = null WHERE deletedAt NOT NULL;</span>

Post<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> sequelize<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'char_length'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// SELECT * FROM post WHERE char_length(status) = 6;</span>
</code></pre></div><h3 id="操作符"><a href="#操作符" class="header-anchor">#</a> 操作符</h3> <p>Sequelize 可用于创建更复杂比较的符号运算符 -</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Op <span class="token operator">=</span> Sequelize<span class="token punctuation">.</span>Op

<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>and<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span>           <span class="token comment">// 且 (a = 5)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">]</span>  <span class="token comment">// (a = 5 或 a = 6)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>                <span class="token comment">// id &gt; 6</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gte<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>               <span class="token comment">// id &gt;= 6</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>lt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>               <span class="token comment">// id &lt; 10</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>lte<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>              <span class="token comment">// id &lt;= 10</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>ne<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>               <span class="token comment">// id != 20</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>eq<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>                <span class="token comment">// = 3</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>not<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token comment">// 不是 TRUE</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>between<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment">// 在 6 和 10 之间</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>notBetween<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 不在 11 和 15 之间</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>in<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>           <span class="token comment">// 在 [1, 2] 之中</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>notIn<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment">// 不在 [1, 2] 之中</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%hat'</span><span class="token punctuation">,</span>         <span class="token comment">// 包含 '%hat'</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>notLike<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%hat'</span>       <span class="token comment">// 不包含 '%hat'</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>iLike<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%hat'</span>         <span class="token comment">// 包含 '%hat' (不区分大小写)  (仅限 PG)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>notILike<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%hat'</span>      <span class="token comment">// 不包含 '%hat'  (仅限 PG)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>startsWith<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'hat'</span>     <span class="token comment">// 类似 'hat%'</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>endsWith<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'hat'</span>       <span class="token comment">// 类似 '%hat'</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>substring<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'hat'</span>      <span class="token comment">// 类似 '%hat%'</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>regexp<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'^[h|a|t]'</span>    <span class="token comment">// 匹配正则表达式/~ '^[h|a|t]' (仅限 MySQL/PG)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>notRegexp<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'^[h|a|t]'</span> <span class="token comment">// 不匹配正则表达式/!~ '^[h|a|t]' (仅限 MySQL/PG)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>iRegexp<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'^[h|a|t]'</span>    <span class="token comment">// ~* '^[h|a|t]' (仅限 PG)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>notIRegexp<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'^[h|a|t]'</span> <span class="token comment">// !~* '^[h|a|t]' (仅限 PG)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>any<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token string">'hat'</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token comment">// 包含任何数组['cat', 'hat'] - 同样适用于 iLike 和 notLike</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>overlap<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>       <span class="token comment">// &amp;&amp; [1, 2] (PG数组重叠运算符)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>contains<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>      <span class="token comment">// @&gt; [1, 2] (PG数组包含运算符)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>contained<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>     <span class="token comment">// &lt;@ [1, 2] (PG数组包含于运算符)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>any<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>            <span class="token comment">// 任何数组[2, 3]::INTEGER (仅限PG)</span>

<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>col<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'user.organization_id'</span> <span class="token comment">// = 'user'.'organization_id', 使用数据库语言特定的列标识符, 本例使用 PG</span>
</code></pre></div><h3 id="范围选项"><a href="#范围选项" class="header-anchor">#</a> 范围选项</h3> <p>所有操作符都支持支持的范围类型查询.</p> <p>请记住,提供的范围值也可以<a href="https://itfun.tv/documents/266#range-types" target="_blank" rel="noopener noreferrer">定义绑定的 inclusion/exclusion<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 所有上述相等和不相等的操作符加上以下内容:</span>

<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>contains<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span>           <span class="token comment">// @&gt; '2'::integer (PG range contains element operator)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>contains<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>      <span class="token comment">// @&gt; [1, 2) (PG range contains range operator)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>contained<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>     <span class="token comment">// &lt;@ [1, 2) (PG range is contained by operator)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>overlap<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>       <span class="token comment">// &amp;&amp; [1, 2) (PG range overlap (have points in common) operator)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>adjacent<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>      <span class="token comment">// -|- [1, 2) (PG range is adjacent to operator)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>strictLeft<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>    <span class="token comment">// &lt;&lt; [1, 2) (PG range strictly left of operator)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>strictRight<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>   <span class="token comment">// &gt;&gt; [1, 2) (PG range strictly right of operator)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>noExtendRight<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment">// &amp;&lt; [1, 2) (PG range does not extend to the right of operator)</span>
<span class="token punctuation">[</span>Op<span class="token punctuation">.</span>noExtendLeft<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment">// &amp;&gt; [1, 2) (PG range does not extend to the left of operator)</span>
</code></pre></div><h3 id="组合"><a href="#组合" class="header-anchor">#</a> 组合</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">rank</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>lt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>eq<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// rank &lt; 1000 OR rank IS NULL</span>

<span class="token punctuation">{</span>
  <span class="token literal-property property">createdAt</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>lt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// createdAt &lt; [timestamp] AND createdAt &gt; [timestamp]</span>

<span class="token punctuation">{</span>
  <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'Boat%'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%boat%'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// title LIKE 'Boat%' OR description LIKE '%boat%'</span>
</code></pre></div><h3 id="关系-关联"><a href="#关系-关联" class="header-anchor">#</a> 关系 / 关联</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 找到所有具有至少一个 task 的  project,其中 task.state === project.state</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">model</span><span class="token operator">:</span> Task<span class="token punctuation">,</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">state</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'project.state'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="分页-限制"><a href="#分页-限制" class="header-anchor">#</a> 分页 / 限制</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取10个实例/行</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 跳过8个实例/行</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 跳过5个实例,然后取5个</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h3> <p><code>order</code> 需要一个条目的数组来排序查询或者一个 sequelize 方法.一般来说,你将要使用任一属性的 tuple/array,并确定排序的正反方向.</p> <div class="language-js extra-class"><pre class="language-js"><code>Subtask<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 将转义标题,并根据有效的方向参数列表验证DESC</span>
    <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// 将按最大值排序(age)</span>
    sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'max'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// 将按最大顺序(age) DESC</span>
    <span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'max'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// 将按 otherfunction 排序(`col1`, 12, 'lalala') DESC</span>
    <span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'otherfunction'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'col1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">'lalala'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// 将使用模型名称作为关联的名称排序关联模型的 created_at.</span>
    <span class="token punctuation">[</span>Task<span class="token punctuation">,</span> <span class="token string">'createdAt'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Will order through an associated model's created_at using the model names as the associations' names.</span>
    <span class="token punctuation">[</span>Task<span class="token punctuation">,</span> Project<span class="token punctuation">,</span> <span class="token string">'createdAt'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// 将使用关联的名称由关联模型的created_at排序.</span>
    <span class="token punctuation">[</span><span class="token string">'Task'</span><span class="token punctuation">,</span> <span class="token string">'createdAt'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Will order by a nested associated model's created_at using the names of the associations.</span>
    <span class="token punctuation">[</span><span class="token string">'Task'</span><span class="token punctuation">,</span> <span class="token string">'Project'</span><span class="token punctuation">,</span> <span class="token string">'createdAt'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Will order by an associated model's created_at using an association object. (优选方法)</span>
    <span class="token punctuation">[</span>Subtask<span class="token punctuation">.</span>associations<span class="token punctuation">.</span>Task<span class="token punctuation">,</span> <span class="token string">'createdAt'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Will order by a nested associated model's created_at using association objects. (优选方法)</span>
    <span class="token punctuation">[</span>Subtask<span class="token punctuation">.</span>associations<span class="token punctuation">.</span>Task<span class="token punctuation">,</span> Task<span class="token punctuation">.</span>associations<span class="token punctuation">.</span>Project<span class="token punctuation">,</span> <span class="token string">'createdAt'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Will order by an associated model's created_at using a simple association object.</span>
    <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">model</span><span class="token operator">:</span> Task<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Task'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'createdAt'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// 嵌套关联模型的 created_at 简单关联对象排序</span>
    <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">model</span><span class="token operator">:</span> Task<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Task'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">model</span><span class="token operator">:</span> Project<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Project'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'createdAt'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>

  <span class="token comment">// 将按年龄最大值降序排列</span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> sequelize<span class="token punctuation">.</span><span class="token function">literal</span><span class="token punctuation">(</span><span class="token string">'max(age) DESC'</span><span class="token punctuation">)</span>

  <span class="token comment">// 按最年龄大值升序排列,当省略排序条件时默认是升序排列</span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'max'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// 按升序排列是省略排序条件的默认顺序</span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>

  <span class="token comment">// 将根据方言随机排序 (而不是 fn('RAND') 或 fn('RANDOM'))</span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> sequelize<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="count-计算数据库中元素的出现次数"><a href="#count-计算数据库中元素的出现次数" class="header-anchor">#</a> <code>count</code> - 计算数据库中元素的出现次数</h3> <p>还有一种数据库对象计数的方法:</p> <div class="language-js extra-class"><pre class="language-js"><code>Project<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;There are &quot;</span> <span class="token operator">+</span> c <span class="token operator">+</span> <span class="token string">&quot; projects!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Project<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">'id'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;There are &quot;</span> <span class="token operator">+</span> c <span class="token operator">+</span> <span class="token string">&quot; projects with an id greater than 25.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="max-获取特定表中特定属性的最大值"><a href="#max-获取特定表中特定属性的最大值" class="header-anchor">#</a> <code>max</code> - 获取特定表中特定属性的最大值</h3> <p>这里是获取属性的最大值的方法:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
   我们假设3个具有属性年龄的对象.
   第一个是10岁,
   第二个是5岁,
   第三个是40岁.
*/</span>
Project<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">max</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将返回 40</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Project<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>lt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">max</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将会是 10</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="min-获取特定表中特定属性的最小值"><a href="#min-获取特定表中特定属性的最小值" class="header-anchor">#</a> <code>min</code> - 获取特定表中特定属性的最小值</h3> <p>这里是获取属性的最小值的方法:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
   我们假设3个具有属性年龄的对象.
   第一个是10岁,
   第二个是5岁,
   第三个是40岁.
*/</span>
Project<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">min</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将返回 5</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Project<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">min</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将会是 10</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="sum-特定属性的值求和"><a href="#sum-特定属性的值求和" class="header-anchor">#</a> <code>sum</code> - 特定属性的值求和</h3> <p>为了计算表的特定列的总和,可以使用“sum”方法.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
   我们假设3个具有属性年龄的对象.
   第一个是10岁,
   第二个是5岁,
   第三个是40岁.
*/</span>
Project<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">sum</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将返回 55</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Project<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">sum</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将会是 50</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="预加载"><a href="#预加载" class="header-anchor">#</a> 预加载</h2> <p>当你从数据库检索数据时,也想同时获得与之相关联的查询,这被称为预加载.这个基本思路就是当你调用 <code>find</code> 或 <code>findAll</code> 时使用 <code>include</code> 属性.让我们假设以下设置:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
User<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize<span class="token punctuation">,</span> <span class="token literal-property property">modelName</span><span class="token operator">:</span> <span class="token string">'user'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Task<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize<span class="token punctuation">,</span> <span class="token literal-property property">modelName</span><span class="token operator">:</span> <span class="token string">'task'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Tool</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Tool<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize<span class="token punctuation">,</span> <span class="token literal-property property">modelName</span><span class="token operator">:</span> <span class="token string">'tool'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

Task<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
User<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Task<span class="token punctuation">)</span>
User<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Tool<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Instruments'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

sequelize<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这是我们继续的地方 ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>首先,让我们用它们的关联 user 加载所有的 task.</p> <div class="language-js extra-class"><pre class="language-js"><code>Task<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> User <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">tasks</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">/*
    [{
      &quot;name&quot;: &quot;A Task&quot;,
      &quot;id&quot;: 1,
      &quot;createdAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,
      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,
      &quot;userId&quot;: 1,
      &quot;user&quot;: {
        &quot;name&quot;: &quot;John Doe&quot;,
        &quot;id&quot;: 1,
        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;
      }
    }]
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>请注意,访问者(结果实例中的 <code>User</code> 属性)是单数形式,因为关联是一对一的.</p> <p>接下来的事情:用多对一的关联加载数据！</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> Task <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">/*
    [{
      &quot;name&quot;: &quot;John Doe&quot;,
      &quot;id&quot;: 1,
      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
      &quot;tasks&quot;: [{
        &quot;name&quot;: &quot;A Task&quot;,
        &quot;id&quot;: 1,
        &quot;createdAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,
        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,
        &quot;userId&quot;: 1
      }]
    }]
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>请注意,访问者(结果实例中的 <code>Tasks</code> 属性)是复数形式,因为关联是多对一的.</p> <p>如果关联是别名的(使用 <code>as</code> 参数),则在包含模型时必须指定此别名. 注意用户的 <code>Tool</code> 如何被别名为 <code>Instruments</code>. 为了获得正确的权限,你必须指定要加载的模型以及别名:</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> Tool<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Instruments'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">/*
    [{
      &quot;name&quot;: &quot;John Doe&quot;,
      &quot;id&quot;: 1,
      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
      &quot;Instruments&quot;: [{
        &quot;name&quot;: &quot;Toothpick&quot;,
        &quot;id&quot;: 1,
        &quot;createdAt&quot;: null,
        &quot;updatedAt&quot;: null,
        &quot;userId&quot;: 1
      }]
    }]
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>你还可以通过指定与关联别名匹配的字符串来包含别名:</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Instruments'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">/*
    [{
      &quot;name&quot;: &quot;John Doe&quot;,
      &quot;id&quot;: 1,
      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
      &quot;Instruments&quot;: [{
        &quot;name&quot;: &quot;Toothpick&quot;,
        &quot;id&quot;: 1,
        &quot;createdAt&quot;: null,
        &quot;updatedAt&quot;: null,
        &quot;userId&quot;: 1
      }]
    }]
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">association</span><span class="token operator">:</span> <span class="token string">'Instruments'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">/*
    [{
      &quot;name&quot;: &quot;John Doe&quot;,
      &quot;id&quot;: 1,
      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
      &quot;Instruments&quot;: [{
        &quot;name&quot;: &quot;Toothpick&quot;,
        &quot;id&quot;: 1,
        &quot;createdAt&quot;: null,
        &quot;updatedAt&quot;: null,
        &quot;userId&quot;: 1
      }]
    }]
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>当预加载时,我们也可以使用 <code>where</code> 过滤关联的模型. 这将返回 <code>Tool</code> 模型中所有与 <code>where</code> 语句匹配的行的<code>User</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">model</span><span class="token operator">:</span> Tool<span class="token punctuation">,</span>
        <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Instruments'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%ooth%'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">/*
      [{
        &quot;name&quot;: &quot;John Doe&quot;,
        &quot;id&quot;: 1,
        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
        &quot;Instruments&quot;: [{
          &quot;name&quot;: &quot;Toothpick&quot;,
          &quot;id&quot;: 1,
          &quot;createdAt&quot;: null,
          &quot;updatedAt&quot;: null,
          &quot;userId&quot;: 1
        }]
      }],

      [{
        &quot;name&quot;: &quot;John Smith&quot;,
        &quot;id&quot;: 2,
        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
        &quot;Instruments&quot;: [{
          &quot;name&quot;: &quot;Toothpick&quot;,
          &quot;id&quot;: 1,
          &quot;createdAt&quot;: null,
          &quot;updatedAt&quot;: null,
          &quot;userId&quot;: 1
        }]
      }],
    */</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>当使用 <code>include.where</code> 过滤一个预加载的模型时,<code>include.required</code> 被隐式设置为 <code>true</code>. 这意味着内部联接完成返回具有任何匹配子项的父模型.</p> <h3 id="使用预加载模型的顶层-where"><a href="#使用预加载模型的顶层-where" class="header-anchor">#</a> 使用预加载模型的顶层 WHERE</h3> <p>将模型的 <code>WHERE</code> 条件从 <code>ON</code> 条件的 include 模式移动到顶层,你可以使用 <code>'$nested.column$'</code> 语法:</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">'$Instruments.name$'</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>iLike<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%ooth%'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">model</span><span class="token operator">:</span> Tool<span class="token punctuation">,</span>
        <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Instruments'</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
      [{
        &quot;name&quot;: &quot;John Doe&quot;,
        &quot;id&quot;: 1,
        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
        &quot;Instruments&quot;: [{
          &quot;name&quot;: &quot;Toothpick&quot;,
          &quot;id&quot;: 1,
          &quot;createdAt&quot;: null,
          &quot;updatedAt&quot;: null,
          &quot;userId&quot;: 1
        }]
      }],

      [{
        &quot;name&quot;: &quot;John Smith&quot;,
        &quot;id&quot;: 2,
        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
        &quot;Instruments&quot;: [{
          &quot;name&quot;: &quot;Toothpick&quot;,
          &quot;id&quot;: 1,
          &quot;createdAt&quot;: null,
          &quot;updatedAt&quot;: null,
          &quot;userId&quot;: 1
        }]
      }],
    */</span>
</code></pre></div><h3 id="包括所有"><a href="#包括所有" class="header-anchor">#</a> 包括所有</h3> <p>要包含所有属性,你可以使用 <code>all:true</code> 传递单个对象:</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">all</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="包括软删除的记录"><a href="#包括软删除的记录" class="header-anchor">#</a> 包括软删除的记录</h3> <p>如果想要加载软删除的记录,可以通过将 <code>include.paranoid</code> 设置为 <code>false</code> 来实现</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">model</span><span class="token operator">:</span> Tool<span class="token punctuation">,</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'%ooth%'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">paranoid</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// query and loads the soft deleted records</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="排序预加载关联"><a href="#排序预加载关联" class="header-anchor">#</a> 排序预加载关联</h3> <p>在一对多关系的情况下.</p> <div class="language-js extra-class"><pre class="language-js"><code>Company<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> Division <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> Division<span class="token punctuation">,</span> <span class="token string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Company<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> Division <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> Division<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Company<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> Division<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Div'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> Division<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Company<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> Division<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Div'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> Division<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Div'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Company<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> Division<span class="token punctuation">,</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> Department <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> Division<span class="token punctuation">,</span> Department<span class="token punctuation">,</span> <span class="token string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在多对多关系的情况下,你还可以通过表中的属性进行排序.</p> <div class="language-js extra-class"><pre class="language-js"><code>Company<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> Division<span class="token punctuation">,</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> Department <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> Division<span class="token punctuation">,</span> DepartmentDivision<span class="token punctuation">,</span> <span class="token string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="嵌套预加载"><a href="#嵌套预加载" class="header-anchor">#</a> 嵌套预加载</h3> <p>你可以使用嵌套的预加载来加载相关模型的所有相关模型:</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token literal-property property">model</span><span class="token operator">:</span> Tool<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Instruments'</span><span class="token punctuation">,</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span><span class="token literal-property property">model</span><span class="token operator">:</span> Teacher<span class="token punctuation">,</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">/* etc */</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">/*
    [{
      &quot;name&quot;: &quot;John Doe&quot;,
      &quot;id&quot;: 1,
      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,
      &quot;Instruments&quot;: [{ // 1:M and N:M association
        &quot;name&quot;: &quot;Toothpick&quot;,
        &quot;id&quot;: 1,
        &quot;createdAt&quot;: null,
        &quot;updatedAt&quot;: null,
        &quot;userId&quot;: 1,
        &quot;Teacher&quot;: { // 1:1 association
          &quot;name&quot;: &quot;Jimi Hendrix&quot;
        }
      }]
    }]
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这将产生一个外连接. 但是,相关模型上的 <code>where</code> 语句将创建一个内部连接,并仅返回具有匹配子模型的实例. 要返回所有父实例,你应该添加 <code>required: false</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token literal-property property">model</span><span class="token operator">:</span> Tool<span class="token punctuation">,</span>
    <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Instruments'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token literal-property property">model</span><span class="token operator">:</span> Teacher<span class="token punctuation">,</span>
      <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">school</span><span class="token operator">:</span> <span class="token string">&quot;Woodstock Music School&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以上查询将返回所有用户及其所有乐器,但只会返回与 <code>Woodstock Music School</code> 相关的老师.</p> <p>包括所有也支持嵌套加载:</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">all</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">nested</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="新增"><a href="#新增" class="header-anchor">#</a> 新增</h2> <h3 id="字段限制"><a href="#字段限制" class="header-anchor">#</a> 字段限制</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'barfooz'</span><span class="token punctuation">,</span> <span class="token literal-property property">isAdmin</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">fields</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'username'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 只有username有效</span>

User<span class="token punctuation">.</span><span class="token function">bulkCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'foo'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token literal-property property">admin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">fields</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// admin 将不会被构建</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="新增单个"><a href="#新增单个" class="header-anchor">#</a> 新增单个</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// create</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;哈哈哈&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">12</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="批量新增"><a href="#批量新增" class="header-anchor">#</a> 批量新增</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 批量新增 bulkCreate</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">bulkCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;第一个&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">15</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;第二个&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">15</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;第三个&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">15</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="修改"><a href="#修改" class="header-anchor">#</a> 修改</h2> <h3 id="字段限制-2"><a href="#字段限制-2" class="header-anchor">#</a> 字段限制</h3> <div class="language-js extra-class"><pre class="language-js"><code>task<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">'foooo'</span>
task<span class="token punctuation">.</span>description <span class="token operator">=</span> <span class="token string">'baaaaaar'</span>
<span class="token keyword">await</span> task<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">fields</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// title 现在将是 “foooo”,而 description 与以前一样</span>

<span class="token comment">// 使用等效的 update 调用如下所示:</span>
<span class="token keyword">await</span> task<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'foooo'</span><span class="token punctuation">,</span> <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token string">'baaaaaar'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">fields</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  title 现在将是 “foooo”,而 description 与以前一样</span>
</code></pre></div><h3 id="单个修改"><a href="#单个修改" class="header-anchor">#</a> 单个修改</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 找出当前记录</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;我被修改了&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="批量修改"><a href="#批量修改" class="header-anchor">#</a> 批量修改</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 批量修改</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;批量修改&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 条件</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;第一个&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="递增"><a href="#递增" class="header-anchor">#</a> 递增</h3> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// 找出当前记录 increment</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// age每次递增3</span>
    <span class="token literal-property property">other</span><span class="token operator">:</span><span class="token number">2</span> <span class="token comment">// other每次递增2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="递减"><a href="#递减" class="header-anchor">#</a> 递减</h3> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// 找出当前记录 decrement</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// age每次递减3</span>
    <span class="token literal-property property">other</span><span class="token operator">:</span><span class="token number">2</span> <span class="token comment">// other每次递减2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="删除"><a href="#删除" class="header-anchor">#</a> 删除</h2> <h3 id="软删除"><a href="#软删除" class="header-anchor">#</a> 软删除</h3> <p>模型中配置</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 配置（重要）</span>
  <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">/* bla */</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
      <span class="token comment">// 同时需要设置paranoid为true（此种模式下，删除数据时不会进行物理删除，而是设置deletedAt为当前时间</span>
      <span class="token string-property property">'paranoid'</span><span class="token operator">:</span> <span class="token boolean">true</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="查询包括软删除内容"><a href="#查询包括软删除内容" class="header-anchor">#</a> 查询包括软删除内容</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token literal-property property">model</span><span class="token operator">:</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Video<span class="token punctuation">,</span>
      <span class="token comment">// 包括软删除</span>
      <span class="token literal-property property">paranoid</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">33</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 包括软删除</span>
    <span class="token literal-property property">paranoid</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="彻底删除"><a href="#彻底删除" class="header-anchor">#</a> 彻底删除</h3> <p>如果 <code>paranoid</code> 选项为 true,则不会删除该对象,而将 <code>deletedAt</code> 列设置为当前时间戳. 要强制删除,可以将 <code>force: true</code> 传递给 destroy 调用:</p> <div class="language-js extra-class"><pre class="language-js"><code>task<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">force</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在 <code>paranoid</code> 模式下对象被软删除后,在强制删除旧实例之前,你将无法使用相同的主键创建新实例.</p> <h3 id="恢复软删除的实例"><a href="#恢复软删除的实例" class="header-anchor">#</a> 恢复软删除的实例</h3> <p>如果你使用 <code>paranoid:true</code> 软删除了模型的实例,之后想要撤消删除,请使用 <code>restore</code> 方法:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 进行软删除...</span>
task<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 恢复软删除...</span>
task<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="条件删除"><a href="#条件删除" class="header-anchor">#</a> 条件删除</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;批量修改&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="批量删除"><a href="#批量删除" class="header-anchor">#</a> 批量删除</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Post<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> posts
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="重载实例"><a href="#重载实例" class="header-anchor">#</a> 重载实例</h2> <p>如果你需要让你的实例同步,你可以使用 <code>reload</code> 方法. 它将从数据库中获取当前数据,并覆盖调用该方法的模型的属性.</p> <div class="language-js extra-class"><pre class="language-js"><code>Person<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'john'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">person</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'jane'</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 'jane'</span>

  person<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 'john'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="模型自定义方法"><a href="#模型自定义方法" class="header-anchor">#</a> 模型自定义方法</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模型</span>
<span class="token comment">// 模型自定义方法</span>
topic_user<span class="token punctuation">.</span><span class="token function-variable function">ceshi</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'模型自定义方法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> param<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 控制器</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TopicUser<span class="token punctuation">.</span><span class="token function">ceshi</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="scopes-作用域-重点"><a href="#scopes-作用域-重点" class="header-anchor">#</a> Scopes - 作用域（重点）</h2> <p>作用域允许你定义常用查询,以便以后轻松使用. 作用域可以包括与常规查找器 <code>where</code>, <code>include</code>, <code>limit</code> 等所有相同的属性.</p> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h3> <p>作用域在模型定义中定义,可以是finder对象或返回finder对象的函数,除了默认作用域,该作用域只能是一个对象:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Project</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Project<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 属性</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">defaultScope</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">scopes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">deleted</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">deleted</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">activeUsers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> User<span class="token punctuation">,</span> <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">random</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">someNumber</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">accessLevel</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">accessLevel</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gte<span class="token punctuation">]</span><span class="token operator">:</span> value
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    sequelize<span class="token punctuation">,</span>
    <span class="token literal-property property">modelName</span><span class="token operator">:</span> <span class="token string">'project'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过调用 <code>addScope</code> 定义模型后,还可以添加作用域. 这对于具有包含的作用域特别有用,其中在定义其他模型时可能不会定义 include 中的模型.</p> <p>始终应用默认作用域. 这意味着,通过上面的模型定义,<code>Project.findAll()</code> 将创建以下查询:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> projects <span class="token constant">WHERE</span> active <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><p>可以通过调用 <code>.unscoped()</code>, <code>.scope(null)</code> 或通过调用另一个作用域来删除默认作用域:</p> <div class="language-js extra-class"><pre class="language-js"><code>Project<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'deleted'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除默认作用域</span>
<span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> projects <span class="token constant">WHERE</span> deleted <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><p>还可以在作用域定义中包含作用域模型. 这让你避免重复 <code>include</code>,<code>attributes</code> 或 <code>where</code> 定义.</p> <p>使用上面的例子,并在包含的用户模型中调用 <code>active</code> 作用域(而不是直接在该 include 对象中指定条件):</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token literal-property property">activeUsers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">model</span><span class="token operator">:</span> User<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'active'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h3> <p>通过在模型定义上调用 <code>.scope</code> 来应用作用域,传递一个或多个作用域的名称. <code>.scope</code> 返回一个全功能的模型实例,它具有所有常规的方法:<code>.findAll</code>,<code>.update</code>,<code>.count</code>,<code>.destroy</code>等等.你可以保存这个模型实例并稍后再次使用:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> DeletedProjects <span class="token operator">=</span> Project<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'deleted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

DeletedProjects<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 过一段时间</span>

<span class="token comment">// 让我们再次寻找被删除的项目！</span>
DeletedProjects<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>作用域适用于 <code>.find</code>, <code>.findAll</code>, <code>.count</code>, <code>.update</code>, <code>.increment</code> 和 <code>.destroy</code>.</p> <p>可以通过两种方式调用作为函数的作用域. 如果作用域没有任何参数,它可以正常调用. 如果作用域采用参数,则传递一个对象:</p> <div class="language-js extra-class"><pre class="language-js"><code>Project<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'random'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'accessLevel'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> projects <span class="token constant">WHERE</span> someNumber <span class="token operator">=</span> <span class="token number">42</span> <span class="token constant">AND</span> accessLevel <span class="token operator">&gt;=</span> <span class="token number">19</span>
</code></pre></div><h3 id="合并"><a href="#合并" class="header-anchor">#</a> 合并</h3> <p>通过将作用域数组传递到 <code>.scope</code> 或通过将作用域作为连续参数传递,可以同时应用多个作用域.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这两个是等价的</span>
Project<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'deleted'</span><span class="token punctuation">,</span> <span class="token string">'activeUsers'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Project<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'deleted'</span><span class="token punctuation">,</span> <span class="token string">'activeUsers'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> projects
<span class="token constant">INNER</span> <span class="token constant">JOIN</span> users <span class="token constant">ON</span> projects<span class="token punctuation">.</span>userId <span class="token operator">=</span> users<span class="token punctuation">.</span>id
<span class="token constant">WHERE</span> projects<span class="token punctuation">.</span>deleted <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token constant">AND</span> users<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><p>如果要将其他作用域与默认作用域一起应用,请将键 <code>defaultScope</code> 传递给 <code>.scope</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code>Project<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'defaultScope'</span><span class="token punctuation">,</span> <span class="token string">'deleted'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> projects <span class="token constant">WHERE</span> active <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token constant">AND</span> deleted <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><p>当调用多个作用域时,后续作用域的键将覆盖以前的作用域(类似于 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign" target="_blank" rel="noopener noreferrer">Object.assign<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>),除了<code>where</code>和<code>include</code>,它们将被合并. 考虑两个作用域:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">scope1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'bob'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">scope2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">30</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">10</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用 <code>.scope('scope1', 'scope2')</code> 将产生以下查询</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">WHERE</span> firstName <span class="token operator">=</span> <span class="token string">'bob'</span> <span class="token constant">AND</span> age <span class="token operator">&gt;</span> <span class="token number">30</span> <span class="token constant">LIMIT</span> <span class="token number">10</span>
</code></pre></div><p>注意 <code>scope2</code> 将覆盖 <code>limit</code> 和 <code>age</code>,而 <code>firstName</code> 被保留. <code>limit</code>,<code>offset</code>,<code>order</code>,<code>paranoid</code>,<code>lock</code>和<code>raw</code>字段被覆盖,而<code>where</code>被浅层合并(意味着相同的键将被覆盖). <code>include</code> 的合并策略将在后面讨论.</p> <p>请注意,多个应用作用域的 <code>attributes</code> 键以这样的方式合并,即始终保留 <code>attributes.exclude</code>. 这允许合并多个作用域,并且永远不会泄漏最终作用域内的敏感字段.</p> <p>将查找对象直接传递给作用域模型上的<code>findAll</code>(和类似的查找程序)时,适用相同的合并逻辑:</p> <div class="language-js extra-class"><pre class="language-js"><code>Project<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'deleted'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'john'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token constant">WHERE</span> deleted <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token constant">AND</span> firstName <span class="token operator">=</span> <span class="token string">'john'</span>
</code></pre></div><p>这里的 <code>deleted</code> 作用域与 finder 合并. 如果我们要将 <code>where: { firstName: 'john', deleted: false }</code> 传递给 finder,那么 <code>deleted</code> 作用域将被覆盖.</p> <h3 id="合并-include"><a href="#合并-include" class="header-anchor">#</a> 合并 include</h3> <p>Include 是根据包含的模型递归合并的. 这是一个非常强大的合并,在 v5 上添加,并通过示例更好地理解.</p> <p>考虑四种模型:Foo,Bar,Baz和Qux,具有如下多种关联:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Baz</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Qux</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Foo<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Bar<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Baz<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Qux<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Foo<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Bar<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">'fooId'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Bar<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Baz<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">'barId'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Baz<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Qux<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">'bazId'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在,考虑Foo上定义的以下四个作用域:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">includeEverything</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Bar<span class="token punctuation">,</span>
      <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Baz<span class="token punctuation">,</span>
        <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Qux
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">limitedBars</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Bar<span class="token punctuation">,</span>
      <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">limitedBazs</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Bar<span class="token punctuation">,</span>
      <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Baz<span class="token punctuation">,</span>
        <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">excludeBazName</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Bar<span class="token punctuation">,</span>
      <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Baz<span class="token punctuation">,</span>
        <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这四个作用域可以很容易地深度合并,例如通过调用 <code>Foo.scope('includeEverything', 'limitedBars', 'limitedBazs', 'excludeBazName').findAll()</code>,这完全等同于调用以下内容:</p> <div class="language-js extra-class"><pre class="language-js"><code>Foo<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Bar<span class="token punctuation">,</span>
    <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Baz<span class="token punctuation">,</span>
      <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Qux
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>观察四个作用域如何合并为一个. 根据所包含的模型合并作用域的include. 如果一个作用域包括模型A而另一个作用域包括模型B,则合并结果将包括模型A和B.另一方面,如果两个作用域包括相同的模型A,但具有不同的参数(例如嵌套include或其他属性) ,这些将以递归方式合并,如上所示.</p> <p>无论应用于作用域的顺序如何,上面说明的合并都以完全相同的方式工作. 如果某个参数由两个不同的作用域设置,那么只会该顺序产生差异 - 这不是上述示例的情况,因为每个作用域都做了不同的事情.</p> <p>这种合并策略的工作方式与传递给<code>.findAll</code>,<code>.findOne</code>等的参数完全相同.</p> <h3 id="关联"><a href="#关联" class="header-anchor">#</a> 关联</h3> <p>Sequelize 与关联有两个不同但相关的作用域概念. 差异是微妙但重要的:</p> <ul><li><strong>关联作用域</strong> 允许你在获取和设置关联时指定默认属性 - 在实现多态关联时很有用. 当使用<code>get</code>,<code>set</code>,<code>add</code>和<code>create</code>相关联的模型函数时,这个作用域仅在两个模型之间的关联上被调用</li> <li><strong>关联模型上的作用域</strong> 允许你在获取关联时应用默认和其他作用域,并允许你在创建关联时传递作用域模型. 这些作用域都适用于模型上的常规查找和通过关联查找.</li></ul> <p>举个例子,思考模型Post和Comment. Comment与其他几个模型(图像,视频等)相关联,Comment和其他模型之间的关联是多态的,这意味着除了外键 <code>commentable_id</code> 之外,注释还存储一个<code>commentable</code>列.</p> <p>可以使用 association scope 来实现多态关联:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>Post<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Comment<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">'commentable_id'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">commentable</span><span class="token operator">:</span> <span class="token string">'post'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当调用 <code>post.getComments()</code> 时,这将自动添加 <code>WHERE commentable = 'post'</code>. 类似地,当向帖子添加新的注释时,<code>commentable</code> 会自动设置为 <code>'post'</code>. 关联作用域是为了存活于后台,没有程序员不必担心 - 它不能被禁用. 有关更完整的多态性示例,请参阅 <a href="https://itfun.tv/documents/272#scopes" target="_blank" rel="noopener noreferrer">关联作用域<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>那么考虑那个Post的默认作用域只显示活动的帖子:<code>where: { active: true }</code>. 该作用域存在于相关联的模型(Post)上,而不是像<code>commentable</code> 作用域那样在关联上. 就像在调用<code>Post.findAll()</code> 时一样应用默认作用域,当调用 <code>User.getPosts()</code> 时,它也会被应用 - 这只会返回该用户的活动帖子.</p> <p>要禁用默认作用域,将 <code>scope: null</code> 传递给 getter: <code>User.getPosts({ scope: null })</code>. 同样,如果要应用其他作用域,请像这样:</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'scope1'</span><span class="token punctuation">,</span> <span class="token string">'scope2'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果要为关联模型上的作用域创建快捷方式,可以将作用域模型传递给关联. 考虑一个快捷方式来获取用户所有已删除的帖子:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Post</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Post<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">defaultScope</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">scopes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">deleted</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">deleted</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  sequelize<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

User<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Post<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 常规 getPosts 关联</span>
User<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Post<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token string">'deleted'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'deletedPosts'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
User<span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// WHERE active = true</span>
User<span class="token punctuation">.</span><span class="token function">getDeletedPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// WHERE deleted = true</span>
</code></pre></div><h2 id="扩展"><a href="#扩展" class="header-anchor">#</a> 扩展</h2> <p>extend/helper.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/extend/helper.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 扩展一个格式日期的方法</span>
    <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>val <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>模板中调用</p> <div class="language-html extra-class"><pre class="language-html"><code> &lt;%=helper.formatTime(dateline)%&gt;
</code></pre></div><p>其他地方调用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">formatTime</span><span class="token punctuation">(</span>dateline<span class="token punctuation">)</span>
</code></pre></div><h2 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h2> <h3 id="_1-定义"><a href="#_1-定义" class="header-anchor">#</a> 1. 定义</h3> <p>app/middleware/getIp.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
options: 中间件的配置项，框架会将 app.config[${middlewareName}] 传递进来。
app: 当前应用 Application 的实例。
*/</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">option<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回一个异步的方法</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过option传入额外参数</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-配置"><a href="#_2-配置" class="header-anchor">#</a> 2. 配置</h3> <p>config/config.default.js（配置全局中间件，所有路由都会调用）</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">appInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    
    <span class="token comment">// 配置全局中间件</span>
    config<span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'getIp'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 注意驼峰式写法，如果中间件是a_bc.js，则要写成aBc</span>

    <span class="token comment">// 配置中间件参数</span>
    config<span class="token punctuation">.</span>getIp <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">ceshi</span><span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span>
        <span class="token comment">// 通用配置（以下是重点）</span>
        <span class="token literal-property property">enable</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 控制中间件是否开启。</span>
        <span class="token literal-property property">match</span><span class="token operator">:</span><span class="token string">'/news'</span><span class="token punctuation">,</span> <span class="token comment">// 设置只有符合某些规则的请求才会经过这个中间件（匹配路由）</span>
        <span class="token literal-property property">ignore</span><span class="token operator">:</span><span class="token string">'/shop'</span> <span class="token comment">// 设置符合某些规则的请求不经过这个中间件。</span>
        
        <span class="token comment">/**
        注意：
        1. match 和 ignore 不允许同时配置
        2. 例如：match:'/news'，只要包含/news的任何页面都生效
        **/</span>
        
        <span class="token comment">// match 和 ignore 支持多种类型的配置方式：字符串、正则、函数（推荐）</span>
        <span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 只有 ios 设备才开启</span>
          <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">iphone|ipad|ipod</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'user-agent'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

    


</code></pre></div><h3 id="_3-使用-2"><a href="#_3-使用-2" class="header-anchor">#</a> 3. 使用</h3> <h3 id="路由中使用"><a href="#路由中使用" class="header-anchor">#</a> 路由中使用</h3> <p>app/router.js</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 局部中间件（如果只需要局部调用，则不需要在config.default.js中配置）</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin/:id'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
        <span class="token literal-property property">ceshi</span><span class="token operator">:</span> <span class="token string">&quot;我是admin&quot;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="使用-koa-的中间件-gzip压缩"><a href="#使用-koa-的中间件-gzip压缩" class="header-anchor">#</a> 使用 Koa 的中间件（gzip压缩）</h3> <p>大大提高网站的访问速度（非常有效）</p> <p>以 <a href="https://github.com/koajs/compress" target="_blank" rel="noopener noreferrer">koa-compress<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 为例，在 Koa 中使用时：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> compress <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-compress'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">threshold</span><span class="token operator">:</span> <span class="token number">2048</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">compress</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们按照框架的规范来在应用中加载这个 Koa 的中间件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/middleware/compress.js</span>
<span class="token comment">// koa-compress 暴露的接口(`(options) =&gt; middleware`)和框架对中间件要求一致</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-compress'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// config/config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">middleware</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'compress'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">threshold</span><span class="token operator">:</span> <span class="token number">2048</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="表单提交"><a href="#表单提交" class="header-anchor">#</a> 表单提交</h2> <h3 id="post"><a href="#post" class="header-anchor">#</a> post</h3> <p>app/controller/home.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">addInput</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过ctx.request.body获取post提交数据</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>app/view/post.html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!--
需要定义：?_csrf=&lt;%=ctx.csrf%&gt;
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/add?_csrf=&lt;%=ctx.csrf%&gt;<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>提交<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>app/router.js</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>addInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="cookie"><a href="#cookie" class="header-anchor">#</a> cookie</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.设置</span>
ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'ceshi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2.获取</span>
ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3.设置中文(加密操作 encrypt: true)</span>

<span class="token comment">// 4.设置（其他参数配置）</span>
ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'ceshi'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token comment">// 存储24小时，单位毫秒，关闭浏览器cookie还存在</span>
    <span class="token literal-property property">httpOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 设置键值对是否可以被 js 访问，默认为 true，不允许被 js 访问。</span>
    <span class="token literal-property property">signed</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 签名，防止用户前台修改</span>
    <span class="token literal-property property">encrypt</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 加密，注意：get获取时需要解密</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 5.获取时解密</span>
ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token literal-property property">encrypt</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 6.清除cookie</span>
ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="session"><a href="#session" class="header-anchor">#</a> session</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.设置</span>
ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">'测试'</span><span class="token punctuation">;</span>
<span class="token comment">// 2.获取</span>
ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username
<span class="token comment">// 3.默认配置（全局配置，config/config.default.js）</span>
exports<span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'EGG_SESS'</span><span class="token punctuation">,</span> <span class="token comment">// 设置cookies的key值</span>
  <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 1 天，过期时间</span>
  <span class="token literal-property property">httpOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 设置键值对是否可以被 js 访问，默认为 true，不允许被 js 访问。</span>
  <span class="token literal-property property">encrypt</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">// 加密</span>
  <span class="token literal-property property">renew</span><span class="token operator">:</span><span class="token boolean">true</span>    <span class="token comment">// 每次刷新页面都会被延期</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 4.动态配置</span>
ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>maxAge <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span> <span class="token comment">// 5秒的过期时间</span>
ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">'测试'</span><span class="token punctuation">;</span>
<span class="token comment">// 5.清空session</span>
ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="定时任务"><a href="#定时任务" class="header-anchor">#</a> 定时任务</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/schedule/ceshi.js</span>
<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置定时任务的执行间隔等配置</span>
    <span class="token literal-property property">schedule</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">interval</span><span class="token operator">:</span> <span class="token string">'5s'</span><span class="token punctuation">,</span> <span class="token comment">// 每5秒执行一次</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'all'</span> <span class="token comment">// 指定所有的 worker 都需要执行</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 任务</span>
    <span class="token keyword">async</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">++</span>i<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="api"><a href="#api" class="header-anchor">#</a> API</h2> <h2 id="_1-context"><a href="#_1-context" class="header-anchor">#</a> 1. context</h2> <h3 id="curl"><a href="#curl" class="header-anchor">#</a> curl</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">ceshi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过ctx中的curl方法获取数据</span>
    <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'http://www.phonegap100.com/appapi.php?a=getPortalList&amp;catid=20&amp;page=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将buffer类型数据转为json类型</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> result <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="常用插件"><a href="#常用插件" class="header-anchor">#</a> 常用插件</h2> <h3 id="缓存"><a href="#缓存" class="header-anchor">#</a> 缓存</h3> <p><a href="https://www.npmjs.com/package/egg-cache" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/egg-cache<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <br> <a href="https://www.npmjs.com/package/egg-redis" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/egg-redis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="验证"><a href="#验证" class="header-anchor">#</a> 验证</h3> <p><a href="https://github.com/temool/egg-validate-plus" target="_blank" rel="noopener noreferrer">https://github.com/temool/egg-validate-plus<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="加密"><a href="#加密" class="header-anchor">#</a> 加密</h3> <p><a href="https://www.npmjs.com/package/egg-jwt" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/egg-jwt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>前端访问：header头添加：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Authorization:&quot;Bearer token值&quot;</span>
<span class="token literal-property property">Authorization</span><span class="token operator">:</span><span class="token string">&quot;Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6MTIzLCJpYXQiOjE1NzkxOTQxNTN9.Ml5B02ZPfYo78QwJic-Jdp2LUi2_AU0RGNgPhhJH--o&quot;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2024年2月4日星期日下午4点22分</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.4c1fa2f2.js" defer></script><script src="/assets/js/10.a1858127.js" defer></script><script src="/assets/js/2.641709ae.js" defer></script><script src="/assets/js/115.73763f96.js" defer></script><script src="/assets/js/4.68f7b7e9.js" defer></script>
  </body>
</html>
