<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>eggjs多进程处理 | 睿晨网</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/assets/img/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="#icon-pengyouquan" href="/icons/iconfont.svg" color="#3eaf7c">
    <meta name="description" content="睿晨网|睿晨编程|零基础学做网站、app、小程序就从这里开始">
    <meta name="keywords" content="睿晨网,睿晨编程,零基础学做网站,零基础学app,零基础学小程序">
    <meta name="author" content="睿晨网,睿晨编程,阿东老师">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.c8027397.css" as="style"><link rel="preload" href="/assets/js/app.1551c49e.js" as="script"><link rel="preload" href="/assets/js/10.a1858127.js" as="script"><link rel="preload" href="/assets/js/2.641709ae.js" as="script"><link rel="preload" href="/assets/js/47.0a01cff4.js" as="script"><link rel="preload" href="/assets/js/4.68f7b7e9.js" as="script"><link rel="prefetch" href="/assets/js/100.18619803.js"><link rel="prefetch" href="/assets/js/101.8bd041cc.js"><link rel="prefetch" href="/assets/js/102.68768c8d.js"><link rel="prefetch" href="/assets/js/103.739a9bcb.js"><link rel="prefetch" href="/assets/js/104.9cadff90.js"><link rel="prefetch" href="/assets/js/105.78b9c2c5.js"><link rel="prefetch" href="/assets/js/106.844c8756.js"><link rel="prefetch" href="/assets/js/107.5b519fc6.js"><link rel="prefetch" href="/assets/js/108.ee801dcb.js"><link rel="prefetch" href="/assets/js/109.52a303c7.js"><link rel="prefetch" href="/assets/js/11.e11c94df.js"><link rel="prefetch" href="/assets/js/110.f6ed432b.js"><link rel="prefetch" href="/assets/js/111.285a5894.js"><link rel="prefetch" href="/assets/js/112.a1381053.js"><link rel="prefetch" href="/assets/js/113.debf9c90.js"><link rel="prefetch" href="/assets/js/114.4ce70875.js"><link rel="prefetch" href="/assets/js/115.1408f138.js"><link rel="prefetch" href="/assets/js/116.4e59efa6.js"><link rel="prefetch" href="/assets/js/117.c346744b.js"><link rel="prefetch" href="/assets/js/118.132696e5.js"><link rel="prefetch" href="/assets/js/119.60ccd5df.js"><link rel="prefetch" href="/assets/js/12.a0e9d6b9.js"><link rel="prefetch" href="/assets/js/120.316ae5a5.js"><link rel="prefetch" href="/assets/js/121.012199c0.js"><link rel="prefetch" href="/assets/js/122.5ca95392.js"><link rel="prefetch" href="/assets/js/123.ea49ceda.js"><link rel="prefetch" href="/assets/js/124.b897f52b.js"><link rel="prefetch" href="/assets/js/125.37828099.js"><link rel="prefetch" href="/assets/js/126.ecfe8e36.js"><link rel="prefetch" href="/assets/js/127.267b3d81.js"><link rel="prefetch" href="/assets/js/128.00882258.js"><link rel="prefetch" href="/assets/js/129.9fea3788.js"><link rel="prefetch" href="/assets/js/13.a99e59c7.js"><link rel="prefetch" href="/assets/js/130.954f8f8c.js"><link rel="prefetch" href="/assets/js/131.eaafcb7a.js"><link rel="prefetch" href="/assets/js/132.d2e8f32a.js"><link rel="prefetch" href="/assets/js/133.1dc1d6e0.js"><link rel="prefetch" href="/assets/js/134.2f2faf4f.js"><link rel="prefetch" href="/assets/js/135.24200144.js"><link rel="prefetch" href="/assets/js/136.187156eb.js"><link rel="prefetch" href="/assets/js/137.9fe04d34.js"><link rel="prefetch" href="/assets/js/138.37623004.js"><link rel="prefetch" href="/assets/js/139.10fc690f.js"><link rel="prefetch" href="/assets/js/14.76051a79.js"><link rel="prefetch" href="/assets/js/140.a969638c.js"><link rel="prefetch" href="/assets/js/141.e236c931.js"><link rel="prefetch" href="/assets/js/142.a43949f7.js"><link rel="prefetch" href="/assets/js/143.d885f78e.js"><link rel="prefetch" href="/assets/js/144.ebf722ab.js"><link rel="prefetch" href="/assets/js/145.ba52af84.js"><link rel="prefetch" href="/assets/js/146.e8bbd530.js"><link rel="prefetch" href="/assets/js/147.5a05818f.js"><link rel="prefetch" href="/assets/js/148.e276ad6e.js"><link rel="prefetch" href="/assets/js/149.bddb34d3.js"><link rel="prefetch" href="/assets/js/15.db8daf5b.js"><link rel="prefetch" href="/assets/js/150.cd32a7c3.js"><link rel="prefetch" href="/assets/js/151.6551da2a.js"><link rel="prefetch" href="/assets/js/152.798b2ebc.js"><link rel="prefetch" href="/assets/js/153.150ee96b.js"><link rel="prefetch" href="/assets/js/154.3a632aed.js"><link rel="prefetch" href="/assets/js/155.b1d968ee.js"><link rel="prefetch" href="/assets/js/156.a7558efa.js"><link rel="prefetch" href="/assets/js/157.7c186d60.js"><link rel="prefetch" href="/assets/js/158.78b10030.js"><link rel="prefetch" href="/assets/js/159.38ad86c7.js"><link rel="prefetch" href="/assets/js/16.f378a7de.js"><link rel="prefetch" href="/assets/js/160.27a75dfc.js"><link rel="prefetch" href="/assets/js/161.798343cd.js"><link rel="prefetch" href="/assets/js/162.513c160a.js"><link rel="prefetch" href="/assets/js/163.fbb06251.js"><link rel="prefetch" href="/assets/js/164.ff79daa8.js"><link rel="prefetch" href="/assets/js/165.5e2d2eec.js"><link rel="prefetch" href="/assets/js/166.1fc2a343.js"><link rel="prefetch" href="/assets/js/167.49a03db0.js"><link rel="prefetch" href="/assets/js/168.ebe9c55c.js"><link rel="prefetch" href="/assets/js/169.53efa7bb.js"><link rel="prefetch" href="/assets/js/17.96a778e6.js"><link rel="prefetch" href="/assets/js/170.4016444f.js"><link rel="prefetch" href="/assets/js/171.757c64d8.js"><link rel="prefetch" href="/assets/js/172.081f7480.js"><link rel="prefetch" href="/assets/js/173.2997f3cf.js"><link rel="prefetch" href="/assets/js/174.c1023074.js"><link rel="prefetch" href="/assets/js/175.07ca7ced.js"><link rel="prefetch" href="/assets/js/176.4b30a8cb.js"><link rel="prefetch" href="/assets/js/177.07e9b413.js"><link rel="prefetch" href="/assets/js/178.a00e2f64.js"><link rel="prefetch" href="/assets/js/179.24580058.js"><link rel="prefetch" href="/assets/js/18.27191b20.js"><link rel="prefetch" href="/assets/js/180.55016948.js"><link rel="prefetch" href="/assets/js/181.c752bdb6.js"><link rel="prefetch" href="/assets/js/182.042feb52.js"><link rel="prefetch" href="/assets/js/183.b86a5c39.js"><link rel="prefetch" href="/assets/js/184.56bfc2de.js"><link rel="prefetch" href="/assets/js/185.f76f49e1.js"><link rel="prefetch" href="/assets/js/186.96f8766b.js"><link rel="prefetch" href="/assets/js/187.624813c9.js"><link rel="prefetch" href="/assets/js/188.4e072f4e.js"><link rel="prefetch" href="/assets/js/189.41e97faa.js"><link rel="prefetch" href="/assets/js/19.10e6b66e.js"><link rel="prefetch" href="/assets/js/190.ec9c5b21.js"><link rel="prefetch" href="/assets/js/191.40cc4d4f.js"><link rel="prefetch" href="/assets/js/192.c5f96b34.js"><link rel="prefetch" href="/assets/js/193.4f75e166.js"><link rel="prefetch" href="/assets/js/194.ed00019f.js"><link rel="prefetch" href="/assets/js/195.55d74520.js"><link rel="prefetch" href="/assets/js/196.bbf11fae.js"><link rel="prefetch" href="/assets/js/197.36f48310.js"><link rel="prefetch" href="/assets/js/198.6382480c.js"><link rel="prefetch" href="/assets/js/199.0b4a31ca.js"><link rel="prefetch" href="/assets/js/20.c9849598.js"><link rel="prefetch" href="/assets/js/200.a9d76202.js"><link rel="prefetch" href="/assets/js/201.4fe67f1c.js"><link rel="prefetch" href="/assets/js/202.e7a135c5.js"><link rel="prefetch" href="/assets/js/203.b542e6ca.js"><link rel="prefetch" href="/assets/js/204.f5529869.js"><link rel="prefetch" href="/assets/js/205.a0f2a271.js"><link rel="prefetch" href="/assets/js/206.7a631840.js"><link rel="prefetch" href="/assets/js/207.c970a2c8.js"><link rel="prefetch" href="/assets/js/208.5e6266fc.js"><link rel="prefetch" href="/assets/js/209.43081e06.js"><link rel="prefetch" href="/assets/js/21.7b35d070.js"><link rel="prefetch" href="/assets/js/210.8ccf8057.js"><link rel="prefetch" href="/assets/js/211.991f5672.js"><link rel="prefetch" href="/assets/js/212.2cb93159.js"><link rel="prefetch" href="/assets/js/213.62a11f95.js"><link rel="prefetch" href="/assets/js/214.d83d9a17.js"><link rel="prefetch" href="/assets/js/215.97687768.js"><link rel="prefetch" href="/assets/js/216.4d1df106.js"><link rel="prefetch" href="/assets/js/217.4499f4a4.js"><link rel="prefetch" href="/assets/js/218.e733a259.js"><link rel="prefetch" href="/assets/js/219.6b5a8c63.js"><link rel="prefetch" href="/assets/js/22.a81c6dd1.js"><link rel="prefetch" href="/assets/js/220.4eb1d1a7.js"><link rel="prefetch" href="/assets/js/221.93de4946.js"><link rel="prefetch" href="/assets/js/222.29e3105a.js"><link rel="prefetch" href="/assets/js/223.855829f1.js"><link rel="prefetch" href="/assets/js/224.aa3e2b6c.js"><link rel="prefetch" href="/assets/js/23.19ef55db.js"><link rel="prefetch" href="/assets/js/24.14e8df9c.js"><link rel="prefetch" href="/assets/js/25.c61b2c85.js"><link rel="prefetch" href="/assets/js/26.f2e99aca.js"><link rel="prefetch" href="/assets/js/27.0055f1bf.js"><link rel="prefetch" href="/assets/js/28.d502962b.js"><link rel="prefetch" href="/assets/js/29.5274de73.js"><link rel="prefetch" href="/assets/js/3.c29c4376.js"><link rel="prefetch" href="/assets/js/30.d171a8c6.js"><link rel="prefetch" href="/assets/js/31.33ab4c82.js"><link rel="prefetch" href="/assets/js/32.5d7f62dd.js"><link rel="prefetch" href="/assets/js/33.432e7101.js"><link rel="prefetch" href="/assets/js/34.527238ae.js"><link rel="prefetch" href="/assets/js/35.41e2f1a9.js"><link rel="prefetch" href="/assets/js/36.36e8cbe9.js"><link rel="prefetch" href="/assets/js/37.408ecd7e.js"><link rel="prefetch" href="/assets/js/38.adb87b54.js"><link rel="prefetch" href="/assets/js/39.ab1743c0.js"><link rel="prefetch" href="/assets/js/40.dfe88367.js"><link rel="prefetch" href="/assets/js/41.4c0a244c.js"><link rel="prefetch" href="/assets/js/42.0db7ffc1.js"><link rel="prefetch" href="/assets/js/43.9bbc3fdc.js"><link rel="prefetch" href="/assets/js/44.9cb60997.js"><link rel="prefetch" href="/assets/js/45.233bc319.js"><link rel="prefetch" href="/assets/js/46.df825005.js"><link rel="prefetch" href="/assets/js/48.7f166177.js"><link rel="prefetch" href="/assets/js/49.8011783f.js"><link rel="prefetch" href="/assets/js/5.669bc404.js"><link rel="prefetch" href="/assets/js/50.20d114ee.js"><link rel="prefetch" href="/assets/js/51.41215bac.js"><link rel="prefetch" href="/assets/js/52.f14ab548.js"><link rel="prefetch" href="/assets/js/53.4f82a59d.js"><link rel="prefetch" href="/assets/js/54.5358a28a.js"><link rel="prefetch" href="/assets/js/55.15f62ff0.js"><link rel="prefetch" href="/assets/js/56.3b96ac00.js"><link rel="prefetch" href="/assets/js/57.82080407.js"><link rel="prefetch" href="/assets/js/58.b87f8a4f.js"><link rel="prefetch" href="/assets/js/59.d0280025.js"><link rel="prefetch" href="/assets/js/6.f6f62d21.js"><link rel="prefetch" href="/assets/js/60.a7627211.js"><link rel="prefetch" href="/assets/js/61.035209e3.js"><link rel="prefetch" href="/assets/js/62.2c485d50.js"><link rel="prefetch" href="/assets/js/63.248fe83e.js"><link rel="prefetch" href="/assets/js/64.78e661de.js"><link rel="prefetch" href="/assets/js/65.dd2bb2cc.js"><link rel="prefetch" href="/assets/js/66.4ee0cd75.js"><link rel="prefetch" href="/assets/js/67.d9fcd12f.js"><link rel="prefetch" href="/assets/js/68.952f4f3c.js"><link rel="prefetch" href="/assets/js/69.8e3c6d8f.js"><link rel="prefetch" href="/assets/js/7.4992cb98.js"><link rel="prefetch" href="/assets/js/70.272781c2.js"><link rel="prefetch" href="/assets/js/71.15cd1362.js"><link rel="prefetch" href="/assets/js/72.5f749898.js"><link rel="prefetch" href="/assets/js/73.d99dde8e.js"><link rel="prefetch" href="/assets/js/74.e998e475.js"><link rel="prefetch" href="/assets/js/75.757237b7.js"><link rel="prefetch" href="/assets/js/76.f5792d24.js"><link rel="prefetch" href="/assets/js/77.1024fde7.js"><link rel="prefetch" href="/assets/js/78.19a91326.js"><link rel="prefetch" href="/assets/js/79.a1f0575e.js"><link rel="prefetch" href="/assets/js/8.876918ab.js"><link rel="prefetch" href="/assets/js/80.4d569b1a.js"><link rel="prefetch" href="/assets/js/81.2cd439e3.js"><link rel="prefetch" href="/assets/js/82.9af7b0cb.js"><link rel="prefetch" href="/assets/js/83.2472ebe5.js"><link rel="prefetch" href="/assets/js/84.dc3685e8.js"><link rel="prefetch" href="/assets/js/85.6b6a015d.js"><link rel="prefetch" href="/assets/js/86.82cafc1a.js"><link rel="prefetch" href="/assets/js/87.cd7ab5af.js"><link rel="prefetch" href="/assets/js/88.69217326.js"><link rel="prefetch" href="/assets/js/89.b36c40f8.js"><link rel="prefetch" href="/assets/js/9.cab32b0c.js"><link rel="prefetch" href="/assets/js/90.dc1195b5.js"><link rel="prefetch" href="/assets/js/91.bda7a16a.js"><link rel="prefetch" href="/assets/js/92.808c8bb7.js"><link rel="prefetch" href="/assets/js/93.317ba4e1.js"><link rel="prefetch" href="/assets/js/94.8805601c.js"><link rel="prefetch" href="/assets/js/95.becd22c7.js"><link rel="prefetch" href="/assets/js/96.67caa618.js"><link rel="prefetch" href="/assets/js/97.4824155c.js"><link rel="prefetch" href="/assets/js/98.214e2bc6.js"><link rel="prefetch" href="/assets/js/99.0cf23487.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c8027397.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">睿晨网</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/aboutless.html" class="nav-link">
  第一期企业网页开发
</a></div><div class="nav-item"><a href="/secondless/" class="nav-link">
  第二期企业网站开发
</a></div><div class="nav-item"><a href="/thirdless/" class="nav-link">
  第三期移动端(H5/小程序/App)课程
</a></div><div class="nav-item"><a href="/fourthless/" class="nav-link router-link-active">
  第四期web全栈课程
</a></div><div class="nav-item"><a href="/fiveless/" class="nav-link">
  第五期python课程
</a></div><div class="nav-item"><a href="/web/software/" class="nav-link">
  课程软件小案例
</a></div><div class="nav-item"><a href="/web/mysql/" class="nav-link">
  课程案例数据表
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程答疑汇总" class="dropdown-title"><span class="title">课程答疑</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程答疑汇总" class="mobile-dropdown-title"><span class="title">课程答疑</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/answer/课程常见问题.html" class="nav-link">
  课程常见问题
</a></li><li class="dropdown-item"><!----> <a href="/deploy/" class="nav-link">
  项目部署
</a></li><li class="dropdown-item"><!----> <a href="/web/answer/免费部署SSL证书.html" class="nav-link">
  免费部署SSL证书
</a></li><li class="dropdown-item"><!----> <a href="/web/answer/如何清除服务器Nginx缓存.html" class="nav-link">
  清除Nginx缓存
</a></li><li class="dropdown-item"><!----> <a href="/web/answer/浏览器指纹.html" class="nav-link">
  浏览器指纹
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程学习网站" class="dropdown-title"><span class="title">课程学习网站</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程学习网站" class="mobile-dropdown-title"><span class="title">课程学习网站</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          视频学习网站
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://study.163.com/provider/480000002289674/index.htm?share=2&amp;shareId=480000002289674" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网易云课堂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://space.bilibili.com/3493114067028034/pugv" target="_blank" rel="noopener noreferrer" class="nav-link external">
  B站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实用菜单" class="dropdown-title"><span class="title">实用网站和方法</span> <span class="arrow down"></span></button> <button type="button" aria-label="实用菜单" class="mobile-dropdown-title"><span class="title">实用网站和方法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          实用方法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/定位相关.html" class="nav-link">
  定位相关
</a></li><li class="dropdown-subitem"><a href="/web/methods/地图相关.html" class="nav-link">
  地图相关
</a></li><li class="dropdown-subitem"><a href="/web/methods/树形结构数据转换.html" class="nav-link">
  树形结构数据转换
</a></li></ul></li><li class="dropdown-item"><h4>
          uni-app专栏
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/uni-app专栏.html" class="nav-link">
  uni-app的UI框架
</a></li><li class="dropdown-subitem"><a href="/web/methods/uni-app如何引入库.html" class="nav-link">
  uni-app如何引入js库
</a></li></ul></li><li class="dropdown-item"><h4>
          Egg.js专栏
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/secondless/w-c/Egg.js.html" class="nav-link">
  Egg.js基础
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/egg.js基础总结.html" class="nav-link">
  Egg.js基础总结
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/egg.js重要知识详细文档.html" class="nav-link">
  Egg.js重要知识详细文档
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/ValParams API 说明.html" class="nav-link">
  Egg.js参数验证说明
</a></li><li class="dropdown-subitem"><a href="/web/mysql/Sequelize数据类型.html" class="nav-link">
  Egg.js迁移文件Sequelize数据类型
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/Egg.js接口安全防护方案.html" class="nav-link">
  Egg.js接口安全防护方案
</a></li><li class="dropdown-subitem"><a href="/web/answer/课程常见问题.html#_3-eggjs如何重置数据表-保证id每次从1开始计算" class="nav-link">
  Egg.js重置数据表每次ID为1
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/Egg.js中extend中helper调用.html" class="nav-link">
  Egg.js中extend中helper调用
</a></li></ul></li><li class="dropdown-item"><h4>
          实用网站
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/实用接口.html" class="nav-link">
  实用接口
</a></li><li class="dropdown-subitem"><a href="/web/css/" class="nav-link">
  css
</a></li><li class="dropdown-subitem"><a href="/web/vue.js/" class="nav-link">
  Vue.js
</a></li><li class="dropdown-subitem"><a href="/web/Vue3+ElementPlus/" class="nav-link">
  Vue3+ElementPlus系统
</a></li><li class="dropdown-subitem"><a href="/web/echarts/" class="nav-link">
  echarts图表
</a></li><li class="dropdown-subitem"><a href="/web/bootstrap/" class="nav-link">
  Bootstrap
</a></li><li class="dropdown-subitem"><a href="/web/IIS/" class="nav-link">
  IIS
</a></li><li class="dropdown-subitem"><a href="/web/github/" class="nav-link">
  Github
</a></li><li class="dropdown-subitem"><a href="/web/Vanta.js/" class="nav-link">
  Vanta.js网页3D背景
</a></li><li class="dropdown-subitem"><a href="/web/shop/" class="nav-link">
  商城系统推荐
</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/aboutless.html" class="nav-link">
  第一期企业网页开发
</a></div><div class="nav-item"><a href="/secondless/" class="nav-link">
  第二期企业网站开发
</a></div><div class="nav-item"><a href="/thirdless/" class="nav-link">
  第三期移动端(H5/小程序/App)课程
</a></div><div class="nav-item"><a href="/fourthless/" class="nav-link router-link-active">
  第四期web全栈课程
</a></div><div class="nav-item"><a href="/fiveless/" class="nav-link">
  第五期python课程
</a></div><div class="nav-item"><a href="/web/software/" class="nav-link">
  课程软件小案例
</a></div><div class="nav-item"><a href="/web/mysql/" class="nav-link">
  课程案例数据表
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程答疑汇总" class="dropdown-title"><span class="title">课程答疑</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程答疑汇总" class="mobile-dropdown-title"><span class="title">课程答疑</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/answer/课程常见问题.html" class="nav-link">
  课程常见问题
</a></li><li class="dropdown-item"><!----> <a href="/deploy/" class="nav-link">
  项目部署
</a></li><li class="dropdown-item"><!----> <a href="/web/answer/免费部署SSL证书.html" class="nav-link">
  免费部署SSL证书
</a></li><li class="dropdown-item"><!----> <a href="/web/answer/如何清除服务器Nginx缓存.html" class="nav-link">
  清除Nginx缓存
</a></li><li class="dropdown-item"><!----> <a href="/web/answer/浏览器指纹.html" class="nav-link">
  浏览器指纹
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="课程学习网站" class="dropdown-title"><span class="title">课程学习网站</span> <span class="arrow down"></span></button> <button type="button" aria-label="课程学习网站" class="mobile-dropdown-title"><span class="title">课程学习网站</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          视频学习网站
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://study.163.com/provider/480000002289674/index.htm?share=2&amp;shareId=480000002289674" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网易云课堂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://space.bilibili.com/3493114067028034/pugv" target="_blank" rel="noopener noreferrer" class="nav-link external">
  B站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实用菜单" class="dropdown-title"><span class="title">实用网站和方法</span> <span class="arrow down"></span></button> <button type="button" aria-label="实用菜单" class="mobile-dropdown-title"><span class="title">实用网站和方法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          实用方法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/定位相关.html" class="nav-link">
  定位相关
</a></li><li class="dropdown-subitem"><a href="/web/methods/地图相关.html" class="nav-link">
  地图相关
</a></li><li class="dropdown-subitem"><a href="/web/methods/树形结构数据转换.html" class="nav-link">
  树形结构数据转换
</a></li></ul></li><li class="dropdown-item"><h4>
          uni-app专栏
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/uni-app专栏.html" class="nav-link">
  uni-app的UI框架
</a></li><li class="dropdown-subitem"><a href="/web/methods/uni-app如何引入库.html" class="nav-link">
  uni-app如何引入js库
</a></li></ul></li><li class="dropdown-item"><h4>
          Egg.js专栏
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/secondless/w-c/Egg.js.html" class="nav-link">
  Egg.js基础
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/egg.js基础总结.html" class="nav-link">
  Egg.js基础总结
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/egg.js重要知识详细文档.html" class="nav-link">
  Egg.js重要知识详细文档
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/ValParams API 说明.html" class="nav-link">
  Egg.js参数验证说明
</a></li><li class="dropdown-subitem"><a href="/web/mysql/Sequelize数据类型.html" class="nav-link">
  Egg.js迁移文件Sequelize数据类型
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/Egg.js接口安全防护方案.html" class="nav-link">
  Egg.js接口安全防护方案
</a></li><li class="dropdown-subitem"><a href="/web/answer/课程常见问题.html#_3-eggjs如何重置数据表-保证id每次从1开始计算" class="nav-link">
  Egg.js重置数据表每次ID为1
</a></li><li class="dropdown-subitem"><a href="/secondless/w-c/Egg.js中extend中helper调用.html" class="nav-link">
  Egg.js中extend中helper调用
</a></li></ul></li><li class="dropdown-item"><h4>
          实用网站
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/methods/实用接口.html" class="nav-link">
  实用接口
</a></li><li class="dropdown-subitem"><a href="/web/css/" class="nav-link">
  css
</a></li><li class="dropdown-subitem"><a href="/web/vue.js/" class="nav-link">
  Vue.js
</a></li><li class="dropdown-subitem"><a href="/web/Vue3+ElementPlus/" class="nav-link">
  Vue3+ElementPlus系统
</a></li><li class="dropdown-subitem"><a href="/web/echarts/" class="nav-link">
  echarts图表
</a></li><li class="dropdown-subitem"><a href="/web/bootstrap/" class="nav-link">
  Bootstrap
</a></li><li class="dropdown-subitem"><a href="/web/IIS/" class="nav-link">
  IIS
</a></li><li class="dropdown-subitem"><a href="/web/github/" class="nav-link">
  Github
</a></li><li class="dropdown-subitem"><a href="/web/Vanta.js/" class="nav-link">
  Vanta.js网页3D背景
</a></li><li class="dropdown-subitem"><a href="/web/shop/" class="nav-link">
  商城系统推荐
</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>eggjs多进程处理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#一、定义多进程存储方式" class="sidebar-link">一、定义多进程存储方式</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#二、多进程处理" class="sidebar-link">二、多进程处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_1-权限验证中间件-app-middleware-chat-user-auth-js" class="sidebar-link">1. 权限验证中间件 app/middleware/chat_user_auth.js</a></li><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_2-websocket权限验证中间件-app-middleware-chatwebsocket-js" class="sidebar-link">2. websocket权限验证中间件 app/middleware/chatwebsocket.js</a></li><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_3-扩展方法-app-extend-context-js" class="sidebar-link">3. 扩展方法 app/extend/context.js</a></li><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_4-新增对多进程的处理-在根目录新增-app-js-文件" class="sidebar-link">4. 新增对多进程的处理，在根目录新增 app.js 文件</a></li><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_5-控制器-app-controller-api-chat-chatwebsocket-js-代码调整" class="sidebar-link">5. 控制器 /app/controller/api/chat/chatwebsocket.js 代码调整</a></li><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_6-控制器-app-controller-api-chat-chatuser-js-代码调整" class="sidebar-link">6. 控制器 /app/controller/api/chat/chatuser.js 代码调整</a></li><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_7-控制器-app-controller-api-chat-chatgroup-js-代码调整" class="sidebar-link">7. 控制器 /app/controller/api/chat/chatgroup.js 代码调整</a></li><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_8-控制器-app-controller-api-chat-goodfriendapply-js-代码调整" class="sidebar-link">8. 控制器 /app/controller/api/chat/goodfriendapply.js 代码调整</a></li><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_9-关于控制器-app-controller-api-chat-chatwebsocket-js新建的服务文件-app-service-chatwebsocket-js" class="sidebar-link">9. 关于控制器 /app/controller/api/chat/chatwebsocket.js新建的服务文件 /app/service/chatwebsocket.js</a></li><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_10-关于设置常见问题问答相关的控制器-app-controller-api-chat-askanswer-js-代码" class="sidebar-link">10. 关于设置常见问题问答相关的控制器 /app/controller/api/chat/askanswer.js 代码</a></li><li class="sidebar-sub-header"><a href="/fourthless/w-a/eggjs.%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%A4%84%E7%90%86.html#_11-关于各种api路由-app-router-api-chat-router-js-汇总" class="sidebar-link">11. 关于各种api路由 /app/router/api/chat/router.js 汇总</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>我们知道 JavaScript 代码是运行在单线程上的，换句话说，一个 Node.js 进程只能运行在一个 CPU 上。那么如果用 Node.js 来做 Web Server，就无法享受到多核运算的好处。因此我们考虑使用多进程。<br></p> <p>具体查看官方文档说明： <a href="https://eggjs.org/zh-CN/core/cluster-and-ipc" target="_blank" rel="noopener noreferrer">https://eggjs.org/zh-CN/core/cluster-and-ipc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <br></p> <h2 id="一、定义多进程存储方式"><a href="#一、定义多进程存储方式" class="header-anchor">#</a> 一、定义多进程存储方式</h2> <p>在配置文件 <code>config/config.default.js</code> 中定义多进程存储方式</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token operator">...</span>
  <span class="token comment">// 客户端用户注册登录校验签名的盐值，用户登录模块</span>
  <span class="token operator">...</span>
  <span class="token comment">// 多进程处理 -- 针对websocket服务 -- 进程间通信 -- 对进程的存储方式设计</span>
  <span class="token comment">// 用户上线 - 多进程处理</span>
  <span class="token comment">// 具体查看根目录 `app/extend/context.js`文件中的`online`方法</span>
  <span class="token comment">// 是否将信息存储在一个 Redis 哈希（Hash）结构中 --- 可自定义</span>
  <span class="token comment">// 例如：你可以定义一个Redis 哈希（Hash）结构中，键为 chat_user_online</span>
  <span class="token comment">// let Hash_key = 'chat_user_online'; // 自定义 -- 少量用户可以这么做，方便统计管理在线用户</span>
  <span class="token comment">// 此处有个重要说明是作为架构师的基础素养：</span>
  <span class="token comment">// 1. 如果在线用户超过1000万（根据存储容量），或者10M，10M 个字段的 Hash 很容易撑爆单个节点的内存</span>
  <span class="token comment">// 2. 对这个 Hash 执行 HGETALL、HSCAN 等操作（例如，如果你想统计在线人数）会极度缓慢，并可能阻塞 Redis，导致其他命令超时</span>
  <span class="token comment">// 3. 这个巨大的 Key 会成为集群环境下无法分割的热点 Key</span>
  <span class="token comment">// 4. 扩展性极差</span>
  <span class="token comment">// 5. 效率并非最优:</span>
  <span class="token comment">// 5.1 - 你的操作主要是单个用户的读写（HSET online_1234 pid / HGET online_1234）。</span>
  <span class="token comment">//       使用 Hash 结构为这种操作增加了不必要的开销，直接使用 String 键（SET online_1234 pid）效率更高</span>
  <span class="token comment">// 5.2 - 推荐方案：使用 String 类型 + 分布式架构</span>
  <span class="token comment">//       对于海量用户在线状态存储，最经典和高效的方案是使用 String 类型，并为每个用户分配一个独立的 Key。</span>
  <span class="token comment">//       也就是简单存储，不要用Hash_key，简单存储的key是类似：'online_' + 用户id，这个值在redis客户端打开Keys就能看到</span>

  <span class="token comment">//配置多进程存储方式hash_key</span>
  <span class="token comment">// config.Hash_key = 'chat_user_online'; // 自定义 -- 少量用户可以这么做，方便统计管理在线用户</span>
  config<span class="token punctuation">.</span>Hash_key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 考虑到将来的海量用户（百万用户以上），我们选择使用简单存储</span>

  <span class="token comment">//配置session</span>
  <span class="token operator">...</span>
</code></pre></div><h2 id="二、多进程处理"><a href="#二、多进程处理" class="header-anchor">#</a> 二、多进程处理</h2> <p>由于多进程处理改动的源码地方较多，以下我给大家提供了完整的文件源码，每个文件会标明改动的地方 <br></p> <h3 id="_1-权限验证中间件-app-middleware-chat-user-auth-js"><a href="#_1-权限验证中间件-app-middleware-chat-user-auth-js" class="header-anchor">#</a> 1. 权限验证中间件 <code>app/middleware/chat_user_auth.js</code></h3> <p>重点调整的地方是： <code>游客可访问的路由白名单</code></p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">option<span class="token punctuation">,</span> app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">chatUserAuth</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 针对游客的操作</span>
        <span class="token comment">//...</span>
        
        <span class="token comment">// 即时通讯注册用户和游客的登录验证</span>
        <span class="token comment">// 1. 获取header头的token</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> ctx<span class="token punctuation">.</span>header<span class="token punctuation">.</span>token <span class="token operator">||</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>token <span class="token operator">||</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'您没有权限访问即时通讯接口'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//2. 根据token解密，换取用户信息，失败则要么Token已过期或者不合法，抛出错误，终止程序</span>
        <span class="token keyword">let</span> tokenUser <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            tokenUser <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">checkToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> fail <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'TokenExpiredError'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'Token已过期！请重新获取令牌'</span> <span class="token operator">:</span> <span class="token string">'Token 令牌不合法！'</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> fail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">//3. 说明token解密正确，此时判断用户是否登录过</span>
        <span class="token comment">// 根据当前解密的用户信息的id,去缓存拿一下该id的信息</span>
        <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'chat_user_'</span> <span class="token operator">+</span> tokenUser<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//console.log('打印t',tokenUser.id);</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t <span class="token operator">||</span> t <span class="token operator">!=</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// if (ctx.path !== '/ws'){</span>
            <span class="token comment">//     ctx.throw(400, 'Token 令牌不合法！');</span>
            <span class="token comment">// }else{</span>
            <span class="token comment">//    // websocket链接在websocket中间件去处理</span>
            <span class="token comment">//    console.log('websocket链接在websocket中间件去处理');</span>
            <span class="token comment">// }</span>
            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'Token 令牌不合法！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 4. 说明当前用户之前登录过了，缓存里有他的数据，比如说已经登录过3天了</span>
        <span class="token comment">// 但有一种情况，这三天内，他发了违规信息，已经被超级管理员禁用了或者被超级管理员把他从数据库删除了</span>
        <span class="token comment">// 那么即使现在他传的token有效，也没有用，依旧不能让他操作</span>
        <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>tokenUser<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> user<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'当前用户不存在或者已被禁用'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 新增：针对游客的操作</span>
        <span class="token comment">//console.log('数据库的用户信息',JSON.parse(JSON.stringify(user)));</span>
        <span class="token comment">//console.log('token的用户信息',JSON.parse(JSON.stringify(tokenUser)));</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>tokenUser<span class="token punctuation">.</span>role <span class="token operator">==</span> <span class="token string">'visitor'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 给游客开放一些接口</span>
            <span class="token comment">// 根据接口设置：&lt;https://docs.51yrc.com/fourthless/w-a/eggjs.即时通讯接口.html&gt;</span>
            <span class="token comment">// 获取接口地址做判断</span>
            <span class="token comment">// ctx.throw(400, '您没有权限访问，请先注册或登录');  </span>
            <span class="token comment">// 获取接口地址做判断</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> method <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
            
            <span class="token comment">// 定义游客允许访问的接口白名单</span>
            <span class="token keyword">const</span> visitorWhitelist <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/socket/sendmessage'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 给服务器发消息（单聊）</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/chatGetmessageOffLine'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 获取离线消息</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/grouplist'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'GET'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 我的群聊列表</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/groupinfo'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'GET'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 获取群资料信息</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/groupnickname'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 修改我在群里面的昵称</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/groupDeleteOrQuit'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 退出群</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/groupQrcode'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'GET'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 生成获取群二维码</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/uploadStreamSingleToServerDiy'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// uni-app项目上传文件[单文件]（图片视频等）到本地服务器（自定义文件路径）</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/uploadAliyun'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// uni-app项目上传文件[单文件]（图片视频等）到阿里云存储OSS</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/getVideoScreenshot'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">//视频上传到服务器获取视频封面</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/revokeMessage'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">//撤回消息接口说明</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/updateUserinfo'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">//修改我的信息（修改我的头像昵称等信息）-游客根据情况有部分权限</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/groupInviteUser'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">//游客自己进群根据群设置来处理</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/getUserSetInfo'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 获取用户一些设置信息如：加好友设置、聊天设置等</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/applyfriend'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 放开一步，游客可以添加好友</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/autoAddFriendAndAgree'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">//自动添加好友并通过（前提是invite_confirm：0）</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/ismygoodfriend'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 查对方是否是我的好友</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/userset'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 和我聊天设置-条数限制</span>
                <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/api/chat/deletegoodfriend'</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// 删除好友</span>

            <span class="token punctuation">]</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 检查当前请求是否在白名单中</span>
            <span class="token keyword">const</span> isAllowed <span class="token operator">=</span> visitorWhitelist<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> 
                path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> method <span class="token operator">===</span> item<span class="token punctuation">.</span>method
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'您没有权限访问，请先注册或登录'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5. 没什么问题了，把用户信息挂载到ctx上，方便调用</span>
        ctx<span class="token punctuation">.</span>chat_user <span class="token operator">=</span> user<span class="token punctuation">;</span>
        <span class="token comment">// 存储一下tokenUser, 因为后面有些判断要用到</span>
        ctx<span class="token punctuation">.</span>tokenUser <span class="token operator">=</span> tokenUser<span class="token punctuation">;</span>

        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-websocket权限验证中间件-app-middleware-chatwebsocket-js"><a href="#_2-websocket权限验证中间件-app-middleware-chatwebsocket-js" class="header-anchor">#</a> 2. websocket权限验证中间件 <code>app/middleware/chatwebsocket.js</code></h3> <p>改动较大，核心放在:</p> <blockquote><p><code>4.检查是否已有同一用户的连接 - 防止异地登录同时在线</code> <br></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 引入 uuid 库 `npm install uuid`</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">v4</span><span class="token operator">:</span> uuidv4 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'WebSocket请求:'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 非websocket链接直接放行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path <span class="token operator">!==</span> <span class="token string">'/ws'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理websocket链接</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">,</span>
                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'缺少 token 参数'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> user <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">checkToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> userCheck <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 1. 判断用户是否存在</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'用户不存在'</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 2. 判断用户是否被禁用</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userCheck<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'你已被管理员禁用'</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 多进程</span>
            <span class="token comment">// 3.存储连接</span>
            ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser <span class="token operator">=</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 4.检查是否已有同一用户的连接 - 防止异地登录同时在线</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser<span class="token punctuation">[</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 给用户一个异地登录消息</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>role <span class="token operator">==</span> <span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">// 检查redis中是否有标记 - 类似修改：昵称、头像、设置等不要推送消息、否则就是异地登录 </span>
                    <span class="token keyword">const</span> redisKey <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">user:modify:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> isSelfModify <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSelfModify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 当前时间</span>
                        <span class="token keyword">const</span> <span class="token function-variable function">currentTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">const</span> year <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
                            <span class="token keyword">const</span> month <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>     
                            <span class="token keyword">const</span> day <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
                            <span class="token keyword">const</span> hh <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
                            <span class="token keyword">const</span> mm <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          
                            <span class="token keyword">const</span> ss <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">let</span> clock <span class="token operator">=</span> year <span class="token operator">+</span> <span class="token string">&quot;年&quot;</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span><span class="token punctuation">(</span>month <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> clock <span class="token operator">+=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">;</span>
                            clock <span class="token operator">+=</span> month <span class="token operator">+</span> <span class="token string">&quot;月&quot;</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span><span class="token punctuation">(</span>day <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> clock <span class="token operator">+=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">;</span>
                            clock <span class="token operator">+=</span> day <span class="token operator">+</span> <span class="token string">&quot;日 &quot;</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span><span class="token punctuation">(</span>hh <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> clock <span class="token operator">+=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">;</span>
                            clock <span class="token operator">+=</span> hh <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>mm <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> clock <span class="token operator">+=</span> <span class="token string">'0'</span><span class="token punctuation">;</span> 
                            clock <span class="token operator">+=</span> mm <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">;</span> 
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>ss <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> clock <span class="token operator">+=</span> <span class="token string">'0'</span><span class="token punctuation">;</span>
                            clock <span class="token operator">+=</span> ss<span class="token punctuation">;</span>
                            <span class="token keyword">return</span><span class="token punctuation">(</span>clock<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
                        <span class="token comment">// 消息内容自定义</span>
                        <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">您的聊天会话线路于 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">currentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 因网络波动或者长时间未操作已经掉线，系统尝试给您重新连接线路，现已连接成功，请刷新页面或者重新打开页面。</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                        <span class="token comment">// 定义一下通知消息 </span>
                        <span class="token keyword">const</span> force_message <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">offlineMsg</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                            <span class="token literal-property property">from_avatar</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/kefu.png</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                            <span class="token literal-property property">from_name</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">聊天会话线路异常提示</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                            <span class="token comment">// from_id: 0,</span>
                            <span class="token literal-property property">data</span><span class="token operator">:</span> data<span class="token punctuation">,</span>
                            <span class="token literal-property property">showModel</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                                <span class="token literal-property property">showModelType</span><span class="token operator">:</span> <span class="token string">'forceLogin'</span><span class="token punctuation">,</span> 
                                <span class="token literal-property property">content</span><span class="token operator">:</span> data<span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 前端页面这个消息不要显示底部输入框</span>
                        force_message<span class="token punctuation">.</span>from_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token comment">// 符合前端页面格式的消息推送 - 异地登录提示</span>
                        <span class="token comment">// ctx.app.ws.chatuser[user.id].send(JSON.stringify({</span>
                        <span class="token comment">//     type: 'singleChat',</span>
                        <span class="token comment">//     data: force_message,</span>
                        <span class="token comment">//     timestamp: Date.now(),</span>
                        <span class="token comment">// }));</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户修改账号昵称头像设置等一般信息，不发送异地登录提示'</span><span class="token punctuation">,</span> isSelfModify<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>isSelfModify <span class="token operator">==</span> <span class="token string">'avatar'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                            <span class="token comment">// 如果是头像更新了，为了配合消息页界面头像更新，这里推送一下消息</span>
                            <span class="token comment">// 获取最新头像</span>
                            <span class="token keyword">const</span> avatar <span class="token operator">=</span> userCheck<span class="token punctuation">.</span>avatar<span class="token punctuation">;</span>
                            <span class="token comment">// 为了方便看效果，设置完成之后，跳转到消息页</span>
                            <span class="token keyword">let</span> redirectUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/pages/xiaoxi/xiaoxi</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                            <span class="token keyword">let</span> redirectType <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">switchTab</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                            <span class="token comment">// 处理链接地址</span>
                            <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/pages/setpageInfo/setpageInfo?action=userinfoSet&amp;title=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span><span class="token string">'账号信息设置'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                            <span class="token comment">// 完整地址</span>
                            url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;redirectUrl=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>redirectUrl<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;redirectType=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>redirectType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                            <span class="token comment">// 账号信息设置，给提示一下</span>
                            <span class="token keyword">let</span> msg <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">offlineMsg</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                                <span class="token literal-property property">from_id</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">redirect-userInfoSet-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                                <span class="token literal-property property">from_avatar</span><span class="token operator">:</span> avatar<span class="token punctuation">,</span>
                                <span class="token literal-property property">from_name</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">头像更换成功</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">不满意你的头像可以继续更换</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                                <span class="token comment">// 处理链接</span>
                                <span class="token literal-property property">redirect</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                                    <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span> <span class="token comment">// 处理链接地址</span>
                                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'navigateTo'</span><span class="token punctuation">,</span> <span class="token comment">// 处理链接类型</span>
                                    <span class="token comment">// 处理链接动作 - 对消息是更新还是删除等在前端类文件chatClass.js依据具体业务场景</span>
                                    <span class="token literal-property property">doaction</span><span class="token operator">:</span> <span class="token string">'avatar'</span><span class="token punctuation">,</span> 
                                <span class="token punctuation">}</span><span class="token punctuation">,</span> 
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            ctx<span class="token punctuation">.</span><span class="token function">chatWebsocketSendOrSaveMessage</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                            <span class="token comment">// 删除redis标记，避免影响后续判断</span>
                            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 5.存储新连接</span>
            ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser<span class="token punctuation">[</span>user<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>websocket<span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>chatuser_id <span class="token operator">=</span> user<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  
            <span class="token comment">// 执行 `/app/extend/context.js`文件中的`online`方法</span>
            <span class="token comment">// 6.用户上线 - 包含其它设备的下线通知</span>
            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">online</span><span class="token punctuation">(</span>userCheck<span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> process<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>   
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">用户 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 连接成功-- 进程ID:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">--并上线</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

            <span class="token comment">// 7.进入控制器</span>
            <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'WebSocket中间件错误:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> message <span class="token operator">=</span> err<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'TokenExpiredError'</span>
                <span class="token operator">?</span> <span class="token string">'token 已过期'</span>
                <span class="token operator">:</span> <span class="token string">'Token 不合法'</span><span class="token punctuation">;</span>

            ctx<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">,</span>
                <span class="token literal-property property">data</span><span class="token operator">:</span> message
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-扩展方法-app-extend-context-js"><a href="#_3-扩展方法-app-extend-context-js" class="header-anchor">#</a> 3. 扩展方法 <code>app/extend/context.js</code></h3> <p>以下是完整的文件代码，重点说改动或者新增的几个地方：</p> <blockquote><ol><li>处理<code>单进程</code>和<code>多进程</code>发消息方法：<code>通用发送websocket消息方法:</code> <code>chatWebsocketSendOrSaveMessage</code></li> <li>新增方法: <code>多进程处理 - 用户上线</code> <code>online</code></li> <li>新增方法: <code>定义通知消息 -- 定义消息格式</code> <code>offlineMsg</code></li> <li>新增方法: <code>多进程：根据进程存储方式获取用户之前的进程</code> <code>getOldProcessId</code></li> <li>新增方法: <code>多进程：根据进程存储方式 - 移除redis中用户的上线记录</code> <code>removeOnlineProcessId</code></li> <li>新增方法: <code>移除websocket用户记录</code> <code>UserWebsocketCloseAndDelete</code></li> <li>新增方法: <code>通用存储聊天消息记录到redis中的key值自定义：带文件夹存储</code> <code>setRedisChatlogKey</code></li> <li>新增方法: <code>通用数据存储到redis自定义方法</code> <code>setRedisDiy</code></li></ol></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/*
//通用文件上传到阿里云OSS方法--File模式
// 阿里云OSS SDK
const OSS = require('ali-oss');
// node系统模块
const path = require('path');
const fs = require('fs/promises');
const crypto = require('crypto');
*/</span>

<span class="token comment">//通用文件上传到阿里云OSS方法--Stream 流模式</span>
<span class="token comment">// 阿里云OSS SDK</span>
<span class="token keyword">const</span> <span class="token constant">OSS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ali-oss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// node系统模块</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//使用 pump 确保流正确写入,必须写入临时文件后才能上传到 OSS</span>
<span class="token comment">//内存管理优化,使用 pump 控制流式写入,每个文件单独处理，避免内存峰值,及时清理临时文件</span>
<span class="token keyword">const</span> pump <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mz-modules/pump'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 引入二维码插件</span>
<span class="token keyword">var</span> qr <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'qr-image'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 引入uuid</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">v4</span><span class="token operator">:</span> uuidv4 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 分页</span>
  <span class="token keyword">async</span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token parameter">modelName<span class="token punctuation">,</span> where <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> page <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span>page <span class="token operator">?</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span>page<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> limit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span>limit <span class="token operator">?</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span>limit<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">;</span>

    <span class="token comment">//options里面有limit，则以options.limit为准</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      limit <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
      offset <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//如果没有传排序规则，则默认给它id降序</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options<span class="token punctuation">.</span>order <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'desc'</span><span class="token punctuation">]</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>model<span class="token punctuation">[</span>modelName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">limit</span><span class="token operator">:</span> limit<span class="token punctuation">,</span>
      <span class="token literal-property property">offset</span><span class="token operator">:</span> offset<span class="token punctuation">,</span>
      <span class="token literal-property property">where</span><span class="token operator">:</span> where<span class="token punctuation">,</span>
      <span class="token operator">...</span>options
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//求得总分页数</span>
    <span class="token keyword">let</span> totalPage <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>count <span class="token operator">/</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果options有include关联查询，导致关联数据很多，分页错误，从新计算分页</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>include<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> _data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>model<span class="token punctuation">[</span>modelName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">limit</span><span class="token operator">:</span> limit<span class="token punctuation">,</span>
        <span class="token literal-property property">offset</span><span class="token operator">:</span> offset<span class="token punctuation">,</span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> where<span class="token punctuation">,</span>
        <span class="token comment">// ...options</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      totalPage <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>_data<span class="token punctuation">.</span>count <span class="token operator">/</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// -----------------------处理页面分页按钮网址上有其他参数的情况-----------------------------------</span>
    <span class="token comment">//网址有其他参数，如：http://127.0.0.1:7001/admin/manager/index?page=1&amp;limit=3&amp;keyword=哈哈&amp;cid=100</span>
    <span class="token comment">// console.log(this.query);</span>
    <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>query <span class="token punctuation">}</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{ page: '1', limit: '3', keyword: '哈哈', cid: '100' }</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> query<span class="token punctuation">.</span>page<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'limit'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> query<span class="token punctuation">.</span>limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{ keyword: '哈哈', cid: '100' }</span>
    <span class="token comment">// 对象转&amp;拼接字符串</span>
    <span class="token comment">//{ keyword: '哈哈', cid: '100'} 转成  &amp;keyword=哈哈&amp;cid=100</span>
    <span class="token keyword">const</span> <span class="token function-variable function">urlEncode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">,</span> key<span class="token punctuation">,</span> encode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> paramStr <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token keyword">typeof</span> <span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token string">'string'</span> <span class="token operator">||</span> t <span class="token operator">==</span> <span class="token string">'number'</span> <span class="token operator">||</span> t <span class="token operator">==</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        paramStr <span class="token operator">+=</span> <span class="token string">'&amp;'</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encode <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> encode<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token operator">:</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> k <span class="token operator">=</span> key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> i <span class="token operator">:</span> key <span class="token operator">+</span> <span class="token punctuation">(</span>param <span class="token keyword">instanceof</span> <span class="token class-name">Array</span> <span class="token operator">?</span> <span class="token string">'['</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">']'</span> <span class="token operator">:</span> <span class="token string">'.'</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>
          paramStr <span class="token operator">+=</span> <span class="token function">urlEncode</span><span class="token punctuation">(</span>param<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> encode<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> paramStr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//调用urlEncode方法</span>
    query <span class="token operator">=</span> <span class="token function">urlEncode</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log(query);//结果：&amp;keyword=哈哈&amp;cid=100 (转码后：&amp;keyword=%E5%93%88%E5%93%88&amp;cid=100)</span>

    <span class="token comment">// -----------------------处理页面分页按钮网址上有其他参数的情况-----------------------------------</span>



    <span class="token comment">//分页模版代码</span>
    <span class="token keyword">let</span> pageEl <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> totalPage<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//判断当前页是否是active</span>
      <span class="token keyword">let</span> active <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        active <span class="token operator">=</span> <span class="token string">'active'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      pageEl <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;li class=&quot;page-item </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>active<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;&lt;a class=&quot;page-link&quot; href=&quot;?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;limit=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/a&gt;&lt;/li&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//如果当前就是第一页，就不存在上一页，禁用上一页按钮，下一页同理</span>
    <span class="token keyword">let</span> prevDisabled <span class="token operator">=</span> page <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">'disabled'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> nextDisabled <span class="token operator">=</span> page <span class="token operator">&gt;=</span> totalPage <span class="token operator">?</span> <span class="token string">'disabled'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token comment">//最后将所有模版代码组装一起</span>
    <span class="token keyword">let</span> pageHtml <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;ul class=&quot;pagination&quot;&gt;
          &lt;li class=&quot;page-item </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prevDisabled<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;
              &lt;a class=&quot;page-link&quot; href=&quot;?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;limit=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; aria-label=&quot;Previous&quot;&gt;
                  &lt;span aria-hidden=&quot;true&quot;&gt;«&lt;/span&gt;
                  &lt;span class=&quot;sr-only&quot;&gt;Previous&lt;/span&gt;
              &lt;/a&gt;
          &lt;/li&gt;
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageEl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
          &lt;li class=&quot;page-item </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextDisabled<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;
              &lt;a class=&quot;page-link&quot; href=&quot;?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;limit=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; aria-label=&quot;Next&quot;&gt;
                  &lt;span aria-hidden=&quot;true&quot;&gt;»&lt;/span&gt;
                  &lt;span class=&quot;sr-only&quot;&gt;Next&lt;/span&gt;
              &lt;/a&gt;
          &lt;/li&gt;
        &lt;/ul&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token comment">//如何将我们定义的这个pageHtml变量放在模版里面去？</span>
    <span class="token comment">//egg.js框架给我们在context扩展里面提供了locals对象，可将变量挂载到这个对象里面，然后可在模版里面使用</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>locals<span class="token punctuation">.</span>pageHtml <span class="token operator">=</span> pageHtml<span class="token punctuation">;</span>


    <span class="token keyword">return</span> data<span class="token punctuation">.</span>rows
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 前端数据模型 + 分页</span>
  <span class="token comment">// 前端数据模型</span>
  <span class="token keyword">async</span> <span class="token function">apiModelData</span><span class="token punctuation">(</span><span class="token parameter">modelName<span class="token punctuation">,</span> where <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> page <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span>page <span class="token operator">?</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span>page<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> limit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span>limit <span class="token operator">?</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span>limit<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">;</span>

    <span class="token comment">//如果没有传排序规则，则默认给它id降序</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options<span class="token punctuation">.</span>order <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'desc'</span><span class="token punctuation">]</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>model<span class="token punctuation">[</span>modelName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">limit</span><span class="token operator">:</span> limit<span class="token punctuation">,</span>
      <span class="token literal-property property">offset</span><span class="token operator">:</span> offset<span class="token punctuation">,</span>
      <span class="token literal-property property">where</span><span class="token operator">:</span> where<span class="token punctuation">,</span>
      <span class="token operator">...</span>options
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//求得总分页数</span>
    <span class="token keyword">let</span> totalPage <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>count <span class="token operator">/</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// -----------------------处理页面分页按钮网址上有其他参数的情况-----------------------------------</span>
    <span class="token comment">//网址有其他参数，如：http://127.0.0.1:7001/admin/manager/index?page=1&amp;limit=3&amp;keyword=哈哈&amp;cid=100</span>
    <span class="token comment">// console.log(this.query);</span>
    <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>query <span class="token punctuation">}</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{ page: '1', limit: '3', keyword: '哈哈', cid: '100' }</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> query<span class="token punctuation">.</span>page<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'limit'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> query<span class="token punctuation">.</span>limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{ keyword: '哈哈', cid: '100' }</span>
    <span class="token comment">// 对象转&amp;拼接字符串</span>
    <span class="token comment">//{ keyword: '哈哈', cid: '100'} 转成  &amp;keyword=哈哈&amp;cid=100</span>
    <span class="token keyword">const</span> <span class="token function-variable function">urlEncode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">,</span> key<span class="token punctuation">,</span> encode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> paramStr <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token keyword">typeof</span> <span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token string">'string'</span> <span class="token operator">||</span> t <span class="token operator">==</span> <span class="token string">'number'</span> <span class="token operator">||</span> t <span class="token operator">==</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        paramStr <span class="token operator">+=</span> <span class="token string">'&amp;'</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encode <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> encode<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token operator">:</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> k <span class="token operator">=</span> key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> i <span class="token operator">:</span> key <span class="token operator">+</span> <span class="token punctuation">(</span>param <span class="token keyword">instanceof</span> <span class="token class-name">Array</span> <span class="token operator">?</span> <span class="token string">'['</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">']'</span> <span class="token operator">:</span> <span class="token string">'.'</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>
          paramStr <span class="token operator">+=</span> <span class="token function">urlEncode</span><span class="token punctuation">(</span>param<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> encode<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> paramStr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//调用urlEncode方法</span>
    query <span class="token operator">=</span> <span class="token function">urlEncode</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log(query);//结果：&amp;keyword=哈哈&amp;cid=100 (转码后：&amp;keyword=%E5%93%88%E5%93%88&amp;cid=100)</span>

    <span class="token comment">// -----------------------处理页面分页按钮网址上有其他参数的情况-----------------------------------</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      page<span class="token punctuation">,</span>
      limit<span class="token punctuation">,</span>
      query<span class="token punctuation">,</span>
      totalPage<span class="token punctuation">,</span>
      data
    <span class="token punctuation">}</span>


  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 前端分页 -- 模版1分页样式</span>
  <span class="token keyword">async</span> <span class="token function">apiPage</span><span class="token punctuation">(</span><span class="token parameter">modelName<span class="token punctuation">,</span> where <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> modeldata <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">apiModelData</span><span class="token punctuation">(</span>modelName<span class="token punctuation">,</span> where<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'modeldata的数据'</span><span class="token punctuation">,</span> modeldata<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> page <span class="token operator">=</span> modeldata<span class="token punctuation">.</span>page<span class="token punctuation">;</span>
    <span class="token keyword">let</span> limit <span class="token operator">=</span> modeldata<span class="token punctuation">.</span>limit<span class="token punctuation">;</span>
    <span class="token keyword">let</span> query <span class="token operator">=</span> modeldata<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">let</span> totalPage <span class="token operator">=</span> modeldata<span class="token punctuation">.</span>totalPage<span class="token punctuation">;</span>

    <span class="token comment">//分页模版代码</span>
    <span class="token keyword">let</span> pageEl <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> totalPage<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//判断当前页是否是active</span>
      <span class="token keyword">let</span> active <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        active <span class="token operator">=</span> <span class="token string">'active'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      pageEl <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;li class=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>active<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;&lt;a href=&quot;?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;limit=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/a&gt;&lt;/li&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//如果当前就是第一页，就不存在上一页，禁用上一页按钮，下一页同理</span>
    <span class="token keyword">let</span> prevDisabled <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>totalPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'disabled'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> nextDisabled <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">&gt;=</span> totalPage<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>totalPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'disabled'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> firstpage <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>totalPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'disabled'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> lastpage <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">==</span> totalPage<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>totalPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'disabled'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token comment">//最后将所有模版代码组装一起</span>
    <span class="token keyword">let</span> apipageHtml <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;style type=&quot;text/css&quot;&gt;
    .pages li.disabled{
      background-color: #f5f5f5;
    }
    .pages li.disabled a{
      color:#aaaaaa;
    }
    .pages li.disabled{
      position:relative;
    }
    .pages li.disabled::before{
       content:'';
       display:'block';
       width:100%;
       height:100%;
       position:absolute;
       left:0;
       top:0;
    }
    &lt;/style&gt;
    &lt;div class=&quot;flex justify-center py-5 mt-5&quot;
    style=&quot;flex:auto&quot;&gt;
        &lt;ul class=&quot;pages&quot;&gt;
          &lt;li class=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>firstpage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;&lt;a href=&quot;?page=1&amp;limit=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;首页&lt;/a&gt;&lt;/li&gt;
          &lt;li class=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prevDisabled<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;
              &lt;a href=&quot;?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;limit=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; &gt;上一页&lt;/a&gt;
          &lt;/li&gt;
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageEl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
          &lt;li class=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextDisabled<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;
              &lt;a href=&quot;?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;limit=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;下一页&lt;/a&gt;
          &lt;/li&gt;
          &lt;li class=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastpage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;&lt;a href=&quot;?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>totalPage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;limit=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>query<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;尾页&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
    &lt;/div&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token comment">//如何将我们定义的这个apipageHtml变量放在模版里面去？</span>
    <span class="token comment">//egg.js框架给我们在context扩展里面提供了locals对象，可将变量挂载到这个对象里面，然后可在模版里面使用</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>locals<span class="token punctuation">.</span>apipageHtml <span class="token operator">=</span> apipageHtml<span class="token punctuation">;</span>


    <span class="token keyword">return</span> modeldata<span class="token punctuation">.</span>data<span class="token punctuation">;</span>


  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//渲染公共模版</span>
  <span class="token keyword">async</span> <span class="token function">renderTemplate</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//获取cookie中的消息提示内容 toast</span>
    <span class="token keyword">let</span> toast <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'toast'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">encrypt</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">//中文要加密</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//合并参数到params里面</span>
    params<span class="token punctuation">.</span>toast <span class="token operator">=</span> toast <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>toast<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/common/template.html'</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">//渲染前端公共模版</span>
  <span class="token comment">/**
   * 
   * @param {Object} params - 用于渲染模板的数据对象。应包含模板所需的所有键值对
   * @param {string} tplname - [tplname = 'api/template01/main_app.html'] -  模板文件的路径。默认为内置的基础API模板路径，可不填。
   * @returns {Promise&lt;void&gt;} - 返回一个Promise，表示渲染操作的完成状态。无具体返回值。
   * @throws {Error} - 如果模板加载或渲染过程中发生错误，可能会抛出异常。
   */</span>
  <span class="token keyword">async</span> <span class="token function">renderApi</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> tplname <span class="token operator">=</span> <span class="token string">'api/template01/main_app.html'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>tplname<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">//消息提示</span>
  <span class="token function">toast</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&quot;danger&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'toast'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      msg<span class="token punctuation">,</span>
      type
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">1500</span><span class="token punctuation">,</span> <span class="token comment">//1500毫秒之后失效</span>
      <span class="token literal-property property">encrypt</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">//中文要加密</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">//页面错误提示</span>
  <span class="token keyword">async</span> <span class="token function">pageFail</span><span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> code <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/common/404.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">,</span>
      code
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//api接口形式成功提示</span>
  <span class="token function">apiSuccess</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">'ok'</span><span class="token punctuation">,</span> code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> code<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> msg<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//api接口形式失败提示</span>
  <span class="token function">apiFail</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">'fail'</span><span class="token punctuation">,</span> code <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> code<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> msg<span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">//生成token</span>
  <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//验证token</span>
  <span class="token function">checkToken</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//return this.app.jwt.verify(token, this.app.config.jwt.secret);</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处理异常（如 token 过期/无效）</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Token 验证失败:'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 通用数据转树形结构方法
   * @param {Array} data - 原始数据列表
   * @param {Object} options - 配置项
   * @param {string} [options.idKey='id'] - 节点唯一标识字段名
   * @param {string} [options.pidKey='pid'] - 父节点标识字段名
   * @param {string} [options.childrenKey='children'] - 子节点属性名
   * @param {number} [options.initialLevel=0] - 初始层级
   * @returns {Array} 树形结构数据
   */</span>
  <span class="token function">treeify</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    idKey <span class="token operator">=</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
    pidKey <span class="token operator">=</span> <span class="token string">'pid'</span><span class="token punctuation">,</span>
    childrenKey <span class="token operator">=</span> <span class="token string">'children'</span><span class="token punctuation">,</span>
    initialLevel <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nodeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 节点映射表</span>
    <span class="token keyword">const</span> roots <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token comment">// 根节点集合</span>

    <span class="token comment">// 创建节点副本并初始化子节点</span>
    data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> node <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>item<span class="token punctuation">,</span>
        <span class="token punctuation">[</span>childrenKey<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">level</span><span class="token operator">:</span> initialLevel <span class="token comment">// 初始化层级，后续会修正</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      nodeMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>node<span class="token punctuation">[</span>idKey<span class="token punctuation">]</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构建父子关系</span>
    data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> node <span class="token operator">=</span> nodeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span>idKey<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> parent <span class="token operator">=</span> nodeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span>pidKey<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent<span class="token punctuation">[</span>childrenKey<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        roots<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用队列进行层级计算（BFS）</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    roots<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">root</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      root<span class="token punctuation">.</span>level <span class="token operator">=</span> initialLevel<span class="token punctuation">;</span> <span class="token comment">// 设置根节点层级</span>
      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> node <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      node<span class="token punctuation">[</span>childrenKey<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        child<span class="token punctuation">.</span>level <span class="token operator">=</span> node<span class="token punctuation">.</span>level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 子节点层级 = 父节点层级 + 1</span>
        queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> roots<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 通用文件上传到阿里云OSS方法--File模式</span>
  <span class="token comment">/**
   * 通用文件上传到阿里云OSS方法--File模式
   * @param {string} fieldName - 上传文件的字段名
   * @param {number} imageClassId - 图片分类ID，默认为0
   * @param {string} prefix - 阿里云oss的Bucket中最外层文件夹名称，默认为'images'
   * @returns {Array} - 上传结果数组，每个元素对象包含上传文件的URL、路径、分类ID和创建时间
   */</span>
  <span class="token keyword">async</span> <span class="token function">uploadOSS_File</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">,</span> imageClassId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> prefix <span class="token operator">=</span> <span class="token string">'images'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 兼容 Egg 3.x 的文件结构</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span>files <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'请选择要上传的文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 筛选指定字段的文件</span>
      <span class="token keyword">const</span> matchedFiles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
        <span class="token parameter">f</span> <span class="token operator">=&gt;</span> f<span class="token punctuation">.</span>fieldname <span class="token operator">===</span> fieldName
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>matchedFiles<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">未找到 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fieldName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字段的上传文件</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 统一处理为数组</span>
      <span class="token keyword">const</span> fileList <span class="token operator">=</span> matchedFiles<span class="token punctuation">;</span>

      <span class="token comment">// 创建 OSS 客户端</span>
      <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSS</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>oss<span class="token punctuation">.</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 并行上传处理</span>
      <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
        fileList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 生成唯一文件名</span>
            <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> randomStr <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> extname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>randomStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

            <span class="token comment">// 创建日期路径</span>
            <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> datePath <span class="token operator">=</span> <span class="token punctuation">[</span>
              now<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">String</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">String</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 构造完整路径</span>
            <span class="token keyword">const</span> ossPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>datePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

            <span class="token comment">// 读取文件内容</span>
            <span class="token keyword">const</span> fileContent <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 上传到 OSS</span>
            <span class="token keyword">const</span> ossRes <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ossPath<span class="token punctuation">,</span> fileContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">url</span><span class="token operator">:</span> ossRes<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
              <span class="token literal-property property">path</span><span class="token operator">:</span> ossPath<span class="token punctuation">,</span>
              <span class="token literal-property property">image_class_id</span><span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>imageClassId<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token literal-property property">create_time</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// 清理临时文件</span>
            <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> results<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 全局异常清理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupRequestFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 通用文件上传到阿里云OSS方法--Stream 流模式</span>
  <span class="token comment">/**
   * 通用文件上传到阿里云OSS方法--Stream 流模式
   * @param {string} fieldName - 上传文件的字段名
   * @param {number} imageClassId - 图片分类ID，默认为0
   * @param {string} prefix - 阿里云oss的Bucket中最外层文件夹名称，默认为'images'
   * @returns {Array} - 上传结果数组，每个元素对象包含上传文件的URL、路径、分类ID和创建时间
   */</span>
  <span class="token keyword">async</span> <span class="token function">uploadOSS_Stream</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">,</span> imageClassId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> prefix <span class="token operator">=</span> <span class="token string">'images'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSS</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>oss<span class="token punctuation">.</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tmpFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 记录临时文件路径</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">//通过 ctx.multipart() 创建迭代器,循环处理每个上传的文件流</span>
      <span class="token keyword">const</span> multipart <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">multipart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> stream<span class="token punctuation">;</span>

      <span class="token comment">// 流式迭代处理</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>stream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">multipart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 过滤非目标字段,精确过滤目标上传字段,支持与其他表单字段共存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stream<span class="token punctuation">.</span>fieldname <span class="token operator">!==</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 生成唯一文件名</span>
        <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> randomStr <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> extname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>randomStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        <span class="token comment">// 创建日期目录</span>
        <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> datePath <span class="token operator">=</span> <span class="token punctuation">[</span>
          now<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">String</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">String</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 构造完整路径</span>
        <span class="token keyword">const</span> ossPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>datePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        <span class="token comment">// 创建临时文件路径</span>
        <span class="token keyword">const</span> tmpFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>
          app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span>tmpdir<span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>randomStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmpFiles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tmpFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 写入临时文件,使用 pump 确保流正确写入,必须写入临时文件后才能上传到 OSS</span>
        <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>tmpFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">pump</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> writeStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 上传到OSS,直接从临时文件创建可读流上传,避免内存中缓存大文件</span>
        <span class="token keyword">const</span> ossRes <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
          ossPath<span class="token punctuation">,</span>
          fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>tmpFilePath<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">url</span><span class="token operator">:</span> ossRes<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
          <span class="token literal-property property">path</span><span class="token operator">:</span> ossPath<span class="token punctuation">,</span>
          <span class="token literal-property property">image_class_id</span><span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>imageClassId<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token literal-property property">create_time</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 清理临时文件</span>
      <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
        tmpFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> results<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 异常时清理所有临时文件</span>
      <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
        tmpFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span>
          fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>


  <span class="token comment">//通用网站后台栏目列表包分页和连表查询方法</span>
  <span class="token keyword">async</span> <span class="token function">datalistIndex</span><span class="token punctuation">(</span><span class="token parameter">modelName<span class="token punctuation">,</span> where <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//分页：可以提炼成一个公共方法page(模型名称，where条件，其他参数options)</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span>modelName<span class="token punctuation">,</span> where<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 转一下data处理</span>
    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log('list', list);</span>
    <span class="token keyword">let</span> rules <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log('rules', rules);</span>

    <span class="token comment">// 数据集组合分类树(一维数组) 带level</span>
    <span class="token keyword">let</span> $rule <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">list_to_tree</span><span class="token punctuation">(</span>$array<span class="token punctuation">,</span> $field <span class="token operator">=</span> <span class="token string">'pid'</span><span class="token punctuation">,</span> $pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> $level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $array<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">$value<span class="token punctuation">,</span> $index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log($value);</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>$value<span class="token punctuation">[</span>$field<span class="token punctuation">]</span> <span class="token operator">==</span> $pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          $value<span class="token punctuation">[</span><span class="token string">'level'</span><span class="token punctuation">]</span> <span class="token operator">=</span> $level<span class="token punctuation">;</span>
          $rule<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>$value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// unset($array[$key]);</span>
          <span class="token comment">// console.log('看一下rule',$rule);</span>
          <span class="token comment">// $array.splice($index, 1);</span>
          <span class="token function">list_to_tree</span><span class="token punctuation">(</span>$array<span class="token punctuation">,</span> $field<span class="token punctuation">,</span> $value<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> $level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> $rule<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">totalCount</span><span class="token operator">:</span> data<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token function">list_to_tree</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">list</span><span class="token operator">:</span> list<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>



  <span class="token comment">// 针对即时通讯发送消息，用户不在线则将消息存储在消息队列，等用户上线再发</span>
  <span class="token comment">/**
   * 通用发送websocket消息方法
   * @param {number} sendto_id - 要发送消息给谁的用户ID  - 必填
   * @param {Object} message - 消息内容 - 必填
   * @param {boolean} offlineSave - 对方不在线，是否保存到消息队列，等对方上线再发 - 默认：true
   * @param {boolean} saveLog_sendto_id - 是否把消息存储到对方的redis历史记录中 - 默认：true
   * @param {Object} options - 额外参数 - 可不填
   * @param {string} [options.offlineSaveKey = 'chat_getmessage_'] - 消息队列KEY值前缀- 默认：'chat_getmessage_'
   * @param {string} [options.chatlog = 'chatlog'] - 模拟文件夹名称(可以是其他名称) - 默认：'chatlog'
   * @param {boolean} [options.saveLog_you = true] - 是否把消息存储到对方的redis记录中 - 默认：true
   * @param {boolean} [options.saveLog_me = false] - 是否把消息存储到自己的redis记录中 - 默认：false
   * @returns {void}  - 无返回值
   */</span>
  <span class="token keyword">async</span> <span class="token function">chatWebsocketSendOrSaveMessage</span><span class="token punctuation">(</span><span class="token parameter">sendto_id<span class="token punctuation">,</span> message<span class="token punctuation">,</span> 
    offlineSave <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> saveLog_sendto_id <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 参数初始化</span>
    <span class="token keyword">let</span> _saveLog_you <span class="token operator">=</span> options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>saveLog_you <span class="token operator">!=</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>saveLog_you <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _saveLog_me <span class="token operator">=</span> options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>saveLog_me <span class="token operator">!=</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>saveLog_me <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    options <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">offlineSaveKey</span><span class="token operator">:</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>offlineSaveKey<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'chat_getmessage_'</span><span class="token punctuation">,</span> <span class="token comment">// 消息队列KEY值前缀</span>
      <span class="token literal-property property">chatlog</span><span class="token operator">:</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>chatlog<span class="token punctuation">)</span> <span class="token operator">||</span>  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">chatlog</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 模拟文件夹名称</span>
      <span class="token literal-property property">saveLog_you</span><span class="token operator">:</span> _saveLog_you<span class="token punctuation">,</span> <span class="token comment">// 是否把消息存储到对方的redis记录中 - 默认：true</span>
      <span class="token literal-property property">saveLog_me</span><span class="token operator">:</span> _saveLog_me<span class="token punctuation">,</span> <span class="token comment">// 是否把消息存储到自己的redis记录中 - 默认：false</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 1. 注意此处的this指的是ctx</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 我的信息</span>
    <span class="token keyword">const</span> me <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chat_user<span class="token punctuation">;</span>
    <span class="token keyword">const</span> me_id <span class="token operator">=</span> me <span class="token operator">&amp;&amp;</span> me<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token comment">// 多进程处理</span>
    <span class="token comment">// 3. 拿到要发消息的用户的进程</span>
    <span class="token keyword">let</span> pid <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOldProcessId</span><span class="token punctuation">(</span>sendto_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">多进程即时通讯发送消息处理，此时拿到用户（对方）id为：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sendto_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 所在子进程</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4. 看进程是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不在线是否保存到消息队列，上线再发</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>offlineSave<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 5. 进程不存在即当前用户没有登录，则将消息存储在消息队列，等用户上线再发</span>
            <span class="token comment">// 放到reids，设置消息列表中， 等待对方上线时，再发送</span>
            <span class="token comment">// this.service.cache.setList('chat_getmessage_' + sendto_id, message);</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">setList</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>offlineSaveKey <span class="token operator">+</span> sendto_id<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
         <span class="token comment">// 6. 进程存在即对方在线，消息推送</span>
         <span class="token comment">// 跟单进程有些区别，需要指定子进程 - </span>
         <span class="token comment">// 在根目录 app.js中方法didReady() 进行监听进程再发消息</span>
         app<span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">sendTo</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token string">'send'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            sendto_id<span class="token punctuation">,</span>
            message
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 存储到对方redis历史记录中</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>saveLog_sendto_id<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 可异步存储或者同步存储</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setRedisDiy</span><span class="token punctuation">(</span>sendto_id<span class="token punctuation">,</span> message<span class="token punctuation">,</span> options<span class="token punctuation">.</span>saveLog_you<span class="token punctuation">,</span> options<span class="token punctuation">.</span>saveLog_me<span class="token punctuation">,</span> options<span class="token punctuation">.</span>chatlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    // 单进程消息处理
    // 拿到对方的socket
    let you_socket = this.app.ws.chatuser[sendto_id];
    // 如果拿不到对方的socket， 则把消息放在redis队列中， 等待对方上线时，再发送
    if (!you_socket) {
      // 放到reids，设置消息列表中：key值是：'chat_getmessage_' + sendto_id（用户id）
      this.service.cache.setList('chat_getmessage_' + sendto_id, message);
    } else {
      // 如果对方在线，则直接推送给对方
      you_socket.send(JSON.stringify({
        type: 'singleChat',
        data: message,
        timestamp: Date.now(),
      }));
      // 存储到对方redis历史记录中
      // key: `chatlog_对方id_[single|group]_我的id`
      this.service.cache.setList(`chatlog_${sendto_id}_${message.chatType}_${me.id}`, message);
    }
    */</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>


  <span class="token comment">// 生成二维码</span>
  <span class="token function">createQrcode</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> img <span class="token operator">=</span> qr<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 类型：image/png | svg</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'image/png'</span><span class="token punctuation">;</span>
    <span class="token comment">// img.pipe(this.response); </span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> img<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>


  <span class="token comment">// 针对uni-app项目上传文件到阿里云存储单文件处理</span>
  <span class="token comment">// 针对uni-app项目通用单文件处理文件上传到阿里云OSS方法--Stream 流模式--单文件--写入本地临时文件--在上传</span>
  <span class="token comment">/**
   * 通用文件上传到阿里云OSS方法--Stream 流模式
   * @param {string} fieldName - 上传文件的字段名
   * @param {number} imageClassId - 图片分类ID，默认为0
   * @param {string} prefix - 阿里云oss的Bucket中最外层文件夹名称，默认为'images'
   * @returns {Array} - 上传结果数组，每个元素对象包含上传文件的URL、路径、分类ID和创建时间
   */</span>
  <span class="token keyword">async</span> <span class="token function">uploadOSS_Stream_uniapp_singleFile_temp</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">,</span> imageClassId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> prefix <span class="token operator">=</span> <span class="token string">'images'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSS</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>oss<span class="token punctuation">.</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取文件流</span>
      <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFileStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 检查是否是目标字段</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stream<span class="token punctuation">.</span>fieldname <span class="token operator">!==</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Expected field '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fieldName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">', but got '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stream<span class="token punctuation">.</span>fieldname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 生成唯一文件名</span>
      <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> randomStr <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> extname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>randomStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

      <span class="token comment">// 创建日期目录</span>
      <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> datePath <span class="token operator">=</span> <span class="token punctuation">[</span>
        now<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">String</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">String</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 构造完整路径</span>
      <span class="token keyword">const</span> ossPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>datePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

      <span class="token comment">// 创建临时文件路径</span>
      <span class="token keyword">const</span> tmpFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>
        app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span>tmpdir<span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>randomStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 写入临时文件</span>
      <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>tmpFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">pump</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> writeStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 上传到OSS</span>
      <span class="token keyword">const</span> ossRes <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
        ossPath<span class="token punctuation">,</span>
        fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>tmpFilePath<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 清理临时文件</span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>tmpFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> ossRes<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> ossPath<span class="token punctuation">,</span>
        <span class="token literal-property property">image_class_id</span><span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>imageClassId<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">create_time</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> results<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 异常时清理临时文件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpFilePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>tmpFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 针对uni-app项目单文件处理通用文件上传到阿里云OSS方法--Stream 流模式--单文件--不写入本地临时文件--直接流上传</span>
  <span class="token comment">/**
   * 通用文件上传到阿里云OSS方法--Stream 流模式
   * @param {string} fieldName - 上传文件的字段名
   * @param {number} imageClassId - 图片分类ID，默认为0
   * @param {string} prefix - 阿里云oss的Bucket中最外层文件夹名称，默认为'images'
   * @returns {Array} - 上传结果数组，每个元素对象包含上传文件的URL、路径、分类ID和创建时间
   */</span>
  <span class="token keyword">async</span> <span class="token function">uploadOSS_Stream_uniapp_singleFile</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">,</span> imageClassId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> prefix <span class="token operator">=</span> <span class="token string">'images'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSS</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>oss<span class="token punctuation">.</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取文件流</span>
      <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFileStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 检查是否是目标字段</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stream<span class="token punctuation">.</span>fieldname <span class="token operator">!==</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Expected field '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fieldName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">', but got '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stream<span class="token punctuation">.</span>fieldname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 生成唯一文件名</span>
      <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> randomStr <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> extname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>randomStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

      <span class="token comment">// 创建日期目录</span>
      <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> datePath <span class="token operator">=</span> <span class="token punctuation">[</span>
        now<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">String</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">String</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 构造完整路径</span>
      <span class="token keyword">const</span> ossPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>datePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

      <span class="token comment">// 直接使用putStream方法上传流</span>
      <span class="token keyword">const</span> ossRes <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">putStream</span><span class="token punctuation">(</span>ossPath<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

      results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> ossRes<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> ossPath<span class="token punctuation">,</span>
        <span class="token literal-property property">image_class_id</span><span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>imageClassId<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">create_time</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> results<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>


  <span class="token comment">// 多进程处理 -  用户上线</span>
  <span class="token comment">// 原理是：记录上线用户在哪个进程中，利用redis存储用户id和进程id</span>
  <span class="token comment">// 传用户id及进程id</span>
  <span class="token keyword">async</span> <span class="token function">online</span><span class="token punctuation">(</span><span class="token parameter">chatuser<span class="token punctuation">,</span> chatuser_id<span class="token punctuation">,</span> processId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.解构</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理多进程</span>
    <span class="token comment">// 2.当前进程id, 没传则直接拿 process.pid</span>
    processId <span class="token operator">=</span> processId <span class="token operator">||</span> process<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
    <span class="token comment">// 3.根据进程存储方式获取用户之前的进程</span>
    <span class="token keyword">let</span> onlineProcessId <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOldProcessId</span><span class="token punctuation">(</span>chatuser_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4. 如果用户已在其他设备登录，处理下线逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onlineProcessId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'之前登录的设备进程'</span><span class="token punctuation">,</span> onlineProcessId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'当前登录的设备进程'</span><span class="token punctuation">,</span> processId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户角色'</span><span class="token punctuation">,</span> chatuser<span class="token punctuation">.</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 检查是否是同一进程</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onlineProcessId <span class="token operator">==</span> processId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
        console.log('同一进程内同一个账号下线不同socket链接设备');
        // 查找同一用户的其他连接 - 获取当前进程中的所有连接
        const connections = this.app.ws.chatuser || {};
        for (const [userId, socket] of Object.entries(connections)) {
          console.log(`同一个进程内的userId：${userId} 和 chatuser_id：${chatuser_id} 和socket信息：${socket}`);
          console.log(`同一个进程内的parseInt(userId) === chatuser_id`, parseInt(userId) === chatuser_id);
          console.log(`同一个进程内的socket !== this.websocket`, socket !== this.websocket);
          // if (parseInt(userId) === chatuser_id &amp;&amp; socket !== this.websocket) {
          // 发现：parseInt(userId) === chatuser_id 时候 socket !== this.websocket 为false 即同一个socket链接
          // 所以if判断无法实现，这跟socket设计有关，所以代码做了注释，关于下线提示在前端完成
          //   if (chatuser.role === 'user') {
          //     // 关闭旧socket连接 - 但不能删除 this.app.ws.chatuser[userId];
          //     socket.close();
          //   }
          // }
        }
        */</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不同进程，发送IPC消息</span>
        <span class="token comment">// 此时用到进程间的通讯：具体看文档&lt;https://eggjs.org/zh-CN/core/cluster-and-ipc&gt;</span>
        <span class="token comment">// 用到：app.messenger.sendTo(pid, action, data): 向指定进程发送消息</span>
        <span class="token comment">// 在根目录app.js文件didReady()方法中监听</span>
        <span class="token comment">// 仅发给role == 'user'的用户，游客不需要</span>
        <span class="token comment">/*
        if(chatuser.role === 'user'){
          console.log('发送IPC消息异地登录仅发给role = user的用户，游客不需要');
          app.messenger.sendTo(parseInt(onlineProcessId), 'offline', {
              chatuser_id,
              chatuser,
              Hash_key
          });
        }
        */</span>
      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token comment">// 5.获取多进程存储方式 - 从配置文件`config/config.default.js`中获取</span>
    <span class="token keyword">let</span> Hash_key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Hash_key<span class="token punctuation">;</span>
    <span class="token comment">// 6.根据多进程存储方式 - 更新用户在线状态为当前设备</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Hash_key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将用户在线状态存储到 chat_user_online 哈希中</span>
        <span class="token comment">// 字段名为 online_用户ID，值为进程ID</span>
        <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span>Hash_key<span class="token punctuation">,</span> <span class="token string">'online_'</span> <span class="token operator">+</span> chatuser_id<span class="token punctuation">,</span> processId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'有Hash_key的存储方式，用户上线成功,上线新进程'</span><span class="token punctuation">,</span> chatuser_id<span class="token punctuation">,</span> processId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置过期时间，防止僵尸状态（例如连接异常断开未清理）</span>
        <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>Hash_key<span class="token punctuation">,</span> <span class="token number">86400</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 24小时</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 利用redis存储用户id和进程id - 即存储上线状态</span>
        <span class="token comment">// 利用redis存储,调用service服务cache.js文件中的set方法</span>
        <span class="token comment">// await service.cache.set('online_' + chatuser_id, processId);</span>
        <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'online_'</span> <span class="token operator">+</span> chatuser_id<span class="token punctuation">,</span> processId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'没有Hash_key的存储方式，用户上线成功,上线新进程'</span><span class="token punctuation">,</span> chatuser_id<span class="token punctuation">,</span> processId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置过期时间,防止僵尸状态（例如连接异常断开未清理）</span>
        <span class="token comment">// 使用app.redis来设置过期时间</span>
        <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string">'online_'</span> <span class="token operator">+</span> chatuser_id<span class="token punctuation">,</span> <span class="token number">86400</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 24小时</span>
    <span class="token punctuation">}</span>
    
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 定义在其它设备登录的消息格式</span>
  <span class="token function">offlineMsg</span><span class="token punctuation">(</span><span class="token parameter">chatuser<span class="token punctuation">,</span>chatuser_id<span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 定义通知消息 -- 定义消息格式</span>
    <span class="token comment">// from_id 初始化自定义</span>
    <span class="token keyword">let</span> _from_id <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">redirect-forceLogout-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chatuser<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> force_message <span class="token operator">=</span> <span class="token punctuation">{</span> 
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token function">uuidv4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 自动生成 UUID,唯一id, 聊天记录id，方便撤回消息</span>
        <span class="token literal-property property">from_avatar</span><span class="token operator">:</span> args<span class="token punctuation">.</span>from_avatar <span class="token operator">||</span> <span class="token string">'https://docs-51yrc-com.oss-cn-hangzhou.aliyuncs.com/chat/kefu.png'</span><span class="token punctuation">,</span> <span class="token comment">// 发送者头像</span>
        <span class="token literal-property property">from_name</span><span class="token operator">:</span> args<span class="token punctuation">.</span>from_name <span class="token operator">||</span> <span class="token string">'账号异地登录'</span><span class="token punctuation">,</span> <span class="token comment">// 发送者名称</span>
        <span class="token literal-property property">from_id</span><span class="token operator">:</span> args<span class="token punctuation">.</span>from_id <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> args<span class="token punctuation">.</span>from_id <span class="token operator">:</span> _from_id<span class="token punctuation">,</span> <span class="token comment">// 发送者id 系统id或者类型</span>
        <span class="token literal-property property">to_id</span><span class="token operator">:</span> chatuser_id<span class="token punctuation">,</span> <span class="token comment">// id</span>
        <span class="token literal-property property">to_name</span><span class="token operator">:</span> chatuser<span class="token punctuation">.</span>nickname <span class="token operator">||</span> chatuser<span class="token punctuation">.</span>username<span class="token punctuation">,</span> <span class="token comment">// 名称</span>
        <span class="token literal-property property">to_avatar</span><span class="token operator">:</span> chatuser<span class="token punctuation">.</span>avatar<span class="token punctuation">,</span> <span class="token comment">// 头像</span>
        <span class="token literal-property property">chatType</span><span class="token operator">:</span> <span class="token string">'single'</span><span class="token punctuation">,</span> <span class="token comment">// 聊天类型 </span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token comment">// 消息类型 系统通知消息</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> args<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">你的账号在其他设备登录了，您当前设备会下线</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">,</span>
            <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> 
            <span class="token literal-property property">otherData</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 消息内容</span>
        <span class="token comment">// 新增处理链接</span>
        <span class="token comment">// redirect: {</span>
        <span class="token comment">//     url:'/pages/xx/xx', // 处理链接地址</span>
        <span class="token comment">//     type: 'navigateTo', // 处理链接类型</span>
        <span class="token comment">// }, // 处理链接</span>
        <span class="token literal-property property">redirect</span><span class="token operator">:</span> args<span class="token punctuation">.</span>redirect <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 处理链接</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 其它参数</span>
        <span class="token literal-property property">create_time</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 创建时间</span>
        <span class="token literal-property property">isremove</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 0未撤回 1已撤回</span>
        <span class="token comment">// 群相关信息</span>
        <span class="token literal-property property">group</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token comment">// 新增一个消息id的key</span>
        <span class="token literal-property property">msgidKey</span><span class="token operator">:</span> args<span class="token punctuation">.</span>from_id <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> args<span class="token punctuation">.</span>from_id <span class="token operator">:</span> _from_id<span class="token punctuation">,</span> <span class="token comment">// 消息id(便于前端在消息页查找记录)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> force_message<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 多进程：根据进程存储方式获取用户之前的进程</span>
  <span class="token keyword">async</span> <span class="token function">getOldProcessId</span><span class="token punctuation">(</span><span class="token parameter">chatuser_id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 1.解构</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.获取多进程存储方式 - 从配置文件`config/config.default.js`中获取</span>
    <span class="token keyword">let</span> Hash_key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Hash_key<span class="token punctuation">;</span>
    <span class="token comment">// console.log('多进程存储方式Hash_key是否有值, null为简单存储', Hash_key);</span>
    <span class="token comment">// 3. 定义进程</span>
    <span class="token keyword">let</span> onlineProcessId<span class="token punctuation">;</span>
    <span class="token comment">// 4. 根据存储方式Hash_key获取设备进程</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Hash_key<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// console.log('有Hash_key的存储方式',Hash_key);</span>
        <span class="token comment">// 检查用户是否已在其他进程上线</span>
        <span class="token comment">/*
        // 使用Redis事务确保原子操作
        const multi = app.redis.multi();
        multi.hget(Hash_key, 'online_' + chatuser_id);
        const [result] = await multi.exec();
        onlineProcessId = result;
        */</span>
        onlineProcessId <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span>Hash_key<span class="token punctuation">,</span> <span class="token string">'online_'</span> <span class="token operator">+</span> chatuser_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">// console.log('简单存储null的方式');</span>
        <span class="token comment">// 如果用户之前登录过，存在某个进程中，现在新设备登录</span>
        <span class="token comment">// 下线其他设备 - 先找到用户在哪个进程</span>
        <span class="token comment">// onlineProcessId = await service.cache.get('online_' + chatuser_id);</span>
        onlineProcessId <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'online_'</span> <span class="token operator">+</span> chatuser_id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">多进程处理：根据进程存储方式Hash_key获取用户之前的进程</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> onlineProcessId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> onlineProcessId<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 多进程：根据进程存储方式 - 移除redis中用户的上线记录</span>
  <span class="token keyword">async</span> <span class="token function">removeOnlineProcessId</span><span class="token punctuation">(</span><span class="token parameter">chatuser_id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 1.解构</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.获取多进程存储方式 - 从配置文件`config/config.default.js`中获取</span>
    <span class="token keyword">let</span> Hash_key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Hash_key<span class="token punctuation">;</span>
    <span class="token comment">// 3.根据是否使用Hash_key来处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Hash_key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 有Hash_key的处理方式</span>
      <span class="token comment">// console.log(`有Hash_key的处理方式`);</span>
      <span class="token comment">// 下线这个进程中的用户</span>
      <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">hdel</span><span class="token punctuation">(</span>Hash_key<span class="token punctuation">,</span> <span class="token string">'online_'</span> <span class="token operator">+</span> chatuser_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 没有Hash_key的处理方式</span>
      <span class="token comment">// console.log(`没有Hash_key的处理方式`);</span>
      <span class="token keyword">await</span> app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">'online_'</span> <span class="token operator">+</span> chatuser_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 移除redis记录 -- 上线记录</span>
      <span class="token comment">// await service.cache.remove('online_' + user_id).catch(console.error);</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  <span class="token comment">// 移除websocket用户记录</span>
  <span class="token keyword">async</span> <span class="token function">UserWebsocketCloseAndDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 1.解构</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 有没有websocket用户记录 - this代表ctx</span>
    <span class="token keyword">const</span> chatuser_id <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>chatuser_id<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chatuser_id<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 拿到websocket用户链接记录</span>
    <span class="token keyword">let</span> websocket_user_connect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser<span class="token punctuation">[</span>chatuser_id<span class="token punctuation">]</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">移除websocket用户 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chatuser_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 记录, 此时链接信息是：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>websocket_user_connect<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4. 移除websocket用户链接记录</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>websocket_user_connect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 关闭连接</span>
        websocket_user_connect<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除链接信息</span>
        <span class="token keyword">delete</span> websocket_user_connect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>


  <span class="token comment">// 存储聊天消息记录到redis中的key值自定义</span>
  <span class="token comment">/**
   * 通用存储聊天消息记录到redis中的key值自定义：带文件夹存储
   * @param {number} sendto_id - 要发送消息给谁的用户ID  - 必填
   * @param {Object} message - 消息内容 - 必填
   * @param {string} folder - 文件夹参数 - 可不填 - 默认：'chatlog'
   * @param {string} [message.chatType] - 从message中定义传过来，要是不传 - 默认：`TO`
   * @returns {Object}  - 返回我和对方的redis存储的key值
   */</span>
  <span class="token keyword">async</span> <span class="token function">setRedisChatlogKey</span><span class="token punctuation">(</span>sendto_id<span class="token punctuation">,</span> message<span class="token punctuation">,</span> folder <span class="token operator">=</span> <span class="token string">'chatlog'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 1. 注意此处的this指的是ctx</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 我的信息</span>
    <span class="token keyword">const</span> me <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chat_user<span class="token punctuation">;</span>
    <span class="token keyword">const</span> me_id <span class="token operator">=</span> me <span class="token operator">&amp;&amp;</span> me<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token comment">// 3. 定义返回值</span>
    <span class="token keyword">let</span> keyReturn <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 4. 根据message中是否有chatType来判断，均返回我和对方的key值</span>
    <span class="token comment">// 如果没有message.chatType 则定义一个默认的chatType，如：`TO`</span>
    message<span class="token punctuation">.</span>chatType <span class="token operator">=</span> message<span class="token punctuation">.</span>chatType <span class="token operator">||</span> <span class="token string">'TO'</span><span class="token punctuation">;</span>
    <span class="token comment">// 5. key值存储方式, 类似模拟文件夹： `文件夹/key值`</span>
    <span class="token keyword">let</span> _folder <span class="token operator">=</span> folder<span class="token punctuation">;</span> <span class="token comment">// 模拟文件夹名称，不传则默认为 `chatlog`</span>
    <span class="token comment">// 存储模式：使用冒号 : 作为分隔符来创建命名空间</span>
    <span class="token comment">// 1. 对方的key值</span>
    <span class="token keyword">let</span> you_key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_folder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sendto_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>chatType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>me_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> youKey <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_folder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>you_key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 我的key值</span>
    <span class="token keyword">let</span> me_key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_folder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>me_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>chatType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sendto_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> meKey <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>_folder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>me_key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 返回值</span>
    keyReturn <span class="token operator">=</span> <span class="token punctuation">{</span>
        youKey<span class="token punctuation">,</span>
        meKey<span class="token punctuation">,</span>
        _folder
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> keyReturn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 通用数据存储到redis自定义方法</span>
  <span class="token comment">/**
   * 通用数据存储到redis自定义方法
   * @param {number} sendto_id - 要发送消息给谁的用户ID  - 必填
   * @param {Object} message - 消息内容 - 必填
   * @param {boolean} saveLog_you - 是否把消息存储到对方的redis中 - 可不填 - 默认：true
   * @param {boolean} saveLog_me - 是否把消息存储到我的redis中 - 可不填 - 默认：true
   * @param {string} folder - 存入redis的模拟文件夹名称 - 可不填 - 默认：'chatlog'
   * @returns {void}  - 无返回值
   */</span>
  <span class="token keyword">async</span> <span class="token function">setRedisDiy</span><span class="token punctuation">(</span>sendto_id<span class="token punctuation">,</span> message<span class="token punctuation">,</span> saveLog_you <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> saveLog_me <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> folder <span class="token operator">=</span> <span class="token string">'chatlog'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// key: `chatlog_对方id_[single|group]_我的id`</span>
      <span class="token comment">// 第一种存储方式：直接存在 redis客户端Keys中，打开就能看见</span>
      <span class="token comment">// this.service.cache.setList(`chatlog_${sendto_id}_${message.chatType}_${me.id}`, message);</span>
      <span class="token comment">// 第二种存储方式, 类似： `文件夹/key值`</span>
      <span class="token comment">// 获取Key值, 调用：setRedisChatlogKey(sendto_id, message, folder = 'chatlog')</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span>youKey<span class="token punctuation">,</span> meKey<span class="token punctuation">,</span> _folder<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setRedisChatlogKey</span><span class="token punctuation">(</span>sendto_id<span class="token punctuation">,</span> message<span class="token punctuation">,</span> folder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 1. 存储对方的聊天记录</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>saveLog_you<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">setList</span><span class="token punctuation">(</span>youKey<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 第二种存储方式获取</span>
      <span class="token comment">// const messages = await this.service.cache.getList(youKey, true);</span>
      <span class="token comment">// 第二种存储方式删除</span>
      <span class="token comment">// await this.service.cache.remove(youKey);</span>
      <span class="token comment">// 第二种存储方式批量操作</span>
      <span class="token comment">// 1. 如批量操作 - 可以使用 Redis 的 KEYS 或 SCAN 命令：</span>
      <span class="token comment">/*
      // ①：获取所有聊天记录键 -- 实际就是获取文件夹名称，后面模糊匹配
      const allChatKeys = await this.app.redis.keys(`${_folder}:*`);
      // 如何进行删除：
      for (const key of allChatKeys) {
          await this.app.redis.del(key);
      }
      */</span>
      <span class="token comment">/*
      // ②：删除某个用户（sendto_id）的所有聊天记录（与所有人单聊、与所有群聊记录）
      // 这个地方可以做匹配，如： `${_folder}:${_folder}_${sendto_id}:*`， 当然也可以精确指定 youKey
      const userChatKeys = await this.app.redis.keys(`${_folder}:${_folder}_${sendto_id}:*`);
      for (const key of userChatKeys) {
          await this.app.redis.del(key);
      }
      */</span>
      <span class="token comment">// 2. 存储我的聊天记录</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>saveLog_me<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">setList</span><span class="token punctuation">(</span>meKey<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-新增对多进程的处理-在根目录新增-app-js-文件"><a href="#_4-新增对多进程的处理-在根目录新增-app-js-文件" class="header-anchor">#</a> 4. 新增对多进程的处理，在根目录新增 <code>app.js</code> 文件</h3> <p>此文件主要是对多进程的处理，具体可查看文档 <a href="https://eggjs.org/zh-CN/core/cluster-and-ipc#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AFipc" target="_blank" rel="noopener noreferrer">https://eggjs.org/zh-CN/core/cluster-and-ipc#进程间通讯ipc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <br></p> <p>说明：</p> <ol><li>在 <code>app.js</code> 中处理进程通讯，目前主要在 <code>async didReady() 应用已启动完毕 监听进程通讯</code></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 监听多进程间的通讯：启动自定义，具体可参考文档：https://eggjs.org/zh-CN/basics/app-start</span>
<span class="token comment">// app.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">v4</span><span class="token operator">:</span> uuidv4 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">AppBootHook</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">configWillLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 此时 config 文件已经被读取并合并，但还并未生效</span>
    <span class="token comment">// 这是应用层修改配置的最后机会</span>
    <span class="token comment">// 注意：此函数只支持同步调用</span>

    <span class="token comment">/*
    // 例如：参数中的密码是加密的，在此处进行解密
    this.app.config.mysql.password = decrypt(this.app.config.mysql.password);
    // 例如：插入一个中间件到框架的 coreMiddleware 之间
    const statusIdx = this.app.config.coreMiddleware.indexOf('status');
    this.app.config.coreMiddleware.splice(statusIdx + 1, 0, 'limit');
    */</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">didLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 所有配置已经加载完毕</span>
    <span class="token comment">// 可以用来加载应用自定义的文件，启动自定义服务</span>

    <span class="token comment">/*
    // 例如：创建自定义应用的实例
    this.app.queue = new Queue(this.app.config.queue);
    await this.app.queue.init();
 
    // 例如：加载自定义目录
    this.app.loader.loadToContext(path.join(__dirname, 'app/tasks'), 'tasks', {
      fieldClass: 'tasksClasses',
    });
    */</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">willReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 所有插件已启动完毕，但应用整体尚未 ready</span>
    <span class="token comment">// 可进行数据初始化等操作，这些操作成功后才启动应用</span>

    <span class="token comment">// 例如：从数据库加载数据到内存缓存</span>
    <span class="token comment">// this.app.cacheData = await this.app.model.query(QUERY_CACHE_SQL);</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">didReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 应用已启动完毕</span>
    <span class="token comment">// 拿app 实例</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">;</span>
    <span class="token comment">// 拿ctx 实例</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">createAnonymousContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 监听多进程：具体看文档 &lt;https://eggjs.org/zh-CN/core/cluster-and-ipc#%E6%8E%A5%E6%94%B6&gt;</span>
    <span class="token comment">// 接收: 监听 messenger 上的相应 action 事件可收到其他进程发送的消息。</span>
    <span class="token comment">// 注意跟扩展 `app/extend/context.js`中的方法：online方法中的</span>
    <span class="token comment">// online方法中的: app.messenger.sendTo(onlineProcessId, 'offline', {chatuser_id,chatuser}); 对应上</span>


    <span class="token comment">// 1. 监听用户在其他进程下线</span>
    app<span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> chatuser_id<span class="token punctuation">,</span> chatuser<span class="token punctuation">,</span> Hash_key <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 收到用户 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chatuser_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 的下线通知</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2.处理本进程中的用户连接（旧设备）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser<span class="token punctuation">[</span>chatuser_id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 定义一下通知消息 - 执行 `app/extend/context.js`中的方法 offlineMsg</span>
        <span class="token keyword">const</span> force_message <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">offlineMsg</span><span class="token punctuation">(</span>chatuser<span class="token punctuation">,</span> chatuser_id<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 符合前端页面格式的消息推送</span>
        app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser<span class="token punctuation">[</span>chatuser_id<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'singleChat'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">data</span><span class="token operator">:</span> force_message<span class="token punctuation">,</span>
          <span class="token literal-property property">timestamp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">后端推送旧设备</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chatuser_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">下线通知及关闭旧设备</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser<span class="token punctuation">[</span>chatuser_id<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭连接</span>
        app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser<span class="token punctuation">[</span>chatuser_id<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser<span class="token punctuation">[</span>chatuser_id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>


      <span class="token comment">// 3. 多进程：根据进程存储方式 - 移除redis中用户的上线记录</span>
      <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">removeOnlineProcessId</span><span class="token punctuation">(</span>chatuser_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 监听处理websocket消息</span>
    app<span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'send'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> sendto_id<span class="token punctuation">,</span> message <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 拿到对方的socket</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser<span class="token punctuation">[</span>sendto_id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> you_socket <span class="token operator">=</span> app<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chatuser<span class="token punctuation">[</span>sendto_id<span class="token punctuation">]</span><span class="token punctuation">;</span>
        you_socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'singleChat'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">data</span><span class="token operator">:</span> message<span class="token punctuation">,</span>
          <span class="token literal-property property">timestamp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">serverDidReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// http/https 服务器已启动，开始接收外部请求</span>
    <span class="token comment">// 此时可以从 app.server 获取 server 实例</span>

    <span class="token comment">/*
    this.app.server.on('timeout', socket =&gt; {
      // 处理 socket 超时
    });
    */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> AppBootHook<span class="token punctuation">;</span>
</code></pre></div><h3 id="_5-控制器-app-controller-api-chat-chatwebsocket-js-代码调整"><a href="#_5-控制器-app-controller-api-chat-chatwebsocket-js-代码调整" class="header-anchor">#</a> 5. 控制器 <code>/app/controller/api/chat/chatwebsocket.js</code> 代码调整</h3> <ol><li>将里面的发websocket消息的方法换成文件 <code>app/extend/context.js</code> 中通用处理<code>单进程</code>和<code>多进程</code>发消息方法：<code>通用发送websocket消息方法:</code> <code>chatWebsocketSendOrSaveMessage</code> <br></li> <li>统一针对用户角色<code>visitor 游客</code> 和 <code>user 用户</code> 进行websocket消息发送来初始化消息页；<br></li></ol> <blockquote><p>内容较多，去新页面查看：<br> <a href="/fourthless/w-a/eggjs.即时通讯webscoket发消息的控制器.html#一、websocket发消息的控制器方法汇总-控制器-app-controller-api-chat-chatwebsocket-js-完整代码" target="_blank">一、websocket发消息的控制器方法汇总</a><br></p></blockquote> <h3 id="_6-控制器-app-controller-api-chat-chatuser-js-代码调整"><a href="#_6-控制器-app-controller-api-chat-chatuser-js-代码调整" class="header-anchor">#</a> 6. 控制器 <code>/app/controller/api/chat/chatuser.js</code> 代码调整</h3> <p>将里面的发websocket消息的方法换成文件 <code>app/extend/context.js</code> 中通用处理<code>单进程</code>和<code>多进程</code>发消息方法：<code>通用发送websocket消息方法:</code> <code>chatWebsocketSendOrSaveMessage</code> <br></p> <blockquote><p>内容较多，去新页面查看：<br> <a href="/fourthless/w-a/eggjs.即时通讯单聊相关方法.html#一、单聊相关方法汇总" target="_blank">一、单聊相关方法汇总(控制器 <code>/app/controller/api/chat/chatuser.js</code> 完整代码)</a><br></p></blockquote> <h3 id="_7-控制器-app-controller-api-chat-chatgroup-js-代码调整"><a href="#_7-控制器-app-controller-api-chat-chatgroup-js-代码调整" class="header-anchor">#</a> 7. 控制器 <code>/app/controller/api/chat/chatgroup.js</code> 代码调整</h3> <p>将里面的发websocket消息的方法换成文件 <code>app/extend/context.js</code> 中通用处理<code>单进程</code>和<code>多进程</code>发消息方法：<code>通用发送websocket消息方法:</code> <code>chatWebsocketSendOrSaveMessage</code> <br></p> <blockquote><p>内容较多，去新页面查看：<br> <a href="/fourthless/w-a/eggjs.即时通讯群聊相关方法及路由.html#一、群聊相关方法汇总" target="_blank">一、群聊相关方法汇总(控制器 <code>/app/controller/api/chat/chatgroup.js</code> 完整代码)</a><br></p></blockquote> <h3 id="_8-控制器-app-controller-api-chat-goodfriendapply-js-代码调整"><a href="#_8-控制器-app-controller-api-chat-goodfriendapply-js-代码调整" class="header-anchor">#</a> 8. 控制器 <code>/app/controller/api/chat/goodfriendapply.js</code> 代码调整</h3> <p>将里面的发websocket消息的方法换成文件 <code>app/extend/context.js</code> 中通用处理<code>单进程</code>和<code>多进程</code>发消息方法：<code>通用发送websocket消息方法:</code> <code>chatWebsocketSendOrSaveMessage</code> <br></p> <blockquote><p>内容较多，去新页面查看：<br> <a href="/fourthless/w-a/eggjs.goodfriendapply.js控制器完整代码.html#一、好友申请相关方法汇总-控制器-app-controller-api-chat-goodfriendapply-js-完整代码" target="_blank">一、好友申请相关方法汇总(控制器 /app/controller/api/chat/goodfriendapply.js 完整代码)</a><br></p></blockquote> <h3 id="_9-关于控制器-app-controller-api-chat-chatwebsocket-js新建的服务文件-app-service-chatwebsocket-js"><a href="#_9-关于控制器-app-controller-api-chat-chatwebsocket-js新建的服务文件-app-service-chatwebsocket-js" class="header-anchor">#</a> 9. 关于控制器 <code>/app/controller/api/chat/chatwebsocket.js</code>新建的服务文件 <code>/app/service/chatwebsocket.js</code></h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service<span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ChatwebsocketService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取文件路径</span>
    <span class="token function">getFilePath</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> createUserId<span class="token punctuation">,</span> existsName1 <span class="token operator">=</span> <span class="token string">'data'</span><span class="token punctuation">,</span> existsName2 <span class="token operator">=</span> <span class="token string">'askAnswer'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> baseDir <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>baseDir<span class="token punctuation">;</span>
        <span class="token keyword">const</span> dirPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>baseDir<span class="token punctuation">,</span> existsName1<span class="token punctuation">,</span> existsName2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 确保目录存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">chatuser_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createUserId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取文件数据</span>
    <span class="token function">readFileData</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'读取文件失败:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写入文件数据</span>
    <span class="token function">writeFileData</span><span class="token punctuation">(</span><span class="token parameter">filePath<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'写入文件失败:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 搜索问答 - 修复版本</span>
    <span class="token keyword">async</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> create_userId<span class="token punctuation">,</span> ask</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-----搜索问答参数'</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> create_userId<span class="token punctuation">,</span> ask<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type <span class="token operator">||</span> <span class="token operator">!</span>create_userId <span class="token operator">||</span> <span class="token operator">!</span>ask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 返回错误对象，而不是设置ctx.body</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
                <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'参数不完整'</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> create_userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> questions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readFileData</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-----搜索问答数据'</span><span class="token punctuation">,</span> questions<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>questions<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'暂无问答数据'</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 模糊匹配算法</span>
            <span class="token keyword">const</span> searchKeywords <span class="token operator">=</span> ask<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">k</span> <span class="token operator">=&gt;</span> k<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> bestMatch <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> highestScore <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token comment">// 计算匹配度评分</span>
            questions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">question</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> questionText <span class="token operator">=</span> <span class="token punctuation">(</span>question<span class="token punctuation">.</span>ask <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> question<span class="token punctuation">.</span>answer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 1. 完全匹配 - 最高优先级</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>question<span class="token punctuation">.</span>ask<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>ask<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                    question<span class="token punctuation">.</span>answer<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>ask<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    score <span class="token operator">+=</span> <span class="token number">100</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 2. 关键词匹配</span>
                searchKeywords<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">keyword</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 问题中包含关键词</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>question<span class="token punctuation">.</span>ask<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        score <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// 回答中包含关键词</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>question<span class="token punctuation">.</span>answer<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        score <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// 计算关键词出现次数</span>
                    <span class="token keyword">const</span> askCount <span class="token operator">=</span> <span class="token punctuation">(</span>question<span class="token punctuation">.</span>ask<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                    <span class="token keyword">const</span> answerCount <span class="token operator">=</span> <span class="token punctuation">(</span>question<span class="token punctuation">.</span>answer<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                    score <span class="token operator">+=</span> <span class="token punctuation">(</span>askCount <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> answerCount<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 3. 长度相似度 - 问题长度越接近搜索词，得分越高</span>
                <span class="token keyword">const</span> lengthDiff <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>question<span class="token punctuation">.</span>ask<span class="token punctuation">.</span>length <span class="token operator">-</span> ask<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                score <span class="token operator">+=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">-</span> lengthDiff <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 4. 时效性 - 较新的内容得分更高</span>
                <span class="token keyword">const</span> updateTime <span class="token operator">=</span> question<span class="token punctuation">.</span>update_time <span class="token operator">||</span> question<span class="token punctuation">.</span>create_time<span class="token punctuation">;</span>
                <span class="token keyword">const</span> daysSinceUpdate <span class="token operator">=</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> updateTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                score <span class="token operator">+=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">-</span> daysSinceUpdate <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 5. 热门度 - 点赞多的内容得分更高</span>
                score <span class="token operator">+=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>question<span class="token punctuation">.</span>likeCount <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 更新最佳匹配</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">&gt;</span> highestScore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    highestScore <span class="token operator">=</span> score<span class="token punctuation">;</span>
                    bestMatch <span class="token operator">=</span> question<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 设置匹配阈值，避免低质量匹配</span>
            <span class="token keyword">const</span> threshold <span class="token operator">=</span> searchKeywords<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">;</span>

            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-----搜索问答匹配结果'</span><span class="token punctuation">,</span> bestMatch<span class="token punctuation">,</span> highestScore<span class="token punctuation">,</span> threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>bestMatch <span class="token operator">&amp;&amp;</span> highestScore <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">data</span><span class="token operator">:</span> bestMatch<span class="token punctuation">,</span>
                    <span class="token literal-property property">score</span><span class="token operator">:</span> highestScore<span class="token punctuation">,</span>
                    <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'搜索成功'</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果没有找到合适匹配，尝试使用更宽松的匹配方式</span>
                <span class="token keyword">const</span> fallbackMatch <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fallbackSearch</span><span class="token punctuation">(</span>questions<span class="token punctuation">,</span> ask<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fallbackMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">data</span><span class="token operator">:</span> fallbackMatch<span class="token punctuation">,</span>
                        <span class="token literal-property property">score</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'找到相关回答'</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'未找到相关问答'</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'搜索问答失败:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
                <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'搜索失败'</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 备用搜索方法 - 使用更宽松的匹配规则</span>
    <span class="token function">fallbackSearch</span><span class="token punctuation">(</span><span class="token parameter">questions<span class="token punctuation">,</span> ask</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> searchText <span class="token operator">=</span> ask<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 尝试部分匹配</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> question <span class="token keyword">of</span> questions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> questionText <span class="token operator">=</span> <span class="token punctuation">(</span>question<span class="token punctuation">.</span>ask <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> question<span class="token punctuation">.</span>answer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 检查是否包含搜索词的主要部分</span>
            <span class="token keyword">const</span> words <span class="token operator">=</span> searchText<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">w</span> <span class="token operator">=&gt;</span> w<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> matchCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> word <span class="token keyword">of</span> words<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>questionText<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    matchCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 如果超过一半的关键词匹配，认为是相关结果</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>matchCount <span class="token operator">&gt;=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>words<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> question<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 尝试同义词匹配（简单实现）</span>
        <span class="token keyword">const</span> synonymMap <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string-property property">'怎么'</span><span class="token operator">:</span> <span class="token string">'如何'</span><span class="token punctuation">,</span>
            <span class="token string-property property">'哪里'</span><span class="token operator">:</span> <span class="token string">'何处'</span><span class="token punctuation">,</span>
            <span class="token string-property property">'什么'</span><span class="token operator">:</span> <span class="token string">'啥'</span><span class="token punctuation">,</span>
            <span class="token string-property property">'为什么'</span><span class="token operator">:</span> <span class="token string">'为何'</span><span class="token punctuation">,</span>
            <span class="token string-property property">'怎么办'</span><span class="token operator">:</span> <span class="token string">'如何处理'</span><span class="token punctuation">,</span>
            <span class="token string-property property">'？'</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token string-property property">'?'</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token string-property property">'，'</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token string-property property">','</span><span class="token operator">:</span> <span class="token string">''</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> synonymText <span class="token operator">=</span> searchText<span class="token punctuation">;</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>synonymMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            synonymText <span class="token operator">=</span> synonymText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> synonymMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>synonymText <span class="token operator">!==</span> searchText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> question <span class="token keyword">of</span> questions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> questionText <span class="token operator">=</span> <span class="token punctuation">(</span>question<span class="token punctuation">.</span>ask <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> question<span class="token punctuation">.</span>answer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> cleanQuestionText <span class="token operator">=</span> questionText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[？?，,]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cleanQuestionText<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>synonymText<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> question<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 最后尝试：直接包含匹配（去除标点符号）</span>
        <span class="token keyword">const</span> cleanSearchText <span class="token operator">=</span> searchText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[？?，,]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> question <span class="token keyword">of</span> questions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> cleanQuestionAsk <span class="token operator">=</span> question<span class="token punctuation">.</span>ask<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[？?，,]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cleanQuestionAsk<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>cleanSearchText<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> question<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ChatwebsocketService<span class="token punctuation">;</span>
</code></pre></div><h3 id="_10-关于设置常见问题问答相关的控制器-app-controller-api-chat-askanswer-js-代码"><a href="#_10-关于设置常见问题问答相关的控制器-app-controller-api-chat-askanswer-js-代码" class="header-anchor">#</a> 10. 关于设置常见问题问答相关的控制器 <code>/app/controller/api/chat/askanswer.js</code> 代码</h3> <p><code>登录用户可设置常见问题的问答内容，当你不在线的时候，系统自动回复给客户</code><br></p> <blockquote><p>内容较多，去新页面查看：<br> <a href="/fourthless/w-a/eggjs.问答.html#一、eggjs问答系统-控制器-app-controller-api-chat-askanswer-js-完整代码" target="_blank">一、eggjs问答系统(控制器 /app/controller/api/chat/askanswer.js 完整代码)</a><br></p></blockquote> <h3 id="_11-关于各种api路由-app-router-api-chat-router-js-汇总"><a href="#_11-关于各种api路由-app-router-api-chat-router-js-汇总" class="header-anchor">#</a> 11. 关于各种api路由 <code>/app/router/api/chat/router.js</code> 汇总</h3> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
    <span class="token comment">//用户登录</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/loginChat'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>userlogin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//用户注册</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/regChat'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>userregister<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//用户退出登录</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/logout'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>userlogout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 系统给游客用户注册身份</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/visitorRegister'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>visitorRegister<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 游客用户正式注册身份</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/visitorregChat'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>visitorregChat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 游客用户正式登录身份</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/visitorloginChat'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>visitorloginChat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//搜索用户（登录用户才能搜索用户，未登录用户（游客）不能搜索用户）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/searchUser'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>searchUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查看用户信息(公共接口，游客和登录用户都可以访问)</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/userinfo/:uuid'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>userinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查看用户是否申请加我为好友（登录用户有这个权限，游客无权限）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/isApplyfriend/:uuid'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>isApplyfriend<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用户设置更新（登录用户有这个权限，游客无权限）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/userset'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>userset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token comment">//申请添加好友 （登录用户才能申请添加好友，（游客）不能申请添加好友）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/applyfriend'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriendapply<span class="token punctuation">.</span>applyfriend<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取别人申请我为好友的列表数据（登录用户才行，（游客）不能）</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/chat/listapplyfriend/:page'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriendapply<span class="token punctuation">.</span>listapplyfriend<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对申请加我为好友的信息进行处理（登录用户才行，（游客）不能） 传一个申请表的id</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/handleapply/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriendapply<span class="token punctuation">.</span>handleapply<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 好友列表（登录用户才行，（游客）不能）</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/chat/goodfriendlist/:page'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriend<span class="token punctuation">.</span>goodfriendlist<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查看好友资料信息（登录用户才可以查看好友资料信息，（游客）没有这个功能）, 传好友id</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/chat/getgoodfriendinfo/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriend<span class="token punctuation">.</span>getgoodfriendinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将好友移入移出黑名单（登录用户有将好友移入移出黑名单功能，（游客）没有这个功能），传好友id</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/setblackgoodfriend/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriend<span class="token punctuation">.</span>setblackgoodfriend<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将好友设置为星标好友或者取消（登录用户有设置为星标好友或者取消功能，（游客）没有这个功能），传好友id</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/setstargoodfriend/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriend<span class="token punctuation">.</span>setstargoodfriend<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置我和朋友是否可以互相查看对方发布的信息或者朋友圈（登录用户有这个功能，（游客）没有这个功能），传好友id</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/setmeOrfriendCanSee/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriend<span class="token punctuation">.</span>setmeOrfriendCanSee<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查看对方是否是我的好友（登录用户才可以查看好友资料信息，（游客）没有这个功能），传好友id</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/ismygoodfriend/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriend<span class="token punctuation">.</span>ismygoodfriend<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 创建群聊（登录用户有这个功能，（游客）没有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/group/create'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>creategroup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 用户(我)上线后获取离线消息（登录用户和游客都有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/chatGetmessageOffLine'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatwebsocket<span class="token punctuation">.</span>chat_getmessage_OffLine<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 群聊列表（登录用户和游客都有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/chat/grouplist/:page'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>grouplist<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取群资料信息（登录用户和游客都有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/chat/groupinfo/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>groupinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 修改群名称（群主才有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/groupUpdateName'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>groupUpdateName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 修改群公告（群主才有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/groupremark'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>groupremark<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 删除群成员（群主才有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/groupDeleteUser'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>groupDeleteUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 进群设置  （群主才有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/groupAddUserSet'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>groupAddUserSet<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 同意或者拒绝用户进群（群主才有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/groupAgreeOrNo'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>groupAgreeOrNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 邀请人进群(群主直接邀请，群成员邀请、游客自己进群根据群设置来处理)</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/groupInviteUser'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>groupInviteUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 修改我在群里面的昵称（登录用户和游客都有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/groupnickname'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>groupnickname<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 删除群（群主可操作）或退出群（群成员可操作）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/groupDeleteOrQuit'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>groupDeleteOrQuit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 生成群二维码（登录用户和游客都有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/chat/groupQrcode/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatgroup<span class="token punctuation">.</span>groupQrcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 上传文件（图片视频等）到本地服务器（自定义文件路径）（登录用户和游客都有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/uploadStreamSingleToServerDiy/:diydir'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>uploadStreamSingleToServerDiy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 上传文件（图片视频等）到阿里云存储（登录用户和游客都有这个功能）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/uploadAliyun'</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>image<span class="token punctuation">.</span>uniapp_uploadAliyunOSS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据视频地址获取视频截图</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/getVideoScreenshot'</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>video<span class="token punctuation">.</span>getVideoScreenshot<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 撤回消息（游客和登录用户都有这个权限）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/revokeMessage'</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>revokeMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 删除好友（登录用户有这个功能，（游客）没有这个功能），传好友id</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/deletegoodfriend/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriend<span class="token punctuation">.</span>deletegoodfriend<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 修改账号信息（登录用户都有这个权限，游客根据情况有部分权限）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/updateUserinfo'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>updateUserinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取用户一些设置信息如：加好友设置、聊天设置等（登录用户有这个权限，游客无权限）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/getUserSetInfo'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>getUserSetInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 自动添加好友并通过（申请加好友和审核的合并逻辑，前提是invite_confirm：0，登录用户和游客均可）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/autoAddFriendAndAgree'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>goodfriendapply<span class="token punctuation">.</span>autoAddFriendAndAgree<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 修改密码（登录用户有这个权限，游客无权限）</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/setPassword'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chatuser<span class="token punctuation">.</span>setPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 问答相关路由</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/askanswer/create'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>askanswer<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/askanswer/update'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>askanswer<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/askanswer/delete'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>askanswer<span class="token punctuation">.</span>delete<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/askanswer/list'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>askanswer<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/askanswer/detail'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>askanswer<span class="token punctuation">.</span>detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/chat/askanswer/search'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>askanswer<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 新增搜索路由</span>

    
<span class="token punctuation">}</span><span class="token punctuation">;</span>   

</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2025年9月27日星期六晚上10点22分</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.1551c49e.js" defer></script><script src="/assets/js/10.a1858127.js" defer></script><script src="/assets/js/2.641709ae.js" defer></script><script src="/assets/js/47.0a01cff4.js" defer></script><script src="/assets/js/4.68f7b7e9.js" defer></script>
  </body>
</html>
